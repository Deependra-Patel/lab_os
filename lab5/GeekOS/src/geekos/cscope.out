cscope 15 $HOME/Desktop/os/lab_os/lab5/GeekOS/src/geekos               0000288739
	@README.txt

1 
GìkOS
 
is
 
a
 
töy
 
›î©ög
 
sy°em
 
kî√l
 
x86
 
	gPCs
. 
Its
 
maö
 
puΩo£


2 
is
 
to
 
£rve
 
as
 
a
 
sim∂e
 
but
 
ªÆi°ic
 
exam∂e
 
of
 
™
 
OS
 
kî√l
 
ru¬ög


3 
⁄
 
ªÆ
 
	gh¨dw¨e
.

5 
GìkOS
 
is
 
‰ì
 
	gso·w¨e
: 
£e
 
the
 
fûe
 "COPYING" 
dëaûs
.

	@alarm.c

10 
	~<gìkos/timî.h
>

11 
	~<gìkos/Æ¨m.h
>

12 
	~<gìkos/mÆloc.h
>

13 
	~<gìkos/î∫o.h
>

14 
	~<gìkos/öt.h
>

15 
	~<gìkos/kthªad.h
>

17 #i‚de‡
NULL


18 
	#NULL
 ((*)0)

	)

21 
Spö_Lock_t
 
	gÆ¨mLock
;

23 
	#DEBUG_ALARM
(
x
...)

	)

25 
Aœrm_H™dÀr_Queue
 
	gs_Æ¨mWaôögQueue
;

26 
Aœrm_H™dÀr_Queue
 
	gs_Æ¨mPídögQueue
;

27 
Thªad_Queue
 
	gs_thªadQueue
;

29 
ölöe
 
	$CÆc_Ticks_Pî_MS
(
mûli£c⁄ds
) {

30 
ticks
 = 
TICKS_PER_MS
 * 
mûli£c⁄ds
;

31 
åunc
 = ()
ticks
;

32  (((
ticks
 - 
åunc
) > 0) ?Årunc + 1 :Årunc);

33 
	}
}

35 
Aœrm_Evít
 *
	$Aœrm_Föd_In_Queue_By_ID
(
Aœrm_H™dÀr_Queue


36 *
queue
, 
id
) {

37 
Aœrm_Evít
 *
Æ¨m
;

38 
Æ¨m
 = 
	`Gë_Fr⁄t_Of_Aœrm_H™dÀr_Queue
(
queue
);

39 
Æ¨m
 !0;áœrm = 
	`Gë_Next_In_Aœrm_H™dÀr_Queue
(alarm)) {

40 i‡(
Æ¨m
->
timîId
 =
id
) {

41  
Æ¨m
;

44  
NULL
;

45 
	}
}

47 *
_íd
;

48 
Aœrm_H™dÀr
(
ul⁄g_t
 
¨g
 
__©åibuã__
 ((
unu£d
))) {

49 
Aœrm_Evít
 *
	gÆ¨m
 = 
NULL
;

51 
DißbÀ_I¡îru±s
();

53 i‡(!
Is_Aœrm_H™dÀr_Queue_Em±y
(&
s_Æ¨mPídögQueue
)) {

55 
	gÆ¨m
 =

56 
Remove_From_Fr⁄t_Of_Aœrm_H™dÀr_Queue


57 (&
s_Æ¨mPídögQueue
);

58 
E«bÀ_I¡îru±s
();

60 
DEBUG_ALARM
("Æ: %∞", 
Æ¨m
);

61 
KASSERT0
(
Æ¨m
, "firstálarm handler in queue isÇull");

62 
KASSERT0
((*)
Æ¨m
 > (*)0x10,

64 
DEBUG_ALARM
("Æcb: %p(%pËC‹ê%d\n", 
Æ¨m
->
ˇŒback
,

65 
Æ¨m
->
d©a
, 
Gë_CPU_ID
());

66 i‡(
	g_íd
) {

67 
KASSERT0
((*)
Æ¨m
->
ˇŒback
 < 
_íd
,

70 
	gÆ¨m
->
ˇŒback
(
Æ¨m
->
d©a
);

72 
DißbÀ_I¡îru±s
();

73 
Fªe
(
Æ¨m
);

74 
E«bÀ_I¡îru±s
();

76 
Waô
(&
s_thªadQueue
);

77 
E«bÀ_I¡îru±s
();

82 
	$Sy°em_Timî_CÆlback
(
id
) {

83 
	`KASSERT
(!
	`I¡îru±s_E«bÀd
());

84 
Aœrm_Evít
 *
Æ¨m
 =

85 
	`Aœrm_Föd_In_Queue_By_ID
(&
s_Æ¨mWaôögQueue
, 
id
);

86 i‡(
Æ¨m
 == 0)

89 
	`KASSERT0
((*)
Æ¨m
->
ˇŒback
, "alarm callback wasÇull");

90 i‡(
_íd
) {

91 
	`KASSERT0
((*)
Æ¨m
->
ˇŒback
 < 
_íd
,

95 
	`Remove_From_Aœrm_H™dÀr_Queue
(&
s_Æ¨mWaôögQueue
, 
Æ¨m
);

96 
	`C™˚l_Timî
(
id
);

100 i‡(!
	`Is_Membî_Of_Aœrm_H™dÀr_Queue
(&
s_Æ¨mPídögQueue
, 
Æ¨m
)) {

101 
	`Add_To_Fr⁄t_Of_Aœrm_H™dÀr_Queue
(&
s_Æ¨mPídögQueue
, 
Æ¨m
);

103 
	`Wake_Up
(&
s_thªadQueue
);

104 
	}
}

106 
	$Inô_Aœrm
() {

107 
	`Sèπ_Kî√l_Thªad
(
Aœrm_H™dÀr
, 0, 
PRIORITY_NORMAL
, 
Ál£
, "{Alarm}");

108 
	}
}

110 
	$Aœrm_Cª©e
(
Aœrm_CÆlback
 
ˇŒback
, *
d©a
,

111 
mûliSec⁄ds
) {

112 
Aœrm_Evít
 *
Æ¨mEvít
 = 
	`MÆloc
((Alarm_Event));

113 i‡(
Æ¨mEvít
 == 0)

114  
ENOMEM
;

116 
id
;

118 
Æ¨mEvít
->
ˇŒback
 = callback;

119 
Æ¨mEvít
->
d©a
 = data;

120 
Æ¨mEvít
->
thªad
 = 
CURRENT_THREAD
;

122 
	`DißbÀ_I¡îru±s
();

124 
id
 = 
	`Sèπ_Timî
(
	`CÆc_Ticks_Pî_MS
(
mûliSec⁄ds
), 
Sy°em_Timî_CÆlback
);

125 i‡(
id
 < 0) {

126 
	`E«bÀ_I¡îru±s
();

127 
	`DEBUG_ALARM
("In Alarm_Create, failedÅo Start_Timer\n");

131 
Æ¨mEvít
->
timîId
 = 
id
;

133 
	`Add_To_Fr⁄t_Of_Aœrm_H™dÀr_Queue
(&
s_Æ¨mWaôögQueue
, 
Æ¨mEvít
);

134 
	`E«bÀ_I¡îru±s
();

135  
id
;

137 
	}
}

139 
	$Aœrm_C™˚l_F‹_Thªad
(
Kî√l_Thªad
 *
thªad
) {

140 
Aœrm_Evít
 *
Æ¨m
, *
√xt
;

142 
	`KASSERT
(!
	`I¡îru±s_E«bÀd
());

144 
Æ¨m
 = 
	`Gë_Fr⁄t_Of_Aœrm_H™dÀr_Queue
(&
s_Æ¨mWaôögQueue
);

145 
Æ¨m
 !0;áœrm = 
√xt
) {

146 
√xt
 = 
	`Gë_Next_In_Aœrm_H™dÀr_Queue
(
Æ¨m
);

147 i‡(
Æ¨m
->
thªad
 ==Åhread) {

148 
	`Remove_From_Aœrm_H™dÀr_Queue
(&
s_Æ¨mWaôögQueue
, 
Æ¨m
);

149 
	`Fªe
(
Æ¨m
);

154 
	}
}

156 
	$Aœrm_De°roy
(
id
) {

157 
	`DißbÀ_I¡îru±s
();

159 
Aœrm_Evít
 *
Æ¨m
 =

160 
	`Aœrm_Föd_In_Queue_By_ID
(&
s_Æ¨mWaôögQueue
, 
id
);

161 i‡(
Æ¨m
) {

162 
	`Remove_From_Aœrm_H™dÀr_Queue
(&
s_Æ¨mWaôögQueue
, 
Æ¨m
);

163 
	`C™˚l_Timî
(
id
);

164 
	`Fªe
(
Æ¨m
);

166 
Æ¨m
 = 
	`Aœrm_Föd_In_Queue_By_ID
(&
s_Æ¨mPídögQueue
, 
id
);

167 i‡(
Æ¨m
) {

168 
	`Remove_From_Aœrm_H™dÀr_Queue
(&
s_Æ¨mPídögQueue
, 
Æ¨m
);

169 
	`Fªe
(
Æ¨m
);

172 
	`E«bÀ_I¡îru±s
();

174 
	}
}

	@argblock.c

10 
	~<gìkos/kty≥s.h
>

11 
	~<gìkos/°rög.h
>

12 
	~<gìkos/¨gblock.h
>

19 
boﬁ
 
	$Is_S∑˚
(
c
) {

20  
c
 == ' ' || c == '\t' || c == '\n' || c == '\r';

21 
	}
}

28 c⁄° *
	$Skù_Whôe•a˚
(c⁄° *
s
) {

29 
	`Is_S∑˚
(*
s
))

30 ++
s
;

31  
s
;

32 
	}
}

39 
	$Gë_Argumít_Lí
(c⁄° *
¨g
) {

40 c⁄° *
s
 = 
¨g
;

41 
Àn
 = 0;

43 *
s
 !'\0' && !
	`Is_S∑˚
(*s)) {

44 ++
Àn
;

45 ++
s
;

47  
Àn
;

48 
	}
}

59 
	$Gë_Argumít_Block_Size
(c⁄° *
comm™d
, *
numArgs
,

60 
ul⁄g_t
 * 
¨gBlockSize
) {

61 
ul⁄g_t
 
size
 = 0;

62 
¨gCou¡
 = 0;

63 c⁄° *
s
 = 
comm™d
;

65 
size
 += ();

66 
size
 += (**);

73 
Àn
;

75 
s
 = 
	`Skù_Whôe•a˚
(s);

77 i‡(*
s
 == '\0')

79 
Àn
 = 
	`Gë_Argumít_Lí
(
s
);

80 
s
 +
Àn
;

82 
size
 += (*);

83 
size
 +
Àn
 + 1;

84 ++
¨gCou¡
;

88 
size
 += (*);

90 *
numArgs
 = 
¨gCou¡
;

91 *
¨gBlockSize
 = 
size
;

94 
	}
}

108 
	$F‹m©_Argumít_Block
(*
¨gBlock
, 
numArgs
,

109 
ul⁄g_t
 
u£rAddªss
, c⁄° *
comm™d
) {

110 
Àn
;

111 
ul⁄g_t
 *
¨gv
;

112 *
d°
 = 
¨gBlock
;

113 c⁄° *
s
 = 
comm™d
;

116 *(*)
d°
 = 
numArgs
;

117 
d°
 += ();

123 *(
ul⁄g_t
 *Ë
d°
 = 
u£rAddªss
 + (
Argumít_Block
);

124 
d°
 += (**);

127 
¨gv
 = (
ul⁄g_t
 *Ë
d°
;

128 
d°
 +(
numArgs
 + 1) * (*);

132 
s
 = 
	`Skù_Whôe•a˚
(s);

133 i‡(*
s
 == '\0')

135 *
¨gv
++ = 
u£rAddªss
 + (
d°
 - 
¨gBlock
);

137 
Àn
 = 
	`Gë_Argumít_Lí
(
s
);

138 
	`mem˝y
(
d°
, 
s
, 
Àn
);

139 
d°
 +
Àn
;

140 *
d°
++ = '\0';

142 
s
 +
Àn
;

146 *
¨gv
++ = 0;

147 
	}
}

	@bitset.c

15 
	~<gìkos/kas£π.h
>

16 
	~<gìkos/mÆloc.h
>

17 
	~<gìkos/bô£t.h
>

18 
	~<gìkos/°rög.h
>

19 
	~<libc/c⁄io.h
>

21 
	#FIND_OFFSET_AND_BIT
(
bôPos
,
off£t
,
bô
) \

23 
off£t
 = 
bôPos
 / 8; \

24 
bô
 = 
bôPos
 % 8; \

25 } 0)

	)

27 
	#FIND_NUM_BYTES
(
tŸÆBôs
) \

28 ((
tŸÆBôs
 / 8Ë+ (—ŸÆBô†% 8 !0Ë? 1 : 0))

	)

30 *
	$Cª©e_Bô_Së
(
uöt_t
 
tŸÆBôs
) {

31 
ul⁄g_t
 
numByãs
;

32 *
bôSë
;

34 
numByãs
 = 
	`FIND_NUM_BYTES
(
tŸÆBôs
);

36 
bôSë
 = 
	`MÆloc
(
numByãs
);

37 i‡(
bôSë
 != 0)

38 
	`mem£t
(
bôSë
, '\0', 
numByãs
);

40 
	`Pröt
("malloc failed\n");

42  
bôSë
;

43 
	}
}

45 
	$Së_Bô
(*
bôSë
, 
uöt_t
 
bôPos
) {

46 
ul⁄g_t
 
off£t
, 
bô
;

48 
	`FIND_OFFSET_AND_BIT
(
bôPos
, 
off£t
, 
bô
);

49 ((
uch¨_t
 *Ë
bôSë
)[
off£t
] |(1 << 
bô
);

50 
	}
}

52 
	$CÀ¨_Bô
(*
bôSë
, 
uöt_t
 
bôPos
) {

53 
ul⁄g_t
 
off£t
, 
bô
;

55 
	`FIND_OFFSET_AND_BIT
(
bôPos
, 
off£t
, 
bô
);

56 ((
uch¨_t
 *Ë
bôSë
)[
off£t
] &~(1 << 
bô
);

57 
	}
}

59 
boﬁ
 
	$Is_Bô_Së
(*
bôSë
, 
uöt_t
 
bôPos
) {

60 
ul⁄g_t
 
off£t
, 
bô
;

62 
	`FIND_OFFSET_AND_BIT
(
bôPos
, 
off£t
, 
bô
);

63  (((
uch¨_t
 *Ë
bôSë
)[
off£t
] & (1 << 
bô
)) != 0;

64 
	}
}

66 
	$Föd_Fú°_Fªe_Bô
(*
bôSë
, 
ul⁄g_t
 
tŸÆBôs
) {

67 
uöt_t
 
numByãs
 = 
	`FIND_NUM_BYTES
(
tŸÆBôs
);

68 
ul⁄g_t
 
off£t
;

69 
uch¨_t
 *
bôs
 = (uch¨_à*Ë
bôSë
;

71 
off£t
 = 0; off£à< 
numByãs
; ++offset) {

72 i‡(
bôs
[
off£t
] != 0xff) {

73 
uöt_t
 
bô
;

74 
bô
 = 0; bit < 8; ++bit) {

75 i‡((
bôs
[
off£t
] & (1 << 
bô
)) == 0)

76  (
off£t
 * 8Ë+ 
bô
;

78 #ifde‡
GEEKOS


80 
	`KASSERT
(
Ál£
);

86 
	}
}

91 
	$Föd_Fú°_N_Fªe
(*
bôSë
, 
uöt_t
 
runLígth
, 
ul⁄g_t
 
tŸÆBôs
) {

92 
uöt_t
 
i
, 
j
;

94 
i
 = 0; i < 
tŸÆBôs
 - 
runLígth
; i++) {

95 i‡(!
	`Is_Bô_Së
(
bôSë
, 
i
)) {

96 
j
 = 1; j < 
runLígth
; j++) {

97 i‡(
	`Is_Bô_Së
(
bôSë
, 
i
 + 
j
)) {

101 i‡(
j
 =
runLígth
) {

102  
i
;

107 
	}
}

109 
	$De°roy_Bô_Së
(*
bôSë
) {

110 
	`Fªe
(
bôSë
);

111 
	}
}

	@blockdev.c

10 
	~<gìkos/î∫o.h
>

11 
	~<gìkos/s¸ìn.h
>

12 
	~<gìkos/°rög.h
>

13 
	~<gìkos/mÆloc.h
>

14 
	~<gìkos/öt.h
>

15 
	~<gìkos/kthªad.h
>

16 
	~<gìkos/synch.h
>

17 
	~<gìkos/blockdev.h
>

20 #ifde‡
BLOCKDEV_DEBUG


21 
	#Debug
(
¨gs
...Ë
	`Pröt
◊rgs)

	)

23 
	#Debug
(
¨gs
...)

	)

26 
Spö_Lock_t
 
kthªadLock
;

35 
Muãx
 
	gs_blockdevLock
;

40 
DEFINE_LIST
(
Block_Devi˚_Li°
, 
Block_Devi˚
);

41 
IMPLEMENT_LIST
(
Block_Devi˚_Li°
, 
Block_Devi˚
);

47 
Block_Devi˚_Li°
 
	gs_devi˚Li°
;

54 
	$Do_Reque°
(
Block_Devi˚
 *
dev
, 
Reque°_Ty≥
 
ty≥
,

55 
blockNum
, *
buf
) {

56 
Block_Reque°
 *
ªque°
;

57 
rc
;

60 
	`Muãx_Lock
(&
s_blockdevLock
);

61 
ªque°
 = 
	`Cª©e_Reque°
(
dev
, 
ty≥
, 
blockNum
, 
buf
);

63 i‡(
ªque°
 == 0) {

65 
	`Muãx_U∆ock
(&
s_blockdevLock
);

66  
ENOMEM
;

69 
	`Po°_Reque°_And_Waô
(
ªque°
);

70 
rc
 = 
ªque°
->
îr‹Code
;

71 
	`Fªe
(
ªque°
);

72 
	`Muãx_U∆ock
(&
s_blockdevLock
);

73  
rc
;

74 
	}
}

86 
	$Regi°î_Block_Devi˚
(c⁄° *
«me
, 
Block_Devi˚_Ops
 *
›s
,

87 
unô
, *
drivîD©a
,

88 
Thªad_Queue
 *
waôQueue
,

89 
Block_Reque°_Li°
 *
ªque°Queue
) {

90 
Block_Devi˚
 *
dev
;

92 
	`KASSERT
(
›s
 != 0);

93 
	`KASSERT
(
waôQueue
 != 0);

94 
	`KASSERT
(
ªque°Queue
 != 0);

96 
dev
 = (
Block_Devi˚
 *)
	`MÆloc
((*dev));

97 i‡(
dev
 == 0)

98  
ENOMEM
;

100 
	`°r˝y
(
dev
->
«me
,Çame);

101 
dev
->
›s
 = ops;

102 
dev
->
unô
 = unit;

103 
dev
->
öU£
 = 
Ál£
;

104 
dev
->
drivîD©a
 = driverData;

105 
dev
->
waôQueue
 = waitQueue;

106 
dev
->
ªque°Queue
 =ÑequestQueue;

107 
dev
->
ªads
 = dev->
wrôes
 = 0;

109 
	`Muãx_Lock
(&
s_blockdevLock
);

111 
	`Debug
("Regi°îög block devi˚ %s\n", 
dev
->
«me
);

112 
	`Add_To_Back_Of_Block_Devi˚_Li°
(&
s_devi˚Li°
, 
dev
);

113 
	`Muãx_U∆ock
(&
s_blockdevLock
);

116 
	}
}

122 
	$O≥n_Block_Devi˚
(c⁄° *
«me
, 
Block_Devi˚
 **
pDev
) {

123 
Block_Devi˚
 *
dev
;

124 
rc
 = 0;

126 
	`Muãx_Lock
(&
s_blockdevLock
);

128 
dev
 = 
	`Gë_Fr⁄t_Of_Block_Devi˚_Li°
(&
s_devi˚Li°
);

129 
dev
 != 0) {

130 i‡(
	`°rcmp
(
dev
->
«me
,Çame) == 0)

132 
dev
 = 
	`Gë_Next_In_Block_Devi˚_Li°
(dev);

135 i‡(
dev
 == 0)

136 
rc
 = 
ENODEV
;

137 i‡(
dev
->
öU£
)

138 
rc
 = 
EBUSY
;

140 
rc
 = 
dev
->
›s
->
	`O≥n
(dev);

141 i‡(
rc
 == 0) {

142 *
pDev
 = 
dev
;

143 
dev
->
öU£
 = 
åue
;

147 
	`Muãx_U∆ock
(&
s_blockdevLock
);

149  
rc
;

150 
	}
}

156 
	$Clo£_Block_Devi˚
(
Block_Devi˚
 *
dev
) {

157 
rc
;

159 
	`Muãx_Lock
(&
s_blockdevLock
);

161 
	`KASSERT
(
dev
->
öU£
);

162 
rc
 = 
dev
->
›s
->
	`Clo£
(dev);

163 i‡(
rc
 == 0)

164 
dev
->
öU£
 = 
Ál£
;

166 
	`Muãx_U∆ock
(&
s_blockdevLock
);

168  
rc
;

169 
	}
}

174 
Block_Reque°
 *
	$Cª©e_Reque°
(
Block_Devi˚
 *
dev
,

175 
Reque°_Ty≥
 
ty≥
, 
blockNum
,

176 *
buf
) {

177 
Block_Reque°
 *
ªque°
 = 
	`MÆloc
((*request));

178 i‡(
ªque°
 != 0) {

179 
ªque°
->
dev
 = dev;

180 
ªque°
->
ty≥
 =Åype;

181 
ªque°
->
blockNum
 = blockNum;

182 
ªque°
->
buf
 = buf;

183 
ªque°
->
°©e
 = 
PENDING
;

184 
	`CÀ¨_Thªad_Queue
(&
ªque°
->
waôQueue
);

186  
ªque°
;

187 
	}
}

194 
	$Po°_Reque°_And_Waô
(
Block_Reque°
 *
ªque°
) {

195 
Block_Devi˚
 *
dev
;

197 
	`KASSERT
(
ªque°
 != 0);

199 
dev
 = 
ªque°
->dev;

200 
	`KASSERT
(
dev
 != 0);

203 
	`Debug
("Po°ög block devi˚Ñeque° [@%x]...\n", 
ªque°
);

204 
	`DißbÀ_I¡îru±s
();

205 
	`Spö_Lock
(&
kthªadLock
);

206 
	`Add_To_Back_Of_Block_Reque°_Li°
(
dev
->
ªque°Queue
, 
ªque°
);

207 
	`Wake_Up_Locked
(
dev
->
waôQueue
);

208 
	`Spö_U∆ock
(&
kthªadLock
);

209 
	`E«bÀ_I¡îru±s
();

212 
	`DißbÀ_I¡îru±s
();

213 
ªque°
->
°©e
 =
PENDING
) {

214 
	`Debug
("Waôög, sèã=%d\n", 
ªque°
->
°©e
);

215 
	`Waô
(&
ªque°
->
waôQueue
);

217 
	`Debug
("Wait completed!\n");

218 
	`E«bÀ_I¡îru±s
();

219 
	}
}

224 
Block_Reque°
 *
	$Dequeue_Reque°
(
Block_Reque°_Li°
 *
ªque°Queue
,

225 
Thªad_Queue
 *
waôQueue
) {

226 
Block_Reque°
 *
ªque°
;

228 
	`DißbÀ_I¡îru±s
();

229 
	`Is_Block_Reque°_Li°_Em±y
(
ªque°Queue
))

230 
	`Waô
(
waôQueue
);

231 
ªque°
 = 
	`Gë_Fr⁄t_Of_Block_Reque°_Li°
(
ªque°Queue
);

232 
	`Remove_From_Fr⁄t_Of_Block_Reque°_Li°
(
ªque°Queue
);

233 
	`E«bÀ_I¡îru±s
();

235  
ªque°
;

236 
	}
}

241 
	$NŸify_Reque°_Com∂ëi⁄
(
Block_Reque°
 *
ªque°
,

242 
Reque°_Sèã
 
°©e
, 
îr‹Code
) {

243 
	`DißbÀ_I¡îru±s
();

245 
ªque°
->
°©e
 = state;

246 
ªque°
->
îr‹Code
 =ÉrrorCode;

248 
	`Wake_Up
(&
ªque°
->
waôQueue
);

251 
	`E«bÀ_I¡îru±s
();

252 
	}
}

258 
	$Block_Ród
(
Block_Devi˚
 *
dev
, 
blockNum
, *
buf
) {

259 
	`KASSERT
(
dev
);

260 
	`KASSERT
(
buf
);

261 
dev
->
ªads
++;

262  
	`Do_Reque°
(
dev
, 
BLOCK_READ
, 
blockNum
, 
buf
);

263 
	}
}

269 
	$Block_Wrôe
(
Block_Devi˚
 *
dev
, 
blockNum
, *
buf
) {

270 
	`KASSERT
(
dev
);

271 
	`KASSERT
(
buf
);

272 
dev
->
wrôes
++;

273  
	`Do_Reque°
(
dev
, 
BLOCK_WRITE
, 
blockNum
, 
buf
);

274 
	}
}

279 
	$Gë_Num_Blocks
(
Block_Devi˚
 *
dev
) {

280  
dev
->
›s
->
	`Gë_Num_Blocks
(dev);

281 
	}
}

286 
	$Dump_Blockdev_Sèts
() {

287 
Block_Devi˚
 *
dev
;

288 
i
;

289 
	`Pröt
("Block Device Stats:\n");

290 
	`Muãx_Lock
(&
s_blockdevLock
);

291 
dev
 = 
	`Gë_Fr⁄t_Of_Block_Devi˚_Li°
(&
s_devi˚Li°
), 
i
 = 5;

292 
dev
 !0 && 
i
 > 0;

293 
dev
 = 
	`Gë_Next_In_Block_Devi˚_Li°
(dev), 
i
 -= 1) {

294 
	`Pröt
(" %s:Ñód %u wrŸê%u\n", 
dev
->
«me
, dev->
ªads
, dev->
wrôes
);

296 
	`Muãx_U∆ock
(&
s_blockdevLock
);

297 
	}
}

	@bootsect.asm

1 ; 
BoŸ
 
£˘‹
 
	gGìkOS


2 ; 
C›yright
 (
c
Ë2001, 
David
 
	gH
. 
	gHovemeyî
 <
	gdaveho
@
	gcs
.
	gumd
.
	gedu
>

3 ; 
	g$Revisi⁄
: 5.0.2.2 
$


5 ; 
This
 
is
 
‰ì
 
	gso·w¨e
. 
You
 
¨e
 
≥rmôãd
 
to
 
	gu£
,

6 ; 
	gªdi°ribuã
, 
™d
 
modify
 
ô
 
as
 
•ecifõd
 
ö
 
the
 
	gfûe
 "COPYING".

8 ; 
Lﬂds
 
£tup
 
code
 
™d
 
a
 
¥ogøm
 
image
 
‰om
 
	g£˘‹s
 1..
n
 
of
á 
	gÊ›py


9 ; 
™d
 
execuãs
 
the
 
£tup
 
code
 (
which
 
wûl
 
ö
 
tu∫
 
execuã


10 ; 
the
 
¥ogøm
 
image
).

12 ; 
Some
 
of
 
this
 
code
 
is
 
ad≠ãd
 
‰om
 
Kî√l
 
	gToﬁkô
 0.2

13 ; 
™d
 
Löux
 
	gvîsi⁄
 2.2.x, 
so
 
the
 
fﬁlowög
 
c›yrights
 
	g≠∂y
:

15 ; 
C›yright
 (
C
Ë1991, 1992 
Löus
 
	gT‹vÆds


16 ; 
modifõd
 
by
 
Dªw
 
	gEckh¨dt


17 ; 
modifõd
 
by
 
Bru˚
 
Ev™s
 (
bde
)

18 ; 
ad≠ãd
 
Kî√l
 
Toﬁkô
 
by
 
Luigi
 
	gSgro


20 %
	gö˛ude
 "defs.asm"

22 ;;
KERN_START_SEC
 
equ
 (
NUM_SETUP_SECTORS
 + 1)

25 ; 
The
 
a˘uÆ
 
	gcode


28 [
BITS
 16]

29 [
ORG
 0x0]

31 
	gBegöText
: ; 
√eded
 
to
 
ˇlcuœã
 
∑ddög
 
byãs
Åÿ
fûl
 
the
 
	g£˘‹


33 ; 
C›y
 
the
 
boŸ
 
£˘‹
 
öto
 
	gINITSEG
.

34 
mov
 
	gax
, 
BOOTSEG


35 
mov
 
	gds
, 
	gax
 ; 
sour˚
 
£gmít
 
°rög
 
c›y


36 
x‹
 
	gsi
, sò; 
sour˚
 
ödex
 
°rög
 
c›y


37 
mov
 
	gax
, 
INITSEG


38 
mov
 
	ges
, 
	gax
 ; 
de°ö©i⁄
 
£gmít
 
°rög
 
c›y


39 
x‹
 
	gdi
, dò; 
de°ö©i⁄
 
ödex
 
°rög
 
c›y


40 
	g˛d
 ; 
˛ór
 
dúe˘i⁄
 
Êag


41 
mov
 
	gcx
, 256 ; 
numbî
 
of
 
w‹ds
 
to
 
c›y


42 
ªp
 
	gmovsw
 ; 
	gc›y
 512 
byãs


44 
jmp
 
	gINITSEG
:
a·î_move


46 
a·î_move
:

47 ; 
Now
 
	gwe
'reÉxecuting in INITSEG

49 ; 
We
 
w™t
 
the
 
d©a
 
£gmít
 
to
 
ª„r
Åÿ
	gINITSEG


50 ; (
sö˚
 
	gwe
've defined variables inÅhe sameÖlaceásÅhe code)

51 
mov
 
	gds
, 
	gax
 ; 
ax
 
°ûl
 
c⁄èös
 
	gINITSEG


53 ; 
Put
 
the
 
°ack
 
ö
Åhê
∂a˚
 
whîe
 
we
 
wîe
 
‹igöÆly
 
	glﬂded
.

54 ; 
By
 
	gdeföôi⁄
, 
thîe
 
is
 
nŸhög
 
imp‹è¡
Åhîê
	gnow
.

55 
mov
 
	gax
, 0

56 
mov
 
	gss
, 
ax


57 
mov
 
	g•
, (
	gBOOTSEG
 << 4) + 512 - 2

59 
ˇŒ
 
	gGëP¨am


62 
mov
 
	gdx
, [
numHóds
]

63 
ˇŒ
 
PrötHex


64 
ˇŒ
 
PrötSP


66 
mov
 
	gdx
, [
£˘‹sPîTøck
]

67 
ˇŒ
 
PrötHex


68 
ˇŒ
 
PrötSP


70 
mov
 
	gdx
, [
numCylödîs
]

71 
ˇŒ
 
PrötHex


72 
ˇŒ
 
PrötSP


73 
ˇŒ
 
	gPrötNL


74 %
ídif


76 
	glﬂd_£tup
:

77 ; 
Lﬂd
 
the
 
£tup
 
	gcode
.

78 
mov
 
	gax
, 
	gw‹d
 [
£tupSèπ
]

79 
	gmov
 [
£c_cou¡
], 
	gax


80 .
	gagaö
:

81 
mov
 
ax
, [
£c_cou¡
]

82 
push
 
	gax
 ; 1
°
 
∑øm
 
to
 
	$RódSe˘‹
 (
log
 
£c
 
num
)

83 
push
 
w‹d
 
SETUPSEG
 ; 2
nd
 
∑øm
 
to
 
	$RódSe˘‹
 (
£g
 
ba£
)

84 
sub
 
ax
, 
w‹d
 [
£tupSèπ
] ; 
c⁄vît
 
to
 0-
ödexed


85 
shl
 
ax
, 9 ; 
™d
 
mu…ùly
 
by
 512

86 
push
 
ax
 ; 
to
 
gë
 
off£t
 
ö
 
	`£gmít
 (3
rd
 
∑rm
)

88 ;; 
mov
 
ax
, [
£c_cou¡
]

89 ;; 
push
 
ax
 ; 1
°
 
∑øm
 
to
 
	`RódSe˘‹
 (
log
 
£c
 
num
)

90 ;; 
push
 
w‹d
 
SETUPSEG
 ; 2
nd
 
∑øm
 
to
 
	`RódSe˘‹
 (
£g
 
ba£
)

91 ;; 
dec
 
ax
 ; 
c⁄vît
 
to
 0-
ödexed


92 ;; 
shl
 
ax
, 9 ; 
mu…ùly
 
by
 512

93 ;; 
push
 
ax
 ; ...
to
 
gë
 3
rd
 
	`∑øm
 (
byã
 
off£t
)

95 ; 
ªad
 
the
 
£˘‹
 
‰om
Åhê
Ê›py


96 
ˇŒ
 
RódSe˘‹


97 
add
 
•
, 6 ; 
˛ór
 3 
w‹d
 
∑øms


99 ; 
⁄
 
to
 
√xt
 
£˘‹


100 
öc
 
w‹d
 [
£c_cou¡
]

102 ; 
¨e
 
we
 
d⁄e
?

103 
mov
 
ax
, 
w‹d
 [
£tupSèπ
]

104 
add
 
ax
, 
w‹d
 [
£tupSize
]

105 
cmp
 
w‹d
 [
£c_cou¡
], 
ax


106 
jl
 .
agaö


108 
lﬂd_kî√l
:

109 ; 
Lﬂd
 
the
 
kî√l
 
image
 
‰om
 
£˘‹s
 
KERN_START_SEC
..
n
 
of
Åhe

110 ; 
boŸ
 
drive
 
öto
 
mem‹y
 
©
 
KERNSEG
. 
NŸe
 
th©
 
thîe
 
¨e
 128 
£˘‹s


111 ; 
≥r
 64
K
 
£gmít
. 
So
, 
whí
 
figurög
 
out
 
which
 segmíà
to


112 ; 
lﬂd
 
the
 
£˘‹
 
öto
, 
we
 
shi·
 
right
 
by
 7 
	`bôs
 (
which
 
is


113 ; 
equivÆít
 
to
 
dividög
 
by
 128).

114 
mov
 
ax
, 
w‹d
 [
kî√lSèπ
]

115 
mov
 
w‹d
 [
£c_cou¡
], 
ax


116 .
agaö
:

117 
mov
 
ax
, [
£c_cou¡
] ; 
logiˇl
 
£˘‹
 
⁄
 
the
 
Ê›py


118 
push
 
ax
 ; 1
°
 
∑øm
 
to
 
	$RódSe˘‹
 (
log
 
£c
 
num
)

119 
sub
 
ax
, 
w‹d
 [
kî√lSèπ
] ; 
c⁄vît
 
to
 0-
ödexed


120 
mov
 
cx
, 
ax
 ; 
ßve
 
ö
 cx

121 
shr
 
ax
, 7 ; 
divide
 
by
 128

122 
shl
 
ax
, 12 ; ...
™d
 
mu…ùly
 
by
 0x1000

123 
add
 
ax
, 
KERNSEG
 ; ...
to
 
gë
 
ba£
 
ªœtive
Åo KERNSEG

124 
push
 
ax
 ; 2
nd
 
∑øm
 
to
 
	$RódSe˘‹
 (
£g
 
ba£
)

125 
™d
 
cx
, 0x7‡; 
mod
 
£˘‹
 
by
 128

126 
shl
 
cx
, 9 ; ...
™d
 
mu…ùly
 
by
 512

127 
push
 
cx
 ; 
to
 
gë
 
off£t
 
ö
 
	`£gmít
 (3
rd
 
∑rm
)

129 ; 
ªad
 
the
 
£˘‹
 
‰om
Åhê
Ê›py


130 
ˇŒ
 
RódSe˘‹


131 
add
 
•
, 6 ; 
˛ór
 3 
w‹d
 
∑øms


133 ; 
⁄
 
to
 
√xt
 
£˘‹


134 
öc
 
w‹d
 [
£c_cou¡
]

136 ; 
have
 
we
 
lﬂded
 
Æl
 
of
 
the
 
£˘‹s
?

137 
mov
 
ax
, 
w‹d
 [
kî√lSèπ
]

138 
add
 
ax
, 
w‹d
 [
kî√lSize
]

139 
cmp
 
w‹d
 [
£c_cou¡
], 
ax


140 
jl
 .
agaö


142 ; 
put
 
boŸ
 
drive
 
öto
 
œ°
 4 
byes
 
of
 
SETUPSEG


143 
mov
 
ax
, 
DRIVE_NUMBER


144 
mov
 [(
SETUPSEG
<<4)+508], 
ax


146 ; 
Now
 
we
'veÜoadedÅhe setup codeándÅhe kernel image.

147 ; 
Jump
 
to
 
£tup
 
code
.

148 
jmp
 
SETUPSEG
:0

150 ; 
Ród
 
a
 
£˘‹
 
‰om
 
the
 
Ê›py
 
drive
.

151 ; 
This
 
	$code
 (
™d
 
the
 
ª°
 
of
 
this
 
boŸ
 
£˘‹
Ë
wûl
 
have
 
to


152 ; 
be
 
ª
-
wrôãn
 
©
 
some
 
poöt
 
so
 
ô
 
ªads
 
m‹e
 
th™
 
⁄e


153 ; 
£˘‹
 
©
 
a
 
time
.

155 ; 
P¨amëîs
:

156 ; - "logiˇl" 
£˘‹
 
numbî
 [
bp
+8]

157 ; - 
de°ö©i⁄
 
£gmít
 [
bp
+6]

158 ; - 
de°ö©i⁄
 
off£t
 [
bp
+4]

159 
RódSe˘‹
:

160 
push
 
bp
 ; 
£t
 
up
 
°ack
 
‰ame


161 
mov
 
bp
, 
•
 ; "

162 
pusha
 ; 
ßve
 
Æl
 
ªgi°îs


165 ; 
debug
 
∑øms


166 
ˇŒ
 
PrötSP


167 
mov
 
dx
, [
bp
+8]

168 
ˇŒ
 
PrötHex


169 
ˇŒ
 
PrötSP


170 
mov
 
dx
, [
bp
+6]

171 
ˇŒ
 
PrötHex


172 
ˇŒ
 
PrötSP


173 
mov
 
dx
, [
bp
+4]

174 
ˇŒ
 
PrötHex


175 
ˇŒ
 
PrötSP


176 %
ídif


178 ; 
Se˘‹
 = 
log_£c
 % 
SECTORS_PER_TRACK


179 ; 
Hód
 = (
log_£c
 / 
SECTORS_PER_TRACK
Ë% 
HEADS


180 
mov
 
ax
, [
bp
+8] ; 
gë
 
logiˇl
 
£˘‹
 
numbî
 
‰om
 
°ack


181 
x‹
 
dx
, dx ; dx 
is
 
high
 
∑π
 
of
 
	$dividíd
 (== 0)

182 
mov
 
bx
, [
£˘‹sPîTøck
] ; 
divis‹


183 
div
 
bx
 ; dÿ
the
 
divisi⁄


184 
mov
 [
£c
], 
dx
 ; 
£˘‹
 
is
 
the
 
ªmaödî


185 ; 
ax
 = 
log_£c
 / 
SECTORS_PER_TRACK


186 
x‹
 
dx
, dx ; dx 
is
 
high
 
∑π
 
of
 
	$dividíd
 (== 0)

187 
mov
 
bx
, [
numHóds
] ; 
divis‹


188 
div
 
bx


189 
mov
 [
hód
], 
dx
 ; hód 
is
 
the
 
ªmaödî


191 ; 
Tøck
 = 
log_£c
 / (
SECTORS_PER_TRACK
*
HEADS
)

192 
x‹
 
dx
, dx ; dx 
is
 
high
 
∑π
 
of
 
dividíd


193 
mov
 
ax
, [
numHóds
]

194 
mov
 
bx
, [
£˘‹sPîTøck
] ;

195 
mul
 
bx
 ; 
ax
 =
SECTORS_PER_TRACK
*
HEADS


196 
mov
 
bx
, 
ax


198 
mov
 
ax
, [
bp
+8] ; 
gë
 
logiˇl
 
£˘‹
 
numbî
 
agaö


199 
div
 
bx
 ; dÿ
the
 
divisi⁄


200 
mov
 [
åack
], 
ax
 ;Åøck 
is
 
quŸõ¡


203 ; 
debuggög
 
code


204 
mov
 
dx
, [
£c
]

205 
ˇŒ
 
PrötHex


206 
ˇŒ
 
PrötSP


207 
mov
 
dx
, [
hód
]

208 
ˇŒ
 
PrötHex


209 
ˇŒ
 
PrötSP


210 
mov
 
dx
, [
åack
]

211 
ˇŒ
 
PrötHex


212 
ˇŒ
 
PrötNL


213 %
ídif


215 ; 
Now
, 
åy
 
to
 
a˘uÆly
 
ªad
 
the
 
£˘‹
 
‰om
Åhê
Ê›py
,

216 ; 
ªåyög
 
up
 
to
 3 
times
.

218 
mov
 [
num_ªåõs
], 
byã
 0

220 
ªadRëry
:

221 
mov
 
ax
, [
bp
+6] ; 
de°
 
£gmít
...

222 
mov
 
es
, 
ax
 ; 
g€s
 
ö
És

223 
mov
 
ax
, (0x02 << 8Ë| 1 ; 
fun˘i⁄
 = 02
h
 
ö
 
ah
,

224 ; #£c†1 
ö
 
Æ


225 
mov
 
bx
, [
åack
] ;Åøck 
numbî
...

226 
mov
 
ch
, 
bl
 ; 
g€s
 
ö
 ch

227 
mov
 
bx
, [
£c
] ; 
£˘‹
 
numbî
...

228 
mov
 
˛
, 
bl
 ; 
g€s
 
ö
 cl...

229 
öc
 
˛
 ; 
but
 
ô
 
mu°
 
be
 1-
ba£d
, 
nŸ
 0-based

230 
mov
 
bx
, [
hód
] ; hód 
numbî
...

231 
mov
 
dh
, 
bl
 ; 
g€s
 
ö
 dh

232 
mov
 
dl
, 
DRIVE_NUMBER
 ; 
h¨d
 
code
 
fd
=0, 
hd
=0x80

233 
mov
 
bx
, [
bp
+4] ; 
off£t
 
g€s
 
ö
 bx

234 ; (
es
:
bx
 
poöts
 
to
 
buf„r
)

236 ; 
CÆl
 
the
 
BIOS
 
Ród
 
Diskëã
 
Se˘‹s
 
£rvi˚


239 ; 
If
 
the
 
ˇºy
 
Êag
 
is
 
NOT
 
£t
, 
thí
 
thîe
 
was
 
no
 
îr‹


240 ; 
™d
 
we
're done.

241 
jnc
 
ªadD⁄e


243 ; 
Eº‹
 - 
code
 
°‹ed
 
ö
 
ah


244 
mov
 
dx
, 
ax


245 
ˇŒ
 
PrötHex


246 
öc
 
byã
 [
num_ªåõs
]

247 
cmp
 
byã
 [
num_ªåõs
], 3

248 
j√
 
ªadRëry


250 
dód
:

251 ; 
If
 
we
 
gŸ
 
hîe
, wê
Áûed
 
thri˚
, 
so
 wê
give
 
up


252 
mov
 
dx
, 0xdead

253 
ˇŒ
 
PrötHex


254 .
hîe
: 
jmp
 .here

256 
ªadD⁄e
:

257 
p›a
 ; 
ª°‹e
 
Æl
 
ªgisôîs


258 
p›
 
bp
 ; 
Àave
 
°ack
 
‰ame


259 
ªt


261 ; 
In˛ude
 
utûôy
 
routöes


262 %
ö˛ude
 "util.asm"

265 ; 
V¨übÀs


268 ; 
The£
 
¨e
 
u£d
 
by
 
RódSe˘‹


269 
hód
: 
dw
 0

270 
åack
: 
dw
 0

271 
£c
: 
dw
 0

272 
num_ªåõs
: 
db
 0

274 
numHóds
: 
dw
 
HEADS


275 
numCylödîs
: 
dw
 0

276 
£˘‹sPîTøck
: 
dw
 
SECTORS_PER_TRACK


278 ; 
U£d
 
lo›s
 
ªadög
 
£˘‹s
 
‰om
 
Ê›py


279 
£c_cou¡
: 
dw
 0

281 
GëP¨am
:

282 
push
 
bp
 ; 
£t
 
up
 
°ack
 
‰ame


283 
mov
 
bp
, 
•
 ; "

284 
pusha
 ; 
ßve
 
Æl
 
ªgi°îs


286 
mov
 
ah
, 0x08 ;; 
gë∑øm
 
ˇŒ


287 
mov
 
dl
, 
DRIVE_NUMBER


290 
mov
 
Æ
, 
dh


291 
x‹
 
ah
,áh

292 
öc
 
ax


293 
mov
 [
numHóds
], 
ax


295 
mov
 
Æ
, 
˛


296 
™d
 
ax
, 0x3f

297 
mov
 [
£˘‹sPîTøck
], 
ax


299 
mov
 
Æ
, 
ch


300 
mov
 
ah
, 
˛


301 
mov
 
˛
, 6

302 
shr
 
ah
,
˛


303 
öc
 
ax


304 
mov
 [
numCylödîs
], 
ax


306 
p›a
 ; 
ª°‹e
 
Æl
 
ªgisôîs


307 
p›
 
bp
 ; 
Àave
 
°ack
 
‰ame


308 
ªt


310 
EndText
:

312 
FûlSe˘‹
 
	`times
 (482 - (
EndText
 - 
BegöText
)Ë
db
 0

315 ; 
PÁt
 
boŸ
 
ªc‹d


316 
dw
 0

317 
dw
 0

319 
dw
 0

320 
dw
 0

322 
dw
 0

323 
dw
 0

325 
dw
 0

326 
dw
 0

328 
dw
 0

329 
dw
 0

331 ;; 
∑π
 
of
 
pÁt
 
boŸ
 
ªc‹d


332 
£tupSèπ
:

333 
dw
 0

335 ;; 
∑π
 
of
 
pÁt
 
boŸ
 
ªc‹d


336 
£tupSize
:

337 
dw
 0

339 ;; 
∑π
 
of
 
pÁt
 
boŸ
 
ªc‹d


340 
kî√lSèπ
:

341 
dw
 0

343 ;; 
∑π
 
of
 
pÁt
 
boŸ
 
ªc‹d


344 
kî√lSize
:

345 
dw
 0

347 
Sig«tuª
 
dw
 0xAA55 ; 
BIOS
 
c⁄åﬁs
 
this
 
to
 
ísuª
Åhi†
is
 
a
 
boŸ
 
£˘‹


	@bufcache.c

10 
	~<gìkos/î∫o.h
>

11 
	~<gìkos/kas£π.h
>

12 
	~<gìkos/mem.h
>

13 
	~<gìkos/mÆloc.h
>

14 
	~<gìkos/blockdev.h
>

15 
	~<gìkos/bufˇche.h
>

20 
	#FS_BUFFER_CACHE_MAX_BLOCKS
 128

	)

26 
	gbufCacheDebug
 = 0;

27 
	#Debug
(
¨gs
...Ëi‡(
bufCacheDebug
Ë
	`Pröt
◊rgs)

	)

30 
	gnoEvi˘
 = 0;

36 
uöt_t
 
	$Gë_Num_Se˘‹s_Pî_FS_Block
(
FS_Buf„r_Cache
 *
ˇche
) {

37  (
ˇche
->
fsBlockSize
 / 
SECTOR_SIZE
);

38 
	}
}

43 
Do_Buf„r_IO
(
FS_Buf„r_Cache
 *
ˇche
, 
FS_Buf„r
 *
buf
,

44 (*
IO_Func
Ë(
Block_Devi˚
 * 
dev
,

45 
blockNum
, *
buf
)) {

46 
uöt_t
 
off£t
;

47 
£˘‹Cou¡
 = 0;

48 
blockNum
 = 
buf
->
fsBlockNum
 * 
	`Gë_Num_Se˘‹s_Pî_FS_Block
(
ˇche
);

49 *
±r
 = (*)
buf
->
d©a
;

51 
off£t
 = 0; off£à< 
ˇche
->
fsBlockSize
; off£à+
SECTOR_SIZE
) {

52 
rc
 = 
	`IO_Func
(
ˇche
->
dev
, 
blockNum
, 
±r
 + 
off£t
);

53 i‡(
rc
 != 0)

54  
rc
;

55 ++
£˘‹Cou¡
;

56 ++
blockNum
;

58 
	`KASSERT
(
off£t
 =
ˇche
->
fsBlockSize
);

59 
	`KASSERT
(
£˘‹Cou¡
 =
	`Gë_Num_Se˘‹s_Pî_FS_Block
(
ˇche
));

62 
	}
}

67 
	$Sync_Buf„r
(
FS_Buf„r_Cache
 *
ˇche
, 
FS_Buf„r
 *
buf
) {

68 
rc
 = 0;

70 
	`KASSERT
(
	`IS_HELD
(&
ˇche
->
lock
));

72 i‡(
buf
->
Êags
 & 
FS_BUFFER_DIRTY
) {

73 i‡((
rc
 = 
	`Do_Buf„r_IO
(
ˇche
, 
buf
, 
Block_Wrôe
)) == 0)

74 
buf
->
Êags
 &~(
FS_BUFFER_DIRTY
);

77  
rc
;

78 
	}
}

84 
	$Move_To_Fr⁄t
(
FS_Buf„r_Cache
 *
ˇche
,

85 
FS_Buf„r
 *
buf
) {

86 
	`Remove_From_FS_Buf„r_Li°
(&
ˇche
->
buf„rLi°
, 
buf
);

87 
	`Add_To_Fr⁄t_Of_FS_Buf„r_Li°
(&
ˇche
->
buf„rLi°
, 
buf
);

88 
	}
}

94 
	$Gë_Buf„r
(
FS_Buf„r_Cache
 *
ˇche
, 
ul⁄g_t
 
fsBlockNum
,

95 
FS_Buf„r
 **
pBuf
) {

96 
FS_Buf„r
 *
buf
, *
Ãu
 = 0;

97 
rc
;

99 
	`Debug
("Reque° block %lu\n", 
fsBlockNum
);

101 
	`KASSERT
(
	`IS_HELD
(&
ˇche
->
lock
));

108 
buf
 = 
	`Gë_Fr⁄t_Of_FS_Buf„r_Li°
(&
ˇche
->
buf„rLi°
);

109 
buf
 != 0) {

110 i‡(
buf
->
fsBlockNum
 == fsBlockNum) {

111 
	`Debug
("Found block %lu\n", 
fsBlockNum
);

113 
buf
->
Êags
 & 
FS_BUFFER_INUSE
) {

114 
	`Debug
("Waôög f‹ block %lu\n", 
fsBlockNum
);

115 
	`C⁄d_Waô
(&
ˇche
->
c⁄d
, &ˇche->
lock
);

117 
d⁄e
;

121 i‡(!(
buf
->
Êags
 & 
FS_BUFFER_INUSE
))

122 
Ãu
 = 
buf
;

124 
buf
 = 
	`Gë_Next_In_FS_Buf„r_Li°
(buf);

131 i‡(
ˇche
->
numCached
 < 
FS_BUFFER_CACHE_MAX_BLOCKS
) {

132 
buf
 = (
FS_Buf„r
 *)
	`MÆloc
((*buf));

133 i‡(
buf
 != 0) {

134 
buf
->
d©a
 = 
	`AŒoc_Page
();

135 i‡(
buf
->
d©a
 == 0) {

136 
	`Fªe
(
buf
);

139 
buf
->
fsBlockNum
 = fsBlockNum;

140 
buf
->
Êags
 = 0;

141 
	`Add_To_Fr⁄t_Of_FS_Buf„r_Li°
(&
ˇche
->
buf„rLi°
, 
buf
);

142 ++
ˇche
->
numCached
;

143 
ªadAndAcquúe
;

152 i‡(
Ãu
 == 0)

153  
ENOMEM
;

155 
	`KASSERT
(!
noEvi˘
);

158 i‡((
rc
 = 
	`Sync_Buf„r
(
ˇche
, 
Ãu
)) != 0)

159  
rc
;

162 
buf
 = 
Ãu
;

163 
buf
->
Êags
 = 0;

164 
buf
->
fsBlockNum
 = fsBlockNum;

165 
	`Move_To_Fr⁄t
(
ˇche
, 
buf
);

167 
ªadAndAcquúe
:

173 
	`KASSERT
(!(
buf
->
Êags
 & 
FS_BUFFER_DIRTY
));

174 
	`KASSERT
(
	`Gë_Fr⁄t_Of_FS_Buf„r_Li°
(&
ˇche
->
buf„rLi°
Ë=
buf
);

177 i‡((
rc
 = 
	`Do_Buf„r_IO
(
ˇche
, 
buf
, 
Block_Ród
)) != 0)

178  
rc
;

180 
d⁄e
:

182 
buf
->
Êags
 |
FS_BUFFER_INUSE
;

185 
	`Debug
("Acquúed block %lu\n", 
fsBlockNum
);

186 *
pBuf
 = 
buf
;

188 
	}
}

193 
	$Sync_Cache
(
FS_Buf„r_Cache
 *
ˇche
) {

194 
rc
 = 0;

195 
FS_Buf„r
 *
buf
;

197 
	`KASSERT
(
	`IS_HELD
(&
ˇche
->
lock
));

199 
buf
 = 
	`Gë_Fr⁄t_Of_FS_Buf„r_Li°
(&
ˇche
->
buf„rLi°
);

200 
buf
 != 0) {

201 i‡((
rc
 = 
	`Sync_Buf„r
(
ˇche
, 
buf
)) != 0)

203 
buf
 = 
	`Gë_Next_In_FS_Buf„r_Li°
(buf);

206  
rc
;

207 
	}
}

212 
	$Fªe_Buf„r
(
FS_Buf„r
 *
buf
) {

213 
	`KASSERT
(!(
buf
->
Êags
 & (
FS_BUFFER_DIRTY
 | 
FS_BUFFER_INUSE
)));

214 
	`Fªe_Page
(
buf
->
d©a
);

215 
	`Fªe
(
buf
);

216 
	}
}

225 
FS_Buf„r_Cache
 *
	$Cª©e_FS_Buf„r_Cache
(
Block_Devi˚
 *
dev
,

226 
uöt_t
 
fsBlockSize
) {

227 
FS_Buf„r_Cache
 *
ˇche
;

229 
	`KASSERT
(
dev
 != 0);

230 
	`KASSERT
(
dev
->
öU£
);

236 
	`KASSERT
(
fsBlockSize
 <
PAGE_SIZE
);

237 
	`KASSERT
(
fsBlockSize
 > 0);

239 
ˇche
 = (
FS_Buf„r_Cache
 *)
	`MÆloc
((*cache));

240 i‡(
ˇche
 == 0)

243 
ˇche
->
dev
 = dev;

244 
ˇche
->
fsBlockSize
 = fsBlockSize;

245 
ˇche
->
numCached
 = 0;

246 
	`CÀ¨_FS_Buf„r_Li°
(&
ˇche
->
buf„rLi°
);

247 
	`Muãx_Inô
(&
ˇche
->
lock
);

248 
	`C⁄d_Inô
(&
ˇche
->
c⁄d
);

250  
ˇche
;

251 
	}
}

257 
	$Sync_FS_Buf„r_Cache
(
FS_Buf„r_Cache
 *
ˇche
) {

258 
rc
;

260 
	`Muãx_Lock
(&
ˇche
->
lock
);

261 
rc
 = 
	`Sync_Cache
(
ˇche
);

262 
	`Muãx_U∆ock
(&
ˇche
->
lock
);

264  
rc
;

265 
	}
}

272 
	$De°roy_FS_Buf„r_Cache
(
FS_Buf„r_Cache
 *
ˇche
) {

273 
rc
;

274 
FS_Buf„r
 *
buf
;

276 
	`Muãx_Lock
(&
ˇche
->
lock
);

279 
rc
 = 
	`Sync_Cache
(
ˇche
);

282 
buf
 = 
	`Gë_Fr⁄t_Of_FS_Buf„r_Li°
(&
ˇche
->
buf„rLi°
);

283 
buf
 != 0) {

284 
FS_Buf„r
 *
√xt
 = 
	`Gë_Next_In_FS_Buf„r_Li°
(
buf
);

285 
	`Fªe_Buf„r
(
buf
);

286 
buf
 = 
√xt
;

288 
	`CÀ¨_FS_Buf„r_Li°
(&
ˇche
->
buf„rLi°
);

290 
	`Muãx_U∆ock
(&
ˇche
->
lock
);

293 
	`Fªe
(
ˇche
);

295  
rc
;

296 
	}
}

301 
	$Gë_FS_Buf„r
(
FS_Buf„r_Cache
 *
ˇche
, 
ul⁄g_t
 
fsBlockNum
,

302 
FS_Buf„r
 **
pBuf
) {

303 
rc
;

305 
	`KASSERT0
(
ˇche
 !
NULL
, "Null FS_Buffer_CacheÖassedÅo Get_FS_Buffer.");

306 
	`KASSERT0
(
pBuf
 !
NULL
,

309 
	`Muãx_Lock
(&
ˇche
->
lock
);

310 
rc
 = 
	`Gë_Buf„r
(
ˇche
, 
fsBlockNum
, 
pBuf
);

311 
	`Muãx_U∆ock
(&
ˇche
->
lock
);

313  
rc
;

314 
	}
}

319 
	$Modify_FS_Buf„r
(
FS_Buf„r_Cache
 *
ˇche
, 
FS_Buf„r
 *
buf
) {

320 
	`KASSERT0
(
ˇche
 !
NULL
, "Null FS_Buffer_CacheÖassedÅo Modify_FS_Buffer.");

321 
	`KASSERT0
(
buf
 !
NULL
, "Null FS_BufferÖassedÅo Modify_FS_Buffer.");

323 
	`KASSERT
(
buf
->
Êags
 & 
FS_BUFFER_INUSE
);

324 
buf
->
Êags
 |
FS_BUFFER_DIRTY
;

325 
	}
}

331 
	$Sync_FS_Buf„r
(
FS_Buf„r_Cache
 *
ˇche
, 
FS_Buf„r
 *
buf
) {

332 
rc
;

334 
	`KASSERT
(
buf
->
Êags
 & 
FS_BUFFER_INUSE
);

336 
	`Muãx_Lock
(&
ˇche
->
lock
);

337 
rc
 = 
	`Sync_Buf„r
(
ˇche
, 
buf
);

338 
	`Muãx_U∆ock
(&
ˇche
->
lock
);

340  
rc
;

341 
	}
}

346 
	$Rñó£_FS_Buf„r
(
FS_Buf„r_Cache
 *
ˇche
, 
FS_Buf„r
 *
buf
) {

347 
rc
 = 0;

349 
	`KASSERT
(
buf
->
Êags
 & 
FS_BUFFER_INUSE
);

351 
	`Muãx_Lock
(&
ˇche
->
lock
);

358 i‡(
rc
 == 0) {

359 
buf
->
Êags
 &~(
FS_BUFFER_INUSE
);

360 
	`C⁄d_Brﬂdˇ°
(&
ˇche
->
c⁄d
);

362 
	`Debug
("Rñó£d block %lu\n", 
buf
->
fsBlockNum
);

364 
	`Muãx_U∆ock
(&
ˇche
->
lock
);

366  
rc
;

367 
	}
}

	@cfs.c

13 
	~<limôs.h
>

14 
	~<˘y≥.h
>

15 
	~<gìkos/î∫o.h
>

16 
	~<gìkos/kas£π.h
>

17 
	~<gìkos/s¸ìn.h
>

18 
	~<gìkos/mÆloc.h
>

19 
	~<gìkos/°rög.h
>

20 
	~<gìkos/bô£t.h
>

21 
	~<gìkos/synch.h
>

22 
	~<gìkos/bufˇche.h
>

23 
	~<gìkos/li°.h
>

24 
	~<gìkos/cfs.h
>

25 
	~<gìkos/vfs.h
>

26 
	~<gìkos/°rög.h
>

27 
	~<gìkos/¥oje˘s.h
>

28 
	~<gìkos/mem.h
>

38 
	$CFS_F‹m©
(
Block_Devi˚
 *
blockDev
) {

39 
	`TODO_P
(
PROJECT_CFS
, "chameleon file system Format operation");

40  
EUNSUPPORTED
;

41 
	}
}

47 
	$CFS_Mou¡
(
Mou¡_Poöt
 *
mou¡Poöt
) {

48 
	`TODO_P
(
PROJECT_CFS
, "chameleon file system Mount operation");

49  
EUNSUPPORTED
;

50 
	}
}

55 
	$CFS_FSèt
(
Fûe
 *
fûe
, 
VFS_Fûe_Sèt
 *
°©
) {

56 
	`TODO_P
(
PROJECT_CFS
, "chameleon file system FStat operation");

57  
EUNSUPPORTED
;

58 
	}
}

66 
	$CFS_O≥n
(
Mou¡_Poöt
 *
mp
, c⁄° *
∑th
, 
mode
,

67 
Fûe
 **
pFûe
) {

68 
	`TODO_P
(
PROJECT_CFS
, "chameleon file system Open operation");

69  
EUNSUPPORTED
;

70 
	}
}

76 
	$CFS_Ród
(
Fûe
 *
fûe
, *
±r
, 
ul⁄g_t
 
numByãs
) {

77 
	`TODO_P
(
PROJECT_CFS
, "chameleon file system Read operation");

78  
EUNSUPPORTED
;

79 
	}
}

85 
	$CFS_Wrôe
(
Fûe
 *
fûe
, *
±r
, 
ul⁄g_t
 
numByãs
) {

86 
	`TODO_P
(
PROJECT_CFS
, "chameleon file system Write operation");

87  
EUNSUPPORTED
;

88 
	}
}

93 
	$CFS_Sèt
(
Mou¡_Poöt
 *
mou¡Poöt
, c⁄° *
∑th
,

94 
VFS_Fûe_Sèt
 *
°©
) {

95 
	`TODO_P
(
PROJECT_CFS
, "chameleon file system Stat operation");

96  
EUNSUPPORTED
;

97 
	}
}

103 
	$CFS_Sync
(
Mou¡_Poöt
 *
mou¡Poöt
) {

104 
	`TODO_P
(
PROJECT_CFS
, "chameleon file system Sync operation");

105  
EUNSUPPORTED
;

106 
	}
}

111 
	$CFS_Clo£
(
Fûe
 *
fûe
) {

112 
	`TODO_P
(
PROJECT_CFS
, "chameleon file system Close operation");

113  
EUNSUPPORTED
;

114 
	}
}

119 
	$CFS_Cª©e_Dúe˘‹y
(
Mou¡_Poöt
 *
mp
, c⁄° *
c⁄°_∑th
) {

120 
	`TODO_P
(
PROJECT_CFS
, "chameleon file system Create Directory operation");

121  
EUNSUPPORTED
;

122 
	}
}

127 
	$CFS_O≥n_Dúe˘‹y
(
Mou¡_Poöt
 *
mou¡Poöt
, c⁄° *
∑th
,

128 
Fûe
 **
pDú
) {

129 
	`TODO_P
(
PROJECT_CFS
, "chameleon file system Open Directory operation");

130  
EUNSUPPORTED
;

131 
	}
}

136 
	$CFS_Sìk
(
Fûe
 *
fûe
, 
ul⁄g_t
 
pos
) {

137 
	`TODO_P
(
PROJECT_CFS
, "chameleon file system Seek operation");

138  
EUNSUPPORTED
;

139 
	}
}

146 
	$CFS_Dñëe
(
Mou¡_Poöt
 *
mp
, c⁄° *
c⁄°_∑th
, 
boﬁ
 
ªcursive
) {

147 
	`TODO_P
(
PROJECT_CFS
, "chameleon file system Delete operation");

148  
EUNSUPPORTED
;

149 
	}
}

151 
	$CFS_Ríame
(
Mou¡_Poöt
 *
mp
, c⁄° *
ﬁd∑th
,

152 c⁄° *
√w∑th
) {

153 
	`TODO_P
(
PROJECT_USER
, "chameleon file system Rename operation");

154  
EUNSUPPORTED
;

155 
	}
}

157 
	$CFS_Lök
(
Mou¡_Poöt
 *
mp
, c⁄° *
ﬁd∑th
, c⁄° *
√w∑th
) {

158 
	`TODO_P
(
PROJECT_USER
, "chameleon file system Link operation");

159  
EUNSUPPORTED
;

160 
	}
}

162 
	$CFS_SymLök
(
Mou¡_Poöt
 *
mp
, c⁄° *
ﬁd∑th
,

163 c⁄° *
√w∑th
) {

164 
	`TODO_P
(
PROJECT_USER
, "chameleon file system SymLink operation");

165  
EUNSUPPORTED
;

166 
	}
}

168 
	$CFS_SëSëUid
(
Mou¡_Poöt
 *
mp
, c⁄° *
fûe
, 
£tuid
) {

169 
Fûe
 *
pFûe
;

171 
	`TODO_P
(
PROJECT_USER
, "chameleon file system SetSetUID operation");

172  
EUNSUPPORTED
;

173 
	}
}

175 
	$CFS_SëA˛
(
Mou¡_Poöt
 *
mp
, c⁄° *
fûe
, 
uid
,

176 
≥rmissi⁄s
) {

177 
	`TODO_P
(
PROJECT_USER
, "chameleon file system SetAcl operation");

178  
EUNSUPPORTED
;

179 
	}
}

184 
	$CFS_Ród_E¡ry
(
Fûe
 *
fûe
, 
VFS_Dú_E¡ry
 *
íåy
) {

185 
	`TODO_P
(
PROJECT_CFS
, "chameleon file system Read Directory operation");

186  
EUNSUPPORTED
;

187 
	}
}

189 
Fûesy°em_Ops
 
	gs_cfsFûesy°emOps
 = {

190 &
CFS_F‹m©
,

191 &
CFS_Mou¡
,

198 
	$Inô_CFS
() {

199 
	`Regi°î_Fûesy°em
("cfs", &
s_cfsFûesy°emOps
);

200 
	}
}

	@crc32.c

9 
	~<gìkos/¸c32.h
>

10 
	~<gìkos/kas£π.h
>

12 
	#POLYNOMIAL
 (
ul⁄g_t
)0xedb88320

	)

13 
ul⁄g_t
 
	g¸c_èbÀ
[256];

20 
	$Inô_CRC32
() {

21 
i
, 
j
;

22 
ul⁄g_t
 
h
 = 1;

23 
¸c_èbÀ
[0] = 0;

24 
i
 = 128; i; i >>= 1) {

25 
h
 = (h >> 1Ë^ ((h & 1Ë? 
POLYNOMIAL
 : 0);

27 
j
 = 0; j < 256; j +2 * 
i
)

28 
¸c_èbÀ
[
i
 + 
j
] = crc_èbÀ[j] ^ 
h
;

30 
	}
}

42 
ul⁄g_t
 
	$¸c32
(
ul⁄g_t
 
¸c
, c⁄° *
buf
, 
size_t
 
Àn
) {

43 
	`KASSERT
(
¸c_èbÀ
[255] != 0);

44 
¸c
 ^= 0xffffffff;

45 
Àn
--)

46 
¸c
 = (¸¯>> 8Ë^ 
¸c_èbÀ
[(¸¯^ *
buf
++) & 0xff];

47  
¸c
 ^ 0xffffffff;

48 
	}
}

	@cscope.out

1 
	gcsc›e
 15 
	g$HOME
/
	gDeskt›
/
	gos
/
	gœb_os
/
	gœb5
/
	gGìkOS
/
	g§c
/
	ggìkos
 0000008138

2 @
	gs¸ìn
.
	gc


5 ~<°
	gd
¨
	gg
.
	gh


9 ~<
	gg
ì
	gkos
/
	gkas
£π.
	gh


13 ~<
	gg
ì
	gkos
/
	gkty
≥
	gs
.
	gh


17 ~<
	gg
ì
	gkos
/
	gio
.
	gh


21 ~<
	gg
ì
	gkos
/ö
	gt
.
	gh


25 ~<
	gg
ì
	gkos
/
	gfmtout
.
	gh


29 ~<
	gg
ì
	gkos
/
	gs
¸ì
	gn
.
	gh


33 ~<
	gg
ì
	gkos
/
	glock
.
	gh


45 `
	gATTRIB


47 
	gBLACK


49 
	gGRAY


55 
	geS
èã

59 
	gmS_NORMAL


63 
	gmS_ESC


67 
	gmS_ESC2


71 
	gmS_ARG


75 
	gmS_CMD


85 
	gsC
⁄
	gs
ﬁ
	ge_S
èã

89 
	gmrow


91 
	gmc
ﬁ

95 
	gm
ß
	gveRow


97 
	gm
ß
	gveC
ﬁ

101 
	guch
¨
_t


103 
	gmcu
ºí
	gtA
â
	gr


107 
	gS
èã

109 
	gm
°©
	ge


113 
	gm
¨
	ggLi
°

115 
MAXARGS


119 
	gmnumArgs


123 
	gC
⁄
	gs
ﬁ
	ge_S
èã

125 
	ggs_c
⁄
	gs


131 
NUMROWS


133 
	gNUMCOLS


141 
	gNUMROWS


143 
	gNUMCOLS


151 
	gNUMCOLS


159 
	gs_c
⁄
	gs


161 
	gcu
ºí
	gtA
â
	gr


162 <<24Ë| (
	gs_c
⁄
	gs
.
	gcu
ºí
	gtA
â
	gr
<<8))

167 
	g$S
¸ﬁ
	gl


171 
	gu
ö
t_t


173 
	gv


177 
	gi


179 
	gn


181 
NUM_SCROLL_DWORDS


185 
	gu
ö
t_t


187 
	gf
û
	gl


189 
FILL_DWORD


193 
	gv


195 
u
ö
t_t


197 
VIDMEM


199 
	gi


200 0; 
	gi
 <

201 
	gn


202 ; ++
	gi
) {

205 
	gv


206 *(
v
 +

207 
NUM_DWORDS_PER_LINE


211 
	gv


215 
	gv


217 
u
ö
t_t


219 
VIDMEM


221 
n


223 
	gi


224 0; 
	gi
 <

225 
	gNUM_DWORDS_PER_LINE


226 ; ++
	gi
)

229 
	gv


231 
f
û
l


239 
	g$C
À¨
	g_To_EOL


243 
	gn


245 
NUMCOLS


247 
s_c
⁄
s


249 
c
ﬁ

253 
	guch
¨
_t


255 
	gv


257 
VIDMEM


259 
s_c
⁄
s


261 
row


263 
NUMCOLS


264 * 2Ë+ 
s_c
⁄
s
.

265 
c
ﬁ

269 
	gn


273 
	gv


277 
	gv


279 
s_c
⁄
s


281 
cu
ºí
tA
â
r


289 
	g$Newl
ö
	ge


293 
	gs_c
⁄
	gs


295 
	grow


299 
	gs_c
⁄
	gs


301 
	gc
ﬁ

304 101 
	gi
‡(

305 
	gs_c
⁄
	gs


307 
	grow


309 
NUMROWS


313 `
S
¸ﬁ
l


317 
	gs_c
⁄
	gs


319 
	grow


321 
NUMROWS


329 
	g$Put_G
ø
	gphic_Ch
¨

331 
	gc


335 
	guch
¨
_t


337 
	gv


339 
VIDMEM


341 
s_c
⁄
s


343 
row


345 
NUMCOLS


346 * 2Ë+ 
s_c
⁄
s
.

347 
c
ﬁ

351 
	gv


353 
uch
¨
_t


355 
c


359 
	gv


361 
s_c
⁄
s


363 
cu
ºí
tA
â
r


366 119 
	gi
‡(

367 
	gs_c
⁄
	gs


369 
	gc
ﬁ

371 
	gNUMCOLS


375 
	gs_c
⁄
	gs


377 
	gc
ﬁ

381 `
	gNewl
ö
	ge


389 
	g$Ou
ç
	gut_L
ôîÆ
	g_Ch
¨
	ga
˘î

391 
	gc


395 
	gnumS
∑˚
	gs


399 
	gc


403 `
	gC
À¨
	g_To_EOL


407 `
	gNewl
ö
	ge


411 
	gnumS
∑˚
	gs


413 
TABWIDTH


415 
s_c
⁄
s


417 
c
ﬁ

418 % 
TABWIDTH
);

421 
	gnumS
∑˚
	gs


425 `
	gPut_G
ø
	gphic_Ch
¨

429 `
	gPut_G
ø
	gphic_Ch
¨

431 
	gc


434 150 #i‚
	gde
‡

435 
	gNDEBUG


439 `
	gOut_By
ã

441 
	gc


449 
	g$Move_Curs
‹

451 
	grow


453 
	gc
ﬁ

456 165 
	gi
‡(

457 
	grow


461 
	grow


464 167 
	gi
‡(

465 
	grow


467 
	gNUMROWS


471 
	grow


473 
NUMROWS


476 170 
	gi
‡(

477 
	gc
ﬁ

481 
	gc
ﬁ

484 172 
	gi
‡(

485 
	gc
ﬁ

487 
	gNUMCOLS


491 
	gc
ﬁ

493 
NUMCOLS


497 
	gs_c
⁄
	gs


499 
	grow


500 =Ñ
ow
;

503 
	gs_c
⁄
	gs


505 
	gc
ﬁ

506 
cﬁ
;

512 182 ⁄°

513 
	guch
¨
_t


515 
	ggs_
™
	gsiToVgaC
ﬁ‹

519 
BLACK


521 
RED


523 
GREEN


525 
AMBER


527 
BLUE


529 
MAGENTA


531 
CYAN


533 
GRAY


537 
$Upd
©
e_A
â
ribu
ã
s


541 
i


547 
s_c
⁄
s


549 
cu
ºí
tA
â
r


551 
BRIGHT


555 
	gi


556 0; 
	gi
 <

557 
	gs_c
⁄
	gs


559 
	gnumArgs


560 ; ++
	gi
) {

563 
	gv
Æ
	gue


565 
s_c
⁄
s


567 ¨
gLi
°

569 
i


572 196 
	gi
‡(

573 
	gv
Æ
	gue


579 
DEFAULT_ATTRIBUTE


582 198 
	gi
‡(

583 
	gv
Æ
	gue


589 
BRIGHT


592 200 
	gi
‡(

593 
	gv
Æ
	gue


594 >30 && 
vÆue
 <= 37)

599 
s_
™
siToVgaC
ﬁ‹

601 
v
Æ
ue


604 202 
	gi
‡(

605 
	gv
Æ
	gue


606 >40 && 
vÆue
 <= 47)

611 
s_
™
siToVgaC
ﬁ‹

613 
v
Æ
ue


617 
	gs_c
⁄
	gs


619 
	gcu
ºí
	gtA
â
	gr


629 
	g$Re
£
	gt


633 
	gs_c
⁄
	gs


635 °©
	ge


637 
S_NORMAL


641 
	gs_c
⁄
	gs


643 
	gnumArgs


651 
	g$S
èπ
	g_Es
ˇ≥

655 
	gs_c
⁄
	gs


657 °©
	ge


659 
S_ESC


663 
	gs_c
⁄
	gs


665 
	gnumArgs


673 
	g$S
èπ
	g_Arg


675 ¨
	ggNum


679 `
	gKASSERT


681 
	gs_c
⁄
	gs


683 
	gnumArgs


685 ¨
gNum


689 
	gs_c
⁄
	gs


691 
	gnumArgs


695 
	gs_c
⁄
	gs


697 °©
	ge


699 
S_ARG


702 225 
	gi
‡(

703 ¨
	ggNum


705 
	gMAXARGS


709 
	gs_c
⁄
	gs


711 ¨
	ggLi
°

713 ¨
gNum


721 
	g$Save_Curs
‹

725 
	gs_c
⁄
	gs


727 ß
	gveRow


728 
s_c
⁄
s
.

729 
row


733 
	gs_c
⁄
	gs


735 ß
	gveC
ﬁ

736 
s_c
⁄
s
.

737 
c
ﬁ

745 
	g$Re
°‹
	ge_Curs
‹

749 
	gs_c
⁄
	gs


751 
	grow


752 
s_c
⁄
s
.

753 ß
veRow


757 
	gs_c
⁄
	gs


759 
	gc
ﬁ

760 
s_c
⁄
s
.

761 ß
veC
ﬁ

769 
	g$Add_Dig
ô

771 
	gc


775 `
	gKASSERT


777 `
	gISDIGIT


779 
	gc


782 244 
	gi
‡(

783 
	gs_c
⁄
	gs


785 
	gnumArgs


787 
	gMAXARGS


791 ¨
	ggNum


793 
s_c
⁄
s


795 
numArgs


799 
	gs_c
⁄
	gs


801 ¨
	ggLi
°

803 ¨
gNum


807 
	gs_c
⁄
	gs


809 ¨
	ggLi
°

811 ¨
gNum


813 
	gc


821 
	g$G
ë
	g_Arg


823 ¨
	ggNum


827 ¨
	ggNum


829 
	gs_c
⁄
	gs


831 
	gnumArgs


832 ? 
	gs_c
⁄
	gs
.

833 ¨
	ggLi
°

834 [
¨gNum
] : 0;

841 
	g$Put_Ch
¨
	g_Imp


843 
	gc


847 
	gaga
ö

851 
s_c
⁄
s


853 °©
e


857 
S_NORMAL


860 269 
i
‡(

861 
c


863 
ESC


867 `
S
èπ
_Es
ˇ≥

871 `
	gOu
ç
	gut_L
ôîÆ
	g_Ch
¨
	ga
˘î

873 
	gc


877 
	gS_ESC


880 276 
i
‡(

881 
c


885 
s_c
⁄
s


887 °©
e


889 
S_ESC2


893 `
	gRe
£
	gt


897 
	gS_ESC2


900 283 
i
‡(

901 `
ISDIGIT


903 
c


907 `
S
èπ
_Arg


911 
	gaga
ö

914 286 } 
	gi
‡(

915 
	gc


919 `
S
èπ
_Arg


923 `
	gAdd_Dig
ô

927 `
	gS
èπ
	g_Arg


931 
	gs_c
⁄
	gs


933 °©
	ge


935 
S_CMD


939 
	gaga
ö

943 
	gS_ARG


946 298 
i
‡(

947 `
ISDIGIT


949 
c


953 `
Add_Dig
ô

955 
c


958 300 
	gi
‡(

959 
	gc


963 `
S
èπ
_Arg


965 
s_c
⁄
s


967 
numArgs


971 
	gs_c
⁄
	gs


973 °©
	ge


975 
S_CMD


979 
	gaga
ö

983 
	gS_CMD


987 
c


991 `
C
À¨
_To_EOL


995 `
	gSave_Curs
‹

999 `
	gRe
°‹
	ge_Curs
‹

1003 `
	gMove_Curs
‹

1005 
	gs_c
⁄
	gs


1007 
	grow


1009 `
	gG
ë
	g_Arg


1010 (0), 
	gs_c
⁄
	gs
.

1011 
	gc
ﬁ

1015 `
	gMove_Curs
‹

1017 
	gs_c
⁄
	gs


1019 
	grow


1021 `
	gG
ë
	g_Arg


1022 (0), 
	gs_c
⁄
	gs
.

1023 
	gc
ﬁ

1027 `
	gMove_Curs
‹

1029 
	gs_c
⁄
	gs


1031 
	grow


1032 , 
	gs_c
⁄
	gs
.

1033 
	gc
ﬁ

1035 `
	gG
ë
	g_Arg


1039 `
	gMove_Curs
‹

1041 
	gs_c
⁄
	gs


1043 
	grow


1044 , 
	gs_c
⁄
	gs
.

1045 
	gc
ﬁ

1047 `
	gG
ë
	g_Arg


1051 `
	gUpd
©
	ge_A
â
	gribu
ã
	gs


1054 336 
	gi
‡(

1055 
	gs_c
⁄
	gs


1057 
	gnumArgs


1061 `
Move_Curs
‹

1063 `
G
ë
_Arg


1064 (0Ë- 1, 
Gë_Arg
(1) - 1);

1066 340 
	gi
‡(

1067 
	gs_c
⁄
	gs


1069 
	gnumArgs


1071 `
G
ë
_Arg


1075 `
C
À¨
_S
¸ì
n


1079 `
	gPut_Curs
‹

1083 `
	gRe
£
	gt


1087 `
	gKASSERT


1089 Á
	gl
£

1097 
	g$Upd
©
	ge_Curs
‹

1101 
	gu
ö
t_t


1103 
	gch
¨
	ga
˘î
	gPos


1105 
s_c
⁄
s


1107 
row


1109 
NUMCOLS


1110 Ë+ 
s_c
⁄
s
.

1111 
c
ﬁ

1115 
	guch
¨
	g_t


1117 ‹
	gigAddr


1121 ‹
	gigAddr


1123 `
In_By
ã

1125 
CRT_ADDR_REG


1129 `
	gIO_D
ñ
	gay


1133 `
	gOut_By
ã

1135 
	gCRT_ADDR_REG


1137 
	gCRT_CURSOR_LOC_HIGH_REG


1141 `
	gIO_D
ñ
	gay


1145 `
	gOut_By
ã

1147 
	gCRT_DATA_REG


1149 
	gch
¨
	ga
˘î
	gPos


1153 `
	gIO_D
ñ
	gay


1157 `
	gOut_By
ã

1159 
	gCRT_ADDR_REG


1161 
	gCRT_CURSOR_LOC_LOW_REG


1165 `
	gIO_D
ñ
	gay


1169 `
	gOut_By
ã

1171 
	gCRT_DATA_REG


1173 
	gch
¨
	ga
˘î
	gPos


1177 `
	gIO_D
ñ
	gay


1181 `
	gOut_By
ã

1183 
	gCRT_ADDR_REG


1185 ‹
	gigAddr


1193 
	g$In
ô
	g_S
¸ì
	gn


1197 
	gbo
ﬁ

1199 
	gi
Ê
	gag


1201 `
Beg
ö
_I
¡
_Atomic


1205 
	gs_c
⁄
	gs


1207 
	grow


1208 
s_c
⁄
s
.

1209 
c
ﬁ

1213 
	gs_c
⁄
	gs


1215 
	gcu
ºí
	gtA
â
	gr


1217 
DEFAULT_ATTRIBUTE


1221 `
	gC
À¨
	g_S
¸ì
	gn


1225 `
	gEnd_I
¡
	g_Atomic


1227 
	gi
Ê
	gag


1235 
	g$C
À¨
	g_S
¸ì
	gn


1239 
	gu
ö
t_t


1241 
	gv


1242 (
u
ö
t_
à*Ë

1243 
VIDMEM


1247 
	gi


1251 
	gu
ö
t_t


1253 
	gf
û
	gl


1255 
FILL_DWORD


1259 
	gbo
ﬁ

1261 
	gi
Ê
	gag


1263 `
Beg
ö
_I
¡
_Atomic


1267 
	gi


1268 0; 
	gi
 <

1269 
	gNUM_SCREEN_DWORDS


1270 ; ++
	gi
)

1273 
	gv


1275 
f
û
l


1279 `
	gEnd_I
¡
	g_Atomic


1281 
	gi
Ê
	gag


1289 
	g$G
ë
	g_Curs
‹

1291 
	grow


1293 
	gc
ﬁ

1297 
	gbo
ﬁ

1299 
	gi
Ê
	gag


1301 `
Beg
ö
_I
¡
_Atomic


1305 
	grow


1307 
s_c
⁄
s


1308 .
row
;

1311 
	gc
ﬁ

1313 
s_c
⁄
s


1314 .
cﬁ
;

1317 `
	gEnd_I
¡
	g_Atomic


1319 
	gi
Ê
	gag


1327 
	gbo
ﬁ

1329 
	g$Put_Curs
‹

1331 
	grow


1333 
	gc
ﬁ

1337 
	gbo
ﬁ

1339 
	gi
Ê
	gag


1342 442 
	gi
‡(

1343 
	grow


1344 < 0 ||Ñ
	gow
 >

1345 
	gNUMROWS


1347 
	gc
ﬁ

1348 < 0 || 
	gc
ﬁ >

1349 
	gNUMCOLS


1353 Á
	gl
£

1357 
	gi
Ê
	gag


1359 `
Beg
ö
_I
¡
_Atomic


1363 
	gs_c
⁄
	gs


1365 
	grow


1366 =Ñ
ow
;

1369 
	gs_c
⁄
	gs


1371 
	gc
ﬁ

1372 
cﬁ
;

1375 `
	gUpd
©
	ge_Curs
‹

1379 `
	gEnd_I
¡
	g_Atomic


1381 
	gi
Ê
	gag


1385 å
	gue


1393 
	guch
¨
_t


1395 
	g$G
ë
	g_Cu
ºí
	gt_A
â
	gr


1399 
	gs_c
⁄
	gs


1401 
	gcu
ºí
	gtA
â
	gr


1409 
	g$S
ë
	g_Cu
ºí
	gt_A
â
	gr


1411 
	guch
¨
	g_t


1413 ©å
	gib


1417 
	gbo
ﬁ

1419 
	gi
Ê
	gag


1421 `
Beg
ö
_I
¡
_Atomic


1425 
	gs_c
⁄
	gs


1427 
	gcu
ºí
	gtA
â
	gr


1429 ©å
ib


1433 `
	gEnd_I
¡
	g_Atomic


1435 
	gi
Ê
	gag


1443 
	g$Put_Ch
¨

1445 
	gc


1449 
	gbo
ﬁ

1451 
	gi
Ê
	gag


1453 `
Beg
ö
_I
¡
_Atomic


1457 `
	gPut_Ch
¨
	g_Imp


1459 
	gc


1463 `
	gUpd
©
	ge_Curs
‹

1467 `
	gEnd_I
¡
	g_Atomic


1469 
	gi
Ê
	gag


1477 
	g$Put_S
åö
	gg


1478 (
	gc
⁄° *

1479 
	gs


1483 
	gbo
ﬁ

1485 
	gi
Ê
	gag


1487 `
Beg
ö
_I
¡
_Atomic


1491 
	gs


1495 `
Put_Ch
¨
_Imp


1497 
s


1501 `
	gUpd
©
	ge_Curs
‹

1505 `
	gEnd_I
¡
	g_Atomic


1507 
	gi
Ê
	gag


1515 
	g$Put_Buf


1516 (
	gc
⁄° *

1517 
	gbuf


1519 
	gul
⁄
	gg_t


1521 À
	gngth


1525 
	gbo
ﬁ

1527 
	gi
Ê
	gag


1529 `
Beg
ö
_I
¡
_Atomic


1533 À
	gngth


1537 `
	gPut_Ch
¨
	g_Imp


1539 
	gbuf


1543 À
	gngth


1547 `
	gUpd
©
	ge_Curs
‹

1551 `
	gEnd_I
¡
	g_Atomic


1553 
	gi
Ê
	gag


1561 
	gPr
ö
	gt_Em
ô

1563 
	gOu
ç
	gut_S
ö
k


1565 
o


1567 
	g__
©å
	gibu
ã__

1569 
	gunu
£
	gd


1571 
	gch


1575 
	gPut_Ch
¨
	g_Imp


1577 
	gch


1581 
	gPr
ö
	gt_F
ö
	gish


1583 
	gOu
ç
	gut_S
ö
k


1585 
o


1587 
	g__
©å
	gibu
ã__

1589 
	gunu
£
	gd


1593 
	gUpd
©
	ge_Curs
‹

1597 
	gOu
ç
	gut_S
ö
k


1599 
	ggs_ou
ç
	gutS
ö
	gk


1601 
Pr
ö
t_Em
ô

1603 
Pr
ö
t_F
ö
ish


1607 
	gSp
ö
_Lock_t


1609 
	gg
¥ö
	gtLock


1613 
	g$Pr
ö
	gt


1614 (
	gc
⁄° *

1615 
	gfmt


1619 
	gva_li
°

1621 ¨
	ggs


1625 `
	gva_
°¨
	gt


1627 ¨
	ggs


1629 
	gfmt


1633 `
	gF
‹
	gm
©
	g_Ou
ç
	gut


1635 
	gs_ou
ç
	gutS
ö
	gk


1637 
	gfmt


1639 ¨
	ggs


1643 `
	gva_
í
	gd


1645 ¨
	ggs


1656 /
	gu§
/
	gö˛ude


1659 
	gs¸ìn
.
	gc


	@defs.asm

1 ; 
Deföôi⁄s
 
u£
 
ö
 
GìkOS
 
boŸ
 
	gcode


2 ; 
C›yright
 (
c
Ë2001, 
David
 
	gH
. 
	gHovemeyî
 <
	gdaveho
@
	gcs
.
	gumd
.
	gedu
>

3 ; 
	g$Revisi⁄
: 1.7 
$


5 ; 
This
 
is
 
‰ì
 
	gso·w¨e
. 
You
 
¨e
 
≥rmôãd
 
to
 
	gu£
,

6 ; 
	gªdi°ribuã
, 
™d
 
modify
 
ô
 
as
 
•ecifõd
 
ö
 
the
 
	gfûe
 "COPYING".

8 ; 
A
 
lŸ
 
of
 
this
 
code
 
is
 
ad≠ãd
 
‰om
 
Kî√l
 
	gToﬁkô
 0.2

9 ; 
™d
 
Löux
 
	gvîsi⁄
 2.2.x, 
so
 
the
 
fﬁlowög
 
c›yrights
 
	g≠∂y
:

11 ; 
C›yright
 (
C
Ë1991, 1992 
Löus
 
	gT‹vÆds


12 ; 
modifõd
 
by
 
Dªw
 
	gEckh¨dt


13 ; 
modifõd
 
by
 
Bru˚
 
Ev™s
 (
bde
)

14 ; 
ad≠ãd
 
Kî√l
 
Toﬁkô
 
by
 
Luigi
 
	gSgro


16 %
i‚def
 
	gDEFS_ASM


17 %
deföe
 
	gDEFS_ASM


19 ; 
BIOS
 
lﬂds
 
the
 
boŸ
 
£˘‹
 
©
 
	goff£t
 0 
ö
 
this
 
£gmít


20 
BOOTSEG
 
	gequ
 0x07C0

22 ; 
	gWe
'll moveÅhe boot sector upÅo higher memory.

23 ; 
NŸe
 
th©
 
	gthe
 "ISA hﬁe" 
begös
 
©
 
	g£gmít
 0xA000 =640
K
.

24 
INITSEG
 
equ
 0x9000

26 ; 
Put
 
the
 
£tup
 
code
 
	ghîe
, 
ju°
 
a·î
Åhê
boŸ
 
	g£˘‹
.

27 
SETUPSEG
 
	gequ
 0x9020

29 
MEMMAPSEG
 
	gequ
 0x9040

31 ; 
Lﬂd
 
	gour
 "Kî√l" 
©
 
this
 
	g£gmít
, 
which
 
°¨ts
 
	g©
 64
	gK
.

32 ; 
The
 
numbî
 
of
 
£˘‹s
 
ö
 
the
 
	gkî√l
, 
	gNUM_KERN_SECTORS
,

33 ; 
wûl
 
be
 
∑s£d
 
⁄
 
the
 
comm™d
 
	glöe
.

34 
KERNSEG
 
	gequ
 0x1000

36 ; 
Size
 
of
 
PFAT
 
boŸ
 
	gªc‹d
.

37 ; 
Kìp
 
up
 
to
 
d©e
 
	gwôh
 <
	ggìkos
/
	gpÁt
.
	gh
>.

38 
PFAT_BOOT_RECORD_SIZE
 
	gequ
 28

40 ; 
Off£t
 
of
 
BIOS
 
sig«tuª
 
w‹d
 
ö
 
boŸ
 
	g£˘‹
.

41 
BIOS_SIGNATURE_OFFSET
 
	gequ
 510

43 ; 
Off£t
 
of
 
PFAT
 
boŸ
 
ªc‹d
 
ö
 boŸ 
	g£˘‹
.

44 
PFAT_BOOT_RECORD_OFFSET
 
equ
 
	gBIOS_SIGNATURE_OFFSET
 - 
	gPFAT_BOOT_RECORD_SIZE


46 ; 
Video
 
mem‹y
 
£gmít


47 
VIDSEG
 
	gequ
 0xb800

49 ; 
The
 
fﬁlowög
 
öf‹m©i⁄
 
is
 
c‹ª˘
 
	ga
 1.44
M
 
	gÊ›py
.

50 ; 
	gYes
, 
	gI
'm hard codingÅhis.

51 
SECTORS_PER_TRACK
 
	gequ
 18

52 
HEADS
 
	gequ
 2

53 
CYLINDERS
 
	gequ
 80

55 ; 8259A 
PIC
 
öôüliz©i⁄
 
	gcodes
.

56 ; 
	gSour˚
: 
Löux
 
boŸ£˘
.
S
, 
™d
 
	gI¡ñ
 8259A 
	gd©ashìt


58 ; 
The
 
mo°
 
imp‹è¡
 
ªas⁄
 
why
 
we
 
ª¥ogøm
 
the
 
PICs
 
is
 
	gto


59 ; 
rouã
 
the
 
h¨dw¨e
 
öãºu±s
 
through
 
ve˘‹s
 *
	gabove
*

60 ; 
tho£
 
ª£rved
 
by
 
	gI¡ñ
. 
The
 
BIOS
 (
hi°‹iˇl
 
ªas⁄s
 :-)

61 ; 
rouãs
 
them
 
such
 
th©
 
they
 
c⁄Êi˘
 
wôh
 
öã∫Æ
 
	g¥o˚ss‹
-
	ggíî©ed


62 ; 
	göãºu±s
.

64 
ICW1
 
	gequ
 0x11 ; 
	gICW1
 - 
ICW4
 
	g√eded
, 
ˇsˇde
 
	gmode
, 
	göãrvÆ
=8,

65 ; 
edge
 
	gåiggîed
. (
I
 
thök
 
öãrvÆ
 
is
 
	gúªÀv™t


66 ; 
	gx86
.)

67 
ICW2_MASTER
 
	gequ
 0x20 ; 
put
 
	gIRQs
 0-7 
	g©
 0x20 (
above
 
I¡ñ
 
ª£rved
 
	göts
)

68 
ICW2_SLAVE
 
	gequ
 0x28 ; 
put
 
	gIRQs
 8-15 
	g©
 0x28

69 
ICW3_MASTER
 
	gequ
 0x04 ; 
IR2
 
c⁄√˘ed
 
to
 
¶ave


70 
ICW3_SLAVE
 
	gequ
 0x02 ; 
¶ave
 
has
 
	gid
 2

71 
ICW4
 
	gequ
 0x01 ; 8086 
	gmode
, 
no
áuto-
	gEOI
, 
	gn⁄
-
buf„ªd
 mode,

72 ; 
nŸ
 
•ecül
 
fuŒy
 
√°ed
 
	gmode


74 ; 
Kî√l
 
code
 
™d
 
d©a
 
£gmít
 
	g£À˘‹s
.

75 ; 
Kìp
 
the£
 
up
 
to
 
d©e
 
wôh
 
	gdefs
.
	gh
.

76 
KERNEL_CS
 
	gequ
 1<<3 ; 
kî√l
 
code
 
£gmít
 
is
 
GDT
 
	gíåy
 1

77 
KERNEL_DS
 
	gequ
 2<<3 ; 
kî√l
 
d©a
 
£gmít
 
is
 
GDT
 
	gíåy
 2

79 ; 
Pages
 
c⁄ãxt
 
obje˘
 
™d
 
°ack
 
öôül
 
kî√l
 
	gthªad
 -

80 ; 
the
 
⁄e
 
we
 
c⁄°ru˘
 
Maö
(). 
Kìp
 
the£
 
up
 
to
 
d©e
 
wôh
 
	gdefs
.
	gh
.

81 ; 
We
 
put
 
them
 
	g©
 1
	gMB
, 
no
 
∑πicuœr
 
	gªas⁄
.

82 
KERN_THREAD_OBJ
 
	$equ
 (1024*1024)

83 
KERN_STACK
 
equ
 
KERN_THREAD_OBJ
 + 4096

85 
APIC_EOI
 
equ
 0xB0

86 %
ídif


	@dma.c

35 
	~<gìkos/s¸ìn.h
>

36 
	~<gìkos/ønge.h
>

37 
	~<gìkos/öt.h
>

38 
	~<gìkos/io.h
>

39 
	~<gìkos/dma.h
>

54 
	$VALID_CHANNEL
(
ch™
) (((chan) >= 0) && ((chan) < 8))

60 
	#DMA_MAX_ADDR
 0x1000000UL

	)

61 
	#VALID_MEM
(
°¨t
,
size
Ë
	`Check_R™ge_Undî
((
ul⁄g_t
)(°¨t),(size),
DMA_MAX_ADDR
)

	)

66 
	#DMA_BASE
 0x00

	)

67 
	#DMA_COMMAND_REG
 0x08

	)

68 
	#DMA_STATUS_REG
 0x08

	)

69 
	#DMA_REQUEST_REG
 0x09

	)

70 
	#DMA_MASK_ONE_REG
(
ch™
Ë(ch™<4 ? 0x0A : 0xD4Ë

	)

71 
	#DMA_MODE_REG
(
ch™
Ë(ch™<4 ? 0x0B : 0xD6Ë

	)

72 
	#DMA_CLEAR_FF_REG
(
ch™
Ë(ch™<4 ? 0x0C : 0xD8Ë

	)

73 
	#DMA_MASTER_CLEAR_REG
 0x0D

	)

74 
	#DMA_TEMP_REG
 0x0D

	)

75 
	#DMA_CLEAR_MASK_REG
 0x0E

	)

76 
	#DMA_MASK_ALL_REG
 0x0F

	)

84 
	#DMA_ADDR_REG
(
ch™
Ë(ch™<4 ? (((ch™Ë& 0x3)<<1Ë: (0xC0 | ((ch™Ë& 0x3Ë<<2Ë)

	)

87 
	#DMA_COUNT_REG
(
ch™
Ë(
	`DMA_ADDR_REG
(ch™Ë+ (ch™<4 ? 1 : 2))

	)

92 
	#DMA_MASK_ENABLE
 (1<<2Ë

	)

97 
	#DMA_MODE_SINGLE
 0x40

	)

98 
	#DMA_MODE_CASCADE
 0xC0

	)

99 
	#DMA_MODE_READ
 0x04

	)

100 
	#DMA_MODE_WRITE
 0x08

	)

105 c⁄° 
uch¨_t
 
s_dmaPageRegi°îLi°
[] = {

114 
	}
};

116 
	#DMA_PAGE_REG
(
ch™
Ë(
s_dmaPageRegi°îLi°
[ch™]Ë

	)

118 
	#IS_RESERVED
(
ch™
Ë((
s_Æloˇãd
 & (1 << (ch™))Ë!0)

	)

121 #ifde‡
DEBUG_DMA


122 
	#Debug
(
¨gs
...Ë
	`Pröt
◊rgs)

	)

124 
	#Debug
(
¨gs
...)

	)

131 
uch¨_t
 
	gs_Æloˇãd
;

140 
	$Inô_DMA
() {

141 
	`Pröt
("Initializing DMA Controller...\n");

144 
	`Out_Byã
(
DMA_MASTER_CLEAR_REG
, 0);

145 
	}
}

152 
boﬁ
 
	$Re£rve_DMA
(
ch™
) {

153 
boﬁ
 
iÊag
 = 
	`Begö_I¡_Atomic
();

154 
boﬁ
 
ªsu…
 = 
Ál£
;

156 
	`KASSERT
(
	`VALID_CHANNEL
(
ch™
));

158 i‡(!
	`IS_RESERVED
(
ch™
)) {

160 
	`Out_Byã
(
	`DMA_MASK_ONE_REG
(
ch™
), chan & 3);

163 
s_Æloˇãd
 |(1 << 
ch™
);

164 
ªsu…
 = 
åue
;

167 
	`End_I¡_Atomic
(
iÊag
);

169  
ªsu…
;

170 
	}
}

179 
	$Sëup_DMA
(
DMA_Dúe˘i⁄
 
dúe˘i⁄
, 
ch™
, *
addr_
,

180 
ul⁄g_t
 
size
) {

181 
uch¨_t
 
mode
 = 0;

182 
ul⁄g_t
 
addr
 = (ul⁄g_tË
addr_
;

185 
	`KASSERT
(
dúe˘i⁄
 =
DMA_READ
 || dúe˘i⁄ =
DMA_WRITE
);

186 
	`KASSERT
(
	`VALID_CHANNEL
(
ch™
));

187 
	`KASSERT
(
	`IS_RESERVED
(
ch™
));

188 
	`KASSERT
(
	`VALID_MEM
(
addr
, 
size
));

189 
	`KASSERT
(
size
 > 0);

191 
	`KASSERT0
((((
addr
 & 0xffffË=0 && 
size
 <= 65536)) ||

192 (
size
 <(0xfff‡- (
addr
 & 0xffff))),

196 
mode
 |
DMA_MODE_SINGLE
;

197 
mode
 |(
dúe˘i⁄
 =
DMA_READ
Ë? 
DMA_MODE_READ
 : 
DMA_MODE_WRITE
;

198 
mode
 |(
ch™
 & 3);

199 i‡(
ch™
 == 5)

200 
mode
 |= 0x10;

202 
	`Debug
("Setup_DMA(%s,%d,%x,%d)\n",

203 
dúe˘i⁄
 =
DMA_READ
 ? "DMA_READ" : "DMA_WRITE", 
ch™
, 
addr
, 
size
);

204 
	`Debug
("Sëup_DMA: mode=%02x\n", 
mode
);

205 
	`Debug
("DMA_ADDR_REG f‹ ch™√»i†%02x\n", 
	`DMA_ADDR_REG
(
ch™
));

206 
	`Debug
("DMA_PAGE_REG f‹ ch™√»i†%02x\n", 
	`DMA_PAGE_REG
(
ch™
));

207 
	`Debug
("DMA_COUNT_REG f‹ ch™√»i†%02x\n", 
	`DMA_COUNT_REG
(
ch™
));

210 
	`Mask_DMA
(
ch™
);

213 
	`Out_Byã
(
	`DMA_MODE_REG
(
ch™
), 
mode
);

216 
	`Out_Byã
(
	`DMA_CLEAR_FF_REG
(
ch™
), 0);

219 
	`Out_Byã
(
	`DMA_ADDR_REG
(
ch™
), 
addr
 & 0xFF);

220 
	`Out_Byã
(
	`DMA_ADDR_REG
(
ch™
), (
addr
 >> 8) & 0xFF);

223 
	`Out_Byã
(
	`DMA_PAGE_REG
(
ch™
), (
addr
 >> 16) & 0xFF);

229 i‡(
ch™
 > 4) {

230 
size
 >>= 1;

232 --
size
;

233 
	`Out_Byã
(
	`DMA_COUNT_REG
(
ch™
), 
size
 & 0xFF);

234 
	`Out_Byã
(
	`DMA_COUNT_REG
(
ch™
), (
size
 >> 8) & 0xFF);

237 
	`Unmask_DMA
(
ch™
);

238 
	}
}

245 
	$Mask_DMA
(
ch™
) {

246 
	`KASSERT
(
	`VALID_CHANNEL
(
ch™
));

247 
	`KASSERT
(
	`IS_RESERVED
(
ch™
));

249 
	`Out_Byã
(
	`DMA_MASK_ONE_REG
(
ch™
), (1 << 2) | (chan & 3));

250 
	}
}

257 
	$Unmask_DMA
(
ch™
) {

258 
	`KASSERT
(
	`VALID_CHANNEL
(
ch™
));

259 
	`KASSERT
(
	`IS_RESERVED
(
ch™
));

261 
	`Out_Byã
(
	`DMA_MASK_ONE_REG
(
ch™
), chan & 3);

262 
	}
}

	@elf.c

18 
	~<gìkos/î∫o.h
>

19 
	~<gìkos/kas£π.h
>

20 
	~<gìkos/kty≥s.h
>

21 
	~<gìkos/s¸ìn.h
>

22 
	~<gìkos/pÁt.h
>

23 
	~<gìkos/mÆloc.h
>

24 
	~<gìkos/°rög.h
>

25 
	~<gìkos/u£r.h
>

26 
	~<gìkos/fûeio.h
>

27 
	~<gìkos/ñf.h
>

29 
	~<gìkos/∑gög.h
>

31 
	gñfDebug
 = 0;

42 
	$P¨£_ELF_ExecuèbÀ
(*
exeFûeD©a
, 
ul⁄g_t
 
exeFûeLígth
,

43 
Exe_F‹m©
 *
exeF‹m©
) {

44 
ñfHódî
 *
hdr
;

45 
¥ogømHódî
 *
phdr
;

46 
i
;

48 
hdr
 = (
ñfHódî
 *Ë
exeFûeD©a
;

56 i‡(
exeFûeLígth
 < (
ñfHódî
) ||

57 
	`°∫cmp
(
exeFûeD©a
, "\x7F" "ELF", 4) != 0) {

58 i‡(
ñfDebug
)

59 
	`Pröt
("Notán ELFÉxecutable\n");

60  
ENOEXEC
;

63 i‡(
hdr
->
phnum
 > 
EXE_MAX_SEGMENTS
) {

64 i‡(
ñfDebug
)

65 
	`Pröt
("Toÿm™y segmít†(%dËö ELFÉxecuèbÀ\n", 
hdr
->
phnum
);

66  
ENOEXEC
;

69 i‡(
exeFûeLígth
 < 
hdr
->
phoff
 + (hdr->
phnum
 * (
¥ogømHódî
))) {

70 i‡(
ñfDebug
)

71 
	`Pröt
("NotÉnoughÑoom forÖrogram header\n");

72  
ENOEXEC
;

75 
exeF‹m©
->
numSegmíts
 = 
hdr
->
phnum
;

76 
exeF‹m©
->
íåyAddr
 = 
hdr
->
íåy
;

78 
phdr
 = (
¥ogømHódî
 *Ë(
exeFûeD©a
 + 
hdr
->
phoff
);

79 
i
 = 0; i < 
hdr
->
phnum
; ++i) {

80 
Exe_Segmít
 *
£gmít
 = &
exeF‹m©
->
£gmítLi°
[
i
];

86 
£gmít
->
off£tInFûe
 = 
phdr
[
i
].
off£t
;

87 
£gmít
->
ÀngthInFûe
 = 
phdr
[
i
].
fûeSize
;

88 
£gmít
->
°¨tAddªss
 = 
phdr
[
i
].
vaddr
;

89 
£gmít
->
sizeInMem‹y
 = 
phdr
[
i
].
memSize
;

91 i‡(
£gmít
->
ÀngthInFûe
 > segmít->
sizeInMem‹y
) {

92 i‡(
ñfDebug
)

93 
Pröt


95 
i
, 
£gmít
->
ÀngthInFûe
, segmít->
sizeInMem‹y
);

96  
ENOEXEC
;

103 
	}
}

	@fd_boot.asm

1 ; 
BoŸ
 
£˘‹
 
	gGìkOS


2 ; 
C›yright
 (
c
Ë2001,2004 
David
 
	gH
. 
	gHovemeyî
 <
	gdaveho
@
	gcs
.
	gumd
.
	gedu
>

3 ; 
C›yright
 (
c
Ë2003, 
Jef‰ey
 
	gK
. 
	gHﬁlögsw‹th
 <
	ghﬁlögs
@
	gcs
.
	gumd
.
	gedu
>

4 ; 
	g$Revisi⁄
: 1.5 
$


6 ; 
This
 
is
 
‰ì
 
	gso·w¨e
. 
You
 
¨e
 
≥rmôãd
 
to
 
	gu£
,

7 ; 
	gªdi°ribuã
, 
™d
 
modify
 
ô
 
as
 
•ecifõd
 
ö
 
the
 
	gfûe
 "COPYING".

9 ; 
Lﬂds
 
£tup
 
code
 
™d
 
a
 
¥ogøm
 
image
 
‰om
 
	g£˘‹s
 1..
n
 
of
á 
	gÊ›py


10 ; 
™d
 
execuãs
 
the
 
£tup
 
code
 (
which
 
wûl
 
ö
 
tu∫
 
execuã


11 ; 
the
 
¥ogøm
 
image
).

13 ; 
Some
 
of
 
this
 
code
 
is
 
ad≠ãd
 
‰om
 
Kî√l
 
	gToﬁkô
 0.2

14 ; 
™d
 
Löux
 
	gvîsi⁄
 2.2.x, 
so
 
the
 
fﬁlowög
 
c›yrights
 
	g≠∂y
:

16 ; 
C›yright
 (
C
Ë1991, 1992 
Löus
 
	gT‹vÆds


17 ; 
modifõd
 
by
 
Dªw
 
	gEckh¨dt


18 ; 
modifõd
 
by
 
Bru˚
 
Ev™s
 (
bde
)

19 ; 
ad≠ãd
 
Kî√l
 
Toﬁkô
 
by
 
Luigi
 
	gSgro


21 %
	gö˛ude
 "defs.asm"

23 ; 
Pad
 
to
 
desúed
 
off£t
 
‰om
 
°¨t
 
	gsymbﬁ
.

24 ; 
	gUßge
: 
Pad_From_Symbﬁ
 
off£t
, 
	gsymbﬁ


25 %
ma¸o
 
	gPad_From_Symbﬁ
 2

26 
times
 (%1 - (
$
 - %2)Ë
	gdb
 0

27 %
	gídma¸o


30 ; 
The
 
a˘uÆ
 
	gcode


33 [
BITS
 16]

34 [
ORG
 0x0]

36 
	gBegöText
: ; 
√eded
 
to
 
ˇlcuœã
 
∑ddög
 
byãs
Åÿ
fûl
 
the
 
	g£˘‹


38 ; 
C›y
 
the
 
boŸ
 
£˘‹
 
öto
 
	gINITSEG
.

39 
mov
 
	gax
, 
BOOTSEG


40 
mov
 
	gds
, 
	gax
 ; 
sour˚
 
£gmít
 
°rög
 
c›y


41 
x‹
 
	gsi
, sò; 
sour˚
 
ödex
 
°rög
 
c›y


42 
mov
 
	gax
, 
INITSEG


43 
mov
 
	ges
, 
	gax
 ; 
de°ö©i⁄
 
£gmít
 
°rög
 
c›y


44 
x‹
 
	gdi
, dò; 
de°ö©i⁄
 
ödex
 
°rög
 
c›y


45 
	g˛d
 ; 
˛ór
 
dúe˘i⁄
 
Êag


46 
mov
 
	gcx
, 256 ; 
numbî
 
of
 
w‹ds
 
to
 
c›y


47 
ªp
 
	gmovsw
 ; 
	gc›y
 512 
byãs


49 
jmp
 
	gINITSEG
:
a·î_move


51 
a·î_move
:

52 ; 
Now
 
	gwe
'reÉxecuting in INITSEG

54 ; 
We
 
w™t
 
the
 
d©a
 
£gmít
 
to
 
ª„r
Åÿ
	gINITSEG


55 ; (
sö˚
 
	gwe
've defined variables inÅhe sameÖlaceásÅhe code)

56 
mov
 
	gds
, 
	gax
 ; 
ax
 
°ûl
 
c⁄èös
 
	gINITSEG


58 ; 
Put
 
the
 
°ack
 
ö
Åhê
∂a˚
 
whîe
 
we
 
wîe
 
‹igöÆly
 
	glﬂded
.

59 ; 
By
 
	gdeföôi⁄
, 
thîe
 
is
 
nŸhög
 
imp‹è¡
Åhîê
	gnow
.

60 
mov
 
	gax
, 0

61 
mov
 
	gss
, 
ax


62 
mov
 
	g•
, (
	gBOOTSEG
 << 4) + 512 - 2

64 
	glﬂd_£tup
:

65 ; 
Lﬂd
 
the
 
£tup
 
	gcode
.

66 
mov
 
	gax
, 
	gw‹d
 [
£tupSèπ
]

67 
mov
 
	gw‹d
 [
£c_cou¡
], 
ax


68 
add
 
	gax
, [
£tupSize
]

69 
mov
 
	gw‹d
 [
max_£˘‹
], 
	gax


70 .
	gagaö
:

71 
mov
 
ax
, [
£c_cou¡
]

72 
push
 
	gax
 ; 1
°
 
∑øm
 
to
 
	$RódSe˘‹
 (
log
 
£c
 
num
)

73 
push
 
w‹d
 
SETUPSEG
 ; 2
nd
 
∑øm
 
to
 
	$RódSe˘‹
 (
£g
 
ba£
)

74 
sub
 
ax
, [
£tupSèπ
] ; 
c⁄vît
 
to
 0-
ödexed


75 
shl
 
ax
, 9 ; 
mu…ùly
 
by
 512

76 
push
 
ax
 ; ...
to
 
gë
 3
rd
 
	`∑øm
 (
byã
 
off£t
)

78 ; 
ªad
 
the
 
£˘‹
 
‰om
Åhê
Ê›py


79 
ˇŒ
 
RódSe˘‹


80 
add
 
•
, 6 ; 
˛ór
 3 
w‹d
 
∑øms


82 ; 
⁄
 
to
 
√xt
 
£˘‹


83 
öc
 
w‹d
 [
£c_cou¡
]

85 ; 
¨e
 
we
 
d⁄e
?

86 
mov
 
bx
, 
w‹d
 [
max_£˘‹
]

87 
cmp
 
w‹d
 [
£c_cou¡
], 
bx


88 
jl
 .
agaö


90 
lﬂd_kî√l
:

91 ; 
Lﬂd
 
the
 
kî√l
 
image
 
‰om
 
£˘‹s
 
KERN_START_SEC
..
n
 
of
Åhe

92 ; 
Ê›py
 
öto
 
mem‹y
 
©
 
KERNSEG
. 
NŸe
 
th©
 
thîe
 
¨e
 128 
£˘‹s


93 ; 
≥r
 64
K
 
£gmít
. 
So
, 
whí
 
figurög
 
out
 
which
 segmíà
to


94 ; 
lﬂd
 
the
 
£˘‹
 
öto
, 
we
 
shi·
 
right
 
by
 7 
	`bôs
 (
which
 
is


95 ; 
equivÆít
 
to
 
dividög
 
by
 128).

97 ; 
Figuª
 
out
 
°¨t
 
£˘‹
 
™d
 
max
 sector

98 
mov
 
ax
, 
w‹d
 [
kî√lSèπ
]

99 
mov
 
w‹d
 [
£c_cou¡
], 
ax


100 
add
 
ax
, 
w‹d
 [
kî√lSize
]

101 
mov
 
w‹d
 [
max_£˘‹
], 
ax


102 .
agaö
:

103 
mov
 
ax
, [
£c_cou¡
] ; 
logiˇl
 
£˘‹
 
⁄
 
the
 
Ê›py


104 
push
 
ax
 ; 1
°
 
∑øm
 
to
 
	$RódSe˘‹
 (
log
 
£c
 
num
)

105 
sub
 
ax
, [
kî√lSèπ
] ; 
c⁄vît
 
to
 0-
ödexed


106 
mov
 
cx
, 
ax
 ; 
ßve
 
ö
 cx

107 
shr
 
ax
, 7 ; 
divide
 
by
 128

108 
shl
 
ax
, 12 ; ...
™d
 
mu…ùly
 
by
 0x1000

109 
add
 
ax
, 
KERNSEG
 ; ...
to
 
gë
 
ba£
 
ªœtive
Åo KERNSEG

110 
push
 
ax
 ; 2
nd
 
∑øm
 
to
 
	$RódSe˘‹
 (
£g
 
ba£
)

111 
™d
 
cx
, 0x7‡; 
mod
 
£˘‹
 
by
 128

112 
shl
 
cx
, 9 ; ...
™d
 
mu…ùly
 
by
 512

113 
push
 
cx
 ; 
to
 
gë
 
off£t
 
ö
 
	`£gmít
 (3
rd
 
∑rm
)

115 ; 
ªad
 
the
 
£˘‹
 
‰om
Åhê
Ê›py


116 
ˇŒ
 
RódSe˘‹


117 
add
 
•
, 6 ; 
˛ór
 3 
w‹d
 
∑øms


119 ; 
⁄
 
to
 
√xt
 
£˘‹


120 
öc
 
w‹d
 [
£c_cou¡
]

122 ; 
have
 
we
 
lﬂded
 
Æl
 
of
 
the
 
£˘‹s
?

123 
mov
 
bx
, 
w‹d
 [
max_£˘‹
]

124 
cmp
 
w‹d
 [
£c_cou¡
], 
bx


125 
jl
 .
agaö


127 ; 
Now
 
we
'veÜoadedÅhe setup codeándÅhe kernel image.

128 ; 
Jump
 
to
 
£tup
 
code
.

129 
jmp
 
SETUPSEG
:0

131 ; 
Ród
 
a
 
£˘‹
 
‰om
 
the
 
Ê›py
 
drive
.

132 ; 
This
 
	$code
 (
™d
 
the
 
ª°
 
of
 
this
 
boŸ
 
£˘‹
Ë
wûl
 
have
 
to


133 ; 
be
 
ª
-
wrôãn
 
©
 
some
 
poöt
 
so
 
ô
 
ªads
 
m‹e
 
th™
 
⁄e


134 ; 
£˘‹
 
©
 
a
 
time
.

136 ; 
P¨amëîs
:

137 ; - "logiˇl" 
£˘‹
 
numbî
 [
bp
+8]

138 ; - 
de°ö©i⁄
 
£gmít
 [
bp
+6]

139 ; - 
de°ö©i⁄
 
off£t
 [
bp
+4]

140 
RódSe˘‹
:

141 
push
 
bp
 ; 
£t
 
up
 
°ack
 
‰ame


142 
mov
 
bp
, 
•
 ; "

143 
pusha
 ; 
ßve
 
Æl
 
ªgi°îs


146 ; 
debug
 
∑øms


147 
mov
 
dx
, [
bp
+8]

148 
ˇŒ
 
PrötHex


149 
ˇŒ
 
PrötNL


150 
mov
 
dx
, [
bp
+6]

151 
ˇŒ
 
PrötHex


152 
ˇŒ
 
PrötNL


153 
mov
 
dx
, [
bp
+4]

154 
ˇŒ
 
PrötHex


155 
ˇŒ
 
PrötNL


156 %
ídif


158 ; 
Se˘‹
 = 
log_£c
 % 
SECTORS_PER_TRACK


159 ; 
Hód
 = (
log_£c
 / 
SECTORS_PER_TRACK
Ë% 
HEADS


160 
mov
 
ax
, [
bp
+8] ; 
gë
 
logiˇl
 
£˘‹
 
numbî
 
‰om
 
°ack


161 
x‹
 
dx
, dx ; dx 
is
 
high
 
∑π
 
of
 
	$dividíd
 (== 0)

162 
mov
 
bx
, 
SECTORS_PER_TRACK
 ; 
divis‹


163 
div
 
bx
 ; dÿ
the
 
divisi⁄


164 
mov
 [
£c
], 
dx
 ; 
£˘‹
 
is
 
the
 
ªmaödî


165 
™d
 
ax
, 1 ; 
ßme
 
as
 
mod
 
by
 
HEADS
==2 (
¶ight
 
hack
)

166 
mov
 [
hód
], 
ax


168 ; 
Tøck
 = 
log_£c
 / (
SECTORS_PER_TRACK
*
HEADS
)

169 
mov
 
ax
, [
bp
+8] ; 
gë
 
logiˇl
 
£˘‹
 
numbî
 
agaö


170 
x‹
 
dx
, dx ; dx 
is
 
high
 
∑π
 
of
 
dividíd


171 
mov
 
bx
, 
SECTORS_PER_TRACK
*2 ; 
divis‹


172 
div
 
bx
 ; dÿ
the
 
divisi⁄


173 
mov
 [
åack
], 
ax
 ;Åøck 
is
 
quŸõ¡


176 ; 
debuggög
 
code


177 
mov
 
dx
, [
£c
]

178 
ˇŒ
 
PrötHex


179 
ˇŒ
 
PrötNL


180 
mov
 
dx
, [
hód
]

181 
ˇŒ
 
PrötHex


182 
ˇŒ
 
PrötNL


183 
mov
 
dx
, [
åack
]

184 
ˇŒ
 
PrötHex


185 
ˇŒ
 
PrötNL


186 %
ídif


188 ; 
Now
, 
åy
 
to
 
a˘uÆly
 
ªad
 
the
 
£˘‹
 
‰om
Åhê
Ê›py
,

189 ; 
ªåyög
 
up
 
to
 3 
times
.

191 
mov
 [
num_ªåõs
], 
byã
 0

193 .
agaö
:

194 
mov
 
ax
, [
bp
+6] ; 
de°
 
£gmít
...

195 
mov
 
es
, 
ax
 ; 
g€s
 
ö
És

196 
mov
 
ax
, (0x02 << 8Ë| 1 ; 
fun˘i⁄
 = 02
h
 
ö
 
ah
,

197 ; #£c†1 
ö
 
Æ


198 
mov
 
bx
, [
åack
] ;Åøck 
numbî
...

199 
mov
 
ch
, 
bl
 ; 
g€s
 
ö
 ch

200 
mov
 
bx
, [
£c
] ; 
£˘‹
 
numbî
...

201 
mov
 
˛
, 
bl
 ; 
g€s
 
ö
 cl...

202 
öc
 
˛
 ; 
but
 
ô
 
mu°
 
be
 1-
ba£d
, 
nŸ
 0-based

203 
mov
 
bx
, [
hód
] ; hód 
numbî
...

204 
mov
 
dh
, 
bl
 ; 
g€s
 
ö
 dh

205 
x‹
 
dl
, d»; 
h¨d
 
code
 
drive
=0

206 
mov
 
bx
, [
bp
+4] ; 
off£t
 
g€s
 
ö
 bx

207 ; (
es
:
bx
 
poöts
 
to
 
buf„r
)

209 ; 
CÆl
 
the
 
BIOS
 
Ród
 
Diskëã
 
Se˘‹s
 
£rvi˚


212 ; 
If
 
the
 
ˇºy
 
Êag
 
is
 
NOT
 
£t
, 
thí
 
thîe
 
was
 
no
 
îr‹


213 ; 
™d
 
we
're done.

214 
jnc
 .
d⁄e


216 ; 
Eº‹
 - 
code
 
°‹ed
 
ö
 
ah


217 
mov
 
dx
, 
ax


218 
ˇŒ
 
PrötHex


219 
öc
 
byã
 [
num_ªåõs
]

220 
cmp
 
byã
 [
num_ªåõs
], 3

221 
j√
 .
agaö


223 ; 
If
 
we
 
gŸ
 
hîe
, wê
Áûed
 
thri˚
, 
so
 wê
give
 
up


224 
mov
 
dx
, 0xdead

225 
ˇŒ
 
PrötHex


226 .
hîe
: 
jmp
 .here

228 .
d⁄e
:

229 
p›a
 ; 
ª°‹e
 
Æl
 
ªgisôîs


230 
p›
 
bp
 ; 
Àave
 
°ack
 
‰ame


231 
ªt


233 ; 
In˛ude
 
utûôy
 
routöes


234 %
ö˛ude
 "util.asm"

237 ; 
V¨übÀs


240 ; 
The£
 
¨e
 
u£d
 
by
 
RódSe˘‹


241 
hód
: 
dw
 0

242 
åack
: 
dw
 0

243 
£c
: 
dw
 0

244 
num_ªåõs
: 
db
 0

246 ; 
U£d
 
lo›s
 
ªadög
 
£˘‹s
 
‰om
 
Ê›py


247 
£c_cou¡
: 
dw
 0

248 
max_£˘‹
: 
dw
 0

250 ; 
Paddög
 
to
 
make
 
the
 
PFAT
 
BoŸ
 
Rec‹d
 
sô
 
ju°
 
bef‹e
Åhê
BIOS
 
sig«tuª
.

251 
Pad_From_Symbﬁ
 
PFAT_BOOT_RECORD_OFFSET
, 
BegöText


253 ; 
PFAT
 
boŸ
 
ªc‹d


254 ; 
Des¸ibes
 
how
 
to
 
lﬂd
 
the
 
£tup
 
¥ogøm
 
™d
 
kî√l
.

255 ; 
The
  
vÆues
 
¨e
 
≠¥›rüã
 
¸ótög
 
a
 
boŸ


256 ; 
Ê›py
 
by
 
c⁄ˇã«tög
 
the
 
boŸ
 
£˘‹
, 
£tup
 
¥ogøm
,

257 ; 
™d
 
kî√l
 
image
. 
The
 
buûdF©
 
¥ogøm
 
wûl
 
ch™ge


258 ; 
the£
 
vÆues
 
the
 
boŸ
 
Ê›py
 
is
 
f‹m©ãd
 
as
 
a
 
PFAT


259 ; 
fûesy°em
.

260 
dw
 0

261 
dw
 0

263 
dw
 0

264 
dw
 0

266 
dw
 0

267 
dw
 0

269 
dw
 0

270 
dw
 0

272 
dw
 0

273 
dw
 0

275 ;; 
∑π
 
of
 
pÁt
 
boŸ
 
ªc‹d


276 
£tupSèπ
:

277 
dw
 1 ; 
by
 , 
£tup
 
is
 
©
 
fú°
 
£˘‹


279 ;; 
∑π
 
of
 
pÁt
 
boŸ
 
ªc‹d


280 
£tupSize
:

281 
dw
 
NUM_SETUP_SECTORS
 ; 
numbî
 
of
 
£˘‹s
 
ö
 
£tup


283 ;; 
∑π
 
of
 
pÁt
 
boŸ
 
ªc‹d


284 
kî√lSèπ
:

285 
dw
 1+
NUM_SETUP_SECTORS
 ;  
°¨t
 
£˘‹
 
kî√l


287 ;; 
∑π
 
of
 
pÁt
 
boŸ
 
ªc‹d


288 
kî√lSize
:

289 
dw
 
NUM_KERN_SECTORS
 ; 
numbî
 
of
 
£˘‹s
 
ö
 
kî√l


291 ; 
Föish
 
by
 
wrôög
 
the
 
BIOS
 
sig«tuª
 
to
 
m¨k
 
this
 
as


292 ; 
a
 
vÆid
 
boŸ
 
£˘‹
.

293 
Pad_From_Symbﬁ
 
BIOS_SIGNATURE_OFFSET
, 
BegöText


294 
Sig«tuª
 
dw
 0xAA55 ; 
BIOS
 
c⁄åﬁs
 
this
 
to
 
ísuª
Åhi†
is
 
a
 
boŸ
 
£˘‹


	@floppy.c

10 
	~<gìkos/s¸ìn.h
>

11 
	~<gìkos/°rög.h
>

12 
	~<gìkos/mem.h
>

13 
	~<gìkos/mÆloc.h
>

14 
	~<gìkos/öt.h
>

15 
	~<gìkos/úq.h
>

16 
	~<gìkos/dma.h
>

17 
	~<gìkos/io.h
>

18 
	~<gìkos/timî.h
>

19 
	~<gìkos/kthªad.h
>

20 
	~<gìkos/blockdev.h
>

21 
	~<gìkos/Ê›py.h
>

58 
	#FDC_IRQ
 6

	)

63 
	#FDC_DMA
 2

	)

68 
	#FDC_BASE
 0x3F0

	)

69 
	#FDC_DOR_REG
 0x3F2

	)

70 
	#FDC_STATUS_REG
 0x3F4

	)

71 
	#FDC_DATA_RATE_SELECT_REG
 0x3F4

	)

72 
	#FDC_DATA_REG
 0x3F5

	)

77 
	#FDC_STATUS_MRQ
 (1 << 7)

	)

78 
	#FDC_STATUS_DIO
 (1 << 6)

	)

79 
	#FDC_STATUS_NDMA
 (1 << 5)

	)

80 
	#FDC_STATUS_BUSY
 (1 << 4)

	)

81 
	#FDC_STATUS_ACTIVE
(
drive
Ë(1 << (drive))

	)

82 
	#FDC_STATUS_READY_MASK
 (
FDC_STATUS_MRQ
 | 
FDC_STATUS_DIO
)

	)

83 
	#FDC_STATUS_READY_WRITE
 
FDC_STATUS_MRQ


	)

84 
	#FDC_STATUS_READY_READ
 (
FDC_STATUS_MRQ
 | 
FDC_STATUS_DIO
)

	)

89 
	#FDC_DOR_MOTOR
(
drive
Ë(1 << ((driveË+ 4))

	)

90 
	#FDC_DOR_DMA_ENABLE
 (1 << 3)

	)

91 
	#FDC_DOR_RESET_DISABLE
 (1 << 2)

	)

92 
	#FDC_DOR_DRIVE_SELECT
(
drive
Ë((driveË& 0x3)

	)

97 
	#FDC_COMMAND_CALIBRATE
 0x07

	)

98 
	#FDC_COMMAND_SENSE_INT_STATUS
 0x08

	)

99 
	#FDC_COMMAND_SEEK
 0x0F

	)

100 
	#FDC_COMMAND_WRITE_SECTOR
 0x05

	)

101 
	#FDC_COMMAND_READ_SECTOR
 0x06

	)

106 
	#FDC_MULTI_TRACK
 0x80

	)

107 
	#FDC_MFM
 0x40

	)

108 
	#FDC_SKIP_DELETED
 0x20

	)

113 
	#FDC_ST0_SEEK_END
 (1 << 5)

	)

114 
	#FDC_ST0_IS_SUCCESS
(
code
Ë((((codeË>> 6Ë& 0x3Ë=0)

	)

120 
	#CMOS_OUT
 0x70

	)

121 
	#CMOS_IN
 0x71

	)

122 
	#CMOS_FLOPPY_INDEX
 0x10

	)

124 íum { 
	mFLOPPY_READ
, 
	mFLOPPY_WRITE
 };

127 #ifde‡
FLOPPY_DEBUG


128 
	#Debug
(
¨gs
...Ë
	`Pröt
◊rgs)

	)

130 
	#Debug
(
¨gs
...)

	)

140 
	sFl›py_P¨amëîs
 {

141 
	mcylödîs
;

142 
	mhóds
;

143 
	m£˘‹s
;

144 
	m£˘‹SizeCode
;

145 
	mg≠LígthCode
;

147 
	#INVALID_FLOPPY_TYPE
 { -1, -1, -1, -1, -1 }

	)

153 
Fl›py_P¨amëîs
 
	gs_Ê›pyP¨amsTabÀ
[] = {

154 
INVALID_FLOPPY_TYPE
,

155 
INVALID_FLOPPY_TYPE
,

156 
INVALID_FLOPPY_TYPE
,

157 
INVALID_FLOPPY_TYPE
,

159 
INVALID_FLOPPY_TYPE
,

162 
	#NUM_FLOPPY_TYPES
 ((
s_Ê›pyP¨amsTabÀ
Ë/ (
Fl›py_P¨amëîs
))

	)

163 
	#IS_VALID_FLOPPY_TYPE
(
ty≥
) \

164 ((
ty≥
Ë< 
NUM_FLOPPY_TYPES
 && 
s_Ê›pyP¨amsTabÀ
[—y≥)].
cylödîs
 > 0)

	)

169 
	sFl›py_Drive
 {

170 
Fl›py_P¨amëîs
 *
	m∑øms
;

176 
Fl›py_Drive
 
	gs_driveTabÀ
[2];

182 
Thªad_Queue
 
	gs_Ê›pyI¡îru±WaôQueue
;

187 
uch¨_t
 *
	gs_å™s„rBuf
;

192 
Block_Reque°_Li°
 
	gs_Ê›pyReque°Queue
;

198 
Thªad_Queue
 
	gs_Ê›pyWaôQueue
;

207 
	$Fl›py_O≥n
(
Block_Devi˚
 *
dev
) {

208 
	`KASSERT
(!
dev
->
öU£
);

210 
	}
}

215 
	$Fl›py_Clo£
(
Block_Devi˚
 *
dev
) {

216 
	`KASSERT
(
dev
->
öU£
);

218 
	}
}

223 
	$Fl›py_Gë_Num_Blocks
(
Block_Devi˚
 *
dev
) {

224 
Fl›py_Drive
 *
drive
;

225 
Fl›py_P¨amëîs
 *
∑øms
;

227 
	`KASSERT
(
dev
->
unô
 >= 0 && dev->unit <= 1);

228 
drive
 = &
s_driveTabÀ
[
dev
->
unô
];

230 
∑øms
 = 
drive
->params;

231 
	`KASSERT
(
∑øms
 != 0);

233  
∑øms
->
cylödîs
 *Ö¨ams->
hóds
 *Ö¨ams->
£˘‹s
;

234 
	}
}

239 
Block_Devi˚_Ops
 
	gs_Ê›pyDevi˚Ops
 = {

240 
Fl›py_O≥n
,

241 
Fl›py_Clo£
,

242 
Fl›py_Gë_Num_Blocks
,

253 
	$Fl›py_I¡îru±_H™dÀr
(
I¡îru±_Sèã
 *
°©e
) {

254 
	`Begö_IRQ
(
°©e
);

255 
	`Wake_Up
(&
s_Ê›pyI¡îru±WaôQueue
);

256 
	`End_IRQ
(
°©e
);

257 
	}
}

263 
	$Sëup_Drive_P¨amëîs
(
drive
, 
ty≥
) {

264 i‡(
	`IS_VALID_FLOPPY_TYPE
(
ty≥
)) {

265 
Fl›py_P¨amëîs
 *
∑øms
 = &
s_Ê›pyP¨amsTabÀ
[
ty≥
];

266 
dev«me
[
BLOCKDEV_MAX_NAME_LEN
 + 1];

267 
rc
;

269 
	`¢¥ötf
(
dev«me
, (dev«me), "fd%d", 
drive
);

270 
	`Pröt
(" %s: cyl=%d, hóds=%d, se˘‹s=%d\n", 
dev«me
,

271 
∑øms
->
cylödîs
,Ö¨ams->
hóds
,Ö¨ams->
£˘‹s
);

272 
s_driveTabÀ
[
drive
].
∑øms
 =Öarams;

275 
rc
 = 
	`Regi°î_Block_Devi˚
(
dev«me
, &
s_Ê›pyDevi˚Ops
, 
drive
, 0,

276 &
s_Ê›pyWaôQueue
, &
s_Ê›pyReque°Queue
);

277 i‡(
rc
 != 0)

278 
	`Pröt
(" Eº‹: couldÇŸ cª©êblock devi˚ f‹ %s\n", 
dev«me
);

280 
	}
}

285 
	$LBA_To_CHS
(
Fl›py_Drive
 *
drive
, 
lba
, *
cylödî
,

286 *
hód
, *
£˘‹
) {

287 
Fl›py_P¨amëîs
 *
∑øms
 = 
drive
->params;

289 
	`KASSERT
(
∑øms
 != 0);

291 *
cylödî
 = 
lba
 / (
∑øms
->
hóds
 *Ö¨ams->
£˘‹s
);

292 *
hód
 = (
lba
 / 
∑øms
->
£˘‹s
Ë%Ö¨ams->
hóds
;

293 *
£˘‹
 = (
lba
 % 
∑øms
->
£˘‹s
) + 1;

295 
	`KASSERT
(*
cylödî
 >0 && *cylödî < 
∑øms
->
cylödîs
);

296 
	`KASSERT
(*
hód
 >0 && *hód < 
∑øms
->
hóds
);

297 
	`KASSERT
(*
£˘‹
 > 0 && *£˘‹ <
∑øms
->
£˘‹s
);

298 
	}
}

305 
	$Waô_F‹_MRQ
(
uch¨_t
 
ªadyVÆue
) {

306 
	`KASSERT
(
ªadyVÆue
 =
FDC_STATUS_READY_READ
 ||

307 
ªadyVÆue
 =
FDC_STATUS_READY_WRITE
);

310 (
	`In_Byã
(
FDC_STATUS_REG
Ë& 
FDC_STATUS_READY_MASK
Ë!
ªadyVÆue
);

313 
	}
}

318 
uch¨_t
 
	$Fl›py_In
() {

319 
	`Waô_F‹_MRQ
(
FDC_STATUS_READY_READ
);

320  
	`In_Byã
(
FDC_DATA_REG
);

321 
	}
}

326 
	$Fl›py_Out
(
uch¨_t
 
vÆ
) {

327 
	`Waô_F‹_MRQ
(
FDC_STATUS_READY_WRITE
);

328 
	`Out_Byã
(
FDC_DATA_REG
, 
vÆ
);

329 
	}
}

335 
	$Waô_F‹_I¡îru±
() {

336 
	`KASSERT
(!
	`I¡îru±s_E«bÀd
());

339 
	`Waô
(&
s_Ê›pyI¡îru±WaôQueue
);

340 
	}
}

342 
	$Sí£_I¡îru±_Sètus
(
uch¨_t
 * 
°0
, uch¨_à* 
p˙
) {

343 
	`Fl›py_Out
(
FDC_COMMAND_SENSE_INT_STATUS
);

344 *
°0
 = 
	`Fl›py_In
();

345 *
p˙
 = 
	`Fl›py_In
();

346 
	}
}

351 
boﬁ
 
	$CÆibøã
(
drive
) {

352 
numAâem±s
 = 4;

353 
boﬁ
 
suc˚ss
 = 
Ál£
;

354 
uch¨_t
 
°0
, 
p˙
;

356 
	`KASSERT
(!
	`I¡îru±s_E«bÀd
());

358 
numAâem±s
-- > 0) {

360 
	`Fl›py_Out
(
FDC_COMMAND_CALIBRATE
);

361 
	`Fl›py_Out
((
uch¨_t
Ë
drive
);

362 
	`Waô_F‹_I¡îru±
();

365 
	`Sí£_I¡îru±_Sètus
(&
°0
, &
p˙
);

366 
	`Debug
("CÆibøã: st0=%02x,Ö˙=%02x\n", 
°0
, 
p˙
);

367 i‡(
°0
 & 
FDC_ST0_SEEK_END
) {

368 
suc˚ss
 = 
åue
;

373 
	`Debug
("Drivê%d cÆibøti⁄ %s\n", 
drive
,

374 
suc˚ss
 ? "succeeded" : "failed");

375  
suc˚ss
;

376 
	}
}

378 
	$Sèπ_MŸ‹
(
drive
) {

379 
	`Out_Byã
(
FDC_DOR_REG
,

380 
	`FDC_DOR_MOTOR
(
drive
Ë| 
FDC_DOR_DMA_ENABLE
 | 
FDC_DOR_RESET_DISABLE


381 | 
	`FDC_DOR_DRIVE_SELECT
(0));

382 
	}
}

384 
St›_MŸ‹
(
drive
 
__©åibuã__
 ((
unu£d
))) {

385 
Out_Byã
(
FDC_DOR_REG
,

386 
FDC_DOR_DMA_ENABLE
 | 
FDC_DOR_RESET_DISABLE
 |

387 
FDC_DOR_DRIVE_SELECT
(0));

394 
boﬁ
 
	$Re£t_C⁄åﬁÀr
() {

396 
	`Out_Byã
(
FDC_DOR_REG
, 0);

403 
	`Sèπ_MŸ‹
(0);

405  
	`CÆibøã
(0);

406 
	}
}

408 
boﬁ
 
	$Fl›py_Sìk
(
drive
, 
cylödî
, 
hód
) {

409 
uch¨_t
 
°0
, 
p˙
;

410 
numAâem±s
 = 4;

411 
boﬁ
 
suc˚ss
 = 
Ál£
;

413 
	`Debug
("Fl›py_Sìk(%d,%d,%d)\n", 
drive
, 
cylödî
, 
hód
);

415 
numAâem±s
-- > 0) {

416 
	`Sèπ_MŸ‹
(
drive
);

419 
	`DißbÀ_I¡îru±s
();

421 
	`Fl›py_Out
(
FDC_COMMAND_SEEK
);

422 
	`Fl›py_Out
((
hód
 << 2Ë| (
drive
 & 3));

423 
	`Fl›py_Out
(
cylödî
 & 0xFF);

425 
	`Debug
("Seek: waiting for interrupt\n");

426 
	`Waô_F‹_I¡îru±
();

427 
	`Debug
("Seek: got interrupt\n");

429 
	`E«bÀ_I¡îru±s
();

431 
	`St›_MŸ‹
(
drive
);

433 
	`Sí£_I¡îru±_Sètus
(&
°0
, &
p˙
);

434 i‡(
°0
 & 
FDC_ST0_SEEK_END
) {

436 i‡(
p˙
 !
cylödî
) {

437 
	`Debug
("Seekárrivedát wrong cylinder\n");

439 
	`Debug
("Seek complete!\n");

440 
suc˚ss
 = 
åue
;

446  
suc˚ss
;

447 
	}
}

449 
	$Fl›py_Tøns„r
(
dúe˘i⁄
, 
driveNum
, 
blockNum
) {

450 
Fl›py_Drive
 *
drive
 = &
s_driveTabÀ
[
driveNum
];

451 
Fl›py_P¨amëîs
 *
∑øms
 = 
drive
->params;

452 
cylödî
, 
hód
, 
£˘‹
;

453 
DMA_Dúe˘i⁄
 
dmaDúe˘i⁄
 =

454 
dúe˘i⁄
 =
FLOPPY_READ
 ? 
DMA_READ
 : 
DMA_WRITE
;

455 
uch¨_t
 
comm™d
;

456 
uch¨_t
 
°0
, 
°1
, 
°2
;

457 
ªsu…
 = -1;

459 
	`KASSERT
(
driveNum
 == 0);

460 
	`KASSERT
(
dúe˘i⁄
 =
FLOPPY_READ
 || dúe˘i⁄ =
FLOPPY_WRITE
);

461 
	`KASSERT
(
∑øms
 != 0);

463 
	`LBA_To_CHS
(&
s_driveTabÀ
[
driveNum
], 
blockNum
, &
cylödî
, &
hód
, &
£˘‹
);

465 i‡(!
	`Fl›py_Sìk
(
driveNum
, 
cylödî
, 
hód
))

468 
	`DißbÀ_I¡îru±s
();

471 
	`Sëup_DMA
(
dmaDúe˘i⁄
, 
FDC_DMA
, 
s_å™s„rBuf
, 
SECTOR_SIZE
);

474 
	`Sèπ_MŸ‹
(
driveNum
);

480 
	`Mi¸o_Dñay
(8000);

482 i‡(
dúe˘i⁄
 =
FLOPPY_READ
)

483 
comm™d
 = 
FDC_COMMAND_READ_SECTOR
 | 
FDC_MFM
 | 
FDC_SKIP_DELETED
;

485 
comm™d
 = 
FDC_COMMAND_WRITE_SECTOR
 | 
FDC_MFM
;

488 
	`Fl›py_Out
(
comm™d
);

489 
	`Fl›py_Out
((
hód
 << 2Ë| (
driveNum
 & 3));

490 
	`Fl›py_Out
(
cylödî
);

491 
	`Fl›py_Out
(
hód
);

492 
	`Fl›py_Out
(
£˘‹
);

493 
	`Fl›py_Out
(
∑øms
->
£˘‹SizeCode
);

494 
	`Fl›py_Out
(
∑øms
->
£˘‹s
);

495 
	`Fl›py_Out
(
∑øms
->
g≠LígthCode
);

496 
	`Fl›py_Out
(0xFF);

499 
	`Waô_F‹_I¡îru±
();

500 
	`Debug
("Floppy_Transfer:Ñeceived interrupt!\n");

503 
°0
 = 
	`Fl›py_In
();

504 
°1
 = 
	`Fl›py_In
();

505 
°2
 = 
	`Fl›py_In
();

506 
	`Fl›py_In
();

507 
	`Fl›py_In
();

508 
	`Fl›py_In
();

509 
	`Fl›py_In
();

511 
	`St›_MŸ‹
(
driveNum
);

513 i‡(
	`FDC_ST0_IS_SUCCESS
(
°0
)) {

514 
	`Debug
("Floppy_Transfer: successfulÅransfer!\n");

515 
ªsu…
 = 0;

518 
	`E«bÀ_I¡îru±s
();

521  
ªsu…
;

522 
	}
}

524 
	$Fl›py_Ród
(
driveNum
, 
blockNum
, *
buf„r
) {

525 
rc
;

527 
	`Debug
("Fl›py_Ród(%d,%d,%x)\n", 
driveNum
, 
blockNum
, 
buf„r
);

529 #i‚de‡
NDEBUG


530 
	`mem£t
(
buf„r
, ()0xcd, 
SECTOR_SIZE
);

531 
	`mem£t
(
s_å™s„rBuf
, ()0xcd, 
SECTOR_SIZE
);

534 
rc
 = 
	`Fl›py_Tøns„r
(
FLOPPY_READ
, 
driveNum
, 
blockNum
);

536 i‡(
rc
 == 0) {

541 
	`mem˝y
(
buf„r
, 
s_å™s„rBuf
, 
SECTOR_SIZE
);

544  
rc
;

545 
	}
}

547 
	$Fl›py_Wrôe
(
driveNum
, 
blockNum
, *
buf„r
) {

548 
	`Debug
("Fl›py_Wrôe(%d,%d,%x)\n", 
driveNum
, 
blockNum
, 
buf„r
);

550 
	`mem˝y
(
s_å™s„rBuf
, 
buf„r
, 
SECTOR_SIZE
);

551  
	`Fl›py_Tøns„r
(
FLOPPY_WRITE
, 
driveNum
, 
blockNum
);

552 
	}
}

557 
Fl›py_Reque°_Thªad
(
ul⁄g_t
 
¨g
 
__©åibuã__
 ((
unu£d
))) {

558 
	grc
;

560 
Debug
("FRQ: FloppyÑequestÅhread starting...\n");

563 
Block_Reque°
 *
	gªque°
;

566 
Debug
("FRQ: RequestÅhread waiting foráÑequest\n");

567 
	gªque°
 = 
Dequeue_Reque°
(&
s_Ê›pyReque°Queue
, &
s_Ê›pyWaôQueue
);

568 
Debug
("FRQ: GŸá fl›pyÑeque° [@%x]\n", 
ªque°
);

569 
KASSERT
(
ªque°
->
ty≥
 =
BLOCK_READ
 ||Ñeque°->ty≥ =
BLOCK_WRITE
);

572 i‡(
	gªque°
->
	gty≥
 =
BLOCK_READ
)

573 
rc
 = 
Fl›py_Ród
(
ªque°
->
dev
->
unô
,Ñeque°->
blockNum
,

574 
ªque°
->
buf
);

576 
	grc
 = 
Fl›py_Wrôe
(
ªque°
->
dev
->
unô
,Ñeque°->
blockNum
,

577 
ªque°
->
buf
);

580 
Debug
("FRQ: NotifyingÑequestingÅhread...\n");

581 
NŸify_Reque°_Com∂ëi⁄
(
ªque°
, 
rc
 =0 ? 
COMPLETED
 : 
ERROR
,Ñc);

582 
Debug
("FRQ: Completed floppyÑequest\n");

593 
	$Inô_Fl›py
() {

594 
uch¨_t
 
Ê›pyByã
;

595 
boﬁ
 
ªady
 = 
Ál£
;

596 
boﬁ
 
good
;

598 
	`Pröt
("Initializing floppy controller...\n");

601 
s_å™s„rBuf
 = (
uch¨_t
 *Ë
	`AŒoc_Page
();

604 
	`Out_Byã
(
CMOS_OUT
, 
CMOS_FLOPPY_INDEX
);

605 
Ê›pyByã
 = 
	`In_Byã
(
CMOS_IN
);

606 
	`Sëup_Drive_P¨amëîs
(0, (
Ê›pyByã
 >> 4) & 0xF);

607 
	`Sëup_Drive_P¨amëîs
(1, 
Ê›pyByã
 & 0xF);

610 
	`In°Æl_IRQ
(
FDC_IRQ
, &
Fl›py_I¡îru±_H™dÀr
);

611 
	`E«bÀ_IRQ
(
FDC_IRQ
);

614 
	`DißbÀ_I¡îru±s
();

615 
good
 = 
	`Re£t_C⁄åﬁÀr
();

616 
	`E«bÀ_I¡îru±s
();

617 i‡(!
good
) {

618 
	`Pröt
(" FailedÅoÑeset controller!\n");

619 
d⁄e
;

623 i‡(!
	`Re£rve_DMA
(
FDC_DMA
)) {

624 
	`Pröt
(" FailedÅoÑeserve DMA channel\n");

625 
d⁄e
;

632 
ªady
 = 
åue
;

633 
	`Sèπ_Kî√l_Thªad
(
Fl›py_Reque°_Thªad
, 0, 
PRIORITY_NORMAL
, 
åue
,

637 
d⁄e
:

638 i‡(!
ªady
)

639 
	`Pröt
(" Floppy controller initialization FAILED\n");

641 
	`Pröt
(" Floppy controller initialization complete\n");

642 
	}
}

	@gdt.c

10 
	~<gìkos/kas£π.h
>

11 
	~<gìkos/£gmít.h
>

12 
	~<gìkos/öt.h
>

13 
	~<gìkos/tss.h
>

14 
	~<gìkos/gdt.h
>

19 
Lﬂd_GDTR
(
ush‹t_t
 * 
limôAndBa£
);

29 
	#NUM_GDT_ENTRIES
 32

	)

34 
Segmít_Des¸ùt‹
 
	gs_GDT
[
NUM_GDT_ENTRIES
];

39 
	gs_numAŒoˇãd
 = 0;

49 
Segmít_Des¸ùt‹
 *
	$AŒoˇã_Segmít_Des¸ùt‹
() {

50 
Segmít_Des¸ùt‹
 *
ªsu…
 = 0;

51 
i
;

52 
boﬁ
 
iÊag
;

54 
iÊag
 = 
	`Begö_I¡_Atomic
();

57 
i
 = 1; i < 
NUM_GDT_ENTRIES
; ++i) {

58 
Segmít_Des¸ùt‹
 *
desc
 = &
s_GDT
[
i
];

59 i‡(
desc
->
avaû
) {

60 ++
s_numAŒoˇãd
;

61 
desc
->
avaû
 = 0;

62 
ªsu…
 = 
desc
;

67 
	`End_I¡_Atomic
(
iÊag
);

69  
ªsu…
;

70 
	}
}

75 
	$Fªe_Segmít_Des¸ùt‹
(
Segmít_Des¸ùt‹
 *
desc
) {

76 
boﬁ
 
iÊag
 = 
	`Begö_I¡_Atomic
();

78 
	`KASSERT
(!
desc
->
avaû
);

80 
	`Inô_NuŒ_Segmít_Des¸ùt‹
(
desc
);

81 
desc
->
avaû
 = 1;

82 --
s_numAŒoˇãd
;

84 
	`End_I¡_Atomic
(
iÊag
);

85 
	}
}

90 
	$Gë_Des¸ùt‹_Index
(
Segmít_Des¸ùt‹
 *
desc
) {

91  ()(
desc
 - 
s_GDT
);

92 
	}
}

97 
	$Inô_GDT
(
˝uid
) {

98 
ush‹t_t
 
limôAndBa£
[3];

99 
ul⁄g_t
 
gdtBa£Addr
 = (ul⁄g_tË
s_GDT
;

100 
Segmít_Des¸ùt‹
 *
desc
;

101 
i
;

103 
	`KASSERT
((
Segmít_Des¸ùt‹
) == 8);

106 i‡(!
˝uid
) {

108 
i
 = 0; i < 
NUM_GDT_ENTRIES
; ++i) {

109 
desc
 = &
s_GDT
[
i
];

110 
	`Inô_NuŒ_Segmít_Des¸ùt‹
(
desc
);

111 
desc
->
avaû
 = 1;

115 
desc
 = 
	`AŒoˇã_Segmít_Des¸ùt‹
();

116 
	`Inô_Code_Segmít_Des¸ùt‹
(
desc
, 0,

120 
	`KASSERT
(
	`Gë_Des¸ùt‹_Index
(
desc
Ë=(
KERNEL_CS
 >> 3));

123 
desc
 = 
	`AŒoˇã_Segmít_Des¸ùt‹
();

124 
	`Inô_D©a_Segmít_Des¸ùt‹
(
desc
, 0,

128 
	`KASSERT
(
	`Gë_Des¸ùt‹_Index
(
desc
Ë=(
KERNEL_DS
 >> 3));

132 
limôAndBa£
[0] = (
Segmít_Des¸ùt‹
Ë* 
NUM_GDT_ENTRIES
;

133 
limôAndBa£
[1] = 
gdtBa£Addr
 & 0xffff;

134 
limôAndBa£
[2] = 
gdtBa£Addr
 >> 16;

135 
	`Lﬂd_GDTR
(
limôAndBa£
);

136 
	}
}

	@gfs2.c

15 
	~<limôs.h
>

16 
	~<gìkos/î∫o.h
>

17 
	~<gìkos/kas£π.h
>

18 
	~<gìkos/s¸ìn.h
>

19 
	~<gìkos/mÆloc.h
>

20 
	~<gìkos/°rög.h
>

21 
	~<gìkos/bô£t.h
>

22 
	~<gìkos/synch.h
>

23 
	~<gìkos/bufˇche.h
>

24 
	~<gìkos/gfs2.h
>

25 
	~<gìkos/¥oje˘s.h
>

39 
	$GFS2_FSèt
(
Fûe
 *
fûe
, 
VFS_Fûe_Sèt
 *
°©
) {

40 
	`TODO_P
(
PROJECT_GFS2
, "GeekOS filesystem FStat operation");

42 
	}
}

47 
	$GFS2_Ród
(
Fûe
 *
fûe
, *
buf
, 
ul⁄g_t
 
numByãs
) {

48 
	`TODO_P
(
PROJECT_GFS2
, "GeekOS filesystemÑead operation");

50  
EUNSUPPORTED
;

51 
	}
}

56 
	$GFS2_Wrôe
(
Fûe
 *
fûe
, *
buf
, 
ul⁄g_t
 
numByãs
) {

57 
	`TODO_P
(
PROJECT_GFS2
, "GeekOS filesystem write operation");

58  
EUNSUPPORTED
;

59 
	}
}

65 
	$GFS2_Sìk
(
Fûe
 *
fûe
, 
ul⁄g_t
 
pos
) {

66 
	`TODO_P
(
PROJECT_GFS2
, "GeekOS filesystem seek operation");

67  
EUNSUPPORTED
;

68 
	}
}

73 
	$GFS2_Clo£
(
Fûe
 *
fûe
) {

74 
	`TODO_P
(
PROJECT_GFS2
, "GeekOS filesystem close operation");

75  
EUNSUPPORTED
;

76 
	}
}

78  
Fûe_Ops
 
	gs_gfs2FûeOps
 = {

79 &
GFS2_FSèt
,

80 &
GFS2_Ród
,

81 &
GFS2_Wrôe
,

82 &
GFS2_Sìk
,

83 &
GFS2_Clo£
,

90 
	$GFS2_FSèt_Dúe˘‹y
(
Fûe
 *
dú
, 
VFS_Fûe_Sèt
 *
°©
) {

92 
	`TODO_P
(
PROJECT_GFS2
, "GeekOS filesystem FStat directory operation");

94 
	}
}

99 
	$GFS2_Clo£_Dúe˘‹y
(
Fûe
 *
dú
) {

100 
	`TODO_P
(
PROJECT_GFS2
, "GeekOS filesystem Close directory operation");

101  
EUNSUPPORTED
;

102 
	}
}

107 
	$GFS2_Ród_E¡ry
(
Fûe
 *
dú
, 
VFS_Dú_E¡ry
 *
íåy
) {

108 
	`TODO_P
(
PROJECT_GFS2
, "GeekOS filesystem Read_Entry operation");

109  
EUNSUPPORTED
;

110 
	}
}

112  
Fûe_Ops
 
	gs_gfs2DúOps
 = {

113 &
GFS2_FSèt
,

117 &
GFS2_Clo£_Dúe˘‹y
,

118 &
GFS2_Ród_E¡ry
,

126 
	$GFS2_O≥n
(
Mou¡_Poöt
 *
mou¡Poöt
, c⁄° *
∑th
,

127 
mode
, 
Fûe
 **
pFûe
) {

128 
	`TODO_P
(
PROJECT_GFS2
, "GeekOS filesystem open operation");

129  
EUNSUPPORTED
;

130 
	}
}

135 
	$GFS2_Cª©e_Dúe˘‹y
(
Mou¡_Poöt
 *
mou¡Poöt
,

136 c⁄° *
∑th
) {

137 
	`TODO_P
(
PROJECT_GFS2
, "GeekOS filesystem create directory operation");

138  
EUNSUPPORTED
;

139 
	}
}

144 
	$GFS2_O≥n_Dúe˘‹y
(
Mou¡_Poöt
 *
mou¡Poöt
,

145 c⁄° *
∑th
, 
Fûe
 **
pDú
) {

146 
	`TODO_P
(
PROJECT_GFS2
, "GeekOS filesystem open directory operation");

147  
EUNSUPPORTED
;

148 
	}
}

153 
	$GFS2_Dñëe
(
Mou¡_Poöt
 *
mou¡Poöt
, c⁄° *
∑th
,

154 
boﬁ
 
ªcursive
) {

155 
	`TODO_P
(
PROJECT_GFS2
, "GeekOS filesystem delete operation");

156  
EUNSUPPORTED
;

157 
	}
}

162 
	$GFS2_Sèt
(
Mou¡_Poöt
 *
mou¡Poöt
, c⁄° *
∑th
,

163 
VFS_Fûe_Sèt
 *
°©
) {

164 
	`TODO_P
(
PROJECT_GFS2
, "GeekOS filesystem stat operation");

165  
EUNSUPPORTED
;

166 
	}
}

172 
	$GFS2_Sync
(
Mou¡_Poöt
 *
mou¡Poöt
) {

173 
	`TODO_P
(
PROJECT_GFS2
, "GeekOS filesystem sync operation");

174  
EUNSUPPORTED
;

175 
	}
}

177 
	$GFS2_Disk_Pr›îtõs
(
Mou¡_Poöt
 *
mou¡Poöt
,

178 *
block_size
,

179 *
blocks_ö_disk
) {

180 
	`TODO_P
(
PROJECT_GFS2
,

182  
EUNSUPPORTED
;

183 
	}
}

185  
Mou¡_Poöt_Ops
 
	gs_gfs2Mou¡PoötOps
 = {

186 &
GFS2_O≥n
,

187 &
GFS2_Cª©e_Dúe˘‹y
,

188 &
GFS2_O≥n_Dúe˘‹y
,

189 &
GFS2_Sèt
,

190 &
GFS2_Sync
,

191 &
GFS2_Dñëe
,

197 &
GFS2_Disk_Pr›îtõs
,

200 
GFS2_F‹m©
(
Block_Devi˚
 *
blockDev
 
__©åibuã__
 ((
unu£d
))) {

201 
TODO_P
(
PROJECT_GFS2
,

203  
	gEUNSUPPORTED
;

206 
	$GFS2_Mou¡
(
Mou¡_Poöt
 *
mou¡Poöt
) {

207 
	`TODO_P
(
PROJECT_GFS2
, "GeekOS filesystem mount operation");

208  
EUNSUPPORTED
;

209 
	}
}

212 
Fûesy°em_Ops
 
	gs_gfs2Fûesy°emOps
 = {

213 &
GFS2_F‹m©
,

214 &
GFS2_Mou¡
,

221 
	$Inô_GFS2
() {

222 
	`Regi°î_Fûesy°em
("gfs2", &
s_gfs2Fûesy°emOps
);

223 
	}
}

	@gosfs.c

13 
	~<limôs.h
>

14 
	~<gìkos/î∫o.h
>

15 
	~<gìkos/kas£π.h
>

16 
	~<gìkos/s¸ìn.h
>

17 
	~<gìkos/mÆloc.h
>

18 
	~<gìkos/°rög.h
>

19 
	~<gìkos/bô£t.h
>

20 
	~<gìkos/synch.h
>

21 
	~<gìkos/bufˇche.h
>

22 
	~<gìkos/li°.h
>

23 
	~<gìkos/gosfs.h
>

24 
	~<gìkos/vfs.h
>

25 
	~<gìkos/°rög.h
>

26 
	~<gìkos/¥oje˘s.h
>

35 
	$GOSFS_F‹m©
(
Block_Devi˚
 *
blockDev
) {

36 
	`TODO_P
(
PROJECT_GOSFS
, "GeekOS file system Format operation");

37  
EUNSUPPORTED
;

38 
	}
}

44 
	$GOSFS_Mou¡
(
Mou¡_Poöt
 *
mou¡Poöt
) {

45 
	`TODO_P
(
PROJECT_GOSFS
, "GeekOS file system Mount operation");

46  
EUNSUPPORTED
;

47 
	}
}

52 
	$GOSFS_FSèt
(
Fûe
 *
fûe
, 
VFS_Fûe_Sèt
 *
°©
) {

53 
	`TODO_P
(
PROJECT_GOSFS
, "GeekOS file system FStat operation");

54  
EUNSUPPORTED
;

55 
	}
}

61 
	$GOSFS_O≥n
(
Mou¡_Poöt
 *
mp
, c⁄° *
c⁄°_∑th
, 
mode
,

62 
Fûe
 **
pFûe
) {

63 
	`TODO_P
(
PROJECT_GOSFS
, "GeekOS file system Open operation");

64  
EUNSUPPORTED
;

65 
	}
}

71 
	$GOSFS_Ród
(
Fûe
 *
fûe
, *
±r
, 
ul⁄g_t
 
numByãs
) {

72 
	`TODO_P
(
PROJECT_GOSFS
, "GeekOS file system Read operation");

73  
EUNSUPPORTED
;

74 
	}
}

80 
	$GOSFS_Wrôe
(
Fûe
 *
fûe
, *
±r
, 
ul⁄g_t
 
numByãs
) {

81 
	`TODO_P
(
PROJECT_GOSFS
, "GeekOS file system Write operation");

82  
EUNSUPPORTED
;

83 
	}
}

88 
	$GOSFS_Sèt
(
Mou¡_Poöt
 *
mou¡Poöt
, c⁄° *
∑th
,

89 
VFS_Fûe_Sèt
 *
°©
) {

90 
	`TODO_P
(
PROJECT_GOSFS
, "GeekOS file system Stat operation");

91  
EUNSUPPORTED
;

92 
	}
}

98 
	$GOSFS_Sync
(
Mou¡_Poöt
 *
mou¡Poöt
) {

99 
	`TODO_P
(
PROJECT_GOSFS
, "GeekOS file system Sync operation");

100  
EUNSUPPORTED
;

101 
	}
}

106 
	$GOSFS_Clo£
(
Fûe
 *
fûe
) {

107 
	`TODO_P
(
PROJECT_GOSFS
, "GeekOS file system Close operation");

108  
EUNSUPPORTED
;

109 
	}
}

114 
	$GOSFS_Cª©e_Dúe˘‹y
(
Mou¡_Poöt
 *
mp
, c⁄° *
c⁄°_∑th
) {

115 
	`TODO_P
(
PROJECT_GOSFS
, "GeekOS file system Create Directory operation");

116  
EUNSUPPORTED
;

117 
	}
}

122 
	$GOSFS_O≥n_Dúe˘‹y
(
Mou¡_Poöt
 *
mou¡Poöt
, c⁄° *
∑th
,

123 
Fûe
 **
pDú
) {

124 
	`TODO_P
(
PROJECT_GOSFS
, "GeekOS file system Open Directory operation");

125  
EUNSUPPORTED
;

126 
	}
}

131 
	$GOSFS_Sìk
(
Fûe
 *
fûe
, 
ul⁄g_t
 
pos
) {

132 
	`TODO_P
(
PROJECT_GOSFS
, "GeekOS file system Seek operation");

133  
EUNSUPPORTED
;

134 
	}
}

140 
	$GOSFS_Dñëe
(
Mou¡_Poöt
 *
mp
, c⁄° *
c⁄°_∑th
,

141 
boﬁ
 
ªcursive
) {

142 
	`TODO_P
(
PROJECT_GOSFS
, "GeekOS file system Delete operation");

143  
EUNSUPPORTED
;

144 
	}
}

147 
	$GOSFS_SëSëUid
(
Mou¡_Poöt
 *
mp
, c⁄° *
fûe
, 
£tuid
) {

148 
Fûe
 *
pFûe
;

150 
	`TODO_P
(
PROJECT_USER
, "GeekOS file system SetSetUID operation");

151  
EUNSUPPORTED
;

152 
	}
}

154 
	$GOSFS_SëA˛
(
Mou¡_Poöt
 *
mp
, c⁄° *
fûe
, 
uid
,

155 
≥rmissi⁄s
) {

156 
	`TODO_P
(
PROJECT_USER
, "GeekOS file system SetAcl operation");

157  
EUNSUPPORTED
;

158 
	}
}

163 
	$GOSFS_Ród_E¡ry
(
Fûe
 *
fûe
, 
VFS_Dú_E¡ry
 *
íåy
) {

164 
	`TODO_P
(
PROJECT_GOSFS
, "GeekOS file system Read Directory operation");

165  
EUNSUPPORTED
;

166 
	}
}

168 
Fûesy°em_Ops
 
	gs_gosfsFûesy°emOps
 = {

169 &
GOSFS_F‹m©
,

170 &
GOSFS_Mou¡
,

177 
	$Inô_GOSFS
() {

178 
	`Regi°î_Fûesy°em
("gosfs", &
s_gosfsFûesy°emOps
);

179 
	}
}

	@ide.c

21 
	~<gìkos/kty≥s.h
>

22 
	~<gìkos/kas£π.h
>

23 
	~<gìkos/î∫o.h
>

24 
	~<gìkos/mÆloc.h
>

25 
	~<gìkos/°rög.h
>

26 
	~<gìkos/io.h
>

27 
	~<gìkos/öt.h
>

28 
	~<gìkos/s¸ìn.h
>

29 
	~<gìkos/timî.h
>

30 
	~<gìkos/kthªad.h
>

31 
	~<gìkos/blockdev.h
>

32 
	~<gìkos/ide.h
>

35 
	#IDE_DATA_REGISTER
 0x1f0

	)

36 
	#IDE_ERROR_REGISTER
 0x1f1

	)

37 
	#IDE_FEATURE_REG
 
IDE_ERROR_REGISTER


	)

38 
	#IDE_SECTOR_COUNT_REGISTER
 0x1f2

	)

39 
	#IDE_SECTOR_NUMBER_REGISTER
 0x1f3

	)

40 
	#IDE_CYLINDER_LOW_REGISTER
 0x1f4

	)

41 
	#IDE_CYLINDER_HIGH_REGISTER
 0x1f5

	)

42 
	#IDE_DRIVE_HEAD_REGISTER
 0x1f6

	)

43 
	#IDE_STATUS_REGISTER
 0x1f7

	)

44 
	#IDE_COMMAND_REGISTER
 0x1f7

	)

45 
	#IDE_DEVICE_CONTROL_REGISTER
 0x3F6

	)

48 
	#IDE_DRIVE_BASE
 0xa0

	)

49 
	#IDE_DRIVE
(
driveNum
Ë(
IDE_DRIVE_BASE
 | (driveNum <<4))

	)

50 
	#IDE_MAX_DRIVES
 4

	)

54 
	#IDE_COMMAND_IDENTIFY_DRIVE
 0xEC

	)

55 
	#IDE_COMMAND_SEEK
 0x70

	)

56 
	#IDE_COMMAND_READ_SECTORS
 0x21

	)

57 
	#IDE_COMMAND_READ_BUFFER
 0xE4

	)

58 
	#IDE_COMMAND_WRITE_SECTORS
 0x30

	)

59 
	#IDE_COMMAND_WRITE_BUFFER
 0xE8

	)

60 
	#IDE_COMMAND_DIAGNOSTIC
 0x90

	)

61 
	#IDE_COMMAND_ATAPI_IDENT_DRIVE
 0xA1

	)

64 
	#IDE_INDENTIFY_NUM_CYLINDERS
 0x01

	)

65 
	#IDE_INDENTIFY_NUM_HEADS
 0x03

	)

66 
	#IDE_INDENTIFY_NUM_BYTES_TRACK
 0x04

	)

67 
	#IDE_INDENTIFY_NUM_BYTES_SECTOR
 0x05

	)

68 
	#IDE_INDENTIFY_NUM_SECTORS_TRACK
 0x06

	)

71 
	#IDE_STATUS_DRIVE_BUSY
 0x80

	)

72 
	#IDE_STATUS_DRIVE_READY
 0x40

	)

73 
	#IDE_STATUS_DRIVE_WRITE_FAULT
 0x20

	)

74 
	#IDE_STATUS_DRIVE_SEEK_COMPLETE
 0x10

	)

75 
	#IDE_STATUS_DRIVE_DATA_REQUEST
 0x08

	)

76 
	#IDE_STATUS_DRIVE_CORRECTED_DATA
 0x04

	)

77 
	#IDE_STATUS_DRIVE_INDEX
 0x02

	)

78 
	#IDE_STATUS_DRIVE_ERROR
 0x01

	)

81 
	#IDE_DCR_NOINTERRUPT
 0x02

	)

82 
	#IDE_DCR_RESET
 0x04

	)

85 
	#IDE_ERROR_NO_ERROR
 0

	)

86 
	#IDE_ERROR_BAD_DRIVE
 -1

	)

87 
	#IDE_ERROR_INVALID_BLOCK
 -2

	)

88 
	#IDE_ERROR_DRIVE_ERROR
 -3

	)

91 
	#IDE_CONTROL_REGISTER
 0x3F6

	)

92 
	#IDE_CONTROL_SOFTWARE_RESET
 0x04

	)

93 
	#IDE_CONTROL_INT_DISABLE
 0x02

	)

95 
	#LOW_BYTE
(
x
Ë(x & 0xff)

	)

96 
	#HIGH_BYTE
(
x
Ë((x >> 8Ë& 0xff)

	)

99 
	mnum_Cylödîs
;

100 
	mnum_Hóds
;

101 
	mnum_Se˘‹sPîTøck
;

102 
	mnum_ByãsPîSe˘‹
;

103 } 
	tideDisk
;

105 
	gideDebug
 = 0;

106 
	gnumDrives
;

107 
ideDisk
 
	gdrives
[
IDE_MAX_DRIVES
];

109 
Thªad_Queue
 
	gs_ideWaôQueue
;

110 
Block_Reque°_Li°
 
	gs_ideReque°Queue
;

116 
	$IDE_gëNumBlocks
(
driveNum
) {

117 i‡(
driveNum
 < 0 || driveNum > 
IDE_MAX_DRIVES
) {

118  
IDE_ERROR_BAD_DRIVE
;

121  (
drives
[
driveNum
].
num_Hóds
 *

122 
drives
[
driveNum
].
num_Se˘‹sPîTøck
 *

123 
drives
[
driveNum
].
num_Cylödîs
);

124 
	}
}

129 
	$IDE_Ród
(
driveNum
, 
blockNum
, *
buf„r
) {

130 
i
;

131 
hód
;

132 
£˘‹
;

133 
cylödî
;

134 *
buf„rW
;

135 
ªE«bÀ
 = 0;

137 i‡(
driveNum
 < 0 || driveNum > (
numDrives
 - 1)) {

138 i‡(
ideDebug
)

139 
	`Pröt
("ide: invÆid drivê%d\n", 
driveNum
);

140  
IDE_ERROR_BAD_DRIVE
;

143 i‡(
blockNum
 < 0 || blockNum >
	`IDE_gëNumBlocks
(
driveNum
)) {

144 i‡(
ideDebug
)

145 
	`Pröt
("ide: invÆid block %d\n", 
blockNum
);

146  
IDE_ERROR_INVALID_BLOCK
;

149 i‡(
	`I¡îru±s_E«bÀd
()) {

150 
	`DißbÀ_I¡îru±s
();

151 
ªE«bÀ
 = 1;

155 
£˘‹
 = 
blockNum
 % 
drives
[
driveNum
].
num_Se˘‹sPîTøck
 + 1;

156 
cylödî
 = 
blockNum
 / (
drives
[
driveNum
].
num_Hóds
 *

157 
drives
[
driveNum
].
num_Se˘‹sPîTøck
);

158 
hód
 = (
blockNum
 / 
drives
[
driveNum
].
num_Se˘‹sPîTøck
) %

159 
drives
[
driveNum
].
num_Hóds
;

161 i‡(
ideDebug
 >= 2) {

162 
	`Pröt
("ªque°Åÿªad block %d\n", 
blockNum
);

163 
	`Pröt
(" hód %d\n", 
hód
);

164 
	`Pröt
(" cylödî %d\n", 
cylödî
);

165 
	`Pröt
(" se˘‹ %d\n", 
£˘‹
);

168 
	`Out_Byã
(
IDE_SECTOR_COUNT_REGISTER
, 1);

169 
	`Out_Byã
(
IDE_SECTOR_NUMBER_REGISTER
, 
£˘‹
);

170 
	`Out_Byã
(
IDE_CYLINDER_LOW_REGISTER
, 
	`LOW_BYTE
(
cylödî
));

171 
	`Out_Byã
(
IDE_CYLINDER_HIGH_REGISTER
, 
	`HIGH_BYTE
(
cylödî
));

172 
	`Out_Byã
(
IDE_DRIVE_HEAD_REGISTER
, 
	`IDE_DRIVE
(
driveNum
Ë| 
hód
);

174 
	`Out_Byã
(
IDE_COMMAND_REGISTER
, 
IDE_COMMAND_READ_SECTORS
);

176 i‡(
ideDebug
 > 2)

177 
	`Pröt
("AboutÅo wait for Read \n");

180 
	`In_Byã
(
IDE_STATUS_REGISTER
Ë& 
IDE_STATUS_DRIVE_BUSY
);

182 i‡(
	`In_Byã
(
IDE_STATUS_REGISTER
Ë& 
IDE_STATUS_DRIVE_ERROR
) {

183 
	`Pröt
("ERROR: GŸ Ród %d\n", 
	`In_Byã
(
IDE_STATUS_REGISTER
));

184  
IDE_ERROR_DRIVE_ERROR
;

187 i‡(
ideDebug
 > 2)

188 
	`Pröt
("got buffer \n");

190 
buf„rW
 = (*)
buf„r
;

191 
i
 = 0; i < 256; i++) {

192 
buf„rW
[
i
] = 
	`In_W‹d
(
IDE_DATA_REGISTER
);

195 i‡(
ªE«bÀ
)

196 
	`E«bÀ_I¡îru±s
();

198  
IDE_ERROR_NO_ERROR
;

199 
	}
}

204 
	$IDE_Wrôe
(
driveNum
, 
blockNum
, *
buf„r
) {

205 
i
;

206 
hód
;

207 
£˘‹
;

208 
cylödî
;

209 *
buf„rW
;

210 
ªE«bÀ
 = 0;

212 i‡(
driveNum
 < 0 || driveNum > (
numDrives
 - 1)) {

213  
IDE_ERROR_BAD_DRIVE
;

216 i‡(
blockNum
 < 0 || blockNum >
	`IDE_gëNumBlocks
(
driveNum
)) {

217  
IDE_ERROR_INVALID_BLOCK
;

220 i‡(
	`I¡îru±s_E«bÀd
()) {

221 
	`DißbÀ_I¡îru±s
();

222 
ªE«bÀ
 = 1;

226 
£˘‹
 = 
blockNum
 % 
drives
[
driveNum
].
num_Se˘‹sPîTøck
 + 1;

227 
cylödî
 = 
blockNum
 / (
drives
[
driveNum
].
num_Hóds
 *

228 
drives
[
driveNum
].
num_Se˘‹sPîTøck
);

229 
hód
 = (
blockNum
 / 
drives
[
driveNum
].
num_Se˘‹sPîTøck
) %

230 
drives
[
driveNum
].
num_Hóds
;

232 i‡(
ideDebug
) {

233 
	`Pröt
("ªque°Åÿwrôêblock %d\n", 
blockNum
);

234 
	`Pröt
(" hód %d\n", 
hód
);

235 
	`Pröt
(" cylödî %d\n", 
cylödî
);

236 
	`Pröt
(" se˘‹ %d\n", 
£˘‹
);

239 
	`Out_Byã
(
IDE_SECTOR_COUNT_REGISTER
, 1);

240 
	`Out_Byã
(
IDE_SECTOR_NUMBER_REGISTER
, 
£˘‹
);

241 
	`Out_Byã
(
IDE_CYLINDER_LOW_REGISTER
, 
	`LOW_BYTE
(
cylödî
));

242 
	`Out_Byã
(
IDE_CYLINDER_HIGH_REGISTER
, 
	`HIGH_BYTE
(
cylödî
));

243 
	`Out_Byã
(
IDE_DRIVE_HEAD_REGISTER
, 
	`IDE_DRIVE
(
driveNum
Ë| 
hód
);

245 
	`Out_Byã
(
IDE_COMMAND_REGISTER
, 
IDE_COMMAND_WRITE_SECTORS
);

249 
	`In_Byã
(
IDE_STATUS_REGISTER
Ë& 
IDE_STATUS_DRIVE_BUSY
);

251 
buf„rW
 = (*)
buf„r
;

252 
i
 = 0; i < 256; i++) {

253 
	`Out_W‹d
(
IDE_DATA_REGISTER
, 
buf„rW
[
i
]);

256 i‡(
ideDebug
)

257 
	`Pröt
("AboutÅo wait for Write \n");

260 
	`In_Byã
(
IDE_STATUS_REGISTER
Ë& 
IDE_STATUS_DRIVE_BUSY
);

262 i‡(
	`In_Byã
(
IDE_STATUS_REGISTER
Ë& 
IDE_STATUS_DRIVE_ERROR
) {

263 
	`Pröt
("ERROR: GŸ Ród %d\n", 
	`In_Byã
(
IDE_STATUS_REGISTER
));

264  
IDE_ERROR_DRIVE_ERROR
;

267 i‡(
ideDebug
)

268 
	`Pröt
("write completed \n");

270 i‡(
ªE«bÀ
)

271 
	`E«bÀ_I¡îru±s
();

273  
IDE_ERROR_NO_ERROR
;

274 
	}
}

276 
	$IDE_O≥n
(
Block_Devi˚
 *
dev
) {

277 
	`KASSERT
(!
dev
->
öU£
);

279 
	}
}

281 
	$IDE_Clo£
(
Block_Devi˚
 *
dev
) {

282 
	`KASSERT
(
dev
->
öU£
);

284 
	}
}

286 
	$IDE_Gë_Num_Blocks
(
Block_Devi˚
 *
dev
) {

287  
	`IDE_gëNumBlocks
(
dev
->
unô
);

288 
	}
}

290 
Block_Devi˚_Ops
 
	gs_ideDevi˚Ops
 = {

291 
IDE_O≥n
,

292 
IDE_Clo£
,

293 
IDE_Gë_Num_Blocks
,

296 
IDE_Reque°_Thªad
(
ul⁄g_t
 
¨g
 
__©åibuã__
 ((
unu£d
))) {

298 
Block_Reque°
 *
	gªque°
;

299 
	grc
;

302 
	gªque°
 = 
Dequeue_Reque°
(&
s_ideReque°Queue
, &
s_ideWaôQueue
);

305 i‡(
	gªque°
->
	gty≥
 =
BLOCK_READ
)

306 
rc
 = 
IDE_Ród
(
ªque°
->
dev
->
unô
,Ñeque°->
blockNum
,

307 
ªque°
->
buf
);

309 
	grc
 = 
IDE_Wrôe
(
ªque°
->
dev
->
unô
,Ñeque°->
blockNum
,

310 
ªque°
->
buf
);

313 
NŸify_Reque°_Com∂ëi⁄
(
ªque°
, 
rc
 =0 ? 
COMPLETED
 : 
ERROR
,Ñc);

317 
	$ªadDriveC⁄fig
(
drive
) {

318 
i
;

319 
°©us
;

320 
öfo
[256];

321 
dev«me
[
BLOCKDEV_MAX_NAME_LEN
];

322 
rc
;

324 i‡(
ideDebug
 > 1)

325 
	`Pröt
("ide:ábouàtÿªad drivêc⁄fig f‹ drivê#%d\n", 
drive
);

327 
	`Out_Byã
(
IDE_DRIVE_HEAD_REGISTER
, 
	`IDE_DRIVE
(
drive
));

328 
	`Out_Byã
(
IDE_COMMAND_REGISTER
, 
IDE_COMMAND_IDENTIFY_DRIVE
);

329 
	`In_Byã
(
IDE_STATUS_REGISTER
Ë& 
IDE_STATUS_DRIVE_BUSY
);

331 
°©us
 = 
	`In_Byã
(
IDE_STATUS_REGISTER
);

336 i‡((
°©us
 & 
IDE_STATUS_DRIVE_DATA_REQUEST
)) {

337 
	`Pröt
("ide:Örobe found ATA drive: ");

339 
i
 = 0; i < 256; i++) {

340 
öfo
[
i
] = 
	`In_W‹d
(
IDE_DATA_REGISTER
);

343 
drives
[
drive
].
num_Cylödîs
 = 
öfo
[
IDE_INDENTIFY_NUM_CYLINDERS
];

344 
drives
[
drive
].
num_Hóds
 = 
öfo
[
IDE_INDENTIFY_NUM_HEADS
];

345 
drives
[
drive
].
num_Se˘‹sPîTøck
 =

346 
öfo
[
IDE_INDENTIFY_NUM_SECTORS_TRACK
];

347 
drives
[
drive
].
num_ByãsPîSe˘‹
 =

348 
öfo
[
IDE_INDENTIFY_NUM_BYTES_SECTOR
];

351 
	`Out_Byã
(
IDE_FEATURE_REG
, 0);

353 
	`Out_Byã
(
IDE_DRIVE_HEAD_REGISTER
, 
	`IDE_DRIVE
(
drive
));

354 
	`Out_Byã
(
IDE_COMMAND_REGISTER
, 
IDE_COMMAND_ATAPI_IDENT_DRIVE
);

355 
	`In_Byã
(
IDE_STATUS_REGISTER
Ë& 
IDE_STATUS_DRIVE_BUSY
);

356 
°©us
 = 
	`In_Byã
(
IDE_STATUS_REGISTER
);

357 
	`Pröt
("°©u†i†%x\n", 
°©us
);

358 i‡((
°©us
 & 
IDE_STATUS_DRIVE_DATA_REQUEST
)) {

359 
	`Pröt
("ide: foundátapi drive\n");

361 
	`Pröt
("ide: foundÇÿdrivê%d\n", 
drive
);

366 
	`Pröt
(" ide%d: cyl=%d, hóds=%d, se˘‹s=%d\n", 
drive
,

367 
drives
[
drive
].
num_Cylödîs
, drives[drive].
num_Hóds
,

368 
drives
[
drive
].
num_Se˘‹sPîTøck
);

371 
	`¢¥ötf
(
dev«me
, (dev«me), "ide%d", 
drive
);

372 
rc
 = 
	`Regi°î_Block_Devi˚
(
dev«me
, &
s_ideDevi˚Ops
, 
drive
, 0,

373 &
s_ideWaôQueue
, &
s_ideReque°Queue
);

374 i‡(
rc
 != 0)

375 
	`Pröt
(" Eº‹: couldÇŸ cª©êblock devi˚ f‹ %s\n", 
dev«me
);

378 
	}
}

381 
	$Inô_IDE
() {

382 
îr‹Code
;

384 
	`Pröt
("Initializing IDE controller...\n");

387 
	`Out_Byã
(
IDE_DEVICE_CONTROL_REGISTER
,

388 
IDE_DCR_NOINTERRUPT
 | 
IDE_DCR_RESET
);

389 
	`Mi¸o_Dñay
(100);

390 
	`Out_Byã
(
IDE_DEVICE_CONTROL_REGISTER
, 
IDE_DCR_NOINTERRUPT
);

399 
	`In_Byã
(
IDE_STATUS_REGISTER
Ë& 
IDE_STATUS_DRIVE_BUSY
);

401 i‡(
ideDebug
)

402 
	`Pröt
("AboutÅoÑun drive Diagnosis\n");

404 
	`Out_Byã
(
IDE_COMMAND_REGISTER
, 
IDE_COMMAND_DIAGNOSTIC
);

405 
	`In_Byã
(
IDE_STATUS_REGISTER
Ë& 
IDE_STATUS_DRIVE_BUSY
);

406 
îr‹Code
 = 
	`In_Byã
(
IDE_ERROR_REGISTER
);

407 i‡(
ideDebug
 > 1)

408 
	`Pröt
("ide: idêîr‹Ñegi°î = %x\n", 
îr‹Code
);

411 
i
;

412 
i
 = 0; i < 
IDE_MAX_DRIVES
; i++) {

413 i‡(
	`ªadDriveC⁄fig
(
i
) == 0)

414 ++
numDrives
;

416 i‡(
ideDebug
)

417 
	`Pröt
("Found %d IDE drives\n", 
numDrives
);

420 i‡(
numDrives
 > 0)

421 
	`Sèπ_Kî√l_Thªad
(
IDE_Reque°_Thªad
, 0, 
PRIORITY_NORMAL
, 
åue
,

423 
	}
}

	@idt.c

10 
	~<gìkos/kas£π.h
>

11 
	~<gìkos/defs.h
>

12 
	~<gìkos/idt.h
>

13 
	~<gìkos/smp.h
>

22 
IDT_Des¸ùt‹
 
	gs_IDT
[4][
NUM_IDT_ENTRIES
];

30 
g_íåyPoötTabÀSèπ
, 
g_íåyPoötTabÀEnd
;

31 
g_h™dÀrSizeNoEº
, 
g_h™dÀrSizeEº
;

38 
I¡îru±_H™dÀr
 
	gg_öãºu±TabÀ
[
NUM_IDT_ENTRIES
];

51 
	$Inô_IDT
(
˝uID
) {

52 
i
;

53 
ush‹t_t
 
limôAndBa£
[3];

55 
	`KASSERT0
(
˝uID
 < 4, "Only supports upÅo 4 coresÑightÇow");

56 
ul⁄g_t
 
idtBa£Addr
 = (ul⁄g_tË
s_IDT
[
˝uID
];

57 
ul⁄g_t
 
èbÀBa£Addr
 = (ul⁄g_tË& 
g_íåyPoötTabÀSèπ
;

58 
ul⁄g_t
 
addr
;

60 
	`Pröt
("Initializing IDT...\n");

63 
	`KASSERT
(
g_h™dÀrSizeNoEº
 =
g_h™dÀrSizeEº
);

64 
	`KASSERT
((&
g_íåyPoötTabÀEnd
 - &
g_íåyPoötTabÀSèπ
) ==

65 
g_h™dÀrSizeNoEº
 * 
NUM_IDT_ENTRIES
);

73 
i
 = 0, 
addr
 = 
èbÀBa£Addr
; i < 
NUM_IDT_ENTRIES
; ++i) {

78 
d∂
 = (
i
 =
SYSCALL_INT
Ë? 
USER_PRIVILEGE
 : 
KERNEL_PRIVILEGE
;

79 
	`Inô_I¡îru±_G©e
(&
s_IDT
[
˝uID
][
i
], 
addr
, 
d∂
);

80 
addr
 +
g_h™dÀrSizeNoEº
;

87 
limôAndBa£
[0] = 8 * 
NUM_IDT_ENTRIES
;

88 
limôAndBa£
[1] = 
idtBa£Addr
 & 0xffff;

89 
limôAndBa£
[2] = 
idtBa£Addr
 >> 16;

92 
	`Lﬂd_IDTR
(
limôAndBa£
);

93 
	}
}

99 
	$Inô_I¡îru±_G©e
(
IDT_Des¸ùt‹
 *
desc
, 
ul⁄g_t
 
addr
, 
d∂
) {

100 
	`KASSERT
(
desc
);

101 
desc
->
ig
.
off£tLow
 = 
addr
 & 0xffff;

102 
desc
->
ig
.
£gmítSñe˘‹
 = 
KERNEL_CS
;

103 
desc
->
ig
.
ª£rved
 = 0;

104 
desc
->
ig
.
sig«tuª
 = 0x70;

105 
desc
->
ig
.
d∂
 = dpl;

106 
desc
->
ig
.
¥e£¡
 = 1;

107 
desc
->
ig
.
off£tHigh
 = 
addr
 >> 16;

108 
	}
}

116 
	$In°Æl_I¡îru±_H™dÀr
(
öãºu±
, 
I¡îru±_H™dÀr
 
h™dÀr
) {

117 
	`KASSERT
(
öãºu±
 >0 && i¡îru± < 
NUM_IDT_ENTRIES
);

118 
g_öãºu±TabÀ
[
öãºu±
] = 
h™dÀr
;

119 
	}
}

	@int.c

10 
	~<gìkos/idt.h
>

11 
	~<gìkos/s¸ìn.h
>

12 
	~<gìkos/kas£π.h
>

13 
	~<gìkos/∑gög.h
>

14 
	~<gìkos/öt.h
>

19 
ul⁄g_t
 
Gë_Cuºít_EFLAGS
();

30 
	$Dummy_I¡îru±_H™dÀr
(
I¡îru±_Sèã
 *
°©e
) {

31 
	`Pröt
("*** Unexpected interrupt! ***\n");

32 
	`Dump_I¡îru±_Sèã
(
°©e
);

33 
	`STOP
();

34 
	}
}

36 
	$Pröt_Sñe˘‹
(c⁄° *
ªgName
, 
uöt_t
 
vÆue
)

37 
	`__©åibuã__
 ((
unu£d
));

38 
	$Pröt_Sñe˘‹
(c⁄° *
ªgName
, 
uöt_t
 
vÆue
) {

39 
	`Pröt
("%s: index=%d,Åi=%d,Ñpl=%d\n",

40 
ªgName
, 
vÆue
 >> 3, (value >> 2) & 1, value & 3);

41 
	}
}

50 
	$Inô_I¡îru±s
(
˝uID
) {

51 
i
;

54 
	`Inô_IDT
(
˝uID
);

56 i‡(!
˝uID
) {

61 
i
 = 0; i < 
NUM_IDT_ENTRIES
; ++i) {

62 
	`In°Æl_I¡îru±_H™dÀr
(
i
, 
Dummy_I¡îru±_H™dÀr
);

68 
	`__E«bÀ_I¡îru±s
();

69 
	}
}

74 
boﬁ
 
	$I¡îru±s_E«bÀd
() {

75 
ul⁄g_t
 
eÊags
 = 
	`Gë_Cuºít_EFLAGS
();

76  (
eÊags
 & 
EFLAGS_IF
) != 0;

77 
	}
}

82 
	$Dump_I¡îru±_Sèã
(
I¡îru±_Sèã
 *
°©e
) {

83 
uöt_t
 
îr‹Code
 = 
°©e
->errorCode;

85 
	`Pröt
("eax=%08xÉbx=%08xÉcx=%08xÉdx=%08x\n"

90 
°©e
->
óx
, sèã->
ebx
, sèã->
ecx
, sèã->
edx
,

91 
°©e
->
esi
, sèã->
edi
, sèã->
ebp
,

92 
°©e
->
eù
, sèã->
cs
, sèã->
eÊags
,

93 
°©e
->
ötNum
, 
îr‹Code
,

94 
îr‹Code
 >> 3, (errorCode >> 2) & 1, (errorCode >> 1) & 1,

95 
îr‹Code
 & 1);

96 i‡(
	`Is_U£r_I¡îru±
(
°©e
)) {

97 
U£r_I¡îru±_Sèã
 *
u°©e
 =

98 (
U£r_I¡îru±_Sèã
 *)
°©e
;

99 
	`Pröt
("u£∏e•=%08x, u£∏ss=%08x\n", 
u°©e
->
e•U£r
,

100 
u°©e
->
ssU£r
);

102 i‡(
°©e
->
ötNum
 == 14) {

105 
Áu…code_t
 
pfEº‹Code
;

106 
vÆue
;

107 } 
u
;

109 
u
.
vÆue
 = 
îr‹Code
;

110 
	`Pröt
("Page fault: ");

111 i‡(
u
.
pfEº‹Code
.
¥Ÿe˘i⁄Viﬁ©i⁄
)

112 
	`Pröt
("[protection]");

113 
	`Pröt
("[%s]", 
u
.
pfEº‹Code
.
wrôeFau…
 ? "write" : "read");

114 i‡(
u
.
pfEº‹Code
.
u£rModeFau…
)

115 
	`Pröt
("[user mode]");

116 
	`Pröt
("[addªss=%lx]\n", 
	`Gë_Page_Fau…_Addªss
());

118 
	`H¨dw¨e_Shutdown
();

119 
submôTe°ög
;

121 i‡(
submôTe°ög
)

122 
	`H¨dw¨e_Shutdown
();

123 
	`Pröt_Sñe˘‹
("cs", 
°©e
->
cs
);

124 
	`Pröt_Sñe˘‹
("ds", 
°©e
->
ds
);

125 
	`Pröt_Sñe˘‹
("es", 
°©e
->
es
);

126 
	`Pröt_Sñe˘‹
("fs", 
°©e
->
fs
);

127 
	`Pröt_Sñe˘‹
("gs", 
°©e
->
gs
);

128 
	}
}

	@io.c

10 
	~<gìkos/io.h
>

15 
	$Out_Byã
(
ush‹t_t
 
p‹t
, 
uch¨_t
 
vÆue
) {

16 
__asm__
 
	`__vﬁ©ûe__
("outb %b0, %w1"::"a"(
vÆue
), "Nd"(
p‹t
)

18 
	}
}

23 
uch¨_t
 
	$In_Byã
(
ush‹t_t
 
p‹t
) {

24 
uch¨_t
 
vÆue
;

26 
__asm__
 
	`__vﬁ©ûe__
("öb %w1, %b0":"˜"(
vÆue
)

27 :"Nd"(
p‹t
)

30  
vÆue
;

31 
	}
}

36 
	$Out_W‹d
(
ush‹t_t
 
p‹t
, ush‹t_à
vÆue
) {

37 
__asm__
 
	`__vﬁ©ûe__
("outw %w0, %w1"::"a"(
vÆue
), "Nd"(
p‹t
)

39 
	}
}

44 
ush‹t_t
 
	$In_W‹d
(
ush‹t_t
 
p‹t
) {

45 
ush‹t_t
 
vÆue
;

47 
__asm__
 
	`__vﬁ©ûe__
("öw %w1, %w0":"˜"(
vÆue
)

48 :"Nd"(
p‹t
)

51  
vÆue
;

52 
	}
}

58 
	$IO_Dñay
() {

59 
uch¨_t
 
vÆue
 = 0;

60 
__asm__
 
	`__vﬁ©ûe__
("outb %0, $0x80"::"a"(
vÆue
)

62 
	}
}

	@irq.c

21 
	~<gìkos/kas£π.h
>

22 
	~<gìkos/idt.h
>

23 
	~<gìkos/io.h
>

24 
	~<gìkos/úq.h
>

25 
	~<gìkos/smp.h
>

36 
ush‹t_t
 
	gs_úqMask
 = 0xff7b;

41 
	#MASTER
(
mask
Ë((maskË& 0xff)

	)

42 
	#SLAVE
(
mask
Ë(((mask)>>8Ë& 0xff)

	)

53 
	$In°Æl_IRQ
(
úq
, 
I¡îru±_H™dÀr
 
h™dÀr
) {

54 
	`M≠_IO_APIC_IRQ
(
úq
, 
h™dÀr
);

55 
	}
}

61 
ush‹t_t
 
	$Gë_IRQ_Mask
() {

62  
s_úqMask
;

63 
	}
}

68 
	$Së_IRQ_Mask
(
ush‹t_t
 
mask
) {

69 
uch¨_t
 
ﬁdMask
, 
√wMask
;

71 
ﬁdMask
 = 
	`MASTER
(
s_úqMask
);

72 
√wMask
 = 
	`MASTER
(
mask
);

73 i‡(
√wMask
 !
ﬁdMask
) {

74 
	`Out_Byã
(0x21, 
√wMask
);

77 
ﬁdMask
 = 
	`SLAVE
(
s_úqMask
);

78 
√wMask
 = 
	`SLAVE
(
mask
);

79 i‡(
√wMask
 !
ﬁdMask
) {

80 
	`Out_Byã
(0xA1, 
√wMask
);

83 
s_úqMask
 = 
mask
;

84 
	}
}

89 
	$E«bÀ_IRQ
(
úq
) {

90 
boﬁ
 
iÊag
 = 
	`Begö_I¡_Atomic
();

91 
ush‹t_t
 
mask
 = 
	`Gë_IRQ_Mask
();

93 
	`KASSERT
(
úq
 >= 0 && irq <= 32);

94 
mask
 &~(1 << 
úq
);

95 
	`Së_IRQ_Mask
(
mask
);

97 
	`End_I¡_Atomic
(
iÊag
);

98 
	}
}

103 
	$DißbÀ_IRQ
(
úq
) {

104 
boﬁ
 
iÊag
 = 
	`Begö_I¡_Atomic
();

105 
ush‹t_t
 
mask
 = 
	`Gë_IRQ_Mask
();

107 
	`KASSERT
(
úq
 >= 0 && irq < 16);

108 
mask
 |(1 << 
úq
);

109 
	`Së_IRQ_Mask
(
mask
);

111 
	`End_I¡_Atomic
(
iÊag
);

112 
	}
}

118 
Begö_IRQ
(
I¡îru±_Sèã
 *
°©e
 
__©åibuã__
 ((
unu£d
))) {

125 
	$End_IRQ
(
I¡îru±_Sèã
 *
°©e
) {

126 
úq
 = 
°©e
->
ötNum
 - 
FIRST_EXTERNAL_INT
;

127 
uch¨_t
 
comm™d
 = 0x60 | (
úq
 & 0x7);

129 i‡(
úq
 < 8) {

131 
	`Out_Byã
(0x20, 
comm™d
);

134 
	`Out_Byã
(0xA0, 
comm™d
);

135 
	`Out_Byã
(0x20, 0x62);

137 
	}
}

	@keyboard.c

33 
	~<gìkos/kthªad.h
>

34 
	~<gìkos/kas£π.h
>

35 
	~<gìkos/s¸ìn.h
>

36 
	~<gìkos/úq.h
>

37 
	~<gìkos/io.h
>

38 
	~<gìkos/keybﬂrd.h
>

40 
	#DEBUG_KEYBOARD
(
x
...)

	)

50 
	#LEFT_SHIFT
 0x01

	)

51 
	#RIGHT_SHIFT
 0x02

	)

52 
	#LEFT_CTRL
 0x04

	)

53 
	#RIGHT_CTRL
 0x08

	)

54 
	#LEFT_ALT
 0x10

	)

55 
	#RIGHT_ALT
 0x20

	)

56 
	#SHIFT_MASK
 (
LEFT_SHIFT
 | 
RIGHT_SHIFT
)

	)

57 
	#CTRL_MASK
 (
LEFT_CTRL
 | 
RIGHT_CTRL
)

	)

58 
	#ALT_MASK
 (
LEFT_ALT
 | 
RIGHT_ALT
)

	)

59 
	gs_shi·Sèã
 = 0;

65 
	#QUEUE_SIZE
 256

	)

66 
	#QUEUE_MASK
 0xff

	)

67 
	#NEXT
(
ödex
Ë(((ödexË+ 1Ë& 
QUEUE_MASK
)

	)

68 
Keycode
 
	gs_queue
[
QUEUE_SIZE
];

69 
	gs_queueHód
, 
	gs_queueTaû
;

74 
Thªad_Queue
 
	gs_waôQueue
;

79 c⁄° 
Keycode
 
	gs_sˇnTabÀNoShi·
[] = {

80 
KEY_UNKNOWN
, 
ASCII_ESC
, '1', '2',

83 '-', '=', 
ASCII_BS
, '\t',

87 '\r', 
KEY_LCTRL
, 'a', 's',

90 '\'', '`', 
KEY_LSHIFT
, '\\',

93 '.', '/', 
KEY_RSHIFT
, 
KEY_PRINTSCRN
,

94 
KEY_LALT
, ' ', 
KEY_CAPSLOCK
, 
KEY_F1
,

95 
KEY_F2
, 
KEY_F3
, 
KEY_F4
, 
KEY_F5
,

96 
KEY_F6
, 
KEY_F7
, 
KEY_F8
, 
KEY_F9
,

97 
KEY_F10
, 
KEY_NUMLOCK
, 
KEY_SCRLOCK
, 
KEY_KPHOME
,

98 
KEY_KPUP
, 
KEY_KPPGUP
, 
KEY_KPMINUS
, 
KEY_KPLEFT
,

99 
KEY_KPCENTER
, 
KEY_KPRIGHT
, 
KEY_KPPLUS
, 
KEY_KPEND
,

100 
KEY_KPDOWN
, 
KEY_KPPGDN
, 
KEY_KPINSERT
, 
KEY_KPDEL
,

101 
KEY_SYSREQ
, 
KEY_UNKNOWN
, KEY_UNKNOWN, KEY_UNKNOWN,

104 
	#SCAN_TABLE_SIZE
 ((
s_sˇnTabÀNoShi·
Ë/ (
Keycode
))

	)

111 c⁄° 
Keycode
 
	gs_sˇnTabÀWôhShi·
[] = {

112 
KEY_UNKNOWN
, 
ASCII_ESC
, '!', '@',

115 '_', '+', 
ASCII_BS
, '\t',

119 '\r', 
KEY_LCTRL
, 'A', 'S',

122 '"', '~', 
KEY_LSHIFT
, '|',

125 '>', '?', 
KEY_RSHIFT
, 
KEY_PRINTSCRN
,

126 
KEY_LALT
, ' ', 
KEY_CAPSLOCK
, 
KEY_F1
,

127 
KEY_F2
, 
KEY_F3
, 
KEY_F4
, 
KEY_F5
,

128 
KEY_F6
, 
KEY_F7
, 
KEY_F8
, 
KEY_F9
,

129 
KEY_F10
, 
KEY_NUMLOCK
, 
KEY_SCRLOCK
, 
KEY_KPHOME
,

130 
KEY_KPUP
, 
KEY_KPPGUP
, 
KEY_KPMINUS
, 
KEY_KPLEFT
,

131 
KEY_KPCENTER
, 
KEY_KPRIGHT
, 
KEY_KPPLUS
, 
KEY_KPEND
,

132 
KEY_KPDOWN
, 
KEY_KPPGDN
, 
KEY_KPINSERT
, 
KEY_KPDEL
,

133 
KEY_SYSREQ
, 
KEY_UNKNOWN
, KEY_UNKNOWN, KEY_UNKNOWN,

137 c⁄° 
Keycode
 
	gs_sˇnTabÀE0
[] = {

138 
KEY_UNKNOWN
, KEY_UNKNOWN, KEY_UNKNOWN, KEY_UNKNOWN,

139 
KEY_UNKNOWN
, KEY_UNKNOWN, KEY_UNKNOWN, KEY_UNKNOWN,

140 
KEY_UNKNOWN
, KEY_UNKNOWN, KEY_UNKNOWN, KEY_UNKNOWN,

141 
KEY_UNKNOWN
, KEY_UNKNOWN, KEY_UNKNOWN, KEY_UNKNOWN,

142 
KEY_UNKNOWN
, KEY_UNKNOWN, KEY_UNKNOWN, KEY_UNKNOWN,

143 
KEY_UNKNOWN
, KEY_UNKNOWN, KEY_UNKNOWN, KEY_UNKNOWN,

144 
KEY_UNKNOWN
, KEY_UNKNOWN, KEY_UNKNOWN, KEY_UNKNOWN,

145 
KEY_UNKNOWN
, 
KEY_RCTRL
, KEY_UNKNOWN, KEY_UNKNOWN,

146 
KEY_UNKNOWN
, KEY_UNKNOWN, KEY_UNKNOWN, KEY_UNKNOWN,

147 
KEY_UNKNOWN
, KEY_UNKNOWN, KEY_UNKNOWN, KEY_UNKNOWN,

148 
KEY_UNKNOWN
, KEY_UNKNOWN, KEY_UNKNOWN, KEY_UNKNOWN,

149 
KEY_UNKNOWN
, KEY_UNKNOWN, KEY_UNKNOWN, KEY_UNKNOWN,

150 
KEY_UNKNOWN
, KEY_UNKNOWN, KEY_UNKNOWN, KEY_UNKNOWN,

151 
KEY_UNKNOWN
, KEY_UNKNOWN, KEY_UNKNOWN, KEY_UNKNOWN,

152 
KEY_RALT
, 
KEY_UNKNOWN
, KEY_UNKNOWN, KEY_UNKNOWN,

153 
KEY_UNKNOWN
, KEY_UNKNOWN, KEY_UNKNOWN, KEY_UNKNOWN,

154 
KEY_UNKNOWN
, KEY_UNKNOWN, KEY_UNKNOWN, KEY_UNKNOWN,

155 
KEY_UNKNOWN
, KEY_UNKNOWN, KEY_UNKNOWN, KEY_UNKNOWN,

156 
KEY_KPUP
, 
KEY_KPPGUP
, 
KEY_KPMINUS
, 
KEY_KPLEFT
,

157 
KEY_KPCENTER
, 
KEY_KPRIGHT
, 
KEY_KPPLUS
, 
KEY_KPEND
,

158 
KEY_KPDOWN
, 
KEY_KPPGDN
, 
KEY_KPINSERT
, 
KEY_KPDEL
,

159 
KEY_UNKNOWN
, KEY_UNKNOWN, KEY_UNKNOWN, KEY_UNKNOWN,

162 
__ölöe__
 
boﬁ
 
	$Is_Queue_Em±y
() {

163  
s_queueHód
 =
s_queueTaû
;

164 
	}
}

166 
__ölöe__
 
boﬁ
 
	$Is_Queue_FuŒ
() {

167  
	`NEXT
(
s_queueTaû
Ë=
s_queueHód
;

168 
	}
}

170 
__ölöe__
 
	$Enqueue_Keycode
(
Keycode
 
keycode
) {

171 i‡(!
	`Is_Queue_FuŒ
()) {

172 
s_queue
[
s_queueTaû
] = 
keycode
;

173 
s_queueTaû
 = 
	`NEXT
(s_queueTail);

175 
	}
}

177 
__ölöe__
 
Keycode
 
	$Dequeue_Keycode
() {

178 
Keycode
 
ªsu…
;

179 
	`KASSERT
(!
	`Is_Queue_Em±y
());

180 
ªsu…
 = 
s_queue
[
s_queueHód
];

181 
s_queueHód
 = 
	`NEXT
(s_queueHead);

182  
ªsu…
;

183 
	}
}

188 
	$Keybﬂrd_I¡îru±_H™dÀr
(
I¡îru±_Sèã
 *
°©e
) {

189 
uch¨_t
 
°©us
, 
sˇnCode
;

190 
Êag
 = 0;

191 
boﬁ
 
ªÀa£
 = 
Ál£
, 
shi·
;

192 
Keycode
 
keycode
;

194 
	`Begö_IRQ
(
°©e
);

196 
°©us
 = 
	`In_Byã
(
KB_CMD
);

197 
	`IO_Dñay
();

199 i‡((
°©us
 & 
KB_OUTPUT_FULL
) != 0) {

201 
sˇnCode
 = 
	`In_Byã
(
KB_DATA
);

202 
	`IO_Dñay
();

204 
	`DEBUG_KEYBOARD
("code=%x%s\n", 
sˇnCode
,

205 (
sˇnCode
 & 0x80) ? " [release]" : "");

207 
shi·
 = ((
s_shi·Sèã
 & 
SHIFT_MASK
) != 0);

209 c⁄° 
Keycode
 *
sˇ¡abÀ_usög_cuºít_modifõrs
;

210 
sˇ¡abÀ_usög_cuºít_modifõrs
 =

211 
shi·
 ? 
s_sˇnTabÀWôhShi·
 : 
s_sˇnTabÀNoShi·
;

212 i‡(
sˇnCode
 == 0xe0) {

214 
sˇnCode
 = 
	`In_Byã
(
KB_DATA
);

215 
	`IO_Dñay
();

216 
sˇ¡abÀ_usög_cuºít_modifõrs
 = 
s_sˇnTabÀE0
;

217 
	`DEBUG_KEYBOARD
("suffixcode=%x%s\n", 
sˇnCode
,

218 (
sˇnCode
 & 0x80) ? " [release]" : "");

221 i‡(
sˇnCode
 & 
KB_KEY_RELEASE
) {

222 
ªÀa£
 = 
åue
;

223 
sˇnCode
 &~(
KB_KEY_RELEASE
);

226 i‡(
sˇnCode
 >
SCAN_TABLE_SIZE
) {

227 
	`Pröt
("Unknow¿sˇ¿code: 0x%x\n", 
sˇnCode
);

228 
d⁄e
;

231 
keycode
 = 
sˇ¡abÀ_usög_cuºít_modifõrs
[
sˇnCode
];

234 
keycode
) {

235 
KEY_LSHIFT
:

236 
Êag
 = 
LEFT_SHIFT
;

238 
KEY_RSHIFT
:

239 
Êag
 = 
RIGHT_SHIFT
;

241 
KEY_LCTRL
:

242 
Êag
 = 
LEFT_CTRL
;

244 
KEY_RCTRL
:

245 
Êag
 = 
RIGHT_CTRL
;

247 
KEY_LALT
:

248 
Êag
 = 
LEFT_ALT
;

250 
KEY_RALT
:

251 
Êag
 = 
RIGHT_ALT
;

254 
noÊagch™ge
;

257 i‡(
ªÀa£
)

258 
s_shi·Sèã
 &~(
Êag
);

260 
s_shi·Sèã
 |
Êag
;

266 
d⁄e
;

268 
noÊagch™ge
:

270 i‡(
shi·
)

271 
keycode
 |
KEY_SHIFT_FLAG
;

272 i‡((
s_shi·Sèã
 & 
CTRL_MASK
) != 0)

273 
keycode
 |
KEY_CTRL_FLAG
;

274 i‡((
s_shi·Sèã
 & 
ALT_MASK
) != 0)

275 
keycode
 |
KEY_ALT_FLAG
;

276 i‡(
ªÀa£
)

277 
keycode
 |
KEY_RELEASE_FLAG
;

280 
	`Enqueue_Keycode
(
keycode
);

283 
	`Wake_Up
(&
s_waôQueue
);

289 
g_√edRescheduÀ
[
	`Gë_CPU_ID
()] = 
åue
;

292 
d⁄e
:

293 
	`End_IRQ
(
°©e
);

294 
	}
}

300 
	$Inô_Keybﬂrd
() {

301 
ush‹t_t
 
úqMask
;

303 
	`Pröt
("Initializing keyboard...\n");

306 
s_shi·Sèã
 = 0;

309 
s_queueHód
 = 
s_queueTaû
 = 0;

312 
	`In°Æl_IRQ
(
KB_IRQ
, 
Keybﬂrd_I¡îru±_H™dÀr
);

315 
úqMask
 = 
	`Gë_IRQ_Mask
();

316 
úqMask
 &~(1 << 
KB_IRQ
);

317 
	`Së_IRQ_Mask
(
úqMask
);

319 
	}
}

328 
boﬁ
 
	$Ród_Key
(
Keycode
 * 
keycode
) {

329 
boﬁ
 
ªsu…
, 
iÊag
;

331 
iÊag
 = 
	`Begö_I¡_Atomic
();

333 
ªsu…
 = !
	`Is_Queue_Em±y
();

334 i‡(
ªsu…
) {

335 *
keycode
 = 
	`Dequeue_Keycode
();

338 
	`End_I¡_Atomic
(
iÊag
);

340  
ªsu…
;

341 
	}
}

343 
Keycode
 
	$Gë_Te°_I≈ut
() {

344 
Keycode
 
ªt
;

345 
ªt
 = 
	`In_Byã
(0x510);

346 i‡(!
ªt
)

347  
KEY_UNKNOWN
;

349  
ªt
;

350 
	}
}

357 
Keycode
 
	$Waô_F‹_Key
() {

358 
boﬁ
 
gŸKey
, 
iÊag
;

359 
Keycode
 
keycode
 = 
KEY_UNKNOWN
;

362 
keycode
 = 
	`Gë_Te°_I≈ut
();

363 i‡(
keycode
 !
KEY_UNKNOWN
) {

364  
keycode
;

367 
iÊag
 = 
	`Begö_I¡_Atomic
();

370 
gŸKey
 = !
	`Is_Queue_Em±y
();

371 i‡(
gŸKey
)

372 
keycode
 = 
	`Dequeue_Keycode
();

374 
	`Waô
(&
s_waôQueue
);

376 !
gŸKey
);

378 
	`End_I¡_Atomic
(
iÊag
);

380  
keycode
;

381 
	}
}

	@kthread.c

15 
	~<gìkos/kas£π.h
>

16 
	~<gìkos/defs.h
>

17 
	~<gìkos/s¸ìn.h
>

18 
	~<gìkos/öt.h
>

19 
	~<gìkos/mem.h
>

20 
	~<gìkos/symbﬁ.h
>

21 
	~<gìkos/°rög.h
>

22 
	~<gìkos/kthªad.h
>

23 
	~<gìkos/mÆloc.h
>

24 
	~<gìkos/u£r.h
>

25 
	~<gìkos/Æ¨m.h
>

26 
	~<gìkos/¥oje˘s.h
>

27 
	~<gìkos/smp.h
>

29 
Spö_Lock_t
 
kthªadLock
;

38 
AŒ_Thªad_Li°
 
	gs_ÆlThªadLi°
;

43 
Thªad_Queue
 
	gs_runQueue
;

48 
Kî√l_Thªad
 *
	gg_cuºítThªads
[
MAX_CPUS
];

55 
	gg_√edRescheduÀ
[
MAX_CPUS
];

62 vﬁ©ûê
	gg_¥ìm±i⁄DißbÀd
[
MAX_CPUS
];

69 
Thªad_Queue
 
	gs_gøvey¨dQueue
;

70 
Thªad_Queue
 
	gs_ª≠îWaôQueue
;

77 
	gs_éoˇlKeyCou¡î
 = 0;

78 
éoˇl_de°ru˘‹_t
 
	gs_éoˇlDe°ru˘‹s
[
MAX_TLOCAL_KEYS
];

80 
Kî√l_Thªad
 *
Gë_Next_Ru¬abÀ_Locked
();

87 
Spö_Lock_t
 
	gpidLock
;

89 
	$√xtPid
() {

90 
ªt
;

91 
√xtFªePid
 = 1;

93 
	`Spö_Lock
(&
pidLock
);

94 
ªt
 = 
√xtFªePid
++;

95 
	`Spö_U∆ock
(&
pidLock
);

96  
ªt
;

97 
	}
}

103 
	$Inô_Thªad
(
Kî√l_Thªad
 *
kthªad
, *
°ackPage
,

104 
¥i‹ôy
, 
boﬁ
 
dëached
) {

105 
Kî√l_Thªad
 *
ow√r
 = 
CURRENT_THREAD
;

107 
	`mem£t
(
kthªad
, '\0', (*kthread));

108 
kthªad
->
°ackPage
 = stackPage;

109 
	`KASSERT
(
°ackPage
);

110 
kthªad
->
e•
 = ((
ul⁄g_t
Ëkthªad->
°ackPage
Ë+ 
PAGE_SIZE
;

111 
kthªad
->
numTicks
 = 0;

112 
kthªad
->
dëached
 = detached;

113 
kthªad
->
¥i‹ôy
 =Öriority;

114 
kthªad
->
u£rC⁄ãxt
 = 0;

115 
kthªad
->
ow√r
 = owner;

116 
kthªad
->
afföôy
 = 
AFFINITY_ANY_CORE
;

117 
kthªad
->
tŸÆTime
 = 0;

124 
kthªad
->
ªfCou¡
 = 
dëached
 ? 1 : 2;

125 
kthªad
->
Æive
 = 
åue
;

126 
	`CÀ¨_Thªad_Queue
(&
kthªad
->
joöQueue
);

127 
kthªad
->
pid
 = 
	`√xtPid
();

128 
	}
}

134 
Kî√l_Thªad
 *
	$Cª©e_Thªad
(
¥i‹ôy
, 
boﬁ
 
dëached
) {

135 
Kî√l_Thªad
 *
kthªad
;

136 *
°ackPage
 = 0;

142 
kthªad
 = 
	`AŒoc_Page
();

143 i‡(
kthªad
 == 0)

146 
°ackPage
 = 
	`AŒoc_Page
();

147 i‡(
°ackPage
 == 0) {

148 
	`Fªe_Page
(
kthªad
);

158 
	`Inô_Thªad
(
kthªad
, 
°ackPage
, 
¥i‹ôy
, 
dëached
);

161 
	`Add_To_Back_Of_AŒ_Thªad_Li°
(&
s_ÆlThªadLi°
, 
kthªad
);

163  
kthªad
;

164 
	}
}

171 
__ölöe__
 
	$Push
(
Kî√l_Thªad
 *
kthªad
, 
ul⁄g_t
 
vÆue
) {

172 
kthªad
->
e•
 -= 4;

173 *((
ul⁄g_t
 *Ë
kthªad
->
e•
Ë
vÆue
;

174 
	}
}

182 
	$De°roy_Thªad
(
Kî√l_Thªad
 *
kthªad
) {

187 i‡(
kthªad
->
u£rC⁄ãxt
 != 0)

188 
	`Dëach_U£r_C⁄ãxt
(
kthªad
);

191 
	`Remove_From_AŒ_Thªad_Li°
(&
s_ÆlThªadLi°
, 
kthªad
);

194 
	`Fªe_Page
(
kthªad
->
°ackPage
);

195 
	`Fªe_Page
(
kthªad
);

196 
	}
}

202 
	$Róp_Thªad
(
Kî√l_Thªad
 *
kthªad
) {

204 
	`KASSERT
(
kthªad
 !
CPUs
[0].
idÀThªad
);

205 
	`KASSERT
(
kthªad
 !
CPUs
[1].
idÀThªad
);

206 
	`KASSERT
(!
	`I¡îru±s_E«bÀd
());

207 
	`Enqueue_Thªad
(&
s_gøvey¨dQueue
, 
kthªad
);

208 
	`Wake_Up
(&
s_ª≠îWaôQueue
);

209 
	}
}

214 
	$Dëach_Thªad
(
Kî√l_Thªad
 *
kthªad
) {

215 
cou¡
;

217 
	`KASSERT
(!
	`I¡îru±s_E«bÀd
());

219 
	`KASSERT
(
kthªad
->
ªfCou¡
 > 0);

221 
boﬁ
 
iÊag
 = 
	`Begö_I¡_Atomic
();

222 
cou¡
 = --
kthªad
->
ªfCou¡
;

224 i‡(
cou¡
 == 0) {

225 
	`Róp_Thªad
(
kthªad
);

227 
	`End_I¡_Atomic
(
iÊag
);

228 
	}
}

236 
	$Launch_Thªad
() {

237 
	`E«bÀ_I¡îru±s
();

238 
	}
}

243 
	$Push_GíîÆ_Regi°îs
(
Kî√l_Thªad
 *
kthªad
) {

248 
	`Push
(
kthªad
, 0);

249 
	`Push
(
kthªad
, 0);

250 
	`Push
(
kthªad
, 0);

251 
	`Push
(
kthªad
, 0);

252 
	`Push
(
kthªad
, 0);

253 
	`Push
(
kthªad
, 0);

254 
	`Push
(
kthªad
, 0);

255 
	}
}

262 
	$Shutdown_Thªad
() {

263 
	`Exô
(0);

264 
	}
}

269 
	$Sëup_Kî√l_Thªad
(
Kî√l_Thªad
 *
kthªad
,

270 
Thªad_Sèπ_Func
 
°¨tFunc
, 
ul⁄g_t
 
¨g
) {

276 
	`Push
(
kthªad
, 
¨g
);

277 
	`Push
(
kthªad
, (
ul⁄g_t
Ë& 
Shutdown_Thªad
);

280 
	`Push
(
kthªad
, (
ul⁄g_t
Ë
°¨tFunc
);

295 
	`Push
(
kthªad
, 0UL);

301 
	`Push
(
kthªad
, 
KERNEL_CS
);

302 
	`Push
(
kthªad
, (
ul⁄g_t
Ë& 
Launch_Thªad
);

305 
	`Push
(
kthªad
, 0);

306 
	`Push
(
kthªad
, 0);

309 
	`Push_GíîÆ_Regi°îs
(
kthªad
);

317 
	`Push
(
kthªad
, 
KERNEL_DS
);

318 
	`Push
(
kthªad
, 
KERNEL_DS
);

319 
	`Push
(
kthªad
, 0);

320 
	`Push
(
kthªad
, 0);

321 
	}
}

326  
	$Sëup_U£r_Thªad
(

327 
Kî√l_Thªad
 *
kthªad
,

328 
U£r_C⁄ãxt
 *
u£rC⁄ãxt
) {

329 
u£rDebug
;

335 
ul⁄g_t
 
eÊags
 = 
EFLAGS_IF
;

337 
csSñe˘‹
 = 
u£rC⁄ãxt
->csSelector;

338 
dsSñe˘‹
 = 
u£rC⁄ãxt
->dsSelector;

340 
	`Aâach_U£r_C⁄ãxt
(
kthªad
, 
u£rC⁄ãxt
);

348 
	`Push
(
kthªad
, 
dsSñe˘‹
);

349 
	`Push
(
kthªad
, 
u£rC⁄ãxt
->
°ackPoöãrAddr
);

352 
	`Push
(
kthªad
, 
eÊags
);

353 
	`Push
(
kthªad
, 
csSñe˘‹
);

354 
	`Push
(
kthªad
, 
u£rC⁄ãxt
->
íåyAddr
);

355 i‡(
u£rDebug
)

356 
	`Pröt
("E¡ryáddr=%lx\n", 
u£rC⁄ãxt
->
íåyAddr
);

359 
	`Push
(
kthªad
, 0);

360 
	`Push
(
kthªad
, 0);

367 
	`Push
(
kthªad
, 0);

368 
	`Push
(
kthªad
, 0);

369 
	`Push
(
kthªad
, 0);

370 
	`Push
(
kthªad
, 0);

371 
	`Push
(
kthªad
, 
u£rC⁄ãxt
->
¨gBlockAddr
);

372 
	`Push
(
kthªad
, 0);

373 
	`Push
(
kthªad
, 0);

376 
	`Push
(
kthªad
, 
dsSñe˘‹
);

377 
	`Push
(
kthªad
, 
dsSñe˘‹
);

378 
	`Push
(
kthªad
, 
dsSñe˘‹
);

379 
	`Push
(
kthªad
, 
dsSñe˘‹
);

382 
kthªad
->
afföôy
 = -1;

383 
	}
}

391 
IdÀ
(
ul⁄g_t
 
¨g
 
__©åibuã__
 ((
unu£d
))) {

392 
	gåue
) {

398 
__asm__
("hlt");

400 
Yõld
();

408 
Ró≥r
(
ul⁄g_t
 
¨g
 
__©åibuã__
 ((
unu£d
))) {

409 
Kî√l_Thªad
 *
	gkthªad
;

411 
DißbÀ_I¡îru±s
();

413 
	gåue
) {

414 
Spö_Lock
(&
kthªadLock
);

416 i‡((
	gkthªad
 = 
s_gøvey¨dQueue
.
hód
) == 0) {

418 
Spö_U∆ock
(&
kthªadLock
);

419 
Waô
(&
s_ª≠îWaôQueue
);

422 
CÀ¨_Thªad_Queue
(&
s_gøvey¨dQueue
);

425 
	gkthªad
 != 0) {

426 
Kî√l_Thªad
 *
√xt
 =

427 
Gë_Next_In_Thªad_Queue
(
kthªad
);

430 
De°roy_Thªad
(
kthªad
);

431 
KASSERT
(
kthªad
 !
√xt
);

432 
	gkthªad
 = 
√xt
;

436 
Spö_U∆ock
(&
kthªadLock
);

438 
E«bÀ_I¡îru±s
();

439 
Yõld
();

440 
DißbÀ_I¡îru±s
();

449 
__ölöe__
 
Kî√l_Thªad
 *
	$Föd_Be°
(
Thªad_Queue
 *
queue
) {

450 
˝uID
;

452 
	`KASSERT
(
	`Is_Locked
(&
kthªadLock
));

454 
˝uID
 = 
	`Gë_CPU_ID
();

457 
Kî√l_Thªad
 *
kthªad
 = 
queue
->
hód
, *
be°
 = 0;

458 
kthªad
 != 0) {

459 i‡(
kthªad
->
afföôy
 =
AFFINITY_ANY_CORE
 ||

460 
kthªad
->
afföôy
 =
˝uID
) {

461 i‡(
be°
 =0 || 
kthªad
->
¥i‹ôy
 > best->priority)

463 
be°
 = 
kthªad
;

465 
kthªad
 = 
	`Gë_Next_In_Thªad_Queue
(kthread);

468  
be°
;

469 
	}
}

476 
__ölöe__
 c⁄° **
	$Gë_Tloˇl_Poöãr
(
éoˇl_key_t
 
k
) {

477 
Kî√l_Thªad
 *
cuºít
 = 
CURRENT_THREAD
;

479 
	`KASSERT
(
k
 < 
MAX_TLOCAL_KEYS
);

481  &
cuºít
->
éoˇlD©a
[
k
];

482 
	}
}

492 
	$Tloˇl_Exô
(
Kî√l_Thªad
 *
cuº
) {

493 
i
, 
j
, 
ˇŒed
 = 0;

495 
	`KASSERT
(!
	`I¡îru±s_E«bÀd
());

497 
j
 = 0; j < 
MIN_DESTRUCTOR_ITERATIONS
; j++) {

499 
i
 = 0; i < 
MAX_TLOCAL_KEYS
; i++) {

501 *
x
 = (*)
cuº
->
éoˇlD©a
[
i
];

502 i‡(
x
 !
NULL
 && 
s_éoˇlDe°ru˘‹s
[
i
] != NULL) {

504 
cuº
->
éoˇlD©a
[
i
] = 
NULL
;

505 
ˇŒed
 = 1;

507 
	`E«bÀ_I¡îru±s
();

508 
s_éoˇlDe°ru˘‹s
[
i
] (
x
);

509 
	`DißbÀ_I¡îru±s
();

512 i‡(!
ˇŒed
)

515 
	}
}

522 
	$Inô_ScheduÀr
(
˝uID
, *
°ack
) {

523 
Kî√l_Thªad
 *
maöThªad
 = (Kî√l_Thªad *)
	`AŒoc_Page
();

525 
	`mem˝y
(
maöThªad
, (*)
KERN_THREAD_OBJ
, (
Kî√l_Thªad
));

531 
	`Inô_Thªad
(
maöThªad
, 
°ack
, 
PRIORITY_NORMAL
, 
åue
);

532 
CURRENT_THREAD
 = 
maöThªad
;

533 
	`Add_To_Back_Of_AŒ_Thªad_Li°
(&
s_ÆlThªadLi°
, 
maöThªad
);

534 
	`°r˝y
(
maöThªad
->
thªadName
, "{Main}");

540 
«me
[30];

541 
	`°r˝y
(
«me
, "{Idle-#?}");

542 
«me
[7] = 
˝uID
 + '0';

543 
CPUs
[
˝uID
].
idÀThªad
 =

544 
	`Sèπ_Kî√l_Thªad
(
IdÀ
, 0, 
PRIORITY_IDLE
, 
åue
, 
«me
);

545 
CPUs
[
˝uID
].
idÀThªad
->
ow√r
 = 
NULL
;

546 
CPUs
[
˝uID
].
idÀThªad
->
afföôy
 = cpuID;

548 i‡(!
˝uID
) {

553 
Kî√l_Thªad
 *
ª≠î
;

555 
ª≠î
 =

556 
	`Sèπ_Kî√l_Thªad
(
Ró≥r
, 0, 
PRIORITY_NORMAL
, 
åue
, "{Reaper}");

558 
	}
}

571 
Kî√l_Thªad
 *
	$Sèπ_Kî√l_Thªad
(
Thªad_Sèπ_Func
 
°¨tFunc
,

572 
ul⁄g_t
 
¨g
,

573 
¥i‹ôy
,

574 
boﬁ
 
dëached
, c⁄° *
«me
) {

575 
Kî√l_Thªad
 *
kthªad
 = 
	`Cª©e_Thªad
(
¥i‹ôy
, 
dëached
);

576 i‡(
kthªad
 != 0) {

581 
	`Sëup_Kî√l_Thªad
(
kthªad
, 
°¨tFunc
, 
¨g
);

585 
	`Make_Ru¬abÀ_Atomic
(
kthªad
);

587 
	`°r˝y
(
kthªad
->
thªadName
, 
«me
);

590  
kthªad
;

591 
	}
}

597 
Kî√l_Thªad
 *
	$Sèπ_U£r_Thªad
(
U£r_C⁄ãxt
 *
u£rC⁄ãxt
,

598 
boﬁ
 
dëached
) {

599 
Kî√l_Thªad
 *
kthªad
 = 
	`Cª©e_Thªad
(
PRIORITY_USER
, 
dëached
);

600 i‡(
kthªad
 != 0) {

602 
	`Sëup_U£r_Thªad
(
kthªad
, 
u£rC⁄ãxt
);

603 
	`Make_Ru¬abÀ_Atomic
(
kthªad
);

606  
kthªad
;

607 
	}
}

613 
	$Make_Ru¬abÀ
(
Kî√l_Thªad
 *
kthªad
) {

614 
	`KASSERT
(!
	`I¡îru±s_E«bÀd
());

616 
	`Enqueue_Thªad
(&
s_runQueue
, 
kthªad
);

617 
	`TODO_P
(
PROJECT_SCHEDULING
, "replace makeÑunnableásÇeeded");

618 
	}
}

626 
	$Make_Ru¬abÀ_Atomic
(
Kî√l_Thªad
 *
kthªad
) {

627 
	`DißbÀ_I¡îru±s
();

628 
	`Spö_Lock
(&
kthªadLock
);

629 
	`Make_Ru¬abÀ
(
kthªad
);

630 
	`Spö_U∆ock
(&
kthªadLock
);

631 
	`E«bÀ_I¡îru±s
();

632 
	}
}

637 
Kî√l_Thªad
 *
	$Gë_Cuºít
() {

638  
CURRENT_THREAD
;

639 
	}
}

645 
Kî√l_Thªad
 *
	$Gë_Next_Ru¬abÀ_Locked
() {

646 
Kî√l_Thªad
 *
be°
 = 0;

647 
be°
 = 
	`Föd_Be°
(&
s_runQueue
);

648 
	`KASSERT
(
be°
 != 0);

649 
	`Remove_Thªad
(&
s_runQueue
, 
be°
);

650 
˝uID
 = 
	`Gë_CPU_ID
();

652 
	`KASSERT
(
	`Is_Locked
(&
kthªadLock
));

653 
	`TODO_P
(
PROJECT_SCHEDULING
, "fix Get_Next_Runnable");

654  
be°
;

655 
	}
}

657 
Kî√l_Thªad
 *
	$Gë_Next_Ru¬abÀ
() {

658 
Kî√l_Thªad
 *
ªt
;

660 
	`Spö_Lock
(&
kthªadLock
);

662 
ªt
 = 
	`Gë_Next_Ru¬abÀ_Locked
();

665 
	`Spö_U∆ock
(&
kthªadLock
);

667  
ªt
;

668 
	}
}

678 
	$ScheduÀ
() {

679 
Kî√l_Thªad
 *
ru¬abÀ
;

682 
	`KASSERT
(!
	`I¡îru±s_E«bÀd
());

686 
	`KASSERT
(!
g_¥ìm±i⁄DißbÀd
[
	`Gë_CPU_ID
()]);

689 
ru¬abÀ
 = 
	`Gë_Next_Ru¬abÀ
();

699 
	`Swôch_To_Thªad
(
ru¬abÀ
);

700 
	}
}

706 
	$Yõld
() {

707 
	`DißbÀ_I¡îru±s
();

708 
	`Make_Ru¬abÀ
(
CURRENT_THREAD
);

709 
	`ScheduÀ
();

710 
	`E«bÀ_I¡îru±s
();

711 
	}
}

718 
	$Exô
(
exôCode
) {

719 
	`Munm≠_Im∂
(
uöt_t
 
addr
);

721 
Kî√l_Thªad
 *
cuºít
 = 
CURRENT_THREAD
;

723 i‡(
	`I¡îru±s_E«bÀd
())

724 
	`DißbÀ_I¡îru±s
();

727 
cuºít
->
exôCode
 =ÉxitCode;

728 
cuºít
->
Æive
 = 
Ál£
;

732 
	`Aœrm_C™˚l_F‹_Thªad
(
cuºít
);

735 
	`Tloˇl_Exô
(
CURRENT_THREAD
);

737  
	`Wake_Up
(&
cuºít
->
joöQueue
);

740 
	`Dëach_Thªad
(
CURRENT_THREAD
);

748 
	`ScheduÀ
();

751 
	`KASSERT
(
Ál£
);

752 
	}
}

759 
	$Joö
(
Kî√l_Thªad
 *
kthªad
) {

760 
exôCode
;

762 
	`KASSERT
(
	`I¡îru±s_E«bÀd
());

765 
	`KASSERT
(
kthªad
->
ow√r
 =
CURRENT_THREAD
);

767 
	`DißbÀ_I¡îru±s
();

770 
kthªad
->
Æive
) {

771 
	`Waô
(&
kthªad
->
joöQueue
);

775 
exôCode
 = 
kthªad
->exitCode;

779 
kthªad
->
dëached
 = 1;

782 
	`Dëach_Thªad
(
kthªad
);

784 
	`E«bÀ_I¡îru±s
();

786  
exôCode
;

787 
	}
}

797 
Kî√l_Thªad
 *
	$Lookup_Thªad
(
pid
, 
nŸOw√r
) {

798 
Kî√l_Thªad
 *
ªsu…
 = 0;

800 
boﬁ
 
iÊag
 = 
	`Begö_I¡_Atomic
();

808 
	`Spö_Lock
(&
kthªadLock
);

809 
ªsu…
 = 
	`Gë_Fr⁄t_Of_AŒ_Thªad_Li°
(&
s_ÆlThªadLi°
);

810 
ªsu…
 != 0) {

811 i‡(
ªsu…
->
pid
 ==Öid) {

812 i‡(
CURRENT_THREAD
 !
ªsu…
->
ow√r
 && !
nŸOw√r
)

813 
ªsu…
 = 0;

816 
ªsu…
 = 
	`Gë_Next_In_AŒ_Thªad_Li°
(result);

818 
	`Spö_U∆ock
(&
kthªadLock
);

820 
	`End_I¡_Atomic
(
iÊag
);

822  
ªsu…
;

823 
	}
}

836 
	$Waô
(
Thªad_Queue
 *
waôQueue
) {

837 
Kî√l_Thªad
 *
cuºít
 = 
CURRENT_THREAD
;

839 
	`KASSERT
(!
	`I¡îru±s_E«bÀd
());

840 
	`KASSERT
(
waôQueue
 !
NULL
);

843 
	`Enqueue_Thªad
(
waôQueue
, 
cuºít
);

846 
	`ScheduÀ
();

848 
	}
}

850 
	$Wake_Up_Locked
(
Thªad_Queue
 *
waôQueue
) {

851 
Kî√l_Thªad
 *
kthªad
 = 
waôQueue
->
hód
, *
√xt
;

853 
	`KASSERT
(
	`Is_Locked
(&
kthªadLock
));

854 
	`KASSERT
(!
	`I¡îru±s_E«bÀd
());

855 
	`KASSERT
(
waôQueue
 !
NULL
);

861 
kthªad
 = 
waôQueue
->
hód
; kthªad !0; kthªad = 
√xt
) {

862 
√xt
 = 
	`Gë_Next_In_Thªad_Queue
(
kthªad
);

863 *
«me
;

865 i‡(
kthªad
->
u£rC⁄ãxt
) {

866 
«me
 = 
kthªad
->
u£rC⁄ãxt
->name;

868 
«me
 = 
kthªad
->
thªadName
;

872 
	`Make_Ru¬abÀ
(
kthªad
);

876 
	`CÀ¨_Thªad_Queue
(
waôQueue
);

877 
	}
}

886 
	$Wake_Up
(
Thªad_Queue
 *
waôQueue
) {

887 
	`Spö_Lock
(&
kthªadLock
);

888 
	`Wake_Up_Locked
(
waôQueue
);

889 
	`Spö_U∆ock
(&
kthªadLock
);

890 
	}
}

898 
	$Wake_Up_O√
(
Thªad_Queue
 *
waôQueue
) {

899 
Kî√l_Thªad
 *
be°
;

901 
	`KASSERT
(!
	`I¡îru±s_E«bÀd
());

902 
	`KASSERT
(
waôQueue
 !
NULL
);

904 
	`Spö_Lock
(&
kthªadLock
);

906 
be°
 = 
	`Föd_Be°
(
waôQueue
);

908 i‡(
be°
 != 0) {

909 
	`Remove_Thªad
(
waôQueue
, 
be°
);

910 
	`Make_Ru¬abÀ
(
be°
);

914 
	`Spö_U∆ock
(&
kthªadLock
);

915 
	}
}

920 
	$Tloˇl_Cª©e
(
éoˇl_key_t
 * 
key
, 
éoˇl_de°ru˘‹_t
 
de°ru˘‹
) {

921 
boﬁ
 
iÊag
 = 
	`Begö_I¡_Atomic
();

923 
	`KASSERT
(
key
);

925 i‡(
s_éoˇlKeyCou¡î
 =
MAX_TLOCAL_KEYS
)

927 
s_éoˇlDe°ru˘‹s
[
s_éoˇlKeyCou¡î
] = 
de°ru˘‹
;

928 *
key
 = 
s_éoˇlKeyCou¡î
++;

930 
	`End_I¡_Atomic
(
iÊag
);

933 
	}
}

938 
	$Tloˇl_Put
(
éoˇl_key_t
 
k
, c⁄° *
v
) {

939 c⁄° **
pv
;

941 
	`KASSERT
(
k
 < 
s_éoˇlKeyCou¡î
);

943 
pv
 = 
	`Gë_Tloˇl_Poöãr
(
k
);

944 *
pv
 = 
v
;

945 
	}
}

950 *
	$Tloˇl_Gë
(
éoˇl_key_t
 
k
) {

951 c⁄° **
pv
;

953 
	`KASSERT
(
k
 < 
s_éoˇlKeyCou¡î
);

955 
pv
 = 
	`Gë_Tloˇl_Poöãr
(
k
);

956  (*)*
pv
;

957 
	}
}

963 
	$Dump_AŒ_Thªad_Li°
() {

964 
Kî√l_Thªad
 *
kthªad
;

965 
cou¡
 = 0;

966 
boﬁ
 
iÊag
 = 
	`Begö_I¡_Atomic
();

968 
	`Spö_Lock
(&
kthªadLock
);

970 
kthªad
 = 
	`Gë_Fr⁄t_Of_AŒ_Thªad_Li°
(&
s_ÆlThªadLi°
);

972 
	`Pröt
("[");

973 
kthªad
 != 0) {

974 ++
cou¡
;

975 
	`Pröt
("<%lx,%lx,%lx>",

976 (
ul⁄g_t
Ë
	`Gë_Pªv_In_AŒ_Thªad_Li°
(
kthªad
),

977 (
ul⁄g_t
Ë
kthªad
,

978 (
ul⁄g_t
Ë
	`Gë_Next_In_AŒ_Thªad_Li°
(
kthªad
));

979 
	`KASSERT
(
kthªad
 !
	`Gë_Next_In_AŒ_Thªad_Li°
(kthread));

980 
kthªad
 = 
	`Gë_Next_In_AŒ_Thªad_Li°
(kthread);

982 
	`Pröt
("]\n");

983 
	`Pröt
("%dÅhªad†¨êru¬ög\n", 
cou¡
);

985 
	`Spö_U∆ock
(&
kthªadLock
);

986 
	`End_I¡_Atomic
(
iÊag
);

987 
	}
}

	@lowlevel.asm

1 ; 
Low
 
Àvñ
 
	göãºu±
/
thªad
 
h™dlög
 
code
 
	gGìkOS
.

2 ; 
C›yright
 (
c
Ë2001,2003,2004 
David
 
	gH
. 
	gHovemeyî
 <
	gdaveho
@
	gcs
.
	gumd
.
	gedu
>

3 ; 
C›yright
 (
c
Ë2003,2014 
Jef‰ey
 
	gK
. 
	gHﬁlögsw‹th
 <
	ghﬁlögs
@
	gcs
.
	gumd
.
	gedu
>

4 ; 
	g$Revisi⁄
: 1.18 
$


6 ; 
AŒ
 
rights
 
	gª£rved
.

7 ; 
This
 
code
 
may
 
nŸ
 
be
 
ªsdi°ribuãd
 
wôhout
 
the
 
≥rmissi⁄
 
of
Åhê
c›yright
 
	ghﬁdîs
.

9 ; 
This
 
	gis
 32 
bô
 
code
 
to
 
be
 
löked
 
öto
 
the
 
	gkî√l
.

10 ; 
It
 
deföes
 
low
 
Àvñ
 
öãºu±
 
h™dÀr
 
íåy
 
poöts
 
th©
 
	gwe
'll use

11 ; 
to
 
p›uœã
 
the
 
	gIDT
. 
It
 
Æso
 
c⁄èös
Åhê
öãºu±
 
	gh™dlög


12 ; 
™d
 
thªad
 
c⁄ãxt
 
	gcode
.

14 %
	gö˛ude
 "defs.asm"

15 %
	gö˛ude
 "symbol.asm"

17 [
BITS
 32]

20 ; 
	gDeföôi⁄s


23 ; 
This
 
is
 
the
 
size
 
of
Åhê
I¡îru±_Sèã
 
ö
 .
h


24 
INTERRUPT_STATE_SIZE
 
	gequ
 64

26 ; 
Save
 
ªgi°îs
 
¥i‹
 
to
 
ˇŒög
 
a
 
h™dÀr
 
	gfun˘i⁄
.

27 ; 
This
 
mu°
 
be
 
kït
 
up
 
to
 
d©e
 
	gwôh
:

28 ; - 
I¡îru±_Sèã
 
ö
 .
	gh


29 ; - 
	$Sëup_Inôül_Thªad_C⁄ãxt
(Ë
ö
 
kthªad
.
c


30 %
ma¸o
 
Save_Regi°îs
 0

31 
push
 
óx


32 
push
 
ebx


33 
push
 
ecx


34 
push
 
edx


35 
push
 
esi


36 
push
 
edi


37 
push
 
ebp


38 
push
 
ds


39 
push
 
es


40 
push
 
fs


41 
push
 
gs


42 %
ídma¸o


44 ; 
Re°‹e
 
ªgi°îs
 
™d
 
˛ón
 
up
 
the
 
°ack
 
a·î
 
ˇŒög
 
a
 
h™dÀr
 
fun˘i⁄


45 ; (
i
.
e
., 
ju°
 
bef‹e
 
we
  
‰om
 
the
 
öãºu±
 
vü
 
™
 
úë
 
ö°ru˘i⁄
).

46 %
ma¸o
 
Re°‹e_Regi°îs
 0

47 
p›
 
gs


48 
p›
 
fs


49 
p›
 
es


50 
p›
 
ds


51 
p›
 
ebp


52 
p›
 
edi


53 
p›
 
esi


54 
p›
 
edx


55 
p›
 
ecx


56 
p›
 
ebx


57 
p›
 
óx


58 
add
 
e•
, 8 ; 
skù
 
num
 
™d
 
îr‹
 
code


59 %
ídma¸o


61 ; 
Code
 
to
 
a˘iv©e
 
a
 
√w
 
u£r
 
	`c⁄ãxt
 (
√˚sßry
), 
bef‹e
 
ªtu∫ög


62 ; 
to
 
executög
 
a
 
thªad
. 
Should
 
be
 
ˇŒed
 
ju°
 
bef‹e
 
ª°‹ög


63 ; 
	`ªgi°îs
 (
beˇu£
 
the
 
öãºu±
 
c⁄ãxt
 
is
 
u£d
).

64 %
ma¸o
 
A˘iv©e_U£r_C⁄ãxt
 0

65 ; 
If
 
the
 
√w
 
thªad
 
has
 
a
 
u£r
 
c⁄ãxt
 
which
 
is
 
nŸ
Åhê
cuºít


66 ; 
⁄e
, 
a˘iv©e
 
ô
.

67 
push
 
e•
 ; 
I¡îru±_Sèã
 
poöãr


68 
Push_Cuºít_Thªad_PTR


69 
ˇŒ
 
Swôch_To_U£r_C⁄ãxt


70 
add
 
e•
, 8 ; 
˛ór
 2 
¨gumíts


71 %
ídma¸o


73 ; 
Code
 
to
 
ª¨ønge
 
the
 
°ack
Åÿ
a˘iv©e
 
a
 
sig«l
 
h™dÀr


74 %
ma¸o
 
Pro˚ss_Sig«l
 1

75 ; 
Check
 
a
 
sig«l
 
is
 
≥ndög
. 
If
 
so
, 
we
 
√ed
 
to


76 ; 
ª¨ønge
 
the
 
°ack
 
so
 
th©
 
whí
Åhê
thªad
 
ª°¨ts


77 ; 
ô
 
wûl
 
íãr
 
the
 
sig«l
 
h™dÀr
 
™d
 
thí
 
a·îw¨d


78 ;  
to
 
ôs
 
‹igöÆ
 
•Ÿ


79 
push
 
e•


80 
Push_Cuºít_Thªad_PTR


81 
ˇŒ
 
Check_Pídög_Sig«l


82 
add
 
e•
, 8

83 
cmp
 
óx
, 
dw‹d
 0

84 
je
 %1

85 ; 
We
 
have
 
a
 
≥ndög
 
sig«l
, 
so
 
we
 
mu°
 
¨ønge
 
to


86 ; 
ˇŒ
 
ôs
 
sig«l
 
h™dÀr


87 ; 
push
 
e•


88 ; 
ˇŒ
 
Pröt_IS


89 ; 
add
 
e•
, 4

90 
push
 
e•


91 
Push_Cuºít_Thªad_PTR


92 
ˇŒ
 
Sëup_Føme


93 
add
 
e•
, 8

94 ; 
push
 
e•


95 ; 
ˇŒ
 
Pröt_IS


96 ; 
add
 
e•
, 4

97 %
ídma¸o


99 ; 
Numbî
 
of
 
byãs
 
bëwìn
 
the
 
t›
 o‡thê
°ack
 
™d


100 ; 
the
 
öãºu±
 
numbî
 
a·î
Åhê
gíîÆ
-
puΩo£
 
™d
 
£gmít


101 ; 
ªgi°îs
 
have
 
bìn
 
ßved
.

102 
REG_SKIP
 
	`equ
 (11*4)

104 ; 
Numbî
 
of
 
byãs
 
‰om
 
t›
 o‡
the
 
°ack
Åhêthê
ßved
 
EFLAGS
 
a·î


105 ; 
GP
 
™d
 
£g
 
ªgi°îs
 
have
 
bìn
 
ßved


106 
EFLAGS_SKIP
 
	`equ
 (15*4)

108 ; 
bô
 
mask
 
I¡îru±
 
íabÀ
 bô 
of
 
EFLAGS


109 
EFLAGS_IF
 
equ
 
w‹d
 0x200

111 ; 
Tem∂©e
 
íåy
 
poöt
 
code
 
öãºu±s
 
th©
 
have


112 ; 
™
 
ex∂icô
 
¥o˚ss‹
-
gíî©ed
 
îr‹
 
code
.

113 ; 
The
 
¨gumít
 
is
 
the
 
öãºu±
 
numbî
.

114 %
ma¸o
 
I¡_Wôh_Eº
 1

115 
Æign
 16

116 
push
 
dw‹d
 %1 ;Öush 
öãºu±
 
numbî


117 
jmp
 
H™dÀ_I¡îru±
 ; 
jump
 
to
 
comm⁄
 
h™dÀr


118 %
ídma¸o


120 ; 
Tem∂©e
 
íåy
 
poöt
 
code
 
öãºu±s
 
th©
 dÿ
nŸ


121 ; 
gíî©e
 
™
 
ex∂icô
 
îr‹
 
code
. 
We
 
push
 
a
 
dummy
Érror

122 ; 
code
 
⁄
 
the
 
°ack
, 
so
Åhê°ack 
œyout
 
is
Åhê
ßme


123 ; 
Æl
 
öãºu±s
.

124 %
ma¸o
 
I¡_No_Eº
 1

125 
Æign
 16

126 
push
 
dw‹d
 0 ; 
Áke
 
îr‹
 
code


127 
push
 
dw‹d
 %1 ;Öush 
öãºu±
 
numbî


128 
jmp
 
H™dÀ_I¡îru±
 ; 
jump
 
to
 
comm⁄
 
h™dÀr


129 %
ídma¸o


133 ; 
Symbﬁ
 
imp‹ts
 
™d
 
exp‹ts


136 
IMPORT
 
u∆ockKî√l


137 
IMPORT
 
lockKî√l


139 ; 
This
 
symbﬁ
 
is
 
deföed
 
ö
 
idt
.
c
, 
™d
 i†
a
 
èbÀ
 
of
 
addªs£s


140 ; 
of
 
C
 
h™dÀr
 
fun˘i⁄s
 
öãºu±s
.

141 
IMPORT
 
g_öãºu±TabÀ


143 ; 
GlobÆ
 
v¨übÀ
 
poötög
 
to
 
c⁄ãxt
 
cuºít
 
thªad
.

144 
IMPORT
 
g_cuºítThªads


146 ; 
Së
 
to
 
n⁄
-
zîo
 
whí
 
we
 
√ed
Åÿ
choo£
 
a
 
√w
 
thªad


147 ; 
ö
 
the
 
öãºu±
  
code
.

148 
IMPORT
 
g_√edRescheduÀ


150 ; 
Së
 
to
 
n⁄
-
zîo
 
whí
 
¥ìm±i⁄
 
is
 
dißbÀd
.

151 
IMPORT
 
g_¥ìm±i⁄DißbÀd


153 ; 
This
 
is
 
the
 
fun˘i⁄
 
th©
 
ªtu∫s
Åhê
√xt
 
ru¬abÀ
 
thªad
.

154 
IMPORT
 
Gë_Next_Ru¬abÀ


156 ; 
Fun˘i⁄
 
to
 
put
 
a
 
thªad
 
⁄
 
the
 
run
 
queue
.

157 
IMPORT
 
Make_Ru¬abÀ


159 ; 
Fun˘i⁄
 
to
 
a˘iv©e
 
a
 
√w
 
u£r
 
	`c⁄ãxt
 (
√eded
).

160 
IMPORT
 
Swôch_To_U£r_C⁄ãxt


162 ; 
Fun˘i⁄
 
th©
 
checks
 
the
 
cuºít
 
thªad
 
has
 
a
 
sig«l
 
≥ndög
.

163 
IMPORT
 
Check_Pídög_Sig«l


165 ; 
Fun˘i⁄
 
th©
 
£ts
 
up
 
the
 
°ack
 
‰ame
 
to
 
övoke
 
a
 
sig«l
 
h™dÀr


166 
IMPORT
 
Sëup_Føme


168 ;; 
Fun˘i⁄
 
to
 
m™ùuœã
 
APIC


169 
IMPORT
 
APIC_Wrôe


171 ; 
Sizes
 
of
 
öãºu±
 
h™dÀr
 
íåy
 
poöts
 
öãºu±s
 
wôh


172 ; 
™d
 
wôhout
 
îr‹
 
codes
. 
The
 
code
 
ö
 
idt
.
c
 
u£s
 
this


173 ; 
öf‹m©i⁄
 
to
 
ö„r
 
the
 
œyout
 
of
Åhê
èbÀ
 o‡
öãºu±


174 ; 
h™dÀr
 
íåy
 
poöts
, 
wôhout
 
√edög
 
a
 
£∑øã
 
lökî


175 ; 
symbﬁ
 
óch
 
	`⁄e
 (
which
 
is
 
quôe
 
ãdious
 
to
 
ty≥
 :-)

176 
EXPORT
 
g_h™dÀrSizeNoEº


177 
EXPORT
 
g_h™dÀrSizeEº


179 ; 
Sim∂e
 
fun˘i⁄s
 
to
 
lﬂd
 
the
 
IDTR
, 
GDTR
, 
™d
 
LDTR
.

180 
EXPORT
 
Lﬂd_IDTR


181 
EXPORT
 
Lﬂd_GDTR


182 
EXPORT
 
Lﬂd_LDTR


184 ; 
Begönög
 
™d
 
íd
 
of
 
the
 
èbÀ
 o‡
öãºu±
 
íåy
 
poöts
.

185 
EXPORT
 
g_íåyPoötTabÀSèπ


186 
EXPORT
 
g_íåyPoötTabÀEnd


188 ; 
Thªad
 
c⁄ãxt
 
fun˘i⁄
.

189 
EXPORT
 
Swôch_To_Thªad


191 ; 
Rëu∫
 
cuºít
 
vÆue
 
of
 
eÊags
 .

192 
EXPORT
 
Gë_Cuºít_EFLAGS


194 ; 
VútuÆ
 
mem‹y
 
suµ‹t
.

195 
EXPORT
 
E«bÀ_Pagög


196 
EXPORT
 
Së_PDBR


197 
EXPORT
 
Gë_PDBR


198 
EXPORT
 
Flush_TLB


200 ; 
Spö
 
Lock


201 
EXPORT
 
Spö_Lock_INTERNAL


202 
EXPORT
 
Spö_U∆ock_INTERNAL


203 
EXPORT
 
Síd_Timî_INT


206 ; 
Code


209 [
SECTION
 .
ãxt
]

211 ; 
Lﬂd
 
IDTR
 
wôh
 6-
byã
 
poöãr
 
who£
 
addªss
 
is
 
∑s£d
 
as


212 ; 
the
 
∑ømëî
.

213 
Æign
 8

214 
Lﬂd_IDTR
:

215 
mov
 
óx
, [
e•
+4]

216 
lidt
 [
óx
]

217 
ªt


219 ; 
Lﬂd
 
the
 
GDTR
 
wôh
 6-
byã
 
poöãr
 
who£
 
addªss
 
is


220 ; 
∑s£d
 
as
 
the
 
∑ømëî
. 
Assumes
 
th©
 
öãºu±s


221 ; 
¨e
 
dißbÀd
.

222 
Æign
 8

223 
Lﬂd_GDTR
:

224 
mov
 
óx
, [
e•
+4]

225 
lgdt
 [
óx
]

226 ; 
Rñﬂd
 
£gmít
 
ªgi°îs


227 
mov
 
ax
, 
KERNEL_DS


228 
mov
 
ds
, 
ax


229 
mov
 
es
, 
ax


230 
mov
 
fs
, 
ax


231 
mov
 
gs
, 
ax


232 
mov
 
ss
, 
ax


233 
jmp
 
KERNEL_CS
:.
hîe


234 .
hîe
:

235 
ªt


237 ; 
Lﬂd
 
the
 
LDT
 
who£
 
£À˘‹
 
is
 
∑s£d
 
as
 
a
 
∑ømëî
.

238 
Æign
 8

239 
Lﬂd_LDTR
:

240 
mov
 
óx
, [
e•
+4]

241 
Œdt
 
ax


242 
ªt


245 ; 
Sèπ
 
∑gög


246 ; 
lﬂd
 
¸t3
 
wôh
 
the
 
∑s£d
 
∑ge
 
dúe˘‹y
 
poöãr


247 ; 
íabÀ
 
∑gög
 
bô
 
ö
 
¸2


248 
Æign
 8

249 
E«bÀ_Pagög
:

250 
mov
 
óx
, [
e•
+4]

251 
mov
 
¸3
, 
óx


252 
mov
 
óx
, 
¸3


253 
mov
 
¸3
, 
óx


254 
mov
 
ebx
, 
¸0


255 
‹
 
ebx
, 0x80000000

256 
mov
 
¸0
, 
ebx


257 
ªt


261 ; 
Ch™ge
 
PDBR


262 ; 
lﬂd
 
¸3
 
wôh
 
the
 
∑s£d
 
∑ge
 
dúe˘‹y
 
poöãr


263 
Æign
 8

264 
Së_PDBR
:

265 
mov
 
óx
, [
e•
+4]

266 
mov
 
¸3
, 
óx


267 
mov
 
óx
, [
e•
+4]

268 
mov
 
¸3
, 
óx


269 
ªt


272 ; 
Gë
 
the
 
cuºít
 
PDBR
.

273 ; 
This
 
is
 
u£ful
 
œzûy
 
swôchög
 
addªss
 
•a˚s
;

274 ; 
⁄ly
 
the
 
√w
 
thªad
 
has
 
a
 
dif„ª¡
 
addªss
 
•a˚
.

276 
Æign
 8

277 
Gë_PDBR
:

278 
mov
 
óx
, 
¸3


279 
ªt


282 ; 
Flush
 
TLB
 - 
ju°
 
√ed
 
to
 
ª
-
lﬂd
 
¸3
Åÿ
f‹˚
 
this
Åÿ
h≠≥n


284 ; - 
XXXX
 dÿ
we
 
√ed
 
to
 
shoŸ
 
down
 
the
 
TLBs
 
⁄
 
Ÿhî
 
c‹es
 
wôh
 
™
 
IPI
??

285 ; - 
might
 
√ed
 
to
 
ju°
 
make
 
suª
 
we
 
d⁄
'tÅakeÖages from otherÖrocesses, sinceÅhe TLB clearing is currently

286 ; 
⁄ly
 
u£d
 
to
 
˛ór
 
the
 
TLB
 
whí
 
we
 
èke
 
∑ge
 
out
 
a
Öagê
‰om
á 
¥o˚ss
, 
√ed
Åÿ
ísuª
ÅhêTLB 
	`íåy
 (
™y
)

287 ; 
ô
 
is
 
˛óªd
. 
Whí
 
we
 
°¨t
 
to
 
have
 
sh¨ed
 
mem‹y
 
bëwìn
 
c‹es
, 
wûl
 
√ed
Åÿ
look
 
©
 
a
 
fuŒ
 
shoŸdown


288 ; 
°øãgy
.

290 
Æign
 8

291 
Flush_TLB
:

292 
mov
 
óx
, 
¸3


293 
mov
 
¸3
, 
óx


294 
ªt


297 
APIC_BASE
 
equ
 0xFEE00000

298 
APIC_ID
 
equ
 0x20

301 ;; 
óx
 = &
g_cuºítThªads
[
	`Gë_CPU_ID
()];

303 %
ma¸o
 
Mov_EAX_Cuºít_Thªad_PTR
 0

304 
mov
 
óx
, [
APIC_BASE
+
APIC_ID
] ;; 
lﬂd
 
id
 
of
 
loˇl
 
	$APC
 (
which
 
is
 
˝uid
)

305 
shr
 
óx
, 24-2 ;; 
id
 
is
 
ö
 
high
 24 
bôs
 
of
 , 
but
 
√ed
 id <<2

306 
add
 
óx
, 
g_cuºítThªads


307 %
ídma¸o


309 %
ma¸o
 
Push_Cuºít_Thªad_PTR
 0

310 
Mov_EAX_Cuºít_Thªad_PTR


311 
push
 
dw‹d
 [
óx
]

312 %
ídma¸o


314 ; 
Comm⁄
 
öãºu±
 
h™dlög
 
code
.

315 ; 
Save
 
ªgi°îs
, 
ˇŒ
 
C
 
h™dÀr
 
fun˘i⁄
,

316 ; 
possibly
 
choo£
 
a
 
√w
 
thªad
 
to
 
run
, 
ª°‹e


317 ; 
ªgi°îs
,  
‰om
 
the
 
öãºu±
.

318 
Æign
 8

319 
H™dÀ_I¡îru±
:

320 ; 
Save
 
	$ªgi°îs
 (
gíîÆ
 
puΩo£
 
™d
 
£gmít
)

321 
Save_Regi°îs


323 ; 
Ensuª
 
th©
 
we
're usingÅhe kernel data segment

324 
mov
 
ax
, 
KERNEL_DS


325 
mov
 
ds
, 
ax


326 
mov
 
es
, 
ax


328 ; 
gë
 
the
 
kî√l
 
lock
 
öãºu±s
 
wîe
 
⁄
 
bef‹e
 

329 
ã°
 
w‹d
 [
e•
+
EFLAGS_SKIP
], 
EFLAGS_IF


330 
jz
 .
skùLock


331 
ˇŒ
 
lockKî√l


332 .
skùLock
:

334 ; 
Gë
 
the
 
addªss
 
of
Åhê
C
 
h™dÀr
 
fun˘i⁄
 
‰om
Åhe

335 ; 
èbÀ
 
of
 
h™dÀr
 
fun˘i⁄s
.

336 
mov
 
óx
, 
g_öãºu±TabÀ
 ; 
gë
 
addªss
 
of
 
h™dÀr
 
èbÀ


337 
mov
 
esi
, [
e•
+
REG_SKIP
] ; 
gë
 
öãºu±
 
numbî


338 
mov
 
ebx
, [
óx
+
esi
*4] ; 
gë
 
addªss
 
of
 
h™dÀr
 
fun˘i⁄


340 ; 
CÆl
 
the
 
h™dÀr
.

341 ; 
The
 
¨gumít
 
∑s£d
 
is
 
a
 
poöãr
 
to
 
™
 
I¡îru±_Sèã
 ,

342 ; 
which
 
des¸ibes
 
the
 
°ack
 
œyout
 
Æl
 
öãºu±s
.

343 
push
 
e•


344 
ˇŒ
 
ebx


345 
add
 
e•
, 4 ; 
˛ór
 1 
¨gumít


347 ; 
If
 
¥ìm±i⁄
 
is
 
dißbÀd
, 
thí
 
the
 
cuºít
 
thªad


348 ; 
kìps
 
ru¬ög
.

350 
mov
 
ebx
, [
APIC_BASE
+
APIC_ID
] ;; 
lﬂd
 
id
 
of
 
loˇl
 
	$APC
 (
which
 
is
 
˝uid
)

351 
shr
 
ebx
, 24-2 ;; 
id
 
is
 
ö
 
high
 24 
bôs
 
of
 , 
but
 
√ed
 id <<2

352 
cmp
 [
g_¥ìm±i⁄DißbÀd
+
ebx
], 
dw‹d
 0

353 
j√
 .
ª°‹e


355 ; 
Sì
 
we
 
√ed
 
to
 
choo£
 
a
 
√w
 
thªad
Åÿ
run
.

356 
mov
 
ebx
, [
APIC_BASE
+
APIC_ID
] ;; 
lﬂd
 
id
 
of
 
loˇl
 
	$APC
 (
which
 
is
 
˝uid
)

357 
shr
 
ebx
, 24-2 ;; 
id
 
is
 
ö
 
high
 24 
bôs
 
of
 , 
but
 
√ed
 id <<2

358 
cmp
 [
g_√edRescheduÀ
+
ebx
], 
dw‹d
 0

359 
je
 .
ª°‹e


361 ; 
Put
 
cuºít
 
thªad
 
back
 
⁄
 
the
 
run
 
queue


362 
Push_Cuºít_Thªad_PTR


363 
ˇŒ
 
Make_Ru¬abÀ


364 
add
 
e•
, 4 ; 
˛ór
 1 
¨gumít


366 ; 
Save
 
°ack
 
poöãr
 
ö
 
cuºít
 
thªad
 
c⁄ãxt
, 
™d


367 ; 
˛ór
 
numTicks
 
fõld
.

368 ;; 
XXX
 - 
ﬁd
 
code
 
mov
 
óx
, [
g_cuºítThªads
]

369 
Mov_EAX_Cuºít_Thªad_PTR


370 
mov
 
óx
, [eax]

371 
mov
 [
óx
+0], 
e•
 ;É• 
fõld


372 
mov
 [
óx
+4], 
dw‹d
 0 ; 
numTicks
 
fõld


374 ; 
Pick
 
a
 
√w
 
thªad
 
to
 
run
, 
™d
 tÿ
ôs
 
°ack


375 
ˇŒ
 
Gë_Next_Ru¬abÀ


376 ;; 
mov
 [
g_cuºítThªads
], 
óx


377 
mov
 
ebx
, 
óx


378 
Mov_EAX_Cuºít_Thªad_PTR


379 
mov
 [
óx
], 
ebx


380 
mov
 
e•
, [
ebx
+0] ;É• 
fõld


382 ; 
CÀ¨
 "√edÑescheduÀ" 
Êag


383 
mov
 
ebx
, [
APIC_BASE
+
APIC_ID
] ;; 
lﬂd
 
id
 
of
 
loˇl
 
	$APC
 (
which
 
is
 
˝uid
)

384 
shr
 
ebx
, 24-2 ;; 
id
 
is
 
ö
 
high
 24 
bôs
 
of
 , 
but
 
√ed
 id <<2

385 
mov
 [
g_√edRescheduÀ
+
ebx
], 
dw‹d
 0

387 .
ª°‹e
:

388 ; 
A˘iv©e
 
the
 
u£r
 
c⁄ãxt
, 
√˚sßry
.

389 
A˘iv©e_U£r_C⁄ãxt


391 
Pro˚ss_Sig«l
 .
föish


392 .
föish
:

394 ; 
˛ór
 
APIC
 
I¡îru±
 
öfo


395 
mov
 [
APIC_BASE
+
APIC_EOI
], 
dw‹d
 0

397 ; 
ªÀa£e
 
the
 
kî√l
 
lock
 
öãºu±s
 
wûl
 
be
 
ª
-
íabÀd


398 
ã°
 
w‹d
 [
e•
+
EFLAGS_SKIP
], 
EFLAGS_IF


399 
jz
 .
skùU∆ock


400 
ˇŒ
 
u∆ockKî√l


401 .
skùU∆ock
:

403 ; 
Re°‹e
 
ªgi°îs


404 
Re°‹e_Regi°îs


406 ; 
Rëu∫
 
‰om
 
the
 
öãºu±
.

407 
úë


410 ; 
	`Swôch_To_Thªad
()

411 ; 
Save
 
c⁄ãxt
 
of
 
cuºíéy
 
executög
 
thªad
, 
™d
 
a˘iv©e


412 ; 
the
 
thªad
 
who£
 
c⁄ãxt
 
obje˘
 
is
 
∑s£d
 
as
 
a
 
∑ømëî
.

414 ; 
P¨amëî
:

415 ; - 
±r
 
to
 
Kî√l_Thªad
 
who£
 
°©e
 
should
 
be
 
ª°‹ed
 
™d
 
made
 
a˘ive


417 ; 
NŸes
:

418 ; 
CÆÀd
 
wôh
 
öãºu±s
 
dißbÀd
.

419 ; 
This
 
mu°
 
be
 
kït
 
up
 
to
 
d©e
 
wôh
 
deföôi⁄
 
of
 
Kî√l_Thªad


420 ; , 
ö
 
kthªad
.
h
.

422 
Æign
 16

423 
Swôch_To_Thªad
:

424 ; 
Modify
 
the
 
°ack
 
to
 
Ælow
 
a
 
œãr
  
vü
 
™
 
úë
 
ö°ru˘i⁄
.

425 ; 
We
 
°¨t
 
wôh
 
a
 
°ack
 
th©
 
looks
 
like
 
this
:

427 ; 
thªad_±r


428 ; 
e•
 -->  
addr


430 ; 
We
 
ch™ge
 
ô
 
to
 
look
 
like
 
this
:

432 ; 
thªad_±r


433 ; 
eÊags


434 ; 
cs


435 ; 
e•
 -->  
addr


437 
push
 
óx
 ; 
ßve
Éax

438 
mov
 
óx
, [
e•
+4] ; 
gë
  
addªss


439 
mov
 [
e•
-4], 
óx
 ; 
move
  
addr
 
down
 8 
byãs
 
‰om
 
‹ig
 
loc


440 
add
 
e•
, 8 ; 
move
 
°ack
 
±r
 
up


441 
pushfd
 ; 
put
 
eÊags
 
whîe
  
addªss
 
was


442 
mov
 
óx
, [
e•
-4] ; 
ª°‹e
 
ßved
 
vÆue
 
of
Éax

443 
push
 
dw‹d
 
KERNEL_CS
 ;Öush 
cs
 
£À˘‹


444 
sub
 
e•
, 4 ; 
poöt
 
°ack
 
±r
 
©
  
addªss


446 ; 
Push
 
Áke
 
îr‹
 
code
 
™d
 
öãºu±
 
numbî


447 
push
 
dw‹d
 0

448 
push
 
dw‹d
 0

450 ; 
Save
 
gíîÆ
 
puΩo£
 
ªgi°îs
.

451 
Save_Regi°îs


453 ; 
gë
 
the
 
kî√l
 
lock
 
öãºu±s
 
wîe
 
⁄
 
bef‹e
 

454 
ã°
 
w‹d
 [
e•
+
EFLAGS_SKIP
], 
EFLAGS_IF


455 
jz
 .
skùLock


456 
ˇŒ
 
lockKî√l


457 .
skùLock
:

459 ; 
Save
 
°ack
 
poöãr
 
ö
 
the
 
thªad
 
c⁄ãxt
 (
©
 
off£t
 0).

460 
Mov_EAX_Cuºít_Thªad_PTR


461 
mov
 
óx
, [eax]

462 
mov
 [
óx
+0], 
e•


464 ; 
CÀ¨
 
numTicks
 
fõld
 
ö
 
thªad
 
c⁄ãxt
, 
sö˚
 
this


465 ; 
thªad
 
is
 
beög
 
su•íded
.

466 
mov
 [
óx
+4], 
dw‹d
 0

468 ; 
Lﬂd
 
the
 
poöãr
 
to
Åhê
√w
 
thªad
 
c⁄ãxt
 
öto
 
óx
.

469 ; 
We
 
skù
 
ovî
 
the
 
I¡îru±_Sèã
 
⁄
Åhê
°ack
 
to


470 ; 
gë
 
the
 
∑ømëî
.

471 
mov
 
óx
, [
e•
+
INTERRUPT_STATE_SIZE
]

473 ; 
Make
 
the
 
√w
 
thªad
 
cuºít
, 
™d
 
to
 
ôs
 
°ack
.

474 ;; 
mov
 [
g_cuºítThªads
], 
óx


475 
mov
 
ebx
, 
óx


476 
Mov_EAX_Cuºít_Thªad_PTR


477 
mov
 [
óx
], 
ebx


478 
mov
 
e•
, [
ebx
+0]

480 ; 
A˘iv©e
 
the
 
u£r
 
c⁄ãxt
, 
√˚sßry
.

481 
A˘iv©e_U£r_C⁄ãxt


483 ; 
˛ór
 
APIC
 
I¡îru±
 
öfo


484 
mov
 [
APIC_BASE
+
APIC_EOI
], 
dw‹d
 0

486 
Pro˚ss_Sig«l
 .
com∂ëe


487 .
com∂ëe
:

489 ; 
ªÀa£
 
the
 
kî√l
 
lock
, 
íablög
 
öãºu±s
 
⁄
 
úë


490 
ã°
 
w‹d
 [
e•
+
EFLAGS_SKIP
], 
EFLAGS_IF


491 
jz
 .
skùU∆ock


492 
ˇŒ
 
u∆ockKî√l


493 .
skùU∆ock
:

495 ; 
Re°‹e
 
gíîÆ
 
puΩo£
 
™d
 
£gmít
 
ªgi°îs
,ánd 
˛ór
 
öãºu±


496 ; 
numbî
 
™d
 
îr‹
 
code
.

497 
Re°‹e_Regi°îs


499 ; 
We
'llÑeturnÅoÅheÖlace whereÅheÅhread was

500 ; 
executög
 
œ°
.

501 
úë


503 ; 
Rëu∫
 
cuºít
 
c⁄ã¡s
 
of
 
eÊags
 .

504 
Æign
 16

505 
Gë_Cuºít_EFLAGS
:

506 
pushfd
 ; 
push
 
eÊags


507 
p›
 
óx
 ;Ö› 
c⁄ã¡s
 
öto
Éax

508 
ªt


510 
lock›s
:

511 
dd
 0

513 
Spö_Lock_INTERNAL
:

514 
mov
 
ebx
, [
e•
+4]

515 
mov
 
óx
, 1

516 
lock
 
xchg
 
óx
, [
ebx
]

517 
ã°
 
óx
,Éax

518 
jnz
 
Spö_Lock_INTERNAL


519 
öc
 
dw‹d
 [
lock›s
]

520 
ªt


522 
Spö_U∆ock_INTERNAL
:

523 
mov
 
ebx
, [
e•
+4]

524 
mov
 
óx
, 0

525 
xchg
 
óx
, [
ebx
]

526 
ªt


528 
Síd_Timî_INT
:

529 0
h


530 
ªt


533 ; 
Gíî©e
 
öãºu±
-
•ecific
 
íåy
 
poöts
 
Æl
 
öãºu±s
.

534 ; 
We
 
Æso
 
deföe
 
symbﬁs
 
to
 
ödiˇã
 
the
 
exãnd
 
of
Åhê
èbÀ


535 ; 
of
 
íåy
 
poöts
, 
™d
 
the
 
size
 o‡
ödividuÆ
ÉntryÖoints.

537 
Æign
 16

538 
g_íåyPoötTabÀSèπ
:

540 ; 
H™dÀrs
 
¥o˚ss‹
-
gíî©ed
 
ex˚±i⁄s
, 
as
 
deföed
 
by


541 ; 
I¡ñ
 486 
m™uÆ
.

542 
I¡_No_Eº
 0

543 
Æign
 16

544 
Bef‹e_No_Eº
:

545 
I¡_No_Eº
 1

546 
Æign
 16

547 
A·î_No_Eº
:

548 
I¡_No_Eº
 2 ; 
FIXME
: 
nŸ
 
des¸ibed
 
ö
 486 
m™uÆ


549 
I¡_No_Eº
 3

550 
I¡_No_Eº
 4

551 
I¡_No_Eº
 5

552 
I¡_No_Eº
 6

553 
I¡_No_Eº
 7

554 
Æign
 16

555 
Bef‹e_Eº
:

556 
I¡_Wôh_Eº
 8

557 
Æign
 16

558 
A·î_Eº
:

559 
I¡_No_Eº
 9 ; 
FIXME
: 
nŸ
 
des¸ibed
 
ö
 486 
m™uÆ


560 
I¡_Wôh_Eº
 10

561 
I¡_Wôh_Eº
 11

562 
I¡_Wôh_Eº
 12

563 
I¡_Wôh_Eº
 13

564 
I¡_Wôh_Eº
 14

565 
I¡_No_Eº
 15 ; 
FIXME
: 
nŸ
 
des¸ibed
 
ö
 486 
m™uÆ


566 
I¡_No_Eº
 16

567 
I¡_Wôh_Eº
 17

569 ; 
The
 
ªmaöög
 
	`öãºu±s
 (18 - 255Ëdÿ
nŸ
 
have
 
îr‹
 
codes
.

570 ; 
We
 
ˇn
 
gíî©e
 
them
 
Æl
 
ö
 
⁄e
 
go
 
wôh
 
«sm
's %rep construct.

571 %
assign
 
ötNum
 18

572 %
	`ªp
 (256 - 18)

573 
I¡_No_Eº
 
ötNum


574 %
assign
 
ötNum
 intNum+1

575 %
ídªp


577 
Æign
 16

578 
g_íåyPoötTabÀEnd
:

580 [
SECTION
 .
d©a
]

582 ; 
Exp‹ãd
 
symbﬁs
 
deföög
 
the
 
size
 
of
 
h™dÀr
 
íåy
 
poöts


583 ; (
bŸh
 
wôh
 
™d
 
wôhout
 
îr‹
 
codes
).

584 
Æign
 4

585 
g_h™dÀrSizeNoEº
: 
	`dd
 (
A·î_No_Eº
 - 
Bef‹e_No_Eº
)

586 
Æign
 4

587 
g_h™dÀrSizeEº
: 
	`dd
 (
A·î_Eº
 - 
Bef‹e_Eº
)

	@main.c

19 
	~<gìkos/boŸöfo.h
>

20 
	~<gìkos/°rög.h
>

21 
	~<gìkos/s¸ìn.h
>

22 
	~<gìkos/mem.h
>

23 
	~<gìkos/¸c32.h
>

24 
	~<gìkos/tss.h
>

25 
	~<gìkos/öt.h
>

26 
	~<gìkos/kthªad.h
>

27 
	~<gìkos/å≠.h
>

28 
	~<gìkos/timî.h
>

29 
	~<gìkos/keybﬂrd.h
>

30 
	~<gìkos/dma.h
>

31 
	~<gìkos/ide.h
>

32 
	~<gìkos/Ê›py.h
>

33 
	~<gìkos/pÁt.h
>

34 
	~<gìkos/vfs.h
>

35 
	~<gìkos/u£r.h
>

36 
	~<gìkos/∑gög.h
>

37 
	~<gìkos/gosfs.h
>

38 
	~<gìkos/gfs2.h
>

39 
	~<gìkos/cfs.h
>

40 
	~<gìkos/√t/√2000.h
>

41 
	~<gìkos/√t/√t.h
>

42 
	~<gìkos/√t/√tbuf.h
>

43 
	~<gìkos/√t/¨p.h
>

44 
	~<gìkos/Æ¨m.h
>

45 
	~<gìkos/√t/ù.h
>

46 
	~<gìkos/√t/routög.h
>

47 
	~<gìkos/√t/sockë.h
>

48 
	~<gìkos/√t/rù.h
>

49 
	~<gìkos/¥oje˘s.h
>

50 
	~<gìkos/sound.h
>

51 
	~<gìkos/smp.h
>

52 
	~<gìkos/io.h
>

62 #ifde‡
FD_BOOT


63 
	#ROOT_DEVICE
 "fd0"

	)

64 
	#ROOT_PREFIX
 "a"

	)

66 
	#ROOT_DEVICE
 "ide0"

	)

67 
	#ROOT_PREFIX
 "c"

	)

70 
	#INIT_PROGRAM
 "/" 
ROOT_PREFIX
 "/shñl.exe"

	)

74 
Mou¡_RoŸ_Fûesy°em
();

75 
S∑wn_Inô_Pro˚ss
();

83 
checkPagög
();

86 
	$H¨dw¨e_Shutdown
() {

89 
	`Out_Byã
(0x501, 0x00);

92 
	`Out_Byã
(0x8900, 'S');

93 
	`Out_Byã
(0x8900, 'h');

94 
	`Out_Byã
(0x8900, 'u');

95 
	`Out_Byã
(0x8900, 't');

96 
	`Out_Byã
(0x8900, 'd');

97 
	`Out_Byã
(0x8900, 'o');

98 
	`Out_Byã
(0x8900, 'w');

99 
	`Out_Byã
(0x8900, 'n');

100 
	}
}

102 
	$Maö
(
BoŸ_Info
 *
boŸInfo
) {

103 
	`Inô_BSS
();

104 
	`Inô_S¸ìn
();

105 
	`Inô_Mem
(
boŸInfo
);

106 
	`Inô_CRC32
();

107 
	`Inô_TSS
();

109 
	`lockKî√l
();

110 
	`Inô_I¡îru±s
(0);

111 
	`Inô_SMP
();

112 
	`TODO_P
(
PROJECT_VIRTUAL_MEMORY_A
,

114 
	`Inô_ScheduÀr
(0, (*)
KERN_STACK
);

115 
	`Inô_Tøps
();

116 
	`Inô_Loˇl_APIC
(0);

117 
	`Inô_Timî
();

119 
	`Inô_Keybﬂrd
();

120 
	`Inô_DMA
();

122 
	`Inô_IDE
();

123 
	`Inô_PFAT
();

124 
	`Inô_GFS2
();

125 
	`Inô_GOSFS
();

126 
	`Inô_CFS
();

127 
	`Inô_Aœrm
();

129 
	`Rñó£_SMP
();

132 
	`Inô_Nëw‹k_Devi˚s
();

133 
	`Inô_ARP_PrŸocﬁ
();

134 
	`Inô_IP
();

135 
	`Inô_Routög
();

136 
	`Inô_Sockës
();

137 
	`Inô_RIP
();

141 
	`Inô_Sound_Devi˚s
();

144 
	`Mou¡_RoŸ_Fûesy°em
();

146 
	`TODO_P
(
PROJECT_VIRTUAL_MEMORY_A
, "initializeÖage file.");

148 
	`Së_Cuºít_Aâr
(
	`ATTRIB
(
BLACK
, 
GREEN
 | 
BRIGHT
));

149 
	`Pröt
("WelcomeÅo GeekOS!\n");

150 
	`Së_Cuºít_Aâr
(
	`ATTRIB
(
BLACK
, 
GRAY
));

152 
	`TODO_P
(
PROJECT_SOUND
, "play startup sound");

154 
	`S∑wn_Inô_Pro˚ss
();

157 
	`H¨dw¨e_Shutdown
();

160 
	}
}

164 
	$Mou¡_RoŸ_Fûesy°em
() {

165 i‡(
	`Mou¡
(
ROOT_DEVICE
, 
ROOT_PREFIX
, "pfat") != 0)

166 
	`Pröt
("FaûedÅÿmou¡ /" 
ROOT_PREFIX
 " filesystem\n");

168 
	`Pröt
("Mou¡ed /" 
ROOT_PREFIX
 " filesystem!\n");

170 
	}
}

177 
	$S∑wn_Inô_Pro˚ss
() {

178 
rc
;

179 
Kî√l_Thªad
 *
öôPro˚ss
;

182 
	`Pröt
("S∑wnög inôÖro˚s†(%s)\n", 
INIT_PROGRAM
);

183 
rc
 = 
	`S∑wn_F‹eground
(
INIT_PROGRAM
, INIT_PROGRAM, &
öôPro˚ss
);

185 i‡(
rc
 != 0) {

186 
	`Pröt
("FaûedÅÿ•aw¿öôÖro˚ss:Éº‹ codê%d\n", 
rc
);

189 
exôCode
 = 
	`Joö
(
öôPro˚ss
);

190 
	`Pröt
("InôÖro˚s†exôed wôh codê%d\n", 
exôCode
);

192 
	}
}

	@malloc.c

10 
	~<gìkos/s¸ìn.h
>

11 
	~<gìkos/öt.h
>

12 
	~<gìkos/bgë.h
>

13 
	~<gìkos/kas£π.h
>

14 
	~<gìkos/mÆloc.h
>

15 
	~<gìkos/lock.h
>

16 
	~<°rög.h
>

22 
	$Inô_Hóp
(
ul⁄g_t
 
°¨t
, ul⁄g_à
size
) {

23 
	`Pröt
("Cª©ög kî√»hóp: sèπ=%lx, size=%ld\n", 
°¨t
, 
size
);

24 
	`bpoﬁ
((*)
°¨t
, 
size
);

25 
	}
}

27 
Spö_Lock_t
 
	gmÆlocLock
;

34 *
	$MÆloc
(
ul⁄g_t
 
size
) {

35 
boﬁ
 
iÊag
;

36 *
ªsu…
;

38 
	`KASSERT
(
size
 > 0);

40 
iÊag
 = 
	`Begö_I¡_Atomic
();

41 
ªsu…
 = 
	`bgë
(
size
);

42 
	`End_I¡_Atomic
(
iÊag
);

44 i‡(
ªsu…
)

45 
	`mem£t
(
ªsu…
, '\0', 
size
);

47 i‡(!
ªsu…
) {

49 
	`H¨dw¨e_Shutdown
();

50 
	`H¨dw¨e_Shutdown
();

52  
ªsu…
;

53 
	}
}

58 
	$Fªe
(*
buf
) {

59 
boﬁ
 
iÊag
;

61 
	`KASSERT0
(((()
buf
) & 0x3) == 0,

64 
iÊag
 = 
	`Begö_I¡_Atomic
();

65 
	`bªl
(
buf
);

66 
	`End_I¡_Atomic
(
iÊag
);

67 
	}
}

	@mem.c

18 
	~<gìkos/defs.h
>

19 
	~<gìkos/kty≥s.h
>

20 
	~<gìkos/kas£π.h
>

21 
	~<gìkos/kthªad.h
>

22 
	~<gìkos/boŸöfo.h
>

23 
	~<gìkos/gdt.h
>

24 
	~<gìkos/s¸ìn.h
>

25 
	~<gìkos/öt.h
>

26 
	~<gìkos/mÆloc.h
>

27 
	~<gìkos/°rög.h
>

28 
	~<gìkos/∑gög.h
>

29 
	~<gìkos/mem.h
>

38 
Page
 *
	gg_∑geLi°
;

43 
uöt_t
 
	gg_‰ìPageCou¡
 = 0;

52 
debugFau…s
;

53 
	#Debug
(
¨gs
...Ëi‡(
debugFau…s
Ë
	`Pröt
◊rgs)

	)

58 
Page_Li°
 
	gs_‰ìLi°
;

63 
	gs_numPages
;

68 
	$Add_Page_R™ge
(
ul⁄g_t
 
°¨t
, ul⁄g_à
íd
, 
Êags
) {

69 
ul⁄g_t
 
addr
;

71 
	`KASSERT
(
	`Is_Page_Mu…ùÀ
(
°¨t
));

72 
	`KASSERT
(
	`Is_Page_Mu…ùÀ
(
íd
));

73 
	`KASSERT
(
°¨t
 < 
íd
);

75 
addr
 = 
°¨t
;ádd∏< 
íd
;ádd∏+
PAGE_SIZE
) {

76 
Page
 *
∑ge
 = 
	`Gë_Page
(
addr
);

78 
∑ge
->
Êags
 = flags;

80 i‡(
Êags
 =
PAGE_AVAIL
) {

82 
	`Unchecked_Add_To_Back_Of_Page_Li°
(&
s_‰ìLi°
, 
∑ge
);

85 ++
g_‰ìPageCou¡
;

87 
	`Së_Next_In_Page_Li°
(
∑ge
, 0);

88 
	`Së_Pªv_In_Page_Li°
(
∑ge
, 0);

91 
∑ge
->
˛ock
 = 0;

92 
∑ge
->
vaddr
 = 0;

93 
∑ge
->
c⁄ãxt
 = 
NULL
;

94 
∑ge
->
íåy
 = 0;

96 
	}
}

106 
íd
;

112 
	$Inô_Mem
(
BoŸ_Info
 *
boŸInfo
) {

113 i‡(!
boŸInfo
->
memSizeKB
) {

115 
i
;

117 
i
 = 0; i < 
boŸInfo
->
numMemRegi⁄s
; i++) {

118 i‡((
boŸInfo
->
memRegi⁄s
[
i
].
ba£Addr_low
 == 0x100000) &&

119 (
boŸInfo
->
memRegi⁄s
[
i
].
ty≥
 == 1)) {

120 
boŸInfo
->
memSizeKB
 =

121 
boŸInfo
->
memRegi⁄s
[
i
].
Àngth_low
 / 1024;

124 
boŸInfo
->
memSizeKB
 += 0x1000;

127 
ul⁄g_t
 
numPages
 = 
boŸInfo
->
memSizeKB
 >> 2;

128 
ul⁄g_t
 
ídOfMem
 = 
numPages
 * 
PAGE_SIZE
;

129 
numPageLi°Byãs
 = (
Page
Ë* 
numPages
;

130 
ul⁄g_t
 
∑geLi°Addr
;

131 
ul⁄g_t
 
kînEnd
;

132 
ul⁄g_t
 
∑geLi°End
;

134 
	`KASSERT
(
boŸInfo
->
memSizeKB
 > 0);

140 
	`Inô_GDT
(0);

148 
∑geLi°Addr
 = (
HIGHMEM_START
 + 
KERNEL_HEAP_SIZE
);

149 i‡(
∑geLi°Addr
 >
ídOfMem
) {

150 
Pröt


152 
KERNEL_HEAP_SIZE
, 
HIGHMEM_START
, 
ídOfMem
);

153 
	`KASSERT0
(
∑geLi°Addr
 < 
ídOfMem
,

156 
g_∑geLi°
 = (
Page
 *)
∑geLi°Addr
;

157 
∑geLi°End
 = 
	`Round_Up_To_Page
(
∑geLi°Addr
 + 
numPageLi°Byãs
);

160 
	`mem£t
((*)
g_∑geLi°
, '\0', (
∑geLi°End
 - (
ul⁄g_t
) g_pageList));

162 
kînEnd
 = 
	`Round_Up_To_Page
(()&
íd
);

163 
s_numPages
 = 
numPages
;

169 
	`KASSERT
(
ISA_HOLE_END
 =
KERN_THREAD_OBJ
);

170 
	`KASSERT
(
KERN_STACK
 =
KERN_THREAD_OBJ
 + 
PAGE_SIZE
);

184 
	`Add_Page_R™ge
(0, 
PAGE_SIZE
, 
PAGE_UNUSED
);

185 
	`Add_Page_R™ge
(
PAGE_SIZE
, 
KERNEL_START_ADDR
, 
PAGE_AVAIL
);

186 
	`Add_Page_R™ge
(
KERNEL_START_ADDR
, 
kînEnd
, 
PAGE_KERN
);

187 
	`Add_Page_R™ge
(
kînEnd
, 
ISA_HOLE_START
, 
PAGE_AVAIL
);

188 
	`Add_Page_R™ge
(
ISA_HOLE_START
, 
ISA_HOLE_END
, 
PAGE_HW
);

189 
	`Add_Page_R™ge
(
ISA_HOLE_END
, 
HIGHMEM_START
, 
PAGE_ALLOCATED
);

190 
	`Add_Page_R™ge
(
HIGHMEM_START
, HIGHMEM_START + 
KERNEL_HEAP_SIZE
,

191 
PAGE_HEAP
);

192 
	`Add_Page_R™ge
(
∑geLi°Addr
, 
∑geLi°End
, 
PAGE_KERN
);

193 i‡(
∑geLi°End
 > 
ídOfMem
) {

194 
	`KASSERT0
(
∑geLi°End
 < 
ídOfMem
,

198 
	`Add_Page_R™ge
(
∑geLi°End
, 
ídOfMem
, 
PAGE_AVAIL
);

201 
	`Inô_Hóp
(
HIGHMEM_START
, 
KERNEL_HEAP_SIZE
);

203 
Pröt


205 
boŸInfo
->
memSizeKB
, 
g_‰ìPageCou¡
, 
KERNEL_HEAP_SIZE
);

206 
	}
}

211 
	$Inô_BSS
() {

212 
BSS_START
, 
BSS_END
;

215 
	`mem£t
(&
BSS_START
, '\0', &
BSS_END
 - &BSS_START);

216 
	}
}

218 *
	$AŒoc_Page_Føme
() {

219 
Page
 *
∑ge
;

220 *
ªsu…
 = 0;

223 i‡(!
	`Is_Page_Li°_Em±y
(&
s_‰ìLi°
)) {

225 
∑ge
 = 
	`Gë_Fr⁄t_Of_Page_Li°
(&
s_‰ìLi°
);

226 
	`KASSERT
((
∑ge
->
Êags
 & 
PAGE_ALLOCATED
) == 0);

227 
	`Remove_From_Fr⁄t_Of_Page_Li°
(&
s_‰ìLi°
);

230 
∑ge
->
Êags
 |
PAGE_ALLOCATED
;

231 
g_‰ìPageCou¡
--;

232 
ªsu…
 = (*)
	`Gë_Page_Addªss
(
∑ge
);

235 i‡(
ªsu…
) {

236 
	`mem£t
(
ªsu…
, '\0', 4096);

239  
ªsu…
;

240 
	}
}

246 
Page
 *
	$Föd_Page_To_Page_Out
() {

247 
i
;

248 
Page
 *
cuº
, *
be°
;

249 
be°
 = 
NULL
;

250 
i
 = 0; i < 
s_numPages
; i++) {

251 i‡((
g_∑geLi°
[
i
].
Êags
 & 
PAGE_PAGEABLE
) &&

252 (
g_∑geLi°
[
i
].
Êags
 & 
PAGE_ALLOCATED
)) {

253 i‡(!
be°
)

254 
be°
 = &
g_∑geLi°
[
i
];

255 
cuº
 = &
g_∑geLi°
[
i
];

256 i‡((
cuº
->
˛ock
 < 
be°
->˛ockË&& (cuº->
Êags
 & 
PAGE_PAGEABLE
)) {

257 
be°
 = 
cuº
;

261  
be°
;

264 
	}
}

275 *
	$AŒoc_Or_Re˛aim_Page
(
±e_t
 * 
íåy
, 
ul⁄g_t
 
vaddr
,

276 
boﬁ
 
pö√dPage
) {

277 
boﬁ
 
iÊag
;

278 
boﬁ
 
m≠≥dPage
;

279 *
∑ddr
 = 0;

280 
Page
 *
∑ge
 = 0;

282 
iÊag
 = 
	`Begö_I¡_Atomic
();

284 
	`KASSERT
(!
	`I¡îru±s_E«bÀd
());

285 
	`KASSERT
(
	`Is_Page_Mu…ùÀ
(
vaddr
));

287 
∑ddr
 = 
	`AŒoc_Page_Føme
();

288 i‡(
∑ddr
 != 0) {

289 
∑ge
 = 
	`Gë_Page
((
ul⁄g_t
Ë
∑ddr
);

290 
	`KASSERT
((
∑ge
->
Êags
 & 
PAGE_PAGEABLE
) == 0);

292 
∑gefûeIndex
;

295 
	`Debug
("AboutÅo hunt foráÖageÅoÖage out\n");

296 
∑ge
 = 
	`Föd_Page_To_Page_Out
();

297 
	`KASSERT
(
∑ge
->
Êags
 & 
PAGE_PAGEABLE
);

299 
∑ddr
 = (*)
	`Gë_Page_Addªss
(
∑ge
);

300 
	`Debug
("Sñe˘edÖagê©ádd∏%∞◊gê%d)\n", 
∑ddr
, 
∑ge
->
˛ock
);

303 
∑ge
->
Êags
 &~(
PAGE_PAGEABLE
);

306 
∑ge
->
Êags
 |
PAGE_LOCKED
;

309 i‡(
	`Is_Mm≠ed_Page
(
∑ge
->
c⁄ãxt
,Öage->
vaddr
)) {

310 
m≠≥dPage
 = 
åue
;

311 i‡(
∑ge
->
íåy
->
dúty
) {

312 
	`E«bÀ_I¡îru±s
();

313 
	`Wrôe_Out_Mm≠ed_Page
(
∑ge
->
c⁄ãxt
,Öage->
vaddr
);

314 
	`DißbÀ_I¡îru±s
();

315 
∑ge
->
íåy
->
dúty
 = 0;

317 
∑ge
->
íåy
->
¥e£¡
 = 0;

319 
m≠≥dPage
 = 
Ál£
;

322 
∑gefûeIndex
 = 
	`Föd_S∑˚_On_Pagög_Fûe
();

323 i‡(
∑gefûeIndex
 < 0) {

325 
	`KASSERT0
(
∑ddr
 =
NULL
,

327 
d⁄e
;

329 
	`Debug
("FªêdiskÖagê© index %d\n", 
∑gefûeIndex
);

332 
	`Debug
("WrôögÖhysiˇ»‰amê%∞tÿ∑gög fûê© %d\n", 
∑ddr
,

333 
∑gefûeIndex
);

334 
	`E«bÀ_I¡îru±s
();

335 
	`Wrôe_To_Pagög_Fûe
(
∑ddr
, 
∑ge
->
vaddr
, 
∑gefûeIndex
);

336 
	`DißbÀ_I¡îru±s
();

338 
	`Debug
("WrŸêphysiˇ»‰amê%∞tÿ∑gög fûê© %d\n", 
∑ddr
,

339 
∑gefûeIndex
);

343 i‡(
∑ge
->
Êags
 & 
PAGE_ALLOCATED
) {

346 
∑ge
->
íåy
->
¥e£¡
 = 0;

347 i‡(!
m≠≥dPage
) {

348 
∑ge
->
íåy
->
kî√lInfo
 = 
KINFO_PAGE_ON_DISK
;

349 
∑ge
->
íåy
->
∑geBa£Addr
 = 
∑gefûeIndex
;

353 i‡(!
m≠≥dPage
) {

354 
	`Fªe_S∑˚_On_Pagög_Fûe
(
∑gefûeIndex
);

358 
∑ge
->
Êags
 |
PAGE_ALLOCATED
;

362 
∑ge
->
Êags
 &~(
PAGE_LOCKED
);

365 
	`Flush_TLB
();

369 i‡(
pö√dPage
) {

370 
∑ge
->
Êags
 |
PAGE_LOCKED
;

371 
∑ge
->
íåy
 = 
NULL
;

372 
∑ge
->
vaddr
 = 0;

373 
∑ge
->
c⁄ãxt
 = 
NULL
;

375 
∑ge
->
Êags
 |
PAGE_PAGEABLE
;

376 
∑ge
->
íåy
 =Éntry;

377 
∑ge
->
íåy
->
kî√lInfo
 = 0;

378 
∑ge
->
vaddr
 = vaddr;

379 
∑ge
->
c⁄ãxt
 = 
CURRENT_THREAD
->
u£rC⁄ãxt
;

380 
	`KASSERT
(
∑ge
->
Êags
 & 
PAGE_ALLOCATED
);

383 
d⁄e
:

384 
	`End_I¡_Atomic
(
iÊag
);

385  
∑ddr
;

386 
	}
}

391 *
	$AŒoc_Page
() {

392 *
ªt
;

394 
ªt
 = 
	`AŒoc_Or_Re˛aim_Page
(
NULL
, 0, 
åue
);

395 i‡(!
ªt
) {

397 
	`H¨dw¨e_Shutdown
();

398 
	`H¨dw¨e_Shutdown
();

401  
ªt
;

402 
	}
}

413 *
	$AŒoc_PagóbÀ_Page
(
±e_t
 * 
íåy
, 
ul⁄g_t
 
vaddr
) {

414  
	`AŒoc_Or_Re˛aim_Page
(
íåy
, 
vaddr
, 
Ál£
);

415 
	}
}

420 
	$Fªe_Page
(*
∑geAddr
) {

421 
ul⁄g_t
 
addr
 = (ul⁄g_tË
∑geAddr
;

422 
Page
 *
∑ge
;

424 
	`mem£t
(
∑geAddr
, '\0', 4096);

426 
	`KASSERT
(
	`Is_Page_Mu…ùÀ
(
addr
));

429 
∑ge
 = 
	`Gë_Page
(
addr
);

430 
	`KASSERT0
(
∑ge
, "Couldn't findá struct Page * forÅhe givenÖageAddr");

432 
	`KASSERT0
((
∑ge
->
Êags
 & 
PAGE_ALLOCATED
) != 0,

436 
∑ge
->
Êags
 &~(
PAGE_ALLOCATED
);

439 i‡(
∑ge
->
Êags
 & 
PAGE_LOCKED
)

443 
∑ge
->
Êags
 &~(
PAGE_PAGEABLE
);

446 
∑ge
->
íåy
 = 0;

449 
	`Add_To_Back_Of_Page_Li°
(&
s_‰ìLi°
, 
∑ge
);

450 
g_‰ìPageCou¡
++;

452 
	}
}

	@paging.c

18 
	~<gìkos/°rög.h
>

19 
	~<gìkos/öt.h
>

20 
	~<gìkos/idt.h
>

21 
	~<gìkos/kthªad.h
>

22 
	~<gìkos/kas£π.h
>

23 
	~<gìkos/s¸ìn.h
>

24 
	~<gìkos/mem.h
>

25 
	~<gìkos/mÆloc.h
>

26 
	~<gìkos/gdt.h
>

27 
	~<gìkos/£gmít.h
>

28 
	~<gìkos/u£r.h
>

29 
	~<gìkos/vfs.h
>

30 
	~<gìkos/¸c32.h
>

31 
	~<gìkos/∑gög.h
>

32 
	~<gìkos/î∫o.h
>

33 
	~<gìkos/¥oje˘s.h
>

34 
	~<gìkos/smp.h
>

36 
	~<libc/mm≠.h
>

46 
	#SECTORS_PER_PAGE
 (
PAGE_SIZE
 / 
SECTOR_SIZE
)

	)

51 
	gdebugFau…s
 = 0;

52 
	#Debug
(
¨gs
...Ëi‡(
debugFau…s
Ë
	`Pröt
◊rgs)

	)

55 c⁄° 
pde_t
 *
	$Kî√l_Page_Dú
() {

56 
	`TODO_P
(
PROJECT_VIRTUAL_MEMORY_A
,

58  
NULL
;

59 
	}
}

66 
	$Pröt_Fau…_Info
(
uöt_t
 
addªss
, 
Áu…code_t
 
Áu…Code
) {

67 
uöt_t
 
g_‰ìPageCou¡
;

69 
	`Pröt
("Pid %d: ", 
CURRENT_THREAD
->
pid
);

70 
	`Pröt
("\n Page FaultÑeceived,átáddress %p (%dÖages free)\n",

71 (*)
addªss
, 
g_‰ìPageCou¡
);

72 i‡(
Áu…Code
.
¥Ÿe˘i⁄Viﬁ©i⁄
)

73 
	`Pröt
(" Protection Violation, ");

75 
	`Pröt
(" Non-presentÖage, ");

76 i‡(
Áu…Code
.
wrôeFau…
)

77 
	`Pröt
("Write Fault, ");

79 
	`Pröt
("Read Fault, ");

80 i‡(
Áu…Code
.
u£rModeFau…
)

81 
	`Pröt
("in User Mode\n");

83 
	`Pröt
("in Supervisor Mode\n");

84 
	}
}

92  
	$Page_Fau…_H™dÀr
(
I¡îru±_Sèã
 *
°©e
) {

93 
ul⁄g_t
 
addªss
;

94 
Áu…code_t
 
Áu…Code
;

96 
	`KASSERT
(!
	`I¡îru±s_E«bÀd
());

99 
addªss
 = 
	`Gë_Page_Fau…_Addªss
();

100 
	`Debug
("PagêÁu… @%lx\n", 
addªss
);

102 i‡(
addªss
 < 0xfec01000 &&áddress > 0xf0000000) {

103 
	`KASSERT0
(0, "page faultáddress in APIC/IOAPICÑange\n");

107 
Áu…Code
 = *((
Áu…code_t
 *Ë& (
°©e
->
îr‹Code
));

110 
	`TODO_P
(
PROJECT_VIRTUAL_MEMORY_B
, "handleÖage faults");

112 
	`TODO_P
(
PROJECT_MMAP
, "handle mmap'dÖage faults");

115 
îr‹
:

116 
	`Pröt
("Unexpected Page FaultÑeceived\n");

117 
	`Pröt_Fau…_Info
(
addªss
, 
Áu…Code
);

118 
	`Dump_I¡îru±_Sèã
(
°©e
);

120 i‡(!
Áu…Code
.
u£rModeFau…
)

121 
	`KASSERT0
(0, "unhandled kernel-modeÖage fault.");

124 
	`Exô
(-1);

125 
	}
}

127 
	$Idíôy_M≠_Page
(
pde_t
 * 
cuºítPageDú
, 
addªss
, 
Êags
) {

128 
	}
}

139 
	$Inô_VM
(
BoŸ_Info
 *
boŸInfo
) {

149 
	`TODO_P
(
PROJECT_VIRTUAL_MEMORY_A
,

151 
	}
}

153 
	$Inô_Sec⁄d¨y_VM
() {

154 
	`TODO_P
(
PROJECT_VIRTUAL_MEMORY_A
, "enableÖaging on secondary cores");

155 
	}
}

162 
	$Inô_Pagög
() {

163 
	`TODO_P
(
PROJECT_VIRTUAL_MEMORY_B
,

165 
	}
}

173 
	$Föd_S∑˚_On_Pagög_Fûe
() {

174 
	`KASSERT
(!
	`I¡îru±s_E«bÀd
());

175 
	`TODO_P
(
PROJECT_VIRTUAL_MEMORY_B
, "Find freeÖage inÖaging file");

176  
EUNSUPPORTED
;

177 
	}
}

184 
	$Fªe_S∑˚_On_Pagög_Fûe
(
∑gefûeIndex
) {

185 
	`KASSERT
(!
	`I¡îru±s_E«bÀd
());

186 
	`TODO_P
(
PROJECT_VIRTUAL_MEMORY_B
, "FreeÖage inÖaging file");

187 
	}
}

197 
	$Wrôe_To_Pagög_Fûe
(*
∑ddr
, 
ul⁄g_t
 
vaddr
, 
∑gefûeIndex
) {

198 
Page
 *
∑ge
 = 
	`Gë_Page
((
ul⁄g_t
Ë
∑ddr
);

199 
	`KASSERT
(!(
∑ge
->
Êags
 & 
PAGE_PAGEABLE
));

200 
	`TODO_P
(
PROJECT_VIRTUAL_MEMORY_B
, "WriteÖage dataÅoÖaging file");

201 
	}
}

212 
	$Ród_From_Pagög_Fûe
(*
∑ddr
, 
ul⁄g_t
 
vaddr
, 
∑gefûeIndex
) {

213 
Page
 *
∑ge
 = 
	`Gë_Page
((
ul⁄g_t
Ë
∑ddr
);

214 
	`KASSERT
(!(
∑ge
->
Êags
 & 
PAGE_PAGEABLE
));

215 
	`TODO_P
(
PROJECT_VIRTUAL_MEMORY_B
, "ReadÖage data fromÖaging file");

216 
	}
}

219 *
	$Mm≠_Im∂
(*
±r
, 
Àngth
, 
¥Ÿ
, 
Êags
, 
fd
) {

220 
	`TODO_P
(
PROJECT_MMAP
, "Mmap setup mapping");

221  
NULL
;

222 
	}
}

224 
boﬁ
 
	$Is_Mm≠ed_Page
(
U£r_C⁄ãxt
 * 
c⁄ãxt
, 
ul⁄g_t
 
vaddr
) {

225 
	`TODO_P
(
PROJECT_MMAP
,

227  
Ál£
;

228 
	}
}

230 
	$Wrôe_Out_Mm≠ed_Page
(
U£r_C⁄ãxt
 *
c⁄ãxt
, 
ul⁄g_t
 
vaddr
) {

231 
	`TODO_P
(
PROJECT_MMAP
, "Mmap write back dirty mmap'dÖage");

232 
	}
}

234 
	$Munm≠_Im∂
(
ul⁄g_t
 
±r
) {

235 
	`TODO_P
(
PROJECT_MMAP
, "unmappÅheÖages");

236 
	}
}

	@pfat.c

16 
	~<limôs.h
>

17 
	~<gìkos/î∫o.h
>

18 
	~<gìkos/s¸ìn.h
>

19 
	~<gìkos/°rög.h
>

20 
	~<gìkos/mÆloc.h
>

21 
	~<gìkos/ide.h
>

22 
	~<gìkos/blockdev.h
>

23 
	~<gìkos/bô£t.h
>

24 
	~<gìkos/vfs.h
>

25 
	~<gìkos/li°.h
>

26 
	~<gìkos/synch.h
>

27 
	~<gìkos/pÁt.h
>

28 
	~<gìkos/¥oje˘s.h
>

47 
	#PAGEFILE_FILENAME
 "/∑gefûe.bö"

	)

49 
	gdebugPFAT
 = 0;

50 
	#Debug
(
¨gs
...Ëi‡(
debugPFAT
Ë
	`Pröt
("PFAT: "árgs)

	)

52 
	gPFAT_Fûe
;

53 
DEFINE_LIST
(
PFAT_Fûe_Li°
, 
PFAT_Fûe
);

59 
	sPFAT_In°™˚
 {

60 
boŸSe˘‹
 
	mfsöfo
;

61 *
	mÁt
;

62 
dúe˘‹yE¡ry
 *
	mroŸDú
;

63 
dúe˘‹yE¡ry
 
	mroŸDúE¡ry
;

64 
Muãx
 
	mlock
;

65 
PFAT_Fûe_Li°
 
	mfûeLi°
;

74 
	sPFAT_Fûe
 {

75 
dúe˘‹yE¡ry
 *
	míåy
;

76 
ul⁄g_t
 
	mnumBlocks
;

77 
	mcuºBlock
;

78 *
	mfûeD©aCache
;

79 
Muãx
 
	mlock
;

80 
DEFINE_LINK
(
PFAT_Fûe_Li°
, 
PFAT_Fûe
);

82 
IMPLEMENT_LIST
(
PFAT_Fûe_Li°
, 
PFAT_Fûe
);

88 
	$C›y_Sèt
(
VFS_Fûe_Sèt
 *
°©
, 
dúe˘‹yE¡ry
 * 
íåy
) {

89 
°©
->
size
 = 
íåy
->
fûeSize
;

90 
°©
->
isDúe˘‹y
 = 
íåy
->
dúe˘‹y
;

92 
°©
->
isSëuid
 = 
íåy
->
isSëUid
;

93 
	`mem˝y
(
°©
->
a˛s
, 
íåy
->acls, (stat->acls));

94 
	}
}

99 
	$PFAT_FSèt
(
Fûe
 *
fûe
, 
VFS_Fûe_Sèt
 *
°©
) {

100 
PFAT_Fûe
 *
pÁtFûe
 = (PFAT_Fûê*)
fûe
->
fsD©a
;

101 
	`C›y_Sèt
(
°©
, 
pÁtFûe
->
íåy
);

103 
	}
}

108 
	$PFAT_Ród
(
Fûe
 *
fûe
, *
buf
, 
ul⁄g_t
 
numByãs
) {

109 
PFAT_Fûe
 *
pÁtFûe
 = (PFAT_Fûê*)
fûe
->
fsD©a
;

110 
PFAT_In°™˚
 *
ö°™˚
 =

111 (
PFAT_In°™˚
 *)
fûe
->
mou¡Poöt
->
fsD©a
;

112 
ul⁄g_t
 
°¨t
 = 
fûe
->
fûePos
;

113 
ul⁄g_t
 
íd
 = 
fûe
->
fûePos
 + 
numByãs
;

115 i‡(
pÁtFûe
->
íåy
->
dúe˘‹y
)

116  
EINVALID
;

118 i‡(
íd
 > 
fûe
->
ídPos
) {

119 
numByãs
 = 
fûe
->
ídPos
 - fûe->
fûePos
;

120 
íd
 = 
fûe
->
ídPos
;

124 
ul⁄g_t
 
°¨tBlock
, 
ídBlock
, 
curBlock
;

125 
ul⁄g_t
 
i
;

128 i‡(
numByãs
 > 
INT_MAX
)

129  
EINVALID
;

134 i‡(
°¨t
 =
fûe
->
ídPos
) {

139 i‡(
°¨t
 >
fûe
->
ídPos
 || 
íd
 > file->endPos ||Énd < start) {

140 
Debug


142 
fûe
->
fûePos
, 
numByãs
, fûe->
ídPos
);

143  
EINVALID
;

150 
°¨tBlock
 = 
°¨t
 / 
SECTOR_SIZE
;

151 
ídBlock
 = 
	`Round_Up_To_Block
(
íd
Ë/ 
SECTOR_SIZE
;

154 
ul⁄g_t
 
°¨tOff£t
 = 
°¨t
 - (
°¨tBlock
 * 
SECTOR_SIZE
);

161 
	`KASSERT
(
pÁtFûe
->
íåy
);

162 
curBlock
 = 
pÁtFûe
->
cuºBlock
;

163 
ul⁄g_t
 
cuºOff£t
;

164 
ul⁄g_t
 
fú°Block
;

166 
i
 = 
°¨tBlock
; i < 
ídBlock
; ++i) {

168 i‡(
curBlock
 =
FAT_ENTRY_FREE
 || curBlock =
FAT_ENTRY_EOF
) {

169 
	`Pröt
("U√x≥˘edÉnd o‡fûêö FATáàfûêblock %lu\n", 
i
);

170  
EIO
;

174 i‡(
i
 >
°¨tBlock
) {

175 
rc
 = 0;

178 
	`Muãx_Lock
(&
pÁtFûe
->
lock
);

180 
rc
 = 
	`Block_Ród
(
fûe
->
mou¡Poöt
->
dev
, 
curBlock
,

181 
pÁtFûe
->
fûeD©aCache
);

183 i‡(
i
 =
°¨tBlock
) {

185 
sh¨e
;

186 i‡(
numByãs
 < 
SECTOR_SIZE
 - 
°¨tOff£t
) {

188 
	`mem˝y
(
buf
, 
pÁtFûe
->
fûeD©aCache
 + 
°¨tOff£t
,

189 
numByãs
);

190 
cuºOff£t
 = 
numByãs
;

192 
	`mem˝y
(
buf
, 
pÁtFûe
->
fûeD©aCache
 + 
°¨tOff£t
,

193 
SECTOR_SIZE
 - 
°¨tOff£t
);

194 
cuºOff£t
 = 
SECTOR_SIZE
 - 
°¨tOff£t
;

196 
curBlock
 = 
ö°™˚
->
Át
[curBlock];

198 } i‡(
i
 =
ídBlock
 - 1) {

199 
	`mem˝y
(
buf
 + 
cuºOff£t
, 
pÁtFûe
->
fûeD©aCache
,

200 
numByãs
 - 
cuºOff£t
);

201 i‡(
numByãs
 - 
cuºOff£t
 =
SECTOR_SIZE
) {

202 
curBlock
 = 
ö°™˚
->
Át
[curBlock];

204 
cuºOff£t
 +
numByãs
 - currOffset;

206 
	`mem˝y
(
buf
 + 
cuºOff£t
, 
pÁtFûe
->
fûeD©aCache
,

207 
SECTOR_SIZE
);

208 
cuºOff£t
 +
SECTOR_SIZE
;

210 
curBlock
 = 
ö°™˚
->
Át
[curBlock];

214 
	`Muãx_U∆ock
(&
pÁtFûe
->
lock
);

219 
fûe
->
fûePos
 +
numByãs
;

220 
pÁtFûe
->
cuºBlock
 = 
curBlock
;

222 
	`KASSERT
(
cuºOff£t
 =
numByãs
);

223 
	`Debug
("Read satisfied!\n");

225  
numByãs
;

226 
	}
}

231 
	$PFAT_Wrôe
(
Fûe
 *
fûe
, *
±r
, 
ul⁄g_t
 
numByãs
) {

232 *
buf
 = (*)
±r
;

233 
PFAT_Fûe
 *
pÁtFûe
 = (PFAT_Fûê*)
fûe
->
fsD©a
;

234 
PFAT_In°™˚
 *
ö°™˚
 =

235 (
PFAT_In°™˚
 *)
fûe
->
mou¡Poöt
->
fsD©a
;

236 
ul⁄g_t
 
°¨t
 = 
fûe
->
fûePos
;

237 
ul⁄g_t
 
íd
 = 
fûe
->
fûePos
 + 
numByãs
;

239 i‡(
pÁtFûe
->
íåy
->
dúe˘‹y
)

240  
EINVALID
;

242 i‡(!(
fûe
->
mode
 & 
O_WRITE
)) {

243  
EINVALID
;

246 i‡(
numByãs
 % 
SECTOR_SIZE
) {

248  
EINVALID
;

251 i‡(
fûe
->
fûePos
 % 
SECTOR_SIZE
) {

253  
EINVALID
;

256 
	`KASSERT
(
fûe
->
fûePos
 <fûe->
ídPos
);

258 i‡(
fûe
->
fûePos
 + 
numByãs
 > fûe->
ídPos
) {

259 
numByãs
 = 
fûe
->
ídPos
 - fûe->
fûePos
;

265 
ul⁄g_t
 
°¨tBlock
 = 
°¨t
 / 
SECTOR_SIZE
;

266 
ul⁄g_t
 
ídBlock
 = 
	`Round_Up_To_Block
(
íd
Ë/ 
SECTOR_SIZE
;

269 
°¨tOff£t
 = 
°¨t
 - (
°¨tBlock
 * 
SECTOR_SIZE
);

275 
	`KASSERT
(
pÁtFûe
->
íåy
);

276 
ul⁄g_t
 
curBlock
 = 
pÁtFûe
->
íåy
->
fú°Block
;

277 
ul⁄g_t
 
cuºOff£t
 = 0;

278 
ul⁄g_t
 
i
;

279 
i
 = 0; i < 
ídBlock
; ++i) {

281 i‡(
curBlock
 =
FAT_ENTRY_FREE
 || curBlock =
FAT_ENTRY_EOF
) {

282 
	`Pröt
("U√x≥˘edÉnd o‡fûêö FATáàfûêblock %lu\n", 
i
);

283  
EIO
;

287 i‡(
i
 >
°¨tBlock
) {

288 
rc
 = 0;

291 
	`Muãx_Lock
(&
pÁtFûe
->
lock
);

293 
rc
 = 
	`Block_Wrôe
(
fûe
->
mou¡Poöt
->
dev
, 
curBlock
,

294 &
buf
[
cuºOff£t
]);

296 
cuºOff£t
 +
SECTOR_SIZE
;

299 
	`Muãx_U∆ock
(&
pÁtFûe
->
lock
);

301 i‡(
rc
 != 0)

302  
rc
;

306 
ul⁄g_t
 
√xtBlock
 = 
ö°™˚
->
Át
[
curBlock
];

307 
curBlock
 = 
√xtBlock
;

311 
fûe
->
fûePos
 +
numByãs
;

312 
pÁtFûe
->
cuºBlock
 = 
curBlock
;

314  
numByãs
;

315 
	}
}

320 
	$PFAT_Sìk
(
Fûe
 *
fûe
, 
ul⁄g_t
 
pos
) {

321 
PFAT_Fûe
 *
pÁtFûe
 = (PFAT_Fûê*)
fûe
->
fsD©a
;

322 
PFAT_In°™˚
 *
ö°™˚
 =

323 (
PFAT_In°™˚
 *)
fûe
->
mou¡Poöt
->
fsD©a
;

325 i‡(
pos
 >
fûe
->
ídPos
)

326  
EINVALID
;

327 i‡(
fûe
->
fûePos
 !
pos
) {

329 
fûe
->
fûePos
 = 
pos
;

330 
	`KASSERT
(
pÁtFûe
->
íåy
);

331 
ul⁄g_t
 
curBlock
 = 
pÁtFûe
->
íåy
->
fú°Block
;

332 
uöt_t
 
i
;

333 
i
 = 0; i < 
pos
; i += 512) {

334 
curBlock
 = 
ö°™˚
->
Át
[curBlock];

336 
pÁtFûe
->
cuºBlock
 = 
curBlock
;

339 
	}
}

344 
PFAT_Clo£
(
Fûe
 *
fûe
 
__©åibuã__
 ((
unu£d
))) {

356 
Fûe_Ops
 
	gs_pÁtFûeOps
 = {

357 &
PFAT_FSèt
,

358 &
PFAT_Ród
,

359 &
PFAT_Wrôe
,

360 &
PFAT_Sìk
,

361 &
PFAT_Clo£
,

365 
	$PFAT_FSèt_Dú
(
Fûe
 *
dú
, 
VFS_Fûe_Sèt
 *
°©
) {

367 
PFAT_In°™˚
 *
ö°™˚
 =

368 (
PFAT_In°™˚
 *)
dú
->
mou¡Poöt
->
fsD©a
;

369 
	`C›y_Sèt
(
°©
, &
ö°™˚
->
roŸDúE¡ry
);

371 
	}
}

376 
PFAT_Clo£_Dú
(
Fûe
 *
dú
 
__©åibuã__
 ((
unu£d
))) {

384 
	$PFAT_Ród_E¡ry
(
Fûe
 *
dú
, 
VFS_Dú_E¡ry
 *
íåy
) {

385 
dúe˘‹yE¡ry
 *
dúe˘‹y
;

386 
dúe˘‹yE¡ry
 *
pÁtDúE¡ry
;

387 
PFAT_In°™˚
 *
ö°™˚
 =

388 (
PFAT_In°™˚
 *)
dú
->
mou¡Poöt
->
fsD©a
;

390 i‡(
dú
->
fûePos
 >dú->
ídPos
)

391  
VFS_NO_MORE_DIR_ENTRIES
;

393 
dúe˘‹y
 = (
dúe˘‹yE¡ry
 *Ë
dú
->
fsD©a
;

394 
pÁtDúE¡ry
 = &
dúe˘‹y
[
dú
->
fûePos
++];

401 
	`°∫˝y
(
íåy
->
«me
, 
pÁtDúE¡ry
->
fûeName
,

402 (
pÁtDúE¡ry
->
fûeName
));

403 
íåy
->
«me
[(
pÁtDúE¡ry
->
fûeName
)] = '\0';

405 
	`C›y_Sèt
(&
íåy
->
°©s
, 
pÁtDúE¡ry
);

408 
	}
}

413 
Fûe_Ops
 
	gs_pÁtDúOps
 = {

414 &
PFAT_FSèt_Dú
,

418 &
PFAT_Clo£_Dú
,

419 &
PFAT_Ród_E¡ry
,

425 
dúe˘‹yE¡ry
 *
	$PFAT_Lookup
(
Mou¡_Poöt
 *
mou¡Poöt
,

426 
PFAT_In°™˚
 *
ö°™˚
,

427 c⁄° *
∑th
) {

428 
dúe˘‹yE¡ry
 *
roŸDú
 = 
ö°™˚
->rootDir;

429 
boŸSe˘‹
 *
fsöfo
 = &
ö°™˚
->fsinfo;

430 
i
;

432 
	`KASSERT
(*
∑th
 == '/');

435 i‡(
	`°rcmp
(
∑th
, "/") == 0)

436  &
ö°™˚
->
roŸDúE¡ry
;

439 ++
∑th
;

441 
dúe˘‹yE¡ry
 *
cuºDú
 = 
roŸDú
;

442 
dúSize
 = 
fsöfo
->
roŸDúe˘‹yCou¡
;

443 
∑th
) {

444 *
ª°
 = 
	`°rchr
(
∑th
, '/');

445 i‡(
ª°
) {

446 *
ª°
 = '\0';

447 
ª°
++;

449 
found
 = 0;

450 
i
 = 0; i < 
dúSize
; ++i) {

451 
dúe˘‹yE¡ry
 *
íåy
 = &
cuºDú
[
i
];

452 i‡(
	`°rcmp
(
íåy
->
fûeName
, 
∑th
) == 0) {

454 
found
 = 1;

455 i‡(!
ª°
) {

456 
	`Debug
("Found m©chög dúÉ¡ry f‹ %s\n", 
∑th
);

457  
íåy
;

460 
cuºDú
 = 
	`MÆloc
(512);

462 
dúSize
 = 
íåy
->
fûeSize
 / (
dúe˘‹yE¡ry
);

463 
	`Block_Ród
(
mou¡Poöt
->
dev
, 
íåy
->
fú°Block
, 
cuºDú
);

464 
∑th
 = 
ª°
;

469 i‡(!
found
)

475 
	}
}

481 
PFAT_Fûe
 *
	$Gë_PFAT_Fûe
(
PFAT_In°™˚
 *
ö°™˚
,

482 
dúe˘‹yE¡ry
 * 
íåy
) {

483 
ul⁄g_t
 
numBlocks
;

484 
PFAT_Fûe
 *
pÁtFûe
 = 0;

485 *
fûeD©aCache
 = 0;

487 
	`KASSERT
(
íåy
 != 0);

488 
	`KASSERT
(
ö°™˚
 != 0);

490 
	`Muãx_Lock
(&
ö°™˚
->
lock
);

496 
pÁtFûe
 = 
	`Gë_Fr⁄t_Of_PFAT_Fûe_Li°
(&
ö°™˚
->
fûeLi°
);

497 
pÁtFûe
 !0;ÖÁtFûê
	`Gë_Next_In_PFAT_Fûe_Li°
(pfatFile)) {

498 i‡(
pÁtFûe
->
íåy
 ==Éntry)

502 i‡(
pÁtFûe
 == 0) {

504 
numBlocks
 = 
	`Round_Up_To_Block
(
íåy
->
fûeSize
Ë/ 
SECTOR_SIZE
;

510 i‡((
pÁtFûe
 = (
PFAT_Fûe
 *)
	`MÆloc
((*pfatFile))) == 0 ||

511 (
fûeD©aCache
 = 
	`MÆloc
(
SECTOR_SIZE
)) == 0) {

512 
memÁû
;

516 
pÁtFûe
->
íåy
 =Éntry;

517 
pÁtFûe
->
numBlocks
 =ÇumBlocks;

518 
pÁtFûe
->
fûeD©aCache
 = fileDataCache;

519 
	`Muãx_Inô
(&
pÁtFûe
->
lock
);

522 
	`Add_To_Back_Of_PFAT_Fûe_Li°
(&
ö°™˚
->
fûeLi°
, 
pÁtFûe
);

523 
	`KASSERT
(
pÁtFûe
->
√xtPFAT_Fûe_Li°
 == 0);

527 
d⁄e
;

529 
memÁû
:

530 i‡(
pÁtFûe
 != 0)

531 
	`Fªe
(
pÁtFûe
);

532 i‡(
fûeD©aCache
 != 0)

533 
	`Fªe
(
fûeD©aCache
);

534 
pÁtFûe
 = 
NULL
;

536 
d⁄e
:

537 
	`Muãx_U∆ock
(&
ö°™˚
->
lock
);

538  
pÁtFûe
;

539 
	}
}

541 
GëUid
();

547 
	$PFAT_O≥n
(
Mou¡_Poöt
 *
mou¡Poöt
, c⁄° *
∑th
,

548 
mode
, 
Fûe
 **
pFûe
) {

549 
rc
 = 0;

550 
PFAT_In°™˚
 *
ö°™˚
 =

551 (
PFAT_In°™˚
 *)
mou¡Poöt
->
fsD©a
;

552 
dúe˘‹yE¡ry
 *
íåy
;

553 
PFAT_Fûe
 *
pÁtFûe
 = 0;

554 
Fûe
 *
fûe
 = 0;

557 i‡((
mode
 & 
O_CREATE
) != 0)

558  
EACCESS
;

561 
íåy
 = 
	`PFAT_Lookup
(
mou¡Poöt
, 
ö°™˚
, 
∑th
);

562 i‡(
íåy
 == 0)

563  
ENOTFOUND
;

567 
pÁtFûe
 = 
	`Gë_PFAT_Fûe
(
ö°™˚
, 
íåy
);

568 i‡(
pÁtFûe
 == 0) {

569 *
pFûe
 = 
NULL
;

570 
rc
 = 
ENOMEM
;

571 
d⁄e
;

574 
pÁtFûe
->
cuºBlock
 =ÖÁtFûe->
íåy
->
fú°Block
;

577 
fûe
 =

578 
	`AŒoˇã_Fûe
(&
s_pÁtFûeOps
, 0, 
íåy
->
fûeSize
, 
pÁtFûe
, 
mode
, 0);

579 i‡(
fûe
 == 0) {

580 
rc
 = 
ENOMEM
;

581 
d⁄e
;

585 *
pFûe
 = 
fûe
;

587 
d⁄e
:

588  
rc
;

589 
	}
}

594 
	$PFAT_O≥n_Dúe˘‹y
(
Mou¡_Poöt
 *
mou¡Poöt
,

595 c⁄° *
∑th
, 
Fûe
 **
pDú
) {

601 
PFAT_In°™˚
 *
ö°™˚
 =

602 (
PFAT_In°™˚
 *)
mou¡Poöt
->
fsD©a
;

603 
Fûe
 *
dú
;

605 i‡(
	`°rcmp
(
∑th
, "/") == 0) {

606 
dú
 = (
Fûe
 *)
	`MÆloc
((*dir));

607 i‡(
dú
 == 0)

608  
ENOMEM
;

610 
dú
->
›s
 = &
s_pÁtDúOps
;

611 
dú
->
fûePos
 = 0;

612 
dú
->
ídPos
 = 
ö°™˚
->
fsöfo
.
roŸDúe˘‹yCou¡
;

613 
dú
->
fsD©a
 = (*)
ö°™˚
->
roŸDú
;

614 *
pDú
 = 
dú
;

617 
dúe˘‹yE¡ry
 *
íåy
;

618 
íåy
 = 
	`PFAT_Lookup
(
mou¡Poöt
, 
ö°™˚
, 
∑th
);

619 i‡(!
íåy
) {

620  
ENOTFOUND
;

622 i‡(!
íåy
->
dúe˘‹y
) {

623  
ENOTFOUND
;

626 
dú
 = (
Fûe
 *)
	`MÆloc
((*dir));

627 i‡(
dú
 == 0)

628  
ENOMEM
;

630 
dú
->
›s
 = &
s_pÁtDúOps
;

631 
dú
->
fûePos
 = 0;

634 
dúe˘‹yE¡ry
 *
ôems
 = (dúe˘‹yE¡ry *Ë
	`MÆloc
(
íåy
->
fûeSize
);

635 i‡(
	`Block_Ród
(
mou¡Poöt
->
dev
, 
íåy
->
fú°Block
, 
ôems
) < 0) {

636 
	`Pröt
("blockÑódáà%d se˘‹ faûed\n", 
íåy
->
fú°Block
);

637  
ENOMEM
;

639 
dú
->
fsD©a
 = (*)
ôems
;

640 
i
;

641 
i
 = 0; i < 
íåy
->
fûeSize
 / (
dúe˘‹yE¡ry
); i++) {

642 i‡(
ôems
[
i
].
fûeName
[0] == '\0')

645 
dú
->
ídPos
 = 
i
;

646 *
pDú
 = 
dú
;

649 
	}
}

654 
	$PFAT_Sèt
(
Mou¡_Poöt
 *
mou¡Poöt
, c⁄° *
∑th
,

655 
VFS_Fûe_Sèt
 *
°©
) {

656 
PFAT_In°™˚
 *
ö°™˚
 =

657 (
PFAT_In°™˚
 *)
mou¡Poöt
->
fsD©a
;

658 
dúe˘‹yE¡ry
 *
íåy
;

660 
	`KASSERT
(
∑th
 != 0);

661 
	`KASSERT
(
°©
 != 0);

663 
	`Debug
("PFAT_Sèt(%s)\n", 
∑th
);

665 
íåy
 = 
	`PFAT_Lookup
(
mou¡Poöt
, 
ö°™˚
, 
∑th
);

666 i‡(
íåy
 == 0)

667  
ENOTFOUND
;

669 
	`C›y_Sèt
(
°©
, 
íåy
);

672 
	}
}

677 
PFAT_Sync
(
Mou¡_Poöt
 *
mou¡Poöt
 
__©åibuã__
 ((
unu£d
))) {

682 
	$PFAT_SëSëUid
(
Mou¡_Poöt
 *
mp
, c⁄° *
fûe
,

683 
£tuid
) {

684 
	`TODO_P
(
PROJECT_USER
, "pfat file system SetSetUID operation");

685  
EUNSUPPORTED
;

686 
	}
}

688 
	$PFAT_SëA˛
(
Mou¡_Poöt
 *
mp
, c⁄° *
fûe
, 
uid
,

689 
≥rmissi⁄s
) {

690 
	`TODO_P
(
PROJECT_USER
, "pfat file system SetAcl operation");

691  
EUNSUPPORTED
;

692 
	}
}

697 
Mou¡_Poöt_Ops
 
	gs_pÁtMou¡PoötOps
 = {

698 
PFAT_O≥n
,

700 
PFAT_O≥n_Dúe˘‹y
,

701 
PFAT_Sèt
,

702 
PFAT_Sync
,

707 
PFAT_SëSëUid
,

708 
PFAT_SëA˛
,

717 
	$PFAT_Regi°î_Pagög_Fûe
(
Mou¡_Poöt
 *
mou¡Poöt
,

718 
PFAT_In°™˚
 *
ö°™˚
) {

719 
dúe˘‹yE¡ry
 *
∑gefûeE¡ry
;

720 
Pagög_Devi˚
 *
∑gedev
 = 0;

721 
size_t
 
«meLí
;

722 *
fûeName
 = 0;

724 i‡(
	`Gë_Pagög_Devi˚
() != 0)

727 
∑gefûeE¡ry
 = 
	`PFAT_Lookup
(
mou¡Poöt
, 
ö°™˚
, 
PAGEFILE_FILENAME
);

728 i‡(
∑gefûeE¡ry
 == 0)

734 
∑gedev
 = (
Pagög_Devi˚
 *)
	`MÆloc
((*pagedev));

735 i‡(
∑gedev
 == 0)

736 
memÁû
;

737 
«meLí
 = 
	`°æí
(
mou¡Poöt
->
∑thPªfix
Ë+ såÀn(
PAGEFILE_FILENAME
) + 3;

738 
fûeName
 = (*)
	`MÆloc
(
«meLí
);

739 i‡(
fûeName
 == 0)

740 
memÁû
;

743 
	`¢¥ötf
(
fûeName
, 
«meLí
, "/%s%s", 
mou¡Poöt
->
∑thPªfix
,

744 
PAGEFILE_FILENAME
);

747 
∑gedev
->
fûeName
 = fileName;

748 
∑gedev
->
dev
 = 
mou¡Poöt
->dev;

749 
∑gedev
->
°¨tSe˘‹
 = 
∑gefûeE¡ry
->
fú°Block
;

750 
∑gedev
->
numSe˘‹s
 = 
∑gefûeE¡ry
->
fûeSize
 / 
SECTOR_SIZE
;

753 
	`Regi°î_Pagög_Devi˚
(
∑gedev
);

756 
memÁû
:

757 
	`Pröt
(" Error: couldÇot createÖaging device forÖfat on %s (%s)\n",

758 
mou¡Poöt
->
∑thPªfix
, mou¡Poöt->
dev
->
«me
);

759 i‡(
∑gedev
 != 0)

760 
	`Fªe
(
∑gedev
);

761 i‡(
fûeName
 != 0)

762 
	`Fªe
(
fûeName
);

763 
	}
}

768 
	$PFAT_Mou¡
(
Mou¡_Poöt
 *
mou¡Poöt
) {

769 
PFAT_In°™˚
 *
ö°™˚
 = 0;

770 
boŸSe˘‹
 *
fsöfo
;

771 *
boŸSe˘
 = 0;

772 
roŸDúSize
;

773 
rc
;

774 
i
;

777 
ö°™˚
 = (
PFAT_In°™˚
 *)
	`MÆloc
((*instance));

778 i‡(
ö°™˚
 == 0)

779 
memÁû
;

780 
	`mem£t
(
ö°™˚
, '\0', (*instance));

781 
fsöfo
 = &
ö°™˚
->fsinfo;

782 
	`Debug
("Created instance object\n");

788 
boŸSe˘
 = 
	`MÆloc
(
SECTOR_SIZE
);

789 i‡(
boŸSe˘
 == 0)

790 
memÁû
;

793 i‡((
rc
 = 
	`Block_Ród
(
mou¡Poöt
->
dev
, 0, 
boŸSe˘
)) < 0)

794 
Áû
;

795 
	`Debug
("Read boot sector\n");

798 
	`mem˝y
(&
ö°™˚
->
fsöfo
, ((*)
boŸSe˘
Ë+ 
PFAT_BOOT_RECORD_OFFSET
,

799 (
boŸSe˘‹
));

800 
	`Debug
("Copied bootÑecord\n");

803 i‡(
fsöfo
->
magic
 !
PFAT_MAGIC
) {

804 
	`Pröt
("Bad magi¯numbî (%xËf‹ PFAT fûesy°em\n", 
fsöfo
->
magic
);

805 
övÆidfs
;

807 
	`Debug
("MagicÇumber is good!\n");

810 i‡(
fsöfo
->
fûeAŒoˇti⁄Off£t
 <= 0 ||

811 
fsöfo
->
fûeAŒoˇti⁄Lígth
 <= 0 ||

812 
fsöfo
->
roŸDúe˘‹yCou¡
 < 0 || fsöfo->
roŸDúe˘‹yOff£t
 <= 0) {

813 
	`Pröt
("InvalidÖarameters for PFAT filesystem\n");

814 
övÆidfs
;

816 
	`Debug
("PFAT filesystemÖarametersáppearÅo be good!\n");

819 
ö°™˚
->
Át
 = (*)
	`MÆloc
(
fsöfo
->
fûeAŒoˇti⁄Lígth
 * 
SECTOR_SIZE
);

820 i‡(
ö°™˚
->
Át
 == 0)

821 
memÁû
;

824 
i
 = 0; i < 
fsöfo
->
fûeAŒoˇti⁄Lígth
; ++i) {

825 
blockNum
 = 
fsöfo
->
fûeAŒoˇti⁄Off£t
 + 
i
;

826 *
p
 = ((*)
ö°™˚
->
Át
Ë+ (
i
 * 
SECTOR_SIZE
);

827 i‡((
rc
 = 
	`Block_Ród
(
mou¡Poöt
->
dev
, 
blockNum
, 
p
)) < 0)

828 
Áû
;

830 
	`Debug
("Read FAT successfully!\n");

832 i‡(
fsöfo
->
roŸDúe˘‹yCou¡
 > 0) {

834 
roŸDúSize
 =

835 
	`Round_Up_To_Block
((
dúe˘‹yE¡ry
) *

836 
fsöfo
->
roŸDúe˘‹yCou¡
);

837 
ö°™˚
->
roŸDú
 = (
dúe˘‹yE¡ry
 *Ë
	`MÆloc
(
roŸDúSize
);

840 
	`Debug
("RoŸ dúe˘‹y sizê%d\n", 
roŸDúSize
);

841 
i
 = 0; i < 
roŸDúSize
; i +
SECTOR_SIZE
) {

842 
blockNum
 = 
fsöfo
->
roŸDúe˘‹yOff£t
 + 
i
 / 
SECTOR_SIZE
;

843 i‡((
rc
 =

844 
	`Block_Ród
(
mou¡Poöt
->
dev
, 
blockNum
,

845 (*)(()
ö°™˚
->
roŸDú
 + 
i
))) < 0)

846 
Áû
;

848 
	`Debug
("ReadÑoot directory successfully!\n");

850 
	`Pröt
("Warning: missingÑoot directory in PFAT");

851 
ö°™˚
->
roŸDú
 = 
NULL
;

855 
	`mem£t
(&
ö°™˚
->
roŸDúE¡ry
, '\0', (
dúe˘‹yE¡ry
));

856 
ö°™˚
->
roŸDúE¡ry
.
ªadO∆y
 = 1;

857 
ö°™˚
->
roŸDúE¡ry
.
dúe˘‹y
 = 1;

858 
ö°™˚
->
roŸDúE¡ry
.
fûeSize
 =

859 
ö°™˚
->
fsöfo
.
roŸDúe˘‹yCou¡
 * (
dúe˘‹yE¡ry
);

862 
	`Muãx_Inô
(&
ö°™˚
->
lock
);

863 
	`CÀ¨_PFAT_Fûe_Li°
(&
ö°™˚
->
fûeLi°
);

866 
	`PFAT_Regi°î_Pagög_Fûe
(
mou¡Poöt
, 
ö°™˚
);

873 
mou¡Poöt
->
›s
 = &
s_pÁtMou¡PoötOps
;

874 
mou¡Poöt
->
fsD©a
 = 
ö°™˚
;

877 
memÁû
:

878 
rc
 = 
ENOMEM
;

879 
Áû
;

880 
övÆidfs
:

881 
rc
 = 
EINVALIDFS
;

882 
Áû
;

883 
Áû
:

884 i‡(
ö°™˚
 != 0) {

885 i‡(
ö°™˚
->
Át
 != 0)

886 
	`Fªe
(
ö°™˚
->
Át
);

887 i‡(
ö°™˚
->
roŸDú
 != 0)

888 
	`Fªe
(
ö°™˚
->
roŸDú
);

889 
	`Fªe
(
ö°™˚
);

891 i‡(
boŸSe˘
 != 0)

892 
	`Fªe
(
boŸSe˘
);

893  
rc
;

894 
	}
}

896 
Fûesy°em_Ops
 
	gs_pÁtFûesy°emOps
 = {

898 &
PFAT_Mou¡
,

905 
	$Inô_PFAT
() {

906 
	`Regi°î_Fûesy°em
("pÁt", &
s_pÁtFûesy°emOps
);

907 
	}
}

	@pipe.c

13 
	~<gìkos/pùe.h
>

14 
	~<gìkos/mÆloc.h
>

15 
	~<gìkos/°rög.h
>

16 
	~<gìkos/î∫o.h
>

17 
	~<gìkos/¥oje˘s.h
>

18 
	~<gìkos/öt.h
>

21 
Fûe_Ops
 
	gPùe_Ród_Ops
 =

22 { 
NULL
, 
Pùe_Ród
, NULL, NULL, 
Pùe_Clo£
, NULL };

23 
Fûe_Ops
 
	gPùe_Wrôe_Ops
 =

24 { 
NULL
, NULL, 
Pùe_Wrôe
, NULL, 
Pùe_Clo£
, NULL };

26 
	$Pùe_Cª©e
(
Fûe
 **
ªad_fûe
, Fûê**
wrôe_fûe
) {

27 
	`TODO_P
(
PROJECT_PIPE
, "CreateáÖipe");

28 
	}
}

30 
	$Pùe_Ród
(
Fûe
 *
f
, *
buf
, 
ul⁄g_t
 
numByãs
) {

31 
	`TODO_P
(
PROJECT_PIPE
, "PipeÑead");

32 
	}
}

34 
	$Pùe_Wrôe
(
Fûe
 *
f
, *
buf
, 
ul⁄g_t
 
numByãs
) {

35 
	`TODO_P
(
PROJECT_PIPE
, "Pipe write");

36 
	}
}

38 
	$Pùe_Clo£
(
Fûe
 *
f
) {

39 
	`TODO_P
(
PROJECT_PIPE
, "Pipe close");

41 
	}
}

	@screen.c

10 
	~<°d¨g.h
>

11 
	~<gìkos/kas£π.h
>

12 
	~<gìkos/kty≥s.h
>

13 
	~<gìkos/io.h
>

14 
	~<gìkos/öt.h
>

15 
	~<gìkos/fmtout.h
>

16 
	~<gìkos/s¸ìn.h
>

17 
	~<gìkos/lock.h
>

29 
	#ESC
 ((Ë0x1B)

	)

30 
	#DEFAULT_ATTRIBUTE
 
	`ATTRIB
(
BLACK
, 
GRAY
)

	)

32 
	eSèã
 {

33 
	mS_NORMAL
,

34 
	mS_ESC
,

35 
	mS_ESC2
,

36 
	mS_ARG
,

37 
	mS_CMD
,

40 
	#MAXARGS
 8

	)

42 
	sC⁄sﬁe_Sèã
 {

44 
	mrow
, 
	mcﬁ
;

45 
	mßveRow
, 
	mßveCﬁ
;

46 
uch¨_t
 
	mcuºítAâr
;

49 
Sèã
 
	m°©e
;

50 
	m¨gLi°
[
MAXARGS
];

51 
	mnumArgs
;

54 
C⁄sﬁe_Sèã
 
	gs_c⁄s
;

56 
	#NUM_SCREEN_DWORDS
 ((
NUMROWS
 * 
NUMCOLS
 * 2Ë/ 4)

	)

57 
	#NUM_SCROLL_DWORDS
 (((
NUMROWS
-1Ë* 
NUMCOLS
 * 2Ë/ 4)

	)

58 
	#NUM_DWORDS_PER_LINE
 ((
NUMCOLS
*2)/4)

	)

59 
	#FILL_DWORD
 (0x00200020 | (
s_c⁄s
.
cuºítAâr
<<24Ë| (s_c⁄s.cuºítAâr<<8))

	)

65 
	$S¸ﬁl
() {

66 
uöt_t
 *
v
;

67 
i
, 
n
 = 
NUM_SCROLL_DWORDS
;

68 
uöt_t
 
fûl
 = 
FILL_DWORD
;

71 
v
 = (
uöt_t
 *Ë
VIDMEM
, 
i
 = 0; i < 
n
; ++i) {

72 *
v
 = *(v + 
NUM_DWORDS_PER_LINE
);

73 ++
v
;

77 
v
 = (
uöt_t
 *Ë
VIDMEM
 + 
n
, 
i
 = 0; i < 
NUM_DWORDS_PER_LINE
; ++i)

78 *
v
++ = 
fûl
;

79 
	}
}

85 
	$CÀ¨_To_EOL
() {

86 
n
 = (
NUMCOLS
 - 
s_c⁄s
.
cﬁ
);

87 
uch¨_t
 *
v
 = 
VIDMEM
 + 
s_c⁄s
.
row
 * (
NUMCOLS
 * 2Ë+ s_c⁄s.
cﬁ
 * 2;

88 
n
-- > 0) {

89 *
v
++ = ' ';

90 *
v
++ = 
s_c⁄s
.
cuºítAâr
;

92 
	}
}

98 
	$Newlöe
() {

99 ++
s_c⁄s
.
row
;

100 
s_c⁄s
.
cﬁ
 = 0;

101 i‡(
s_c⁄s
.
row
 =
NUMROWS
) {

102 
	`S¸ﬁl
();

103 
s_c⁄s
.
row
 = 
NUMROWS
 - 1;

105 
	}
}

112 
	$Put_Gøphic_Ch¨
(
c
) {

113 
uch¨_t
 *
v
 = 
VIDMEM
 + 
s_c⁄s
.
row
 * (
NUMCOLS
 * 2Ë+ s_c⁄s.
cﬁ
 * 2;

116 *
v
++ = (
uch¨_t
Ë
c
;

117 *
v
 = 
s_c⁄s
.
cuºítAâr
;

119 i‡(
s_c⁄s
.
cﬁ
 < 
NUMCOLS
 - 1)

120 ++
s_c⁄s
.
cﬁ
;

122 
	`Newlöe
();

123 
	}
}

130 
	$Ouçut_LôîÆ_Ch¨a˘î
(
c
) {

131 
numS∑˚s
;

133 
c
) {

135 
	`CÀ¨_To_EOL
();

136 
	`Newlöe
();

140 
numS∑˚s
 = 
TABWIDTH
 - (
s_c⁄s
.
cﬁ
 % TABWIDTH);

141 
numS∑˚s
-- > 0)

142 
	`Put_Gøphic_Ch¨
(' ');

146 
	`Put_Gøphic_Ch¨
(
c
);

150 #i‚de‡
NDEBUG


157 
	`Out_Byã
(0xE9, 
c
);

159 
	}
}

164 
	$Move_Curs‹
(
row
, 
cﬁ
) {

165 i‡(
row
 < 0)

166 
row
 = 0;

167 i‡(
row
 >
NUMROWS
)

168 
row
 = 
NUMROWS
 - 1;

170 i‡(
cﬁ
 < 0)

171 
cﬁ
 = 0;

172 i‡(
cﬁ
 >
NUMCOLS
)

173 
cﬁ
 = 
NUMCOLS
 - 1;

175 
s_c⁄s
.
row
 =Ñow;

176 
s_c⁄s
.
cﬁ
 = col;

177 
	}
}

182 c⁄° 
uch¨_t
 
	gs_™siToVgaCﬁ‹
[] = {

183 
BLACK
, 
RED
, 
GREEN
, 
AMBER
, 
BLUE
, 
MAGENTA
, 
CYAN
, 
GRAY


190 
	$Upd©e_Aâribuãs
() {

191 
i
;

192 
©å
 = 
s_c⁄s
.
cuºítAâr
 & ~(
BRIGHT
);

194 
i
 = 0; i < 
s_c⁄s
.
numArgs
; ++i) {

195 
vÆue
 = 
s_c⁄s
.
¨gLi°
[
i
];

196 i‡(
vÆue
 == 0)

197 
©å
 = 
DEFAULT_ATTRIBUTE
;

198 i‡(
vÆue
 == 1)

199 
©å
 |
BRIGHT
;

200 i‡(
vÆue
 >= 30 && value <= 37)

201 
©å
 = (©å & ~0x7Ë| 
s_™siToVgaCﬁ‹
[
vÆue
 - 30];

202 i‡(
vÆue
 >= 40 && value <= 47)

203 
©å
 = (©å & ~(0x7 << 4)Ë| (
s_™siToVgaCﬁ‹
[
vÆue
 - 40] << 4);

205 
s_c⁄s
.
cuºítAâr
 = 
©å
;

206 
	}
}

209 
	$Re£t
() {

210 
s_c⁄s
.
°©e
 = 
S_NORMAL
;

211 
s_c⁄s
.
numArgs
 = 0;

212 
	}
}

215 
	$Sèπ_Esˇ≥
() {

216 
s_c⁄s
.
°©e
 = 
S_ESC
;

217 
s_c⁄s
.
numArgs
 = 0;

218 
	}
}

221 
	$Sèπ_Arg
(
¨gNum
) {

222 
	`KASSERT
(
s_c⁄s
.
numArgs
 =
¨gNum
);

223 
s_c⁄s
.
numArgs
++;

224 
s_c⁄s
.
°©e
 = 
S_ARG
;

225 i‡(
¨gNum
 < 
MAXARGS
)

226 
s_c⁄s
.
¨gLi°
[
¨gNum
] = 0;

227 
	}
}

230 
	$Save_Curs‹
() {

231 
s_c⁄s
.
ßveRow
 = s_c⁄s.
row
;

232 
s_c⁄s
.
ßveCﬁ
 = s_c⁄s.
cﬁ
;

233 
	}
}

236 
	$Re°‹e_Curs‹
() {

237 
s_c⁄s
.
row
 = s_c⁄s.
ßveRow
;

238 
s_c⁄s
.
cﬁ
 = s_c⁄s.
ßveCﬁ
;

239 
	}
}

242 
	$Add_Digô
(
c
) {

243 
	`KASSERT
(
	`ISDIGIT
(
c
));

244 i‡(
s_c⁄s
.
numArgs
 < 
MAXARGS
) {

245 
¨gNum
 = 
s_c⁄s
.
numArgs
 - 1;

246 
s_c⁄s
.
¨gLi°
[
¨gNum
] *= 10;

247 
s_c⁄s
.
¨gLi°
[
¨gNum
] +(
c
 - '0');

249 
	}
}

255 
	$Gë_Arg
(
¨gNum
) {

256  
¨gNum
 < 
s_c⁄s
.
numArgs
 ? s_c⁄s.
¨gLi°
[argNum] : 0;

257 
	}
}

265 
	$Put_Ch¨_Imp
(
c
) {

266 
agaö
:

267 
s_c⁄s
.
°©e
) {

268 
S_NORMAL
:

269 i‡(
c
 =
ESC
)

270 
	`Sèπ_Esˇ≥
();

272 
	`Ouçut_LôîÆ_Ch¨a˘î
(
c
);

275 
S_ESC
:

276 i‡(
c
 == '[')

277 
s_c⁄s
.
°©e
 = 
S_ESC2
;

279 
	`Re£t
();

282 
S_ESC2
:

283 i‡(
	`ISDIGIT
(
c
)) {

284 
	`Sèπ_Arg
(0);

285 
agaö
;

286 } i‡(
c
 == ';') {

288 
	`Sèπ_Arg
(0);

289 
	`Add_Digô
('1');

290 
	`Sèπ_Arg
(1);

292 
s_c⁄s
.
°©e
 = 
S_CMD
;

293 
agaö
;

297 
S_ARG
:

298 i‡(
	`ISDIGIT
(
c
))

299 
	`Add_Digô
(
c
);

300 i‡(
c
 == ';')

301 
	`Sèπ_Arg
(
s_c⁄s
.
numArgs
);

303 
s_c⁄s
.
°©e
 = 
S_CMD
;

304 
agaö
;

308 
S_CMD
:

309 
c
) {

311 
	`CÀ¨_To_EOL
();

314 
	`Save_Curs‹
();

317 
	`Re°‹e_Curs‹
();

320 
	`Move_Curs‹
(
s_c⁄s
.
row
 - 
	`Gë_Arg
(0), s_c⁄s.
cﬁ
);

323 
	`Move_Curs‹
(
s_c⁄s
.
row
 + 
	`Gë_Arg
(0), s_c⁄s.
cﬁ
);

326 
	`Move_Curs‹
(
s_c⁄s
.
row
, s_c⁄s.
cﬁ
 + 
	`Gë_Arg
(0));

329 
	`Move_Curs‹
(
s_c⁄s
.
row
, s_c⁄s.
cﬁ
 - 
	`Gë_Arg
(0));

332 
	`Upd©e_Aâribuãs
();

336 i‡(
s_c⁄s
.
numArgs
 == 2)

337 
	`Move_Curs‹
(
	`Gë_Arg
(0) - 1, Get_Arg(1) - 1);

340 i‡(
s_c⁄s
.
numArgs
 =1 && 
	`Gë_Arg
(0) == 2) {

341 
	`CÀ¨_S¸ìn
();

342 
	`Put_Curs‹
(0, 0);

348 
	`Re£t
();

352 
	`KASSERT
(
Ál£
);

354 
	}
}

359 
	$Upd©e_Curs‹
() {

364 
uöt_t
 
ch¨a˘îPos
 = (
s_c⁄s
.
row
 * 
NUMCOLS
Ë+ s_c⁄s.
cﬁ
;

365 
uch¨_t
 
‹igAddr
;

372 
‹igAddr
 = 
	`In_Byã
(
CRT_ADDR_REG
);

373 
	`IO_Dñay
();

376 
	`Out_Byã
(
CRT_ADDR_REG
, 
CRT_CURSOR_LOC_HIGH_REG
);

377 
	`IO_Dñay
();

378 
	`Out_Byã
(
CRT_DATA_REG
, (
ch¨a˘îPos
 >> 8) & 0xff);

379 
	`IO_Dñay
();

382 
	`Out_Byã
(
CRT_ADDR_REG
, 
CRT_CURSOR_LOC_LOW_REG
);

383 
	`IO_Dñay
();

384 
	`Out_Byã
(
CRT_DATA_REG
, 
ch¨a˘îPos
 & 0xff);

385 
	`IO_Dñay
();

388 
	`Out_Byã
(
CRT_ADDR_REG
, 
‹igAddr
);

389 
	}
}

398 
	$Inô_S¸ìn
() {

399 
boﬁ
 
iÊag
 = 
	`Begö_I¡_Atomic
();

401 
s_c⁄s
.
row
 = s_c⁄s.
cﬁ
 = 0;

402 
s_c⁄s
.
cuºítAâr
 = 
DEFAULT_ATTRIBUTE
;

403 
	`CÀ¨_S¸ìn
();

405 
	`End_I¡_Atomic
(
iÊag
);

406 
	}
}

411 
	$CÀ¨_S¸ìn
() {

412 
uöt_t
 *
v
 = (uöt_à*Ë
VIDMEM
;

413 
i
;

414 
uöt_t
 
fûl
 = 
FILL_DWORD
;

416 
boﬁ
 
iÊag
 = 
	`Begö_I¡_Atomic
();

418 
i
 = 0; i < 
NUM_SCREEN_DWORDS
; ++i)

419 *
v
++ = 
fûl
;

421 
	`End_I¡_Atomic
(
iÊag
);

422 
	}
}

427 
	$Gë_Curs‹
(*
row
, *
cﬁ
) {

428 
boﬁ
 
iÊag
 = 
	`Begö_I¡_Atomic
();

429 *
row
 = 
s_c⁄s
.row;

430 *
cﬁ
 = 
s_c⁄s
.col;

431 
	`End_I¡_Atomic
(
iÊag
);

432 
	}
}

439 
boﬁ
 
	$Put_Curs‹
(
row
, 
cﬁ
) {

440 
boﬁ
 
iÊag
;

442 i‡(
row
 < 0 ||Ñow >
NUMROWS
 || 
cﬁ
 < 0 || cﬁ >
NUMCOLS
)

443  
Ál£
;

445 
iÊag
 = 
	`Begö_I¡_Atomic
();

446 
s_c⁄s
.
row
 =Ñow;

447 
s_c⁄s
.
cﬁ
 = col;

448 
	`Upd©e_Curs‹
();

449 
	`End_I¡_Atomic
(
iÊag
);

451  
åue
;

452 
	}
}

457 
uch¨_t
 
	$Gë_Cuºít_Aâr
() {

458  
s_c⁄s
.
cuºítAâr
;

459 
	}
}

464 
	$Së_Cuºít_Aâr
(
uch¨_t
 
©åib
) {

465 
boﬁ
 
iÊag
 = 
	`Begö_I¡_Atomic
();

466 
s_c⁄s
.
cuºítAâr
 = 
©åib
;

467 
	`End_I¡_Atomic
(
iÊag
);

468 
	}
}

474 
	$Put_Ch¨
(
c
) {

475 
boﬁ
 
iÊag
 = 
	`Begö_I¡_Atomic
();

476 
	`Put_Ch¨_Imp
(
c
);

477 
	`Upd©e_Curs‹
();

478 
	`End_I¡_Atomic
(
iÊag
);

479 
	}
}

485 
	$Put_Såög
(c⁄° *
s
) {

486 
boﬁ
 
iÊag
 = 
	`Begö_I¡_Atomic
();

487 *
s
 != '\0')

488 
	`Put_Ch¨_Imp
(*
s
++);

489 
	`Upd©e_Curs‹
();

490 
	`End_I¡_Atomic
(
iÊag
);

491 
	}
}

497 
	$Put_Buf
(c⁄° *
buf
, 
ul⁄g_t
 
Àngth
) {

498 
boﬁ
 
iÊag
 = 
	`Begö_I¡_Atomic
();

499 
Àngth
 > 0) {

500 
	`Put_Ch¨_Imp
(*
buf
++);

501 --
Àngth
;

503 
	`Upd©e_Curs‹
();

504 
	`End_I¡_Atomic
(
iÊag
);

505 
	}
}

508 
Pröt_Emô
(
Ouçut_Sök
 *
o
 
__©åibuã__
 ((
unu£d
)), 
ch
) {

509 
Put_Ch¨_Imp
(
ch
);

511 
Pröt_Föish
(
Ouçut_Sök
 *
o
 
__©åibuã__
 ((
unu£d
))) {

512 
Upd©e_Curs‹
();

514 
Ouçut_Sök
 
	gs_ouçutSök
 = { &
Pröt_Emô
, &
Pröt_Föish
 };

516 
Spö_Lock_t
 
	g¥ötLock
;

522 
	$Pröt
(c⁄° *
fmt
, ...) {

523 
va_li°
 
¨gs
;

527 
	`va_°¨t
(
¨gs
, 
fmt
);

528 
	`F‹m©_Ouçut
(&
s_ouçutSök
, 
fmt
, 
¨gs
);

529 
	`va_íd
(
¨gs
);

532 
	}
}

	@segment.c

20 
	~<gìkos/kas£π.h
>

21 
	~<gìkos/°rög.h
>

22 
	~<gìkos/tss.h
>

23 
	~<gìkos/£gmít.h
>

25 
__ölöe__
 
	$Së_Size_And_Ba£_Pages
(
Segmít_Des¸ùt‹


26 *
desc
, 
ul⁄g_t
 
ba£Addr
,

27 
ul⁄g_t
 
numPages
) {

35 
	`KASSERT
(
numPages
 > 0);

36 
numPages
 -= 1;

38 
desc
->
sizeLow
 = 
numPages
 & 0xFFFF;

39 
desc
->
sizeHigh
 = (
numPages
 >> 16) & 0x0F;

40 
desc
->
ba£Low
 = 
ba£Addr
 & 0xFFFFFF;

41 
desc
->
ba£High
 = (
ba£Addr
 >> 24) & 0xFF;

42 
desc
->
gønuœrôy
 = 1;

43 
	}
}

45 
__ölöe__
 
	$Së_Size_And_Ba£_Byãs
(
Segmít_Des¸ùt‹


46 *
desc
, 
ul⁄g_t
 
ba£Addr
,

47 
ul⁄g_t
 
numByãs
) {

48 
desc
->
sizeLow
 = 
numByãs
 & 0xFFFF;

49 
desc
->
sizeHigh
 = (
numByãs
 >> 16) & 0x0F;

50 
desc
->
ba£Low
 = 
ba£Addr
 & 0xFFFFFF;

51 
desc
->
ba£High
 = (
ba£Addr
 >> 24) & 0xFF;

52 
desc
->
gønuœrôy
 = 0;

53 
	}
}

58 
	$Inô_NuŒ_Segmít_Des¸ùt‹
(
Segmít_Des¸ùt‹
 *
desc
) {

59 
	`mem£t
(
desc
, '\0', (*desc));

60 
	}
}

65 
	$Inô_Code_Segmít_Des¸ùt‹
(
Segmít_Des¸ùt‹
 *
desc
,

66 
ul⁄g_t
 
ba£Addr
,

67 
ul⁄g_t
 
numPages
, 
¥ivûegeLevñ
) {

68 
	`KASSERT
(
¥ivûegeLevñ
 >= 0 &&ÖrivilegeLevel <= 3);

70 
	`Së_Size_And_Ba£_Pages
(
desc
, 
ba£Addr
, 
numPages
);

71 
desc
->
ty≥
 = 0x0A;

72 
desc
->
sy°em
 = 1;

73 
desc
->
d∂
 = 
¥ivûegeLevñ
;

74 
desc
->
¥e£¡
 = 1;

75 
desc
->
ª£rved
 = 0;

76 
desc
->
dbBô
 = 1;

77 
	}
}

82 
	$Inô_D©a_Segmít_Des¸ùt‹
(
Segmít_Des¸ùt‹
 *
desc
,

83 
ul⁄g_t
 
ba£Addr
,

84 
ul⁄g_t
 
numPages
, 
¥ivûegeLevñ
) {

85 
	`KASSERT
(
¥ivûegeLevñ
 >= 0 &&ÖrivilegeLevel <= 3);

87 
	`Së_Size_And_Ba£_Pages
(
desc
, 
ba£Addr
, 
numPages
);

88 
desc
->
ty≥
 = 0x02;

89 
desc
->
sy°em
 = 1;

90 
desc
->
d∂
 = 
¥ivûegeLevñ
;

91 
desc
->
¥e£¡
 = 1;

92 
desc
->
ª£rved
 = 0;

93 
desc
->
dbBô
 = 1;

94 
	}
}

99 
	$Inô_TSS_Des¸ùt‹
(
Segmít_Des¸ùt‹
 *
desc
, 
TSS
 *
theTSS
) {

100 
	`Së_Size_And_Ba£_Byãs
(
desc
, (
ul⁄g_t
Ë
theTSS
, (
TSS
));

101 
desc
->
ty≥
 = 0x09;

102 
desc
->
sy°em
 = 0;

103 
desc
->
d∂
 = 0;

104 
desc
->
¥e£¡
 = 1;

105 
desc
->
ª£rved
 = 0;

106 
desc
->
dbBô
 = 0;

107 
	}
}

112 
	$Inô_LDT_Des¸ùt‹
(
Segmít_Des¸ùt‹
 *
desc
,

113 
Segmít_Des¸ùt‹
 
theLDT
[], 
numE¡rõs
) {

114 
	`Së_Size_And_Ba£_Byãs
(
desc
, (
ul⁄g_t
Ë
theLDT
,

115 (
Segmít_Des¸ùt‹
Ë* 
numE¡rõs
);

117 
desc
->
ty≥
 = 0x02;

118 
desc
->
sy°em
 = 0;

119 
desc
->
d∂
 = 0;

120 
desc
->
¥e£¡
 = 1;

121 
desc
->
ª£rved
 = 0;

122 
desc
->
dbBô
 = 0;

123 
	}
}

	@sem.c

13 
	~<gìkos/sysˇŒ.h
>

14 
	~<gìkos/î∫o.h
>

15 
	~<gìkos/kthªad.h
>

16 
	~<gìkos/öt.h
>

17 
	~<gìkos/ñf.h
>

18 
	~<gìkos/mÆloc.h
>

19 
	~<gìkos/s¸ìn.h
>

20 
	~<gìkos/keybﬂrd.h
>

21 
	~<gìkos/°rög.h
>

22 
	~<gìkos/u£r.h
>

23 
	~<gìkos/timî.h
>

24 
	~<gìkos/vfs.h
>

25 
	~<gìkos/sig«l.h
>

26 
	~<gìkos/£m.h
>

27 
	~<gìkos/¥oje˘s.h
>

38 
	$Sys_O≥n_Sem≠h‹e
(
I¡îru±_Sèã
 *
°©e
) {

39 
	`KASSERT
(
°©e
);

40 
	`TODO_P
(
PROJECT_SEMAPHORES
, "Open_Semaphore system call");

41  
EUNSUPPORTED
;

42 
	}
}

53 
	$Sys_P
(
I¡îru±_Sèã
 *
°©e
) {

54 
	`KASSERT
(
°©e
);

55 
	`TODO_P
(
PROJECT_SEMAPHORES
, "P (semaphoreácquire) system call");

56  
EUNSUPPORTED
;

57 
	}
}

66 
	$Sys_V
(
I¡îru±_Sèã
 *
°©e
) {

67 
	`KASSERT
(
°©e
);

68 
	`TODO_P
(
PROJECT_SEMAPHORES
, "V (semaphoreÑelease) system call");

69  
EUNSUPPORTED
;

70 
	}
}

79 
	$Sys_Clo£_Sem≠h‹e
(
I¡îru±_Sèã
 *
°©e
) {

80 
	`KASSERT
(
°©e
);

81 
	`TODO_P
(
PROJECT_SEMAPHORES
, "Close_Semaphore system call");

82  
EUNSUPPORTED
;

83 
	}
}

	@setup.asm

1 ; 
GìkOS
 
£tup
 
	gcode


2 ; 
C›yright
 (
c
Ë2001,2004 
David
 
	gH
. 
	gHovemeyî
 <
	gdaveho
@
	gcs
.
	gumd
.
	gedu
>

3 ; 
	g$Revisi⁄
: 1.10 
$


5 ; 
This
 
is
 
‰ì
 
	gso·w¨e
. 
You
 
¨e
 
≥rmôãd
 
to
 
	gu£
,

6 ; 
	gªdi°ribuã
, 
™d
 
modify
 
ô
 
as
 
•ecifõd
 
ö
 
the
 
	gfûe
 "COPYING".

8 ; 
A
 
lŸ
 
of
 
this
 
code
 
is
 
ad≠ãd
 
‰om
 
Kî√l
 
	gToﬁkô
 0.2

9 ; 
™d
 
Löux
 
	gvîsi⁄
 2.2.x, 
so
 
the
 
fﬁlowög
 
c›yrights
 
	g≠∂y
:

11 ; 
C›yright
 (
C
Ë1991, 1992 
Löus
 
	gT‹vÆds


12 ; 
modifõd
 
by
 
Dªw
 
	gEckh¨dt


13 ; 
modifõd
 
by
 
Bru˚
 
Ev™s
 (
bde
)

14 ; 
ad≠ãd
 
Kî√l
 
Toﬁkô
 
by
 
Luigi
 
	gSgro


16 %
	gö˛ude
 "defs.asm"

18 [
BITS
 16]

19 [
ORG
 0x0]

21 
	gBegöSëup
:

22 
°¨t_£tup
:

24 ; 
Redeföe
 
the
 
d©a
 
£gmít
 
so
 
we
 
ˇn
 
ac˚ss
 
	gv¨übÀs


25 ; 
de˛¨ed
 
ö
 
this
 
	gfûe
.

26 
mov
 
	gax
, 
SETUPSEG


27 
mov
 
	gds
, 
	gax


29 ; 
U£
 15
h
 
to
 
föd
 
out
 
size
 
of
 
exãnded
 
mem‹y
 
ö
 
	gKB
.

30 ; 
Exãnded
 
mem‹y
 
is
 
the
 mem‹y 
	gabove
 1
	gMB
. 
So
 
	gby


31 ; 
	gaddög
 1
MB
 
to
 
this
 
	gamou¡
, 
we
 
gë
 
the
 
tŸÆ
ámount

32 ; 
of
 
sy°em
 
	gmem‹y
. 
We
 
ˇn
 
⁄ly
 
	gdëe˘
 64
MB
 
this
 
	gway
,

33 ; 
but
 
	gth©
's OK forÇow.

34 
mov
 
	gah
, 0x88

36 
add
 
	gax
, 1024 ; 1024 
	gKB
 =1 
MB


37 ;; 
	gmov
 [
mem_size_kbyãs
], 
ax


39 
jc
 
îr


40 
ã°
 
	gax
,áx ; 
	gsize
 = 0 
is
 
™
 
îr‹


41 
je
 
îr


42 
cmp
 
ah
, 0x86 ; 
unsuµ‹ãd
 
fun˘i⁄


43 
je
 
îr


44 
cmp
 
	gah
, 0x80 ; 
övÆid
 
comm™d


45 
je
 
îr


46 
mov
 
	gw‹d
 [
mem_size_kbyãs
], 
ax


47 
jmp
 
ok


48 
	gîr
:

49 ;; 
Áûed
 
to
 
gë
 
mem‹y
 
th©
 
	gway
, 
åy
 
the
 
gíîÆ
 
puΩo£
 
	groutöe


50 ;; 
mov
 
	gw‹d
 [
mem_size_kbyãs
], (1024*64)-1

51 
mov
 
	gax
, 
MEMMAPSEG


52 
mov
 
	ges
, 
ax


53 
x‹
 
	gdi
, 
di


54 
ˇŒ
 
do_e820


55 
x‹
 
	gax
, 
ax


56 
mov
 
	gw‹d
 [
mem_size_kbyãs
], 
ax


58 
	gok
:

59 ; 
Kûl
 
the
 
Ê›py
 
	gmŸ‹
.

60 
ˇŒ
 
	gKûl_MŸ‹


62 ; 
Block
 
	göãºu±s
, 
sö˚
 
we
 
	gˇn
't meaningfully handleÅhem yet

63 ; 
™d
 
we
 
no
 
l⁄gî
 
√ed
 
BIOS
 
	g£rvi˚s
.

64 
	g˛i


66 ; 
Së
 
up
 
IDT
 
™d
 
GDT
 
ªgi°îs


67 
	glidt
 [
IDT_Poöãr
]

68 
	glgdt
 [
GDT_Poöãr
]

70 ; 
Inôülize
 
the
 
öãºu±
 
	gc⁄åﬁÀrs
, 
™d
 
íabÀ
 
	gthe


71 ; 
A20
 
addªss
 
löe


72 
ˇŒ
 
Inô_PIC


73 
ˇŒ
 
	gE«bÀ_A20


75 ; 
Swôch
 
to
 
¥Ÿe˘ed
 
	gmode
!

76 
mov
 
	gax
, 0x01

77 
lmsw
 
	gax


79 ; 
Jump
 
	gto
 32 
bô
 
	gcode
.

80 
jmp
 
dw‹d
 
	gKERNEL_CS
:(
SETUPSEG
 << 4Ë+ 
£tup_32


82 [
BITS
 32]

83 
£tup_32
:

85 ; 
£t
 
up
 
d©a
 
£gmít
 
ªgi°îs


86 
mov
 
	gax
, 
KERNEL_DS


87 
mov
 
	gds
, 
ax


88 
mov
 
	ges
, 
ax


89 
mov
 
	gfs
, 
ax


90 
mov
 
	ggs
, 
ax


91 
mov
 
	gss
, 
	gax


93 ; 
Cª©e
 
the
 
°ack
 thê
öôül
 
kî√l
 
	gthªad
.

94 
mov
 
	ge•
, 
	gKERN_STACK
 + 4096

96 ; 
Buûd
 
BoŸ_Info
 
⁄
 
	g°ack
.

97 ; 
NŸe
 
th©
 
we
 
push
 
the
 
fõlds
 
⁄
 
ö
 
ªvî£
 
	g‹dî
,

98 ; 
sö˚
 
the
 
°ack
 
grows
 
	gdownw¨ds
.

99 
mov
 
	góx
, (
	gMEMMAPSEG
<<4Ë;; 
addªss
 
of
 
mem≠
 
£gmíts


100 
push
 
óx


102 
x‹
 
	góx
, 
óx


103 
mov
 
	gax
, [(
SETUPSEG
<<4)+
mm≠_ít
] ;; 
numbî
 
of
 
£gmíts


104 
push
 
óx


106 
x‹
 
	góx
, 
óx


107 
mov
 
	góx
, [(
SETUPSEG
<<4)+
boŸDrive
]

108 
push
 
óx


110 
x‹
 
	góx
, 
óx


111 
mov
 
	gax
, [(
SETUPSEG
<<4)+
mem_size_kbyãs
]

112 
push
 
	góx
 ; 
memSizeKB


114 
push
 
	gdw‹d
 20 ; 
	gboŸInfoSize


116 ; 
Pass
 
poöãr
 
to
 
BoŸ_Info
 
as
 
¨gumít
Åÿ
	gkî√l


117 ; 
íåy
 
	gpoöt
.

118 
push
 
	ge•


120 ; 
Push
  
addªss
 
to
 
make
 
this
 
look
 
like
 
a
 
	gˇŒ


121 ; 
	gXXX
 - 
u¡e°ed


122 
push
 
dw‹d
 (
SETUPSEG
<<4)+.
	gªtu∫Addr


124 ; 
F¨
 
jump
 
öto
 
kî√l


125 
jmp
 
	gKERNEL_CS
:
ENTRY_POINT


127 .
ªtu∫Addr
:

128 ; 
We
 
	gshouldn
'tÑeturn here.

129 .
	ghîe
: 
jmp
 .
hîe


131 [
BITS
 16]

133 ; 
Kûl
 
the
 
Ê›py
 
	gmŸ‹
.

134 ; 
This
 
code
 
was
 
shamñes¶y
 
°ﬁí
 
‰om
 
	gLöux
.

135 
	gKûl_MŸ‹
:

136 
mov
 
dx
, 0x3f2

137 
x‹
 
	gÆ
, 
Æ


138 
out
 
	gdx
, 
Æ


139 
ªt


141 
	gInô_PIC
:

142 ; 
Inôülize
 
ma°î
 
™d
 
¶ave
 
	gPIC
!

143 
mov
 
	gÆ
, 
ICW1


144 
	gout
 0x20, 
	gÆ
 ; 
ICW1
 
to
 
ma°î


145 
ˇŒ
 
Dñay


146 
	gout
 0xA0, 
	gÆ
 ; 
ICW1
 
to
 
¶ave


147 
ˇŒ
 
Dñay


148 
mov
 
	gÆ
, 
ICW2_MASTER


149 
	gout
 0x21, 
	gÆ
 ; 
ICW2
 
to
 
ma°î


150 
ˇŒ
 
Dñay


151 
mov
 
	gÆ
, 
ICW2_SLAVE


152 
	gout
 0xA1, 
	gÆ
 ; 
ICW2
 
to
 
¶ave


153 
ˇŒ
 
Dñay


154 
mov
 
	gÆ
, 
ICW3_MASTER


155 
	gout
 0x21, 
	gÆ
 ; 
ICW3
 
to
 
ma°î


156 
ˇŒ
 
Dñay


157 
mov
 
	gÆ
, 
ICW3_SLAVE


158 
	gout
 0xA1, 
	gÆ
 ; 
ICW3
 
to
 
¶ave


159 
ˇŒ
 
Dñay


160 
mov
 
	gÆ
, 
ICW4


161 
	gout
 0x21, 
	gÆ
 ; 
ICW4
 
to
 
ma°î


162 
ˇŒ
 
Dñay


163 
	gout
 0xA1, 
	gÆ
 ; 
ICW4
 
to
 
¶ave


164 
ˇŒ
 
Dñay


165 
mov
 
	gÆ
, 0xf‡; 
mask
 
Æl
 
öts
 
ö
 
¶ave


166 
	gout
 0xA1, 
	gÆ
 ; 
OCW1
 
to
 
¶ave


167 
ˇŒ
 
Dñay


168 
mov
 
	gÆ
, 0xfb ; 
mask
 
Æl
 
öts
 
	gbut
 2 
ö
 
ma°î


169 
	gout
 0x21, 
	gÆ
 ; 
OCW1
 
to
 
ma°î


170 
ˇŒ
 
Dñay


171 
	gªt


175 ; 
Code
 
‰om
 
	ghâp
:

176 ; 
Ad≠ãd
 
GìkOS
 
by
 
Jeff
 
Hﬁlögsw‹th
 (2/4/10)

178 
	gdo_e820
:

179 
x‹
 
ebx
, 
	gebx
 ;Ébx 
mu°
 
	gbe
 0 
to
 
°¨t


180 
x‹
 
	gbp
, b∞; 
kìp
 
™
 
íåy
 
cou¡
 
ö
 
bp


181 
mov
 
	gedx
, 0x0534D4150 ; 
	gPœ˚
 "SMAP" 
öto
 
edx


182 
mov
 
	góx
, 0xe820

183 
	gmov
 [
es
:
di
 + 20], 
	gdw‹d
 1 ; 
f‹˚
 
a
 
vÆid
 
	gACPI
 3.X 
íåy


184 
mov
 
	gecx
, 24 ; 
ask
 24 
byãs


186 
jc
 .
	gÁûed
 ; 
ˇºy
 
£t
 
⁄
 
fú°
 
ˇŒ
 
	gmóns
 "unsupported function"

187 
mov
 
	gedx
, 0x0534D4150 ; 
Some
 
BIOSes
 
≠∑ª¡ly
 
åash
 
this
 ?

188 
cmp
 
	góx
, 
	gedx
 ; 
⁄
 
	gsuc˚ss
, 
óx
 
mu°
 
have
 
bìn
 
ª£t
 
	gto
 "SMAP"

189 
j√
 .
Áûed


190 
ã°
 
	gebx
,Ébx ;Ébx = 0 
im∂õs
 
li°
 
is
 
⁄ly
 1 
íåy
 (
w‹thÀss
)

191 
je
 .
Áûed


192 
jmp
 .
jmpö


193 .
e820Õ
:

194 
mov
 
óx
, 0xe820 ;Éax, 
ecx
 
gë
 
åashed
 
⁄
 
evîy
 0x15 
ˇŒ


195 
mov
 [
es
:
di
 + 20], 
dw‹d
 1 ; 
f‹˚
 
a
 
vÆid
 
ACPI
 3.X 
íåy


196 
mov
 
ecx
, 24 ; 
ask
 24 
byãs
 
agaö


198 
jc
 .
e820f
 ; 
ˇºy
 
£t
 
móns
 "end ofÜistálreadyÑeached"

199 
mov
 
edx
, 0x0534D4150 ; 
ª∑ú
 
pŸítüŒy
 
åashed
 

200 .
jmpö
:

201 
jcxz
 .
skùít
 ; 
skù
 
™y
 0 
Àngth
 
íåõs


202 
cmp
 
˛
, 20 ; 
gŸ
 
a
 24 
byã
 
ACPI
 3.X 
ª•⁄£
?

203 
jbe
 .
nŸext


204 
ã°
 
byã
 [
es
:
di
 + 20], 1 ; 
so
: 
is
 
the
 "ign‹êthi†d©a" 
bô
 
˛ór
?

205 
je
 .
skùít


206 .
nŸext
:

207 
mov
 
ecx
, [
es
:
di
 + 8] ; 
gë
 
lowî
 
dw‹d
 
of
 
mem‹y
 
ªgi⁄
 
Àngth


208 
ã°
 
ecx
,Écx ; 
is
 
the
 
qw‹d
 == 0?

209 
j√
 .
goodít


210 
mov
 
ecx
, [
es
:
di
 + 12] ; 
gë
 
uµî
 
dw‹d
 
of
 
mem‹y
 
ªgi⁄
 
Àngth


211 
jecxz
 .
skùít
 ; 
Àngth
 
qw‹d
 
is
 0, 
skù
 
íåy


212 .
goodít
:

213 
öc
 
bp
 ; 
gŸ
 
a
 
good
 
íåy
: ++
cou¡
, 
move
 
to
 
√xt
 
°‹age
 
•Ÿ


214 
add
 
di
, 24

215 .
skùít
:

216 
ã°
 
ebx
,Ébx ; ebx 
ª£ts
 
to
 0, 
li°
 
is
 
com∂ëe


217 
j√
 .
e820Õ


218 .
e820f
:

219 
mov
 [
mm≠_ít
], 
bp
 ; 
°‹e
 
the
 
íåy
 
cou¡


220 
ªt
 ; 
ã°
 
›code
 
˛óªd
 
ˇºy
 
Êag


221 .
Áûed
:

222 
°c
 ; "fun˘i⁄ unsuµ‹ãd" 
îr‹
 
exô


223 
ªt


225 
mm≠_ít
: 
dw
 0

228 ; 
Löux
 
u£s
 
this
 
code
.

229 ; 
The
 
idó
 
is
 
th©
 
some
 
sy°ems
 
issue
 
p‹t
 
I
/
O
 
ö°ru˘i⁄s


230 ; 
Á°î
 
th™
 
the
 
devi˚
 
h¨dw¨e
 
ˇn
 
dól
 
wôh
 
them
.

231 
Dñay
:

232 
jmp
 .
d⁄e


233 .
d⁄e
: 
ªt


235 ; 
E«bÀ
 
the
 
A20
 
addªss
 
löe
, 
so
 
we
 
ˇn
 
c‹ª˘ly
áddress

236 ; 
mem‹y
 
above
 1
MB
.

237 
E«bÀ_A20
:

238 
mov
 
Æ
, 0xD1

239 
out
 0x64, 
Æ


240 
ˇŒ
 
Dñay


241 
mov
 
Æ
, 0xDF

242 
out
 0x60, 
Æ


243 
ˇŒ
 
Dñay


244 
ªt


248 ; 
Sëup
 
d©a


251 
mem_size_kbyãs
: 
dw
 0

255 ; 
The
 
GDT
. 
Cª©es
 
Ê©
 32-
bô
 
addªss
 
•a˚
 
the
 
kî√l


256 ; 
code
, 
d©a
, 
™d
 
°ack
. 
NŸe
 
th©
 
this
 
GDT
 
is
 
ju°
 
u£d


257 ; 
to
 
¸óã
 
™
 
ívú⁄mít
 
whîe
 
we
 
ˇn
 
°¨t
 
ru¬ög
 32 
bô


258 ; 
code
. 
The
 
kî√l
 
wûl
 
¸óã
 
™d
 
m™age
 
ôs
 
own
 
GDT
.

261 ; 
GDT
 
öôüliz©i⁄
 
°uff


262 
NUM_GDT_ENTRIES
 
equ
 3 ; 
numbî
 
of
 
íåõs
 
ö
 
GDT


263 
GDT_ENTRY_SZ
 
equ
 8 ; 
size
 
of
 
a
 
sögÀ
 
GDT
 
íåy


265 
Æign
 8, 
db
 0

266 
GDT
:

267 ; 
Des¸ùt‹
 0 
is
 
nŸ
 
u£d


268 
dw
 0

269 
dw
 0

270 
dw
 0

271 
dw
 0

273 ; 
Des¸ùt‹
 1: 
kî√l
 
code
 
£gmít


274 
dw
 0xFFFF ; 
byãs
 0 
™d
 1 
of
 
£gmít
 
size


275 
dw
 0x0000 ; 
byãs
 0 
™d
 1 
of
 
£gmít
 
ba£
 
addªss


276 
db
 0x00 ; 
byã
 2 
of
 
£gmít
 
ba£
 
addªss


277 
db
 0x9A ; 
¥e£¡
, 
DPL
=0, 
n⁄
-
sy°em
, 
code
,Ç⁄-
c⁄f‹mög
,

278 ; 
ªadabÀ
, 
nŸ
 
ac˚s£d


279 
db
 0xCF ; 
gønuœrôy
=
∑ge
, 32 
bô
 
code
, 
uµî
 
nibbÀ
 
of
 
size


280 
db
 0x00 ; 
byã
 3 
of
 
£gmít
 
ba£
 
addªss


282 ; 
Des¸ùt‹
 2: 
kî√l
 
d©a
 
™d
 
°ack
 
£gmít


283 ; 
NOTE
: 
wh©
 
I¡ñ
 
ˇŒs
 
™
 "ex∑nd-up" 
£gmít


284 ; 
a˘uÆly
 
móns
 
th©
 
the
 
°ack
 
wûl
 
grow
 
DOWN
,

285 ; 
tow¨ds
 
lowî
 
mem‹y
. 
So
, 
we
 
ˇn
 
u£
 
this
 
des¸ùt‹


286 ; 
bŸh
 
d©a
 
™d
 
°ack
 
ª„ªn˚s
.

287 
dw
 0xFFFF ; 
byãs
 0 
™d
 1 
of
 
£gmít
 
size


288 
dw
 0x0000 ; 
byãs
 0 
™d
 1 
of
 
£gmít
 
ba£
 
addªss


289 
db
 0x00 ; 
byã
 2 
of
 
£gmít
 
ba£
 
addªss


290 
db
 0x92 ; 
¥e£¡
, 
DPL
=0, 
n⁄
-
sy°em
, 
d©a
, 
ex∑nd
-
up
,

291 ; 
wrôabÀ
, 
nŸ
 
ac˚s£d


292 
db
 0xCF ; 
gønuœrôy
=
∑ge
, 
big
, 
uµî
 
nibbÀ
 
of
 
size


293 
db
 0x00 ; 
byã
 3 
of
 
£gmít
 
ba£
 
addªss


295 
GDT_Poöãr
:

296 
dw
 
NUM_GDT_ENTRIES
*
GDT_ENTRY_SZ
 ; 
limô


297 
	`dd
 (
SETUPSEG
<<4Ë+ 
GDT
 ; 
ba£
 
addªss


299 
IDT_Poöãr
:

300 
dw
 0

301 
dd
 00

302 
EndSëup
:

304 
FûlSe˘‹
 
	`times
 (508 - (
EndSëup
 - 
BegöSëup
)Ë
db
 0

306 
boŸDrive
:

307 
dw
 0

308 
dw
 0

311 ;; 
°¨t
 
up
 
a
 
£c⁄day
 
¥o˚ss‹


312 ;; 
This
 
code
 
√eds
 
to
 
°¨t
 
⁄
 
a
 4
KB
 
∑ge
 
boundry
.

314 
Æign
 4096, 
db
 0

315 [
BITS
 16]

316 
°¨t_£c⁄d¨y_˝u
:

318 
mov
 
ax
, 
SETUPSEG


319 
mov
 
ds
, 
ax


321 ; 
Block
 
öãºu±s
, 
sö˚
 
we
 
ˇn
't meaningfully handleÅhem yet

322 ; 
™d
 
we
 
no
 
l⁄gî
 
√ed
 
BIOS
 
£rvi˚s
.

323 
˛i


325 
mov
 
•
,
TRAMPOLINE_STACK


327 ; 
Së
 
up
 
IDT
 
™d
 
GDT
 
ªgi°îs


328 
lidt
 [
IDT_Poöãr
]

329 
lgdt
 [
GDT_Poöãr
]

331 ; 
Inôülize
 
the
 
öãºu±
 
c⁄åﬁÀrs
, 
™d
 
íabÀ
Åhe

332 ; 
A20
 
addªss
 
löe


333 ;; 
ˇŒ
 
Inô_PIC


334 ;; 
ˇŒ
 
E«bÀ_A20


336 ; 
Swôch
 
to
 
¥Ÿe˘ed
 
mode
!

337 
mov
 
ax
, 0x01

338 
lmsw
 
ax


341 ; 
Jump
 
to
 32 
bô
 
code
.

342 
jmp
 
dw‹d
 
KERNEL_CS
:(
SETUPSEG
 << 4Ë+ 
£tup_2nd_32


344 [
BITS
 32]

345 
£tup_2nd_32
:

347 ; 
£t
 
up
 
d©a
 
£gmít
 
ªgi°îs


348 
mov
 
ax
, 
KERNEL_DS


349 
mov
 
ds
, 
ax


350 
mov
 
es
, 
ax


351 
mov
 
fs
, 
ax


352 
mov
 
gs
, 
ax


353 
mov
 
ss
, 
ax


355 ; 
Cª©e
 
the
 
°ack
 thê
öôül
 
kî√l
 
thªad
.

356 ;;
mov
 
e•
, [
ídSec⁄dSèck
]

357 ;;
mov
 
e•
, 
TRAMPOLINE_STACK


359 ;; 
£c⁄d¨y
 
°ack
 
is
 
the
 
∑ge
 
we
 
Æloˇãd
, 
°acks
 
grow
 
down
 
so
 
move
Åhê°ack 
poöãr
 
to
Åhê
íd
 
of
ÅheÖage

360 
mov
 
e•
, 
dw‹d
 [
SECONDARY_STACK
]

361 
add
 
e•
, 4096

362 
push
 
e•


364 ; 
F¨
 
jump
 
öto
 
kî√l


365 
push
 
	`dw‹d
 (
SETUPSEG
<<4)+.
ªtu∫Addr2


367 
jmp
 
KERNEL_CS
:
SECONDARY_ENTRY_POINT


368 .
ªtu∫Addr2
:

369 .
thîe
: 
jmp
 .there

372 ;; 
XXXX
 
This
 
dïíds
 
⁄
 
the
 
above
 
fun˘i⁄
 
beög
 
Àss
 
th™
 4
KB
 
sö˚
 
we
 
u£
 
a
 
fixed
 
off£t
 
to
 
this
 
√xt
 
loˇti⁄


374 
Æign
 4096, 
db
 0

375 
ídSec⁄dSèck
:

376 
dw
 0

378 
Æign
 4096, 
db
 0

379 
TRAMPOLINE_STACK
:

	@signal.c

24 
	~<gìkos/kas£π.h
>

25 
	~<gìkos/defs.h
>

26 
	~<gìkos/s¸ìn.h
>

27 
	~<gìkos/öt.h
>

28 
	~<gìkos/mem.h
>

29 
	~<gìkos/symbﬁ.h
>

30 
	~<gìkos/°rög.h
>

31 
	~<gìkos/kthªad.h
>

32 
	~<gìkos/mÆloc.h
>

33 
	~<gìkos/u£r.h
>

34 
	~<gìkos/sig«l.h
>

35 
	~<gìkos/¥oje˘s.h
>

36 
	~<gìkos/Æ¨m.h
>

40 
	$Com∂ëe_H™dÀr
(
Kî√l_Thªad
 *
kthªad
,

41 
I¡îru±_Sèã
 *
°©e
) {

42 
	`KASSERT
(
kthªad
);

43 
	`KASSERT
(
°©e
);

44 
	`TODO_P
(
PROJECT_SIGNALS
,

46 
	}
}

48 
	$Check_Pídög_Sig«l
(
Kî√l_Thªad
 *
kthªad
,

49 
I¡îru±_Sèã
 *
°©e
) {

50 
	`KASSERT
(
kthªad
);

51 
	`KASSERT
(
°©e
);

54 
	`TODO_P
(
PROJECT_SIGNALS
,

56 
	}
}

59 
	$Pröt_IS
(
I¡îru±_Sèã
 *
e•
) {

60 **
p
;

61 
	`Pröt
("e•=%x:\n", ()
e•
);

62 
	`Pröt
(" gs=%x\n", ()
e•
->
gs
);

63 
	`Pröt
(" fs=%x\n", ()
e•
->
fs
);

64 
	`Pröt
("És=%x\n", ()
e•
->
es
);

65 
	`Pröt
(" ds=%x\n", ()
e•
->
ds
);

66 
	`Pröt
("Ébp=%x\n", ()
e•
->
ebp
);

67 
	`Pröt
("Édi=%x\n", ()
e•
->
edi
);

68 
	`Pröt
("Ési=%x\n", ()
e•
->
esi
);

69 
	`Pröt
("Édx=%x\n", ()
e•
->
edx
);

70 
	`Pröt
("Écx=%x\n", ()
e•
->
ecx
);

71 
	`Pröt
("Ébx=%x\n", ()
e•
->
ebx
);

72 
	`Pröt
("Éax=%x\n", ()
e•
->
óx
);

73 
	`Pröt
(" i¡Num=%x\n", ()
e•
->
ötNum
);

74 
	`Pröt
("Éº‹Code=%x\n", ()
e•
->
îr‹Code
);

75 
	`Pröt
("Éù=%x\n", ()
e•
->
eù
);

76 
	`Pröt
(" cs=%x\n", ()
e•
->
cs
);

77 
	`Pröt
("ÉÊags=%x\n", ()
e•
->
eÊags
);

78 
p
 = (**)(((
I¡îru±_Sèã
 *)
e•
) + 1);

79 
	`Pröt
("e•+n=%x\n", ()
p
);

80 
	`Pröt
("e•+n[0]=%x\n", ()
p
[0]);

81 
	`Pröt
("e•+n[1]=%x\n", ()
p
[1]);

82 
	}
}

84 
	$dump_°ack
(*
e•
, 
ofs
) {

85 
i
;

86 
	`Pröt
("Setup_Frame: Stack dump\n");

87 
i
 = 0; i < 25; i++) {

88 
	`Pröt
("[%x]: %x\n", ()&
e•
[
i
] - 
ofs
,Ésp[i]);

90 
	}
}

93 
	$Sëup_Føme
(
Kî√l_Thªad
 *
kthªad
, 
I¡îru±_Sèã
 *
°©e
) {

94 
i
;

95 
	`KASSERT
(
kthªad
);

96 
	`KASSERT
(
°©e
);

98 
	`TODO_P
(
PROJECT_SIGNALS
, "Setup_Frame");

99 
	}
}

	@smp.c

13 
	~<gìkos/°rög.h
>

14 
	~<gìkos/s¸ìn.h
>

15 
	~<gìkos/kas£π.h
>

16 
	~<gìkos/≠ic.h
>

17 
	~<gìkos/smp.h
>

18 
	~<gìkos/li°.h
>

19 
	~<gìkos/öt.h
>

20 
	~<gìkos/idt.h
>

21 
	~<gìkos/mÆloc.h
>

22 
	~<gìkos/kthªad.h
>

23 
	~<gìkos/io.h
>

24 
	~<gìkos/timî.h
>

25 
	~<gìkos/tss.h
>

26 
	~<gìkos/å≠.h
>

27 
	~<gìkos/mem.h
>

28 
	~<gìkos/gdt.h
>

39 
	e˝uid_ªque°s
 {

40 
	mCPUID_GETVENDORSTRING
,

41 
	mCPUID_GETFEATURES
,

42 
	mCPUID_GETTLB
,

43 
	mCPUID_GETSERIAL
,

45 
	mCPUID_INTELEXTENDED
 = 0x80000000,

46 
	mCPUID_INTELFEATURES
,

47 
	mCPUID_INTELBRANDSTRING
,

48 
	mCPUID_INTELBRANDSTRINGMORE
,

49 
	mCPUID_INTELBRANDSTRINGEND
,

57 
ölöe
 
	$˝uid
(
code
, *
a
, *
d
) {

58 
asm
 vﬁ©ûê("˝uid":"˜" (*
a
), "=d"(*
d
):"a"(
code
):"ecx", "ebx");

59 
	}
}

62 *
	gAPIC_Addr
 = (*)0xFEE00000;

65 vﬁ©ûê*
	gIO_APIC_Addr
 =

73 
	sMP_C⁄fig_TabÀ
 {

74 
	msig«tuª
[4];

75 
	mÀngth
;

76 
	mªv
;

77 
	mchecksum
;

78 
	mOEM_Low
;

79 
	mOEM_High
;

80 
	m¥odu˘_ID
[12];

81 *
	mOEM_TabÀ_På
;

82 
	mOEM_TabÀ_Size
;

83 
	míåy_Cou¡
;

84 *
	mloˇl_APIC_Addr
;

85 
	mexãnded_TabÀ_Lígth
;

86 
	mexãnded_TabÀ_Checksum
;

87 } 
	tMP_C⁄fig_TabÀ
;

89 
	sMP_Flﬂtög_TabÀ
 {

90 
	msig«tuª
[4];

91 
MP_C⁄fig_TabÀ
 *
	mMP_C⁄fig_PTR
;

92 
	mÀngth
;

93 
	mvîsi⁄
;

94 
	mchecksum
;

95 
	mMP_Fótuªs1
;

96 
	mMP_Fótuªs2
;

97 
	mMP_Re£rved1
;

98 
	mMP_Re£rved2
;

99 
	mMP_Re£rved3
;

100 } 
	tMP_Flﬂtög_TabÀ
;

102 
	emp_èbÀ_ty≥s
 {

103 
	mMP_CONFIG_ENTRY_PROCESSOR
 = 0,

104 
	mMP_CONFIG_ENTRY_BUS
,

105 
	mMP_CONFIG_ENTRY_IO_APIC
,

106 
	mMP_CONFIG_ENTRY_IO_INTERRUPT_ASSIGNMENT
,

107 
	mMP_CONFIG_ENTRY_LOCAL_INTERRUPT_ASSIGNMENT


110 
	sMP_Pro˚ss‹
 {

111 
	mty≥
;

112 
	mAPIC_Id
;

113 
	mAPIC_Vîsi⁄
;

114 
	mCPU_E«bÀd
:1;

115 
	mIs_BoŸ°øp_CPU
:1;

116 
	mCPU_Sig«tuª
;

117 
	mCPU_Fœgs
;

118 
	mª£rved1
;

119 
	mª£rved2
;

120 } 
	tMP_Pro˚ss‹
;

122 
	sMP_IO_APIC
 {

123 
	mty≥
;

124 
	mAPIC_Id
;

125 
	mAPIC_Vîsi⁄
;

126 
	míabÀd
:1;

127 *
	maddªss
;

128 } 
	tMP_IO_APIC
;

130 
	sMP_IO_I¡îru±
 {

131 
	míåy_Ty≥
;

132 
	möãºu±_Ty≥
;

133 
	mÊag_PO
:1;

134 
	mÊag_EL
:1;

135 
	mª£rved
:14;

136 
	mbus_ID
;

137 
	m§c_Bus_IRQ
;

138 
	mde°IO_APIC
;

139 
	mde°IO_APIC_IRQ
;

140 } 
	tMP_IO_I¡îru±
;

142 
	gCPU_Cou¡
;

143 
MP_Pro˚ss‹
 *
	gPro˚ss‹
;

146 
	$MP_Checksum
(*
°¨t
, 
Àngth
) {

147 
i
;

148 
tŸÆ
;

150 
tŸÆ
 = 0;

151 
i
 = 0; i < 
Àngth
; i++)

152 
tŸÆ
 +
°¨t
[
i
];

154  
tŸÆ
 & 0xff;

155 
	}
}

157 
MP_Flﬂtög_TabÀ
 *
	$Sˇn_F‹_Flﬂtög_TabÀ
(*
°¨t
, *
íd
) {

158 *
cuº
;

159 
MP_Flﬂtög_TabÀ
 *
åy
;

160 
cuº
 = 
°¨t
; cuº < 
íd
; curr++) {

161 
åy
 = (
MP_Flﬂtög_TabÀ
 *Ë
cuº
;

162 i‡(!
	`°∫cmp
(
åy
->
sig«tuª
, "_MP_", 4) &&

163 !
	`MP_Checksum
((*)
cuº
, (
MP_Flﬂtög_TabÀ
))) {

164  
åy
;

168 
	}
}

170 
	$Gë_MP_TabÀs
() {

172 
MP_C⁄fig_TabÀ
 *
˘
;

173 
MP_Flﬂtög_TabÀ
 *
·
;

176 
·
 = 
	`Sˇn_F‹_Flﬂtög_TabÀ
((*)0xEBDA, (*)0xEBDA + 1024);

177 i‡(!
·
) {

179 
·
 = 
	`Sˇn_F‹_Flﬂtög_TabÀ
((*)(639 * 1024),

182 i‡(!
·
) {

184 
·
 = 
	`Sˇn_F‹_Flﬂtög_TabÀ
((*)0xF0000, (*)0x100000);

187 i‡(!
·
 || !·->
MP_C⁄fig_PTR
) {

192 
˘
 = 
·
->
MP_C⁄fig_PTR
;

193 i‡(
	`°∫cmp
(
˘
->
sig«tuª
, "PCMP", 4) ||

194 
	`MP_Checksum
((*)
˘
 + ct->
Àngth
,

195 
˘
->
exãnded_TabÀ_Lígth
)) {

197 
	`Pröt
("MP Configuration TableÇot valid\n");

201 *
cuº
 = ((*)
˘
Ë+ (
MP_C⁄fig_TabÀ
);

202 
MP_Pro˚ss‹
 *
¥oc
;

203 
MP_IO_APIC
 *
ioAPIC
;

204 
MP_IO_I¡îru±
 *
ötAss
;

205 
i
;

206 
i
 = 0; i < 
˘
->
íåy_Cou¡
; i++) {

207 *
cuº
) {

208 
MP_CONFIG_ENTRY_PROCESSOR
:

209 
¥oc
 = (
MP_Pro˚ss‹
 *Ë
cuº
;

210 
	`Pröt
("found CPU#%d wôh APIC id #%d\n", 
CPU_Cou¡
,

211 
¥oc
->
APIC_Id
);

213 i‡(!
CPU_Cou¡
)

214 
Pro˚ss‹
 = 
¥oc
;

215 
CPU_Cou¡
++;

216 
cuº
 +(
MP_Pro˚ss‹
);

219 
MP_CONFIG_ENTRY_IO_APIC
:

220 
ioAPIC
 = (
MP_IO_APIC
 *Ë
cuº
;

221 
	`Pröt
("found IO APIC ID=%dáà%x\n", 
ioAPIC
->
APIC_Id
,

222 ()
ioAPIC
->
addªss
);

223 
IO_APIC_Addr
 = 
ioAPIC
->
addªss
;

224 
cuº
 +(
MP_IO_APIC
);

227 
MP_CONFIG_ENTRY_LOCAL_INTERRUPT_ASSIGNMENT
:

228 
MP_CONFIG_ENTRY_IO_INTERRUPT_ASSIGNMENT
:

229 
ötAss
 = (
MP_IO_I¡îru±
 *Ë
cuº
;

230 
cuº
 += 8;

233 
MP_CONFIG_ENTRY_BUS
:

235 
cuº
 += 8;

239 
	`Pröt
("Uknow¿íåyÅy≥ %d\n", *
cuº
);

243 
	}
}

245 
ölöe
 
	$APIC_Ród
(
ªg
) {

246 
ªt
;

248 
	`__asm
("pushfl");

249 
	`__asm
("cli");

250 
ªt
 = *((vﬁ©ûê*)(
APIC_Addr
 + 
ªg
));

251 
	`__asm
("popfl");

253  
ªt
;

254 
	}
}

256 
ölöe
 
	$APIC_Wrôe
(
ªg
, 
vÆue
) {

257 
	`__asm
("pushfl");

258 
	`__asm
("cli");

259 *((vﬁ©ûê*)(
APIC_Addr
 + 
ªg
)Ë
vÆue
;

260 
	`__asm
("popfl");

262 
	}
}

264 
ölöe
 
	$IOAPIC_Wrôe
(c⁄° 
off£t
, c⁄° 
vÆ
) {

265 
	`__asm
("pushfl");

266 
	`__asm
("cli");

268 *
IO_APIC_Addr
 = 
off£t
;

270 *(*)(
IO_APIC_Addr
 + 0x10 / 4Ë
vÆ
;

271 
	`__asm
("popfl");

272 
	}
}

274 
ölöe
 
	$IOAPIC_Ród
(c⁄° 
off£t
) {

275 
ªt
;

277 
	`__asm
("pushfl");

278 
	`__asm
("cli");

279 *(*)
IO_APIC_Addr
 = 
off£t
;

280 
ªt
 = *(*)(
IO_APIC_Addr
 + 0x10 / 4);

281 
	`__asm
("popfl");

283  (
ªt
);

284 
	}
}

290 
	$£nd_IPI
(
APIC_Id
, 
mask
) {

291 
åy
;

292 
°©us
 = 1;

294 
	`APIC_Wrôe
(
APIC_ICR
 + 0x10, (
APIC_Id
 << 24));

295 
	`APIC_Wrôe
(
APIC_ICR
, 
mask
);

297 
åy
 = 0;Åry < 100;Åry++) {

298 
	`Mi¸o_Dñay
(100);

299 
°©us
 = 
	`APIC_Ród
(
APIC_ICR
Ë& 
APIC_ICR_STATUS_PEND
;

300 i‡(!
°©us
)

304 
	`Pröt
("Send IPIÅimeout\n");

306 
	}
}

308 
	$£nd_INIT
(
APIC_Id
) {

310 
	`£nd_IPI
(
APIC_Id
,

311 
APIC_ICR_TM_LEVEL
 | 
APIC_ICR_LEVELASSERT
 | 
APIC_ICR_DM_INIT
);

313 
	`Mi¸o_Dñay
(10000);

316 
	`£nd_IPI
(
APIC_Id
, 
APIC_ICR_TM_LEVEL
 | 
APIC_ICR_DM_INIT
);

318 
	`Mi¸o_Dñay
(10000);

319 
	}
}

321 
	$Spurious_I¡îru±_H™dÀr
(
I¡îru±_Sèã
 *
°©e
) {

322 
CPUid
 = 
	`Gë_CPU_ID
();

323 
CPUs
[
CPUid
].
•uriousCou¡
++;

324 
	}
}

330 
	$Inô_Loˇl_APIC
(
˝u
) {

331 
≠icid
;

332 
˝ubus‰eq
;

333 
tmp
;

334 
qu™tum
 = 10;

335 
≠icInôülCou¡
 = 0;

337 
	`Timî_I¡îru±_H™dÀr
();

338 
	`In°Æl_I¡îru±_H™dÀr
(39, 
Spurious_I¡îru±_H™dÀr
);

340 
	`In°Æl_I¡îru±_H™dÀr
(32, 
Timî_I¡îru±_H™dÀr
);

343 
	`APIC_Wrôe
(
APIC_DFR
, 0xFFFFFFFF);

344 
	`APIC_Wrôe
(
APIC_LDR
, (
	`APIC_Ród
(APIC_LDR) & 0x00FFFFFF) | 1);

345 
	`APIC_Wrôe
(
APIC_LVTT
, 
APIC_DISABLE
);

346 
	`APIC_Wrôe
(
APIC_LVTPC
, 
APIC_ICR_DM_NMI
);

347 
	`APIC_Wrôe
(
APIC_LVT0
, 
APIC_DISABLE
);

348 
	`APIC_Wrôe
(
APIC_LVT1
, 
APIC_DISABLE
);

349 
	`APIC_Wrôe
(
APIC_TPR
, 0);

352 
	`asm
("movl $0x1b, %ecx");

353 
	`asm
("rdmsr");

354 
	`asm
("orl $0x800, %eax");

355 
	`asm
("wrmsr");

358 
≠icid
 = 
	`APIC_Ród
(
APIC_SPIV
);

359 
	`APIC_Wrôe
(
APIC_SPIV
, 
≠icid
 | 
APIC_SPIV_ENABLE_APIC
);

360 
≠icid
 = 
	`GET_APIC_ID
(
	`APIC_Ród
(
APIC_ID
));

363 
	`APIC_Wrôe
(
APIC_SPIV
, 39 | 
APIC_SW_ENABLE
);

365 i‡(!
˝u
) {

367 
	`APIC_Wrôe
(
APIC_LVTT
, 32);

369 
	`APIC_Wrôe
(
APIC_TDCR
, 0x03);

371 
	`Out_Byã
(0x61, (
	`In_Byã
(0x61) & 0xFD) | 1);

372 
	`Out_Byã
(0x43, 0xB2);

374 
	`Out_Byã
(0x42, 0x9B);

375 
	`In_Byã
(0x60);

376 
	`Out_Byã
(0x42, 0x2E);

379 
tmp
 = 
	`In_Byã
(0x61) & 0xFE;

380 
	`Out_Byã
(0x61, ()
tmp
);

381 
	`Out_Byã
(0x61, ()
tmp
 | 1);

384 
	`APIC_Wrôe
(
APIC_TICR
, 0xFFFFFFFF - 1);

387 !(
	`In_Byã
(0x61) & 0x20));

390 
	`APIC_Wrôe
(
APIC_LVTT
, 
APIC_DISABLE
);

393 
	`Pröt
("≠i¯cou¡ed dow¿tÿ%x\n", 
	`APIC_Ród
(
APIC_TCCR
));

394 
˝ubus‰eq
 = (0xFFFFFFFF - (
	`APIC_Ród
(
APIC_TCCR
) + 1)) * 16 * 100;

395 
	`Pröt
("˝u fªq = %d\n", 
˝ubus‰eq
);

396 
≠icInôülCou¡
 = 
˝ubus‰eq
 / 
qu™tum
 / 16;

401 
	`APIC_Wrôe
(
APIC_TICR
, 
≠icInôülCou¡
 < 16 ? 16 :ápicInitialCount);

404 
	`APIC_Wrôe
(
APIC_LVTT
, 32 | 
TMR_PERIODIC
);

408 
	`APIC_Wrôe
(
APIC_TDCR
, 0x03);

410  
≠icid
;

411 
	}
}

414 
	$Gë_CPU_ID
() {

415 
≠icid
;

417 
≠icid
 = 
	`GET_APIC_ID
(
	`APIC_Ród
(
APIC_ID
));

419  
≠icid
;

420 
	}
}

422 
CPU_Info
 
	gCPUs
[
MAX_CPUS
];

430 
	#START_SECONDARY_FUNC
 ((0x9020<<4Ë+ 4096)

	)

432 *
	gSec⁄d¨y_Sèck
;

434 
	$Inô_SMP
() {

435 
i
;

436 
úq
;

437 
cou¡
;

438 
≠icid
;

440 
	`Pröt
("Initializing SMP...\n");

442 
	`Gë_MP_TabÀs
();

443 
≠icid
 = 
	`Gë_CPU_ID
();

445 
	`KASSERT0
(
≠icid
 == 0,

448 
i
 = 0; i < 
CPU_Cou¡
; i++) {

449 i‡(!
Pro˚ss‹
[
i
].
Is_BoŸ°øp_CPU
) {

452 *
±r
;

453 
±r
 = 
	`AŒoc_Page
();

454 
CPUs
[
i
].
°ack
 = 
±r
;

455 
	`£nd_INIT
(
Pro˚ss‹
[
i
].
APIC_Id
);

458 
CPUs
[
i
].
öôD⁄e
 = 1;

461 
	`Mi¸o_Dñay
(10000);

463 
i
 = 0; i < 
CPU_Cou¡
; i++) {

464 i‡(!
Pro˚ss‹
[
i
].
Is_BoŸ°øp_CPU
) {

465 
Sec⁄d¨y_Sèck
 = 
CPUs
[
i
].
°ack
;

466 
	`£nd_IPI
(
i
,

467 
APIC_ICR_DM_SIPI
 |

468 (((()
START_SECONDARY_FUNC
) >> 12) & 0xFF));

469 
	`Mi¸o_Dñay
(10000);

470 !
CPUs
[
i
].
öôD⁄e
)

471 
	`Mi¸o_Dñay
(10000);

474 
	}
}

480 
	$Sec⁄d¨y_Sèπ
(
°ack
) {

481 
i
;

482 
CPUid
;

483 
APICid
;

485 
CPUid
 = 
	`Gë_CPU_ID
();

488 
CPUs
[
CPUid
].
öôD⁄e
 = 1;

491 !
CPUs
[
CPUid
].
ru¬ög
) {

492 
	`Mi¸o_Dñay
(1000);

495 
	`Inô_GDT
(
CPUid
);

497 
	`Inô_TSS
();

499 
	`lockKî√l
();

500 
	`Inô_I¡îru±s
(
CPUid
);

502 
	`Inô_Sec⁄d¨y_VM
();

503 
	`Inô_Sec⁄d¨y_VM
();

505 
	`Inô_ScheduÀr
(
CPUid
, 
CPUs
[CPUid].
°ack
);

507 
	`Inô_Tøps
();

509 
APICid
 = 
	`Inô_Loˇl_APIC
(
CPUid
);

511 
	`Inô_Timî_I¡îru±
();

513 
	`Pröt
("Init done\n");

516 
CPUs
[
CPUid
].
ru¬ög
 = 2;

518 
	`KASSERT0
(
APICid
 =
	`Gë_CPU_ID
(), "Apic id doesn't match cpuid");

520 
	`Síd_Timî_INT
();

523 
	`Exô
(0);

524 
	}
}

526 
	$Rñó£_SMP
() {

527 
i
;

528 
úq
;

530 
i
 = 0; i < 
CPU_Cou¡
; i++) {

531 
CPUs
[
i
].
ru¬ög
 = 1;

532 i‡(
i
)

533 
CPUs
[
i
].
ru¬ög
 != 2);

535 
	}
}

538 
Spö_Lock_t
 
	gli°Lock
;

540 
Spö_Lock_t
 
	gkthªadLock
;

542 
	$Is_Locked
(
Spö_Lock_t
 * 
lock
) {

543  
lock
->lock;

544 
	}
}

546 
	$Spö_Lock_Inô
(
Spö_Lock_t
 * 
lock
) {

547 
	`KASSERT
(
lock
);

549 
lock
->lock = 0;

550 
lock
->
œ°Lockî
 = 
NULL
;

551 
lock
->
lockî
 = 
NULL
;

552 
	}
}

554 
	$Spö_Lock
(
Spö_Lock_t
 * 
lock
) {

555 
	`Spö_Lock_INTERNAL
(
Spö_Lock_t
 * 
lock
);

556 
	`KASSERT
(
lock
);

557 
	`Spö_Lock_INTERNAL
(
lock
);

558 
lock
->
lockî
 = 
CURRENT_THREAD
;

559 
	}
}

561 
	$Spö_U∆ock
(
Spö_Lock_t
 * 
lock
) {

562 
	`Spö_U∆ock_INTERNAL
(
Spö_Lock_t
 * 
lock
);

563 
	`KASSERT
(
lock
);

564 
	`KASSERT
(
lock
->lock);

566 
lock
->
œ°Lockî
 =Üock->
lockî
;

567 
lock
->
lockî
 = 
NULL
;

568 
	`Spö_U∆ock_INTERNAL
(
lock
);

569 
	}
}

573 
	$M≠_IO_APIC_IRQ
(
úq
, *
h™dÀr
) {

575 
	`IOAPIC_Wrôe
(0x10 + 2 * 
úq
, 0x00000000 | irq);

576 
	`IOAPIC_Wrôe
(0x10 + 2 * 
úq
 + 1, 0x00000000);

578 
	`In°Æl_I¡îru±_H™dÀr
(
úq
, 
h™dÀr
);

579 
	}
}

585 
Spö_Lock_t
 
	gglobÆLock
;

587 
	$lockKî√l
() {

588 
	`Spö_Lock
(&
globÆLock
);

589 
	}
}

591 
	$u∆ockKî√l
() {

592 
	`Spö_U∆ock
(&
globÆLock
);

593 
	}
}

	@symbol.asm

1 ; 
Symbﬁ
 
m™glög
 
	gma¸os


2 ; 
C›yright
 (
c
Ë2001, 
David
 
	gH
. 
	gHovemeyî
 <
	gdaveho
@
	gcs
.
	gumd
.
	gedu
>

3 ; 
	g$Revisi⁄
: 1.4 
$


5 ; 
This
 
fûe
 
deföes
 
ma¸os
 
dólög
 
wôh
 
	gexã∫Æly
-
	gvisibÀ


6 ; 
symbﬁs
 
th©
 
mu°
 
be
 
m™gÀd
 
some
 
obje˘
 
fûe
 
	gf‹m©s
.

7 ; 
F‹
 
	gexam∂e
, 
PECOFF
 
ªquúes
 
a
 
Àadög
 
	gundîsc‹e
, 

8 ; 
ELF
 
d€s
 
	gnŸ
.

10 ; 
EXPORT
 
deföes
 
a
 
symbﬁ
 
as
 
	gglobÆ


11 ; 
IMPORT
 
ª„ªn˚s
 
a
 
symbﬁ
 
deföed
 
ö
 
™Ÿhî
 
	gmoduÀ


13 ; 
Th™ks
 
to
 
Chri°›hî
 
Gõ£
 
¥ovidög
 
the
 
NASM
 
	gma¸os


14 ; (
thus
 
ßvög
 
me
 
hours
 
of
 
	g‰u°øti⁄
).

16 %
i‚def
 
	gSYMBOL_ASM


17 %
deföe
 
	gSYMBOL_ASM


19 %
ifdef
 
	gNEED_UNDERSCORE


21 %
ma¸o
 
	gEXPORT
 1

22 [
GLOBAL
 
_
%1]

23 %
	gdeföe
 %1 
	g_
%1

24 %
	gídma¸o


26 %
ma¸o
 
	gIMPORT
 1

27 [
EXTERN
 
_
%1]

28 %
	gdeföe
 %1 
	g_
%1

29 %
	gídma¸o


33 %
ma¸o
 
	gEXPORT
 1

34 [
GLOBAL
 %1]

35 %
	gídma¸o


37 %
ma¸o
 
	gIMPORT
 1

38 [
EXTERN
 %1]

39 %
	gídma¸o


41 %
	gídif


43 %
	gídif


	@synch.c

18 
	~<gìkos/kthªad.h
>

19 
	~<gìkos/öt.h
>

20 
	~<gìkos/kas£π.h
>

21 
	~<gìkos/s¸ìn.h
>

22 
	~<gìkos/synch.h
>

43 
	$Muãx_Waô
(
Muãx
 *
muãx
) {

44 
	`KASSERT
(
muãx
->
°©e
 =
MUTEX_LOCKED
);

45 
	`KASSERT
(
g_¥ìm±i⁄DißbÀd
[
	`Gë_CPU_ID
()]);

47 
	`DißbÀ_I¡îru±s
();

48 
g_¥ìm±i⁄DißbÀd
[
	`Gë_CPU_ID
()] = 
Ál£
;

49 
	`Waô
(&
muãx
->
waôQueue
);

50 
g_¥ìm±i⁄DißbÀd
[
	`Gë_CPU_ID
()] = 
åue
;

51 
	`E«bÀ_I¡îru±s
();

52 
	}
}

58 
__ölöe__
 
	$Muãx_Lock_Imp
(
Muãx
 *
muãx
) {

59 
	`KASSERT
(
g_¥ìm±i⁄DißbÀd
[
	`Gë_CPU_ID
()]);

62 
	`KASSERT
(!
	`IS_HELD
(
muãx
));

65 
muãx
->
°©e
 =
MUTEX_LOCKED
) {

66 
	`Muãx_Waô
(
muãx
);

70 
muãx
->
°©e
 = 
MUTEX_LOCKED
;

71 
muãx
->
ow√r
 = 
CURRENT_THREAD
;

72 
	}
}

78 
__ölöe__
 
	$Muãx_U∆ock_Imp
(
Muãx
 *
muãx
) {

79 
	`KASSERT
(
g_¥ìm±i⁄DißbÀd
[
	`Gë_CPU_ID
()]);

82 
	`KASSERT
(
	`IS_HELD
(
muãx
));

85 
muãx
->
°©e
 = 
MUTEX_UNLOCKED
;

86 
muãx
->
ow√r
 = 0;

95 i‡(!
	`Is_Thªad_Queue_Em±y
(&
muãx
->
waôQueue
)) {

96 
	`DißbÀ_I¡îru±s
();

97 
	`Wake_Up_O√
(&
muãx
->
waôQueue
);

98 
	`E«bÀ_I¡îru±s
();

100 
	}
}

109 
	$Muãx_Inô
(
Muãx
 *
muãx
) {

110 
muãx
->
°©e
 = 
MUTEX_UNLOCKED
;

111 
muãx
->
ow√r
 = 0;

112 
	`CÀ¨_Thªad_Queue
(&
muãx
->
waôQueue
);

113 
	}
}

118 
	$Muãx_Lock
(
Muãx
 *
muãx
) {

119 
	`KASSERT
(
	`I¡îru±s_E«bÀd
());

121 
g_¥ìm±i⁄DißbÀd
[
	`Gë_CPU_ID
()] = 
åue
;

122 
	`Muãx_Lock_Imp
(
muãx
);

123 
g_¥ìm±i⁄DißbÀd
[
	`Gë_CPU_ID
()] = 
Ál£
;

124 
	}
}

129 
	$Muãx_U∆ock
(
Muãx
 *
muãx
) {

130 
	`KASSERT
(
	`I¡îru±s_E«bÀd
());

132 
g_¥ìm±i⁄DißbÀd
[
	`Gë_CPU_ID
()] = 
åue
;

133 
	`Muãx_U∆ock_Imp
(
muãx
);

134 
g_¥ìm±i⁄DißbÀd
[
	`Gë_CPU_ID
()] = 
Ál£
;

135 
	}
}

140 
	$C⁄d_Inô
(
C⁄dôi⁄
 *
c⁄d
) {

141 
	`CÀ¨_Thªad_Queue
(&
c⁄d
->
waôQueue
);

142 
	}
}

147 
	$C⁄d_Waô
(
C⁄dôi⁄
 *
c⁄d
, 
Muãx
 *
muãx
) {

148 
	`KASSERT
(
	`I¡îru±s_E«bÀd
());

151 
	`KASSERT
(
	`IS_HELD
(
muãx
));

154 
g_¥ìm±i⁄DißbÀd
[
	`Gë_CPU_ID
()] = 
åue
;

162 
	`Muãx_U∆ock_Imp
(
muãx
);

171 
	`DißbÀ_I¡îru±s
();

172 
g_¥ìm±i⁄DißbÀd
[
	`Gë_CPU_ID
()] = 
Ál£
;

173 
	`Waô
(&
c⁄d
->
waôQueue
);

174 
g_¥ìm±i⁄DißbÀd
[
	`Gë_CPU_ID
()] = 
åue
;

175 
	`E«bÀ_I¡îru±s
();

178 
	`Muãx_Lock_Imp
(
muãx
);

181 
g_¥ìm±i⁄DißbÀd
[
	`Gë_CPU_ID
()] = 
Ál£
;

182 
	}
}

188 
	$C⁄d_Sig«l
(
C⁄dôi⁄
 *
c⁄d
) {

189 
	`KASSERT
(
	`I¡îru±s_E«bÀd
());

190 
	`DißbÀ_I¡îru±s
();

191 
	`Wake_Up_O√
(&
c⁄d
->
waôQueue
);

192 
	`E«bÀ_I¡îru±s
();

193 
	}
}

199 
	$C⁄d_Brﬂdˇ°
(
C⁄dôi⁄
 *
c⁄d
) {

200 
	`KASSERT
(
	`I¡îru±s_E«bÀd
());

201 
	`DißbÀ_I¡îru±s
();

202 
	`Wake_Up
(&
c⁄d
->
waôQueue
);

203 
	`E«bÀ_I¡îru±s
();

204 
	}
}

	@syscall.c

16 
	~<gìkos/sysˇŒ.h
>

17 
	~<gìkos/î∫o.h
>

18 
	~<gìkos/kthªad.h
>

19 
	~<gìkos/öt.h
>

20 
	~<gìkos/ñf.h
>

21 
	~<gìkos/mÆloc.h
>

22 
	~<gìkos/s¸ìn.h
>

23 
	~<gìkos/keybﬂrd.h
>

24 
	~<gìkos/°rög.h
>

25 
	~<gìkos/u£r.h
>

26 
	~<gìkos/timî.h
>

27 
	~<gìkos/vfs.h
>

28 
	~<gìkos/sig«l.h
>

29 
	~<gìkos/£m.h
>

30 
	~<gìkos/¥oje˘s.h
>

32 
	~<gìkos/sys_√t.h
>

33 
	~<gìkos/pùe.h
>

34 
	~<gìkos/mem.h
>

36 
Spö_Lock_t
 
kthªadLock
;

45 
	$C›y_U£r_Såög
(
ul⁄g_t
 
uaddr
, ul⁄g_à
Àn
, ul⁄g_à
maxLí
,

46 **
pSå
) {

47 
rc
 = 0;

48 *
°r
;

51 i‡(
Àn
 > 
maxLí
)

52  
EINVALID
;

55 
°r
 = (*)
	`MÆloc
(
Àn
 + 1);

56 i‡(
°r
 == 0) {

57 
rc
 = 
ENOMEM
;

58 
d⁄e
;

62 i‡(!
	`C›y_From_U£r
(
°r
, 
uaddr
, 
Àn
)) {

63 
rc
 = 
EINVALID
;

64 
	`Fªe
(
°r
);

65 
d⁄e
;

67 
°r
[
Àn
] = '\0';

70 *
pSå
 = 
°r
;

72 
d⁄e
:

73  
rc
;

74 
	}
}

86 
Sys_NuŒ
(
I¡îru±_Sèã
 *
°©e
 
__©åibuã__
 ((
unu£d
))) {

98 
	$Sys_Exô
(
I¡îru±_Sèã
 *
°©e
) {

99 
	`Exô
(
°©e
->
ebx
);

101 
	}
}

108 
H¨dw¨e_Shutdown
();

109 
	$Sys_ShutDown
(
I¡îru±_Sèã
 *
°©e
) {

110 
	`Pröt
("------------------- THE END ------------------\n");

111 
	`H¨dw¨e_Shutdown
();

114 
	}
}

116 
Spö_Lock_t
 
	g•rötLock
;

126 
	$Sys_PrötSåög
(
I¡îru±_Sèã
 *
°©e
) {

127 
rc
 = 0;

128 
uöt_t
 
Àngth
 = 
°©e
->
ecx
;

129 *
buf
 = 0;

131 
	`Spö_Lock
(&
•rötLock
);

132 i‡(
Àngth
 > 0) {

134 i‡((
rc
 =

135 
	`C›y_U£r_Såög
(
°©e
->
ebx
, 
Àngth
, 1023, (**)&
buf
)) != 0)

136 
d⁄e
;

143 i‡(!
buf
[0]) {

144 
	`Dump_I¡îru±_Sèã
(
°©e
);

145 
	`KASSERT0
(
buf
[0],

150 
	`Put_Buf
(
buf
, 
Àngth
);

153 
d⁄e
:

154 i‡(
buf
 != 0)

155 
	`Fªe
(
buf
);

156 
	`Spö_U∆ock
(&
•rötLock
);

157  
rc
;

158 
	}
}

168 
	$Sys_GëKey
(
I¡îru±_Sèã
 *
°©e
) {

170  
	`Waô_F‹_Key
();

171 
	}
}

179 
	$Sys_SëAâr
(
I¡îru±_Sèã
 *
°©e
) {

180 
	`Së_Cuºít_Aâr
((
uch¨_t
Ë
°©e
->
ebx
);

182 
	}
}

191 
	$Sys_GëCurs‹
(
I¡îru±_Sèã
 *
°©e
) {

192 
row
, 
cﬁ
;

193 
	`Gë_Curs‹
(&
row
, &
cﬁ
);

194 i‡(!
	`C›y_To_U£r
(
°©e
->
ebx
, &
row
, ()) ||

195 !
	`C›y_To_U£r
(
°©e
->
ecx
, &
cﬁ
, ()))

198 
	}
}

207 
	$Sys_PutCurs‹
(
I¡îru±_Sèã
 *
°©e
) {

208  
	`Put_Curs‹
(
°©e
->
ebx
, sèã->
ecx
) ? 0 : -1;

209 
	}
}

221 
	$Sys_S∑wn
(
I¡îru±_Sèã
 *
°©e
) {

222 
rc
;

223 *
¥ogøm
 = 0;

224 *
comm™d
 = 0;

225 
Kî√l_Thªad
 *
¥o˚ss
;

228 i‡((
rc
 =

229 
	`C›y_U£r_Såög
(
°©e
->
ebx
, sèã->
ecx
, 
VFS_MAX_PATH_LEN
,

230 &
¥ogøm
)) != 0 ||

231 (
rc
 = 
	`C›y_U£r_Såög
(
°©e
->
edx
, sèã->
esi
, 1023, &
comm™d
)) != 0)

232 
d⁄e
;

234 
	`E«bÀ_I¡îru±s
();

241 
rc
 = 
	`S∑wn
(
¥ogøm
, 
comm™d
, &
¥o˚ss
, 
°©e
->
edi
);

243 i‡(
rc
 == 0) {

244 
	`KASSERT
(
¥o˚ss
 != 0);

245 
rc
 = 
¥o˚ss
->
pid
;

248 
	`DißbÀ_I¡îru±s
();

250 
d⁄e
:

251 i‡(
¥ogøm
 != 0)

252 
	`Fªe
(
¥ogøm
);

253 i‡(
comm™d
 != 0)

254 
	`Fªe
(
comm™d
);

256  
rc
;

257 
	}
}

266 
	$Sys_Waô
(
I¡îru±_Sèã
 *
°©e
) {

267 
exôCode
;

268 
Kî√l_Thªad
 *
kthªad
 = 
	`Lookup_Thªad
(
°©e
->
ebx
, 0);

269 i‡(
kthªad
 == 0) {

271  
EINVALID
;

274 i‡(
kthªad
->
dëached
) {

276  
EINVALID
;

278 
	`E«bÀ_I¡îru±s
();

279 
exôCode
 = 
	`Joö
(
kthªad
);

280 
	`DißbÀ_I¡îru±s
();

282  
exôCode
;

283 
	}
}

291 
	$Sys_GëPID
(
I¡îru±_Sèã
 *
°©e
) {

292  
CURRENT_THREAD
->
pid
;

293 
	}
}

296 
AŒ_Thªad_Li°
 
s_ÆlThªadLi°
;

297 
Thªad_Queue
 
s_runQueue
;

310 
	$Sys_PS
(
I¡îru±_Sèã
 *
°©e
) {

311 
	`TODO_P
(
PROJECT_BACKGROUND_JOBS
, "Sys_PS system call");

313 
	}
}

323 
	$Sys_Kûl
(
I¡îru±_Sèã
 *
°©e
) {

324 
	`TODO_P
(
PROJECT_SIGNALS
, "Sys_Kill system call");

326 
	}
}

335 
	$Sys_Sig«l
(
I¡îru±_Sèã
 *
°©e
) {

336 
	`TODO_P
(
PROJECT_SIGNALS
, "Sys_Signal system call");

338 
	}
}

351 
	$Sys_RegDñivî
(
I¡îru±_Sèã
 *
°©e
) {

353 
	`TODO_P
(
PROJECT_SIGNALS
, "Sys_RegDeliver system call");

354 
	}
}

363 
	$Sys_Rëu∫Sig«l
(
I¡îru±_Sèã
 *
°©e
) {

364 
	`TODO_P
(
PROJECT_SIGNALS
, "Sys_ReturnSignal system call");

365  
EUNSUPPORTED
;

366 
	}
}

374 
	$Sys_WaôNoPID
(
I¡îru±_Sèã
 *
°©e
) {

375 
	`TODO_P
(
PROJECT_SIGNALS
, "Sys_WaitNoPID system call");

376  
EUNSUPPORTED
;

377 
	}
}

386 
	$Sys_SëSchedulögPﬁicy
(
I¡îru±_Sèã
 *
°©e
) {

387 
	`TODO_P
(
PROJECT_SCHEDULING
, "SetSchedulingPolicy system call");

389 
	}
}

398 
Sys_GëTimeOfDay
(
I¡îru±_Sèã
 *
°©e


399 
__©åibuã__
 ((
unu£d
))) {

400  
	gg_numTicks
;

413 
	$Sys_Mou¡
(
I¡îru±_Sèã
 *
°©e
) {

414 
rc
 = 0;

415 
VFS_Mou¡_Reque°
 *
¨gs
 = 0;

418 i‡((
¨gs
 =

419 (
VFS_Mou¡_Reque°
 *)
	`MÆloc
((VFS_Mount_Request)))

421 
rc
 = 
ENOMEM
;

422 
d⁄e
;

426 i‡(!
	`C›y_From_U£r
(
¨gs
, 
°©e
->
ebx
, (
VFS_Mou¡_Reque°
))) {

427 
rc
 = 
EINVALID
;

428 
d⁄e
;

436 
	`TODO_P
(
PROJECT_FS
, "Mount system call");

438 
d⁄e
:

439 i‡(
¨gs
 != 0)

440 
	`Fªe
(
¨gs
);

441  
rc
;

442 
	}
}

444 
	$gë_∑th_‰om_ªgi°îs
(
uöt_t
 
addr
, uöt_à
Àngth
, **
pP©h
) {

445 i‡(
Àngth
 > 1024) {

446  
ENAMETOOLONG
;

448 *
pP©h
 = 
	`MÆloc
(
Àngth
 + 1);

449 i‡(!*
pP©h
) {

450  
ENOMEM
;

452 i‡(!
	`C›y_From_U£r
(*
pP©h
, 
addr
, 
Àngth
)) {

453 
	`Fªe
(*
pP©h
);

454  
EINVALID
;

456 (*
pP©h
)[
Àngth
] = '\0';

458 
	}
}

460 
	$√xt_des¸ùt‹
() {

461 
des¸ùt‹
;

462 
des¸ùt‹
 = 0;

463 
des¸ùt‹
 < 
USER_MAX_FILES
 &&

464 
CURRENT_THREAD
->
u£rC⁄ãxt
->
fûe_des¸ùt‹_èbÀ
[
des¸ùt‹
] != 0;

465 
des¸ùt‹
++);

466 i‡(
des¸ùt‹
 =
USER_MAX_FILES
) {

467  
EMFILE
;

469  
des¸ùt‹
;

470 
	}
}

472 
	$add_fûe_to_des¸ùt‹_èbÀ
(
Fûe
 *
fûe
) {

473 
des¸ùt‹
 = 
	`√xt_des¸ùt‹
();

474 i‡(
des¸ùt‹
 >= 0) {

475 
CURRENT_THREAD
->
u£rC⁄ãxt
->
fûe_des¸ùt‹_èbÀ
[
des¸ùt‹
] = 
fûe
;

477  
des¸ùt‹
;

478 
	}
}

490 
	$Sys_O≥n
(
I¡îru±_Sèã
 *
°©e
) {

491 *
∑th
;

492 
Fûe
 *
fûe
;

493 
rc
 = 0;

495 
rc
 = 
	`gë_∑th_‰om_ªgi°îs
(
°©e
->
ebx
, sèã->
ecx
, &
∑th
);

496 i‡(
rc
 != 0) {

497  
rc
;

500 
rc
 = 
	`√xt_des¸ùt‹
();

501 i‡(
rc
 < 0) {

502  
rc
;

505 
	`E«bÀ_I¡îru±s
();

506 
rc
 = 
	`O≥n
(
∑th
, 
°©e
->
edx
, &
fûe
);

507 
	`DißbÀ_I¡îru±s
();

508 
	`Fªe
(
∑th
);

510 i‡(
rc
 >= 0) {

511  
	`add_fûe_to_des¸ùt‹_èbÀ
(
fûe
);

513  
rc
;

515 
	}
}

526 
	$Sys_O≥nDúe˘‹y
(
I¡îru±_Sèã
 *
°©e
) {

527 
	`TODO_P
(
PROJECT_FS
, "Open directory system call");

528  
EUNSUPPORTED
;

529 
	}
}

537 
	$Sys_Clo£
(
I¡îru±_Sèã
 *
°©e
) {

539 i‡(
°©e
->
ebx
 > 
USER_MAX_FILES
) {

540 
	`Pröt
("u«bÀÅÿ˛o£ fd index %d, ouào‡ønge.\n", 
°©e
->
ebx
);

541  
EINVALID
;

543 i‡(
CURRENT_THREAD
->
u£rC⁄ãxt
->
fûe_des¸ùt‹_èbÀ
[
°©e
->
ebx
]) {

544 
	`E«bÀ_I¡îru±s
();

545 
	`Clo£
(
CURRENT_THREAD
->
u£rC⁄ãxt
->
fûe_des¸ùt‹_èbÀ
[
°©e
->
ebx
]);

546 
	`DißbÀ_I¡îru±s
();

547 
CURRENT_THREAD
->
u£rC⁄ãxt
->
fûe_des¸ùt‹_èbÀ
[
°©e
->
ebx
] = 0;

550 
	`Pröt
("u«bÀÅÿ˛o£ fd index %d,ÇŸhögÅhîe.\n", 
°©e
->
ebx
);

551  
ENOTFOUND
;

553 
	}
}

564 
	$Sys_Dñëe
(
I¡îru±_Sèã
 *
°©e
) {

565 
	`TODO_P
(
PROJECT_FS
, "Delete system call");

566  
EUNSUPPORTED
;

567 
	}
}

579 
	$Sys_Ríame
(
I¡îru±_Sèã
 *
°©e
) {

580 
	`TODO_P
(
PROJECT_FS
, "Rename system call");

581  
EUNSUPPORTED
;

582 
	}
}

594 
	$Sys_Lök
(
I¡îru±_Sèã
 *
°©e
) {

595 
	`TODO_P
(
PROJECT_FS
, "Link system call");

596  
EUNSUPPORTED
;

597 
	}
}

609 
	$Sys_SymLök
(
I¡îru±_Sèã
 *
°©e
) {

610 
	`TODO_P
(
PROJECT_FS
, "Link system call");

611  
EUNSUPPORTED
;

612 
	}
}

624 
	$Sys_Ród
(
I¡îru±_Sèã
 *
°©e
) {

625 
byãs_ªad
 = 0;

627 i‡(
°©e
->
ebx
 > 
USER_MAX_FILES
) {

628  
EINVALID
;

630 i‡(
CURRENT_THREAD
->
u£rC⁄ãxt
->
fûe_des¸ùt‹_èbÀ
[
°©e
->
ebx
]) {

631 *
d©a_buf„r
 = 
	`MÆloc
(
°©e
->
edx
);

632 i‡(!
d©a_buf„r
) {

633  
ENOMEM
;

635 
	`E«bÀ_I¡îru±s
();

636 
byãs_ªad
 =

637 
	`Ród
(
CURRENT_THREAD
->
u£rC⁄ãxt
->

638 
fûe_des¸ùt‹_èbÀ
[
°©e
->
ebx
], 
d©a_buf„r
, sèã->
edx
);

639 
	`DißbÀ_I¡îru±s
();

640 i‡(!
	`C›y_To_U£r
(
°©e
->
ecx
, 
d©a_buf„r
, sèã->
edx
)) {

641 
	`Fªe
(
d©a_buf„r
);

642  
EINVALID
;

644 
	`Fªe
(
d©a_buf„r
);

645  
byãs_ªad
;

647  
ENOTFOUND
;

649 
	}
}

658 
	$Sys_RódE¡ry
(
I¡îru±_Sèã
 *
°©e
) {

659 
	`TODO_P
(
PROJECT_FS
, "ReadEntry system call");

660  
EUNSUPPORTED
;

661 
	}
}

673 
	$Sys_Wrôe
(
I¡îru±_Sèã
 *
°©e
) {

674 
byãs_wrôãn
 = 0;

676 i‡(
°©e
->
ebx
 > 
USER_MAX_FILES
) {

677  
EINVALID
;

679 i‡(
CURRENT_THREAD
->
u£rC⁄ãxt
->
fûe_des¸ùt‹_èbÀ
[
°©e
->
ebx
]) {

680 *
d©a_buf„r
 = 
	`MÆloc
(
°©e
->
edx
);

681 i‡(!
d©a_buf„r
) {

682  
ENOMEM
;

684 i‡(!
	`C›y_From_U£r
(
d©a_buf„r
, 
°©e
->
ecx
, sèã->
edx
)) {

685 
	`Fªe
(
d©a_buf„r
);

686  
EINVALID
;

688 
	`E«bÀ_I¡îru±s
();

689 
byãs_wrôãn
 =

690 
	`Wrôe
(
CURRENT_THREAD
->
u£rC⁄ãxt
->

691 
fûe_des¸ùt‹_èbÀ
[
°©e
->
ebx
], 
d©a_buf„r
, sèã->
edx
);

692 
	`Fªe
(
d©a_buf„r
);

693 
	`DißbÀ_I¡îru±s
();

694  
byãs_wrôãn
;

696  
ENOTFOUND
;

698 
	}
}

709 
	$Sys_Sèt
(
I¡îru±_Sèã
 *
°©e
) {

710 
	`TODO_P
(
PROJECT_FS
, "Stat system call");

711  
EUNSUPPORTED
;

712 
	}
}

722 
	$Sys_FSèt
(
I¡îru±_Sèã
 *
°©e
) {

723 
	`TODO_P
(
PROJECT_FS
, "FStat system call");

724  
EUNSUPPORTED
;

725 
	}
}

735 
	$Sys_Sìk
(
I¡îru±_Sèã
 *
°©e
) {

736 
	`TODO_P
(
PROJECT_FS
, "Seek system call");

737  
EUNSUPPORTED
;

738 
	}
}

748 
	$Sys_Cª©eDú
(
I¡îru±_Sèã
 *
°©e
) {

749 
	`TODO_P
(
PROJECT_FS
, "CreateDir system call");

750  
EUNSUPPORTED
;

751 
	}
}

758 
	$Sys_Sync
(
I¡îru±_Sèã
 *
°©e
) {

759 
	`TODO_P
(
PROJECT_FS
, "Sync system call");

760  
EUNSUPPORTED
;

761 
	}
}

773 
	$Sys_F‹m©
(
I¡îru±_Sèã
 *
°©e
) {

774 
rc
 = 0;

775 *
dev«me
 = 0, *
f°y≥
 = 0;

777 i‡((
rc
 =

778 
	`C›y_U£r_Såög
(
°©e
->
ebx
, sèã->
ecx
, 
BLOCKDEV_MAX_NAME_LEN
,

779 &
dev«me
)) != 0 ||

780 (
rc
 =

781 
	`C›y_U£r_Såög
(
°©e
->
edx
, sèã->
esi
, 
VFS_MAX_FS_NAME_LEN
,

782 &
f°y≥
)) != 0)

783 
d⁄e
;

785 
	`E«bÀ_I¡îru±s
();

786 
rc
 = 
	`F‹m©
(
dev«me
, 
f°y≥
);

787 
	`DißbÀ_I¡îru±s
();

789 
d⁄e
:

790 i‡(
dev«me
 != 0)

791 
	`Fªe
(
dev«me
);

792 i‡(
f°y≥
 != 0)

793 
	`Fªe
(
f°y≥
);

794  
rc
;

795 
	}
}

808 
	$Sys_RódBlock
(
I¡îru±_Sèã
 *
°©e
) {

809 
	`TODO_P
(
PROJECT_FS
, "ReadBlock system call");

810  
EUNSUPPORTED
;

811 
	}
}

824 
	$Sys_WrôeBlock
(
I¡îru±_Sèã
 *
°©e
) {

825 
	`TODO_P
(
PROJECT_FS
, "WriteBlock system call");

826  
EUNSUPPORTED
;

827 
	}
}

830 
	$Sys_GëUid
(
I¡îru±_Sèã
 *
°©e
) {

831 
	`TODO_P
(
PROJECT_USER
, "Sys_GetUid system call");

832  
EUNSUPPORTED
;

833 
	}
}

835 
	$Sys_SëSëUid
(
I¡îru±_Sèã
 *
°©e
) {

836 
	`TODO_P
(
PROJECT_USER
, "Sys_SetSetUid system call");

837  
EUNSUPPORTED
;

838 
	}
}

840 
	$Sys_SëEf„˘iveUid
(
I¡îru±_Sèã
 *
°©e
) {

841 
	`TODO_P
(
PROJECT_USER
, "Sys_SetEffectiveUid system call");

842  
EUNSUPPORTED
;

843 
	}
}

845 
	$Sys_SëA˛
(
I¡îru±_Sèã
 *
°©e
) {

846 
	`TODO_P
(
PROJECT_USER
, "Sys_SetAcl system call");

847  
EUNSUPPORTED
;

848 
	}
}

850 
SB16_Pœy_Fûe
(c⁄° *
fûíame
);

851 
	$Sys_PœySoundFûe
(
I¡îru±_Sèã
 *
°©e
) {

852 
	`TODO_P
(
PROJECT_SOUND
, "PlaySoundFile system call");

854 
	}
}

862 
	$Sys_Pùe
(
I¡îru±_Sèã
 *
°©e
) {

863 
	`TODO_P
(
PROJECT_PIPE
, "Pipe system call");

864  
EUNSUPPORTED
;

865 
	}
}

869 
	$Sys_F‹k
(
I¡îru±_Sèã
 *
°©e
) {

870 
	`TODO_P
(
PROJECT_FORK
, "Fork system call");

871  
EUNSUPPORTED
;

872 
	}
}

883 
	$Sys_Exe˛
(
I¡îru±_Sèã
 *
°©e
) {

884 
	`TODO_P
(
PROJECT_FORK
, "Execl system call");

885  
EUNSUPPORTED
;

886 
	}
}

894 
	$Sys_Dügno°ic
(
I¡îru±_Sèã
 *
°©e
) {

895 ()
°©e
;

896 
	`E«bÀ_I¡îru±s
();

897 
	`Dump_Blockdev_Sèts
();

898 
	`DißbÀ_I¡îru±s
();

900 
	}
}

911 
	$Sys_Disk_Pr›îtõs
(
I¡îru±_Sèã
 *
°©e
) {

912 *
∑th
;

913 
block_size
, 
blocks_≥r_disk
;

914 
rc
;

915 
	`C›y_U£r_Såög
(
°©e
->
ebx
, sèã->
ecx
, 100, &
∑th
);

916 
	`E«bÀ_I¡îru±s
();

917 
rc
 = 
	`Disk_Pr›îtõs
(
∑th
, &
block_size
, &
blocks_≥r_disk
);

918 i‡(
rc
 == 0) {

919 
	`C›y_To_U£r
(
°©e
->
edx
, &
block_size
, ());

920 
	`C›y_To_U£r
(
°©e
->
esi
, &
blocks_≥r_disk
, ());

922 
	`DißbÀ_I¡îru±s
();

924 
	}
}

933 
	$Sys_Limô
(
I¡îru±_Sèã
 *
°©e
) {

934 
	`TODO_P
(
PROJECT_LIMIT
, "Limit system call");

935  
EUNSUPPORTED
;

936 
	}
}

938 
	$Sys_Së_Afföôy
(
I¡îru±_Sèã
 *
°©e
) {

939  
EUNSUPPORTED
;

940 
	}
}

942 
	$Sys_Gë_Afföôy
(
I¡îru±_Sèã
 *
°©e
) {

943  
EUNSUPPORTED
;

944 
	}
}

954 
	$Sys_Cl⁄e
(
I¡îru±_Sèã
 *
°©e
) {

955 
	`TODO_P
(
PROJECT_CLONE
, "Clone system call");

956  
EUNSUPPORTED
;

957 
	}
}

959 
	$Sys_Mm≠
(
I¡îru±_Sèã
 *
°©e
) {

960 
	`TODO_P
(
PROJECT_MMAP
, "Mmap system call");

961  
EUNSUPPORTED
;

962 
	}
}

964 
	$Sys_Munm≠
(
I¡îru±_Sèã
 *
°©e
) {

965 
	`Munm≠_Im∂
(*);

967 
	`TODO_P
(
PROJECT_MMAP
, "Munmap system call");

968  
EUNSUPPORTED
;

969 
	}
}

971 
	$Sys_Aœrm
(
I¡îru±_Sèã
 *
°©e
) {

972 
	`TODO_P
(
PROJECT_SIGNALS
, "Alarm");

973  
EUNSUPPORTED
;

974 
	}
}

979 c⁄° 
SysˇŒ
 
	gg_sysˇŒTabÀ
[] = {

980 
Sys_NuŒ
,

981 
Sys_Exô
,

982 
Sys_PrötSåög
,

983 
Sys_GëKey
,

984 
Sys_SëAâr
,

985 
Sys_GëCurs‹
,

986 
Sys_PutCurs‹
,

987 
Sys_S∑wn
,

988 
Sys_Waô
,

989 
Sys_GëPID
,

990 
Sys_Kûl
,

991 
Sys_PS
,

992 
Sys_Sig«l
,

993 
Sys_RegDñivî
,

994 
Sys_Rëu∫Sig«l
,

995 
Sys_WaôNoPID
,

997 
Sys_SëSchedulögPﬁicy
,

998 
Sys_GëTimeOfDay
,

999 
Sys_O≥n_Sem≠h‹e
,

1000 
Sys_P
,

1001 
Sys_V
,

1002 
Sys_Clo£_Sem≠h‹e
,

1004 
Sys_Mou¡
,

1005 
Sys_O≥n
,

1006 
Sys_O≥nDúe˘‹y
,

1007 
Sys_Clo£
,

1008 
Sys_Dñëe
,

1009 
Sys_Ród
,

1010 
Sys_RódE¡ry
,

1011 
Sys_Wrôe
,

1012 
Sys_Sèt
,

1013 
Sys_FSèt
,

1014 
Sys_Sìk
,

1015 
Sys_Cª©eDú
,

1016 
Sys_Sync
,

1017 
Sys_F‹m©
,

1018 
Sys_ShutDown
,

1019 
Sys_RódBlock
,

1020 
Sys_WrôeBlock
,

1022 
Sys_EthPackëSíd
,

1023 
Sys_EthPackëRe˚ive
,

1024 
Sys_AΩ
,

1025 
Sys_RouãAdd
,

1026 
Sys_RouãDñ
,

1027 
Sys_RouãGë
,

1028 
Sys_IPC⁄figuª
,

1029 
Sys_IPGë
,

1030 
Sys_IPSíd
,

1032 
Sys_Sockë
,

1033 
Sys_Böd
,

1034 
Sys_Li°í
,

1035 
Sys_Ac˚±
,

1036 
Sys_C⁄√˘
,

1037 
Sys_Síd
,

1038 
Sys_Re˚ive
,

1039 
Sys_SídTo
,

1040 
Sys_Re˚iveFrom
,

1041 
Sys_Clo£Sockë
,

1043 
Sys_Limô
,

1044 
Sys_GëUid
,

1045 
Sys_SëSëUid
,

1046 
Sys_SëEf„˘iveUid
,

1047 
Sys_SëA˛
,

1049 
Sys_PœySoundFûe
,

1051 
Sys_Pùe
,

1052 
Sys_F‹k
,

1053 
Sys_Exe˛
,

1055 
Sys_Dügno°ic
,

1056 
Sys_Disk_Pr›îtõs
,

1058 
Sys_Së_Afföôy
,

1059 
Sys_Gë_Afföôy
,

1060 
Sys_Cl⁄e
,

1062 
Sys_Mm≠
,

1063 
Sys_Munm≠
,

1064 
Sys_Aœrm
,

1065 
Sys_Ríame
,

1066 
Sys_Lök
,

1067 
Sys_SymLök


1073 c⁄° 
	gg_numSysˇŒs
 = (
g_sysˇŒTabÀ
Ë/ (
SysˇŒ
);

	@timer.c

15 
	~<gìkos/kas£π.h
>

16 
	~<gìkos/¥oje˘s.h
>

17 
	~<limôs.h
>

18 
	~<gìkos/io.h
>

19 
	~<gìkos/öt.h
>

20 
	~<gìkos/úq.h
>

21 
	~<gìkos/kthªad.h
>

22 
	~<gìkos/timî.h
>

23 
	~<gìkos/smp.h
>

25 
	#MAX_TIMER_EVENTS
 100

	)

27 
	gtimîDebug
 = 0;

28 
	gtimeEvítCou¡
;

29 
	g√xtEvítID
;

30 
timîEvít
 
	g≥ndögTimîEvíts
[
MAX_TIMER_EVENTS
];

35 vﬁ©ûê
ul⁄g_t
 
	gg_numTicks
;

40 
	gs_•öCou¡PîTick
;

45 
	#CALIBRATE_NUM_TICKS
 3

	)

51 
	#DEFAULT_MAX_TICKS
 4

	)

56 
	gg_Qu™tum
 = 
DEFAULT_MAX_TICKS
;

59 #ifde‡
DEBUG_TIMER


60 
	#Debug
(
¨gs
...Ë
	`Pröt
◊rgs)

	)

62 
	#Debug
(
¨gs
...)

	)

69 
	$Timî_I¡îru±_H™dÀr
(
I¡îru±_Sèã
 *
°©e
) {

70 
i
;

71 
id
;

72 
Kî√l_Thªad
 *
cuºít
 = 
CURRENT_THREAD
;

74 
	`Begö_IRQ
(
°©e
);

76 
id
 = 
	`Gë_CPU_ID
();

78 i‡(!
id
) {

80 ++
g_numTicks
;

85 ++
cuºít
->
numTicks
;

86 ++
cuºít
->
tŸÆTime
;

87 
CPUs
[
id
].
ticks
++;

94 i‡(!
id
) {

97 
i
 = 0; i < 
timeEvítCou¡
; i++) {

98 i‡(
≥ndögTimîEvíts
[
i
].
ticks
 == 0) {

99 i‡(
timîDebug
)

100 
	`Pröt
("timer:Évent %dÉxpired (%dÅicks)\n",

101 
≥ndögTimîEvíts
[
i
].
id
,

102 
≥ndögTimîEvíts
[
i
].
‹igTicks
);

103 (
≥ndögTimîEvíts
[
i
].
ˇŒBack
Ë’ídögTimîEvíts[i].
id
);

105 
≥ndögTimîEvíts
[
i
].
ticks
--;

109 i‡(
cuºít
->
numTicks
 >
g_Qu™tum
) {

110 
g_√edRescheduÀ
[
id
] = 
åue
;

118 
	`End_IRQ
(
°©e
);

119 
	}
}

125 
	$Timî_CÆibøã
(
I¡îru±_Sèã
 *
°©e
) {

126 
	`Begö_IRQ
(
°©e
);

127 i‡(
g_numTicks
 < 
CALIBRATE_NUM_TICKS
)

128 ++
g_numTicks
;

135 
s_•öCou¡PîTick
 = 
INT_MAX
 - 
°©e
->
óx
;

136 
°©e
->
óx
 = 0;

138 
	`End_IRQ
(
°©e
);

139 
	}
}

144 
	$Spö
(
cou¡
) {

152 
ªsu…
;

153 
__asm__
 
	`__vﬁ©ûe__
("1: decl %%eax\n\t"

157 "jg 1b":"˜"(
ªsu…
)

158 :"a"(
cou¡
)

160 
	}
}

167 
	$CÆibøã_Dñay
() {

168 
	`DißbÀ_I¡îru±s
();

171 
	`In°Æl_IRQ
(
TIMER_IRQ
, &
Timî_CÆibøã
);

172 
	`E«bÀ_IRQ
(
TIMER_IRQ
);

174 
	`E«bÀ_I¡îru±s
();

177 
g_numTicks
 < 
CALIBRATE_NUM_TICKS
);

184 
	`Spö
(
INT_MAX
);

186 
	`DißbÀ_I¡îru±s
();

192 
	`DißbÀ_IRQ
(
TIMER_IRQ
);

193 
	`E«bÀ_I¡îru±s
();

194 
	}
}

200 
	$Inô_Timî_I¡îru±
() {

202 
	`E«bÀ_IRQ
(32);

203 
	}
}

205 
	$Inô_Timî
() {

212 
	`Pröt
("InitializingÅimer...\n");

227 
	`In°Æl_IRQ
(32, &
Timî_I¡îru±_H™dÀr
);

229 
	`Inô_Timî_I¡îru±
();

230 
	}
}

232 
	$Sèπ_Timî
(
ticks
, 
timîCÆlback
 
cb
) {

233 
ªtu∫ed_timî_id
;

235 
	`KASSERT
(!
	`I¡îru±s_E«bÀd
());

237 i‡(
timeEvítCou¡
 =
MAX_TIMER_EVENTS
) {

238 
Pröt


240 
MAX_TIMER_EVENTS
);

241 
i
;

242 
i
 = 0; i < 
MAX_TIMER_EVENTS
; i++) {

243 
	`Pröt
("%d: cb 0x%∞ö %d/%dÅicks", 
i
,

244 
≥ndögTimîEvíts
[
i
].
ˇŒBack
,

245 
≥ndögTimîEvíts
[
i
].
ticks
,

246 
≥ndögTimîEvíts
[
i
].
‹igTicks
);

250 
ªtu∫ed_timî_id
 = 
√xtEvítID
++;

251 
≥ndögTimîEvíts
[
timeEvítCou¡
].
id
 = 
ªtu∫ed_timî_id
;

252 
≥ndögTimîEvíts
[
timeEvítCou¡
].
ˇŒBack
 = 
cb
;

253 
≥ndögTimîEvíts
[
timeEvítCou¡
].
ticks
 =Åicks;

254 
≥ndögTimîEvíts
[
timeEvítCou¡
].
‹igTicks
 = 
ticks
;

255 
timeEvítCou¡
++;

257  
ªtu∫ed_timî_id
;

259 
	}
}

261 
	$Gë_Remaög_Timî_Ticks
(
id
) {

262 
i
;

264 
	`KASSERT
(!
	`I¡îru±s_E«bÀd
());

265 
i
 = 0; i < 
timeEvítCou¡
; i++) {

266 i‡(
≥ndögTimîEvíts
[
i
].
id
 == id) {

267  
≥ndögTimîEvíts
[
i
].
ticks
;

272 
	}
}

274 
	$C™˚l_Timî
(
id
) {

275 
i
;

276 
	`KASSERT
(!
	`I¡îru±s_E«bÀd
());

277 
i
 = 0; i < 
timeEvítCou¡
; i++) {

278 i‡(
≥ndögTimîEvíts
[
i
].
id
 == id) {

279 
≥ndögTimîEvíts
[
i
] =ÖídögTimîEvíts[
timeEvítCou¡
 - 1];

280 
timeEvítCou¡
--;

285 
	`Pröt
("timî: u«bÀÅÿfödÅimî id %dÅÿˇn˚»ô\n", 
id
);

287 
	}
}

289 
	#US_PER_TICK
 (
TICKS_PER_SEC
 * 1000000)

	)

296 
	$Mi¸o_Dñay
(
us
) {

297 
num
 = 
us
 * 
s_•öCou¡PîTick
;

298 
díom
 = 
US_PER_TICK
;

300 
numSpös
 = 
num
 / 
díom
;

301 
ªm
 = 
num
 % 
díom
;

303 i‡(
ªm
 > 0)

304 ++
numSpös
;

306 
	`Debug
("Mi¸o_Dñay():Çum=%d, díom=%d, spö cou¡ = %d\n", 
num
, 
díom
,

307 
numSpös
);

309 
	`Spö
(
numSpös
);

310 
	}
}

	@trap.c

18 
	~<gìkos/idt.h
>

19 
	~<gìkos/kthªad.h
>

20 
	~<gìkos/defs.h
>

21 
	~<gìkos/sysˇŒ.h
>

22 
	~<gìkos/å≠.h
>

23 
	~<gìkos/u£r.h
>

24 
	~<gìkos/¥oje˘s.h
>

35 
	$GPF_H™dÀr
(
I¡îru±_Sèã
 *
°©e
) {

37 
	`Pröt
("Exception %dÑeceived, killingÅhread %p (pid %d)\n",

38 
°©e
->
ötNum
, 
CURRENT_THREAD
, CURRENT_THREAD->
pid
);

39 
	`Dump_I¡îru±_Sèã
(
°©e
);

41 
	`Exô
(-1);

44 
	`KASSERT
(
Ál£
);

45 
	}
}

50 
	$SysˇŒ_H™dÀr
(
I¡îru±_Sèã
 *
°©e
) {

52 
uöt_t
 
sysˇŒNum
 = 
°©e
->
óx
;

54 
U£r_C⁄ãxt
 *
u£r
;

58 i‡(
sysˇŒNum
 >
g_numSysˇŒs
) {

59 
	`Pröt
("Illegal system call %d byÖrocess %d\n",

60 
sysˇŒNum
, 
CURRENT_THREAD
->
pid
);

61 
	`Exô
(-1);

64 
	`KASSERT
(
Ál£
);

71 
°©e
->
óx
 = 
g_sysˇŒTabÀ
[
sysˇŒNum
] (state);

72 
	}
}

77 
	$Inô_Tøps
() {

78 
	`In°Æl_I¡îru±_H™dÀr
(12, &
GPF_H™dÀr
);

79 
	`In°Æl_I¡îru±_H™dÀr
(13, &
GPF_H™dÀr
);

80 
	`In°Æl_I¡îru±_H™dÀr
(
SYSCALL_INT
, &
SysˇŒ_H™dÀr
);

81 
	}
}

	@tss.c

20 
	~<gìkos/kas£π.h
>

21 
	~<gìkos/defs.h
>

22 
	~<gìkos/gdt.h
>

23 
	~<gìkos/£gmít.h
>

24 
	~<gìkos/°rög.h
>

25 
	~<gìkos/tss.h
>

26 
	~<gìkos/smp.h
>

31 
TSS
 
	gs_theTSS
[
MAX_CPUS
];

32 
Segmít_Des¸ùt‹
 *
	gs_tssDesc
[
MAX_CPUS
];

33 
ush‹t_t
 
	gs_tssSñe˘‹
[
MAX_CPUS
];

35 
__ölöe__
 
	$Lﬂd_Task_Regi°î
() {

36 
˝u
 = 
	`Gë_CPU_ID
();

38 
	`KASSERT
(
s_tssDesc
[
˝u
]);

41 
s_tssDesc
[
˝u
]->
ty≥
 = 0x09;

44 
__asm__
 
	`__vﬁ©ûe__
("…∏%0"::"a"(
s_tssSñe˘‹
[
˝u
])

46 
	}
}

52 
	$Inô_TSS
() {

53 
˝u
 = 
	`Gë_CPU_ID
();

55 
s_tssDesc
[
˝u
] = 
	`AŒoˇã_Segmít_Des¸ùt‹
();

56 
	`KASSERT
(
s_tssDesc
[
˝u
] != 0);

58 
	`mem£t
(&
s_theTSS
[
˝u
], '\0', (
TSS
));

59 
	`Inô_TSS_Des¸ùt‹
(
s_tssDesc
[
˝u
], &
s_theTSS
[cpu]);

61 
s_tssSñe˘‹
[
˝u
] =

62 
	`Sñe˘‹
(0, 
åue
, 
	`Gë_Des¸ùt‹_Index
(
s_tssDesc
[
˝u
]));

64 
	`Lﬂd_Task_Regi°î
();

65 
	}
}

73 
	$Së_Kî√l_Sèck_Poöãr
(
ul⁄g_t
 
e•0
) {

74 
˝u
 = 
	`Gë_CPU_ID
();

76 
s_theTSS
[
˝u
].
ss0
 = 
KERNEL_DS
;

77 
s_theTSS
[
˝u
].
e•0
 =Ésp0;

85 
	`Lﬂd_Task_Regi°î
();

86 
	}
}

88 
	gsubmôTe°ög
;

95 
	$checkPagög
() {

96 
ªg
 = 0;

97 
__asm__
 
	`__vﬁ©ûe__
("mov»%%¸0, %0":"˜"(
ªg
));

98 
	`Pröt
("Pagög o¿? : %d\n", (
ªg
 & (1 << 31)) != 0);

99 
	}
}

	@user.c

18 
	~<gìkos/î∫o.h
>

19 
	~<gìkos/kty≥s.h
>

20 
	~<gìkos/kas£π.h
>

21 
	~<gìkos/öt.h
>

22 
	~<gìkos/mem.h
>

23 
	~<gìkos/mÆloc.h
>

24 
	~<gìkos/kthªad.h
>

25 
	~<gìkos/vfs.h
>

26 
	~<gìkos/tss.h
>

27 
	~<gìkos/u£r.h
>

28 
	~<gìkos/¥oje˘s.h
>

29 
	~<gìkos/smp.h
>

30 
	~<libc/°rög.h
>

37 
Spö_Lock_t
 
kthªadLock
;

43 
	$Aâach_U£r_C⁄ãxt
(
Kî√l_Thªad
 *
kthªad
,

44 
U£r_C⁄ãxt
 *
c⁄ãxt
) {

45 
	`KASSERT
(
c⁄ãxt
 != 0);

46 
kthªad
->
u£rC⁄ãxt
 = 
c⁄ãxt
;

48 
	`Spö_Lock
(&
kthªadLock
);

50 
	`KASSERT
(
c⁄ãxt
->
ªfCou¡
 >= 0);

52 ++
c⁄ãxt
->
ªfCou¡
;

54 
	`Spö_U∆ock
(&
kthªadLock
);

55 
	}
}

63 
	$Dëach_U£r_C⁄ãxt
(
Kî√l_Thªad
 *
kthªad
) {

64 
U£r_C⁄ãxt
 *
ﬁd
 = 
kthªad
->
u£rC⁄ãxt
;

66 
kthªad
->
u£rC⁄ãxt
 = 
NULL
;

68 i‡(
ﬁd
 != 0) {

69 
boﬁ
 
iÊag
;

70 
iÊag
 = 
	`Begö_I¡_Atomic
();

72 
ªfCou¡
;

74 --
ﬁd
->
ªfCou¡
;

75 i‡(
ﬁd
->
ªfCou¡
 == 0) {

76 
	`De°roy_U£r_C⁄ãxt
(
ﬁd
);

78 
	`End_I¡_Atomic
(
iÊag
);

80 
	}
}

97 
	$S∑wn
(c⁄° *
¥ogøm
, c⁄° *
comm™d
,

98 
Kî√l_Thªad
 **
pThªad
, 
boﬁ
 
background
) {

99 
rc
;

100 *
exeFûeD©a
 = 0;

101 
ul⁄g_t
 
exeFûeLígth
;

102 
U£r_C⁄ãxt
 *
u£rC⁄ãxt
 = 0;

103 
Kî√l_Thªad
 *
¥o˚ss
 = 0;

104 
Exe_F‹m©
 
exeF‹m©
;

110 i‡((
rc
 = 
	`Ród_FuŒy
(
¥ogøm
, (**)&
exeFûeD©a
, &
exeFûeLígth
)) != 0

111 || (
rc
 =

112 
	`P¨£_ELF_ExecuèbÀ
(
exeFûeD©a
, 
exeFûeLígth
, &
exeF‹m©
)) != 0

113 || (
rc
 =

114 
	`Lﬂd_U£r_Progøm
(
exeFûeD©a
, 
exeFûeLígth
, &
exeF‹m©
, 
comm™d
,

115 &
u£rC⁄ãxt
)) != 0)

116 
Áû
;

122 
	`Fªe
(
exeFûeD©a
);

123 
exeFûeD©a
 = 0;

125 
	`°∫˝y
(
u£rC⁄ãxt
->
«me
, 
¥ogøm
, 
MAX_PROC_NAME_SZB
);

126 
u£rC⁄ãxt
->
«me
[
MAX_PROC_NAME_SZB
 - 1] = '\0';

130 
¥o˚ss
 = 
	`Sèπ_U£r_Thªad
(
u£rC⁄ãxt
, 
background
);

131 i‡(
¥o˚ss
 != 0) {

133 *
pThªad
 = 
¥o˚ss
;

135 
rc
 = 
ENOMEM
;

137  
rc
;

139 
Áû
:

140 i‡(
exeFûeD©a
 != 0)

141 
	`Fªe
(
exeFûeD©a
);

142 i‡(
u£rC⁄ãxt
 != 0)

143 
	`De°roy_U£r_C⁄ãxt
(
u£rC⁄ãxt
);

145  
rc
;

146 
	}
}

151 
	$S∑wn_F‹eground
(c⁄° *
¥ogøm
, c⁄° *
comm™d
,

152 
Kî√l_Thªad
 **
pThªad
) {

153  
	`S∑wn
(
¥ogøm
, 
comm™d
, 
pThªad
, 
Ál£
);

154 
	}
}

166 
Swôch_To_U£r_C⁄ãxt
(
Kî√l_Thªad
 *
kthªad
,

167 
I¡îru±_Sèã
 *
°©e


168 
__©åibuã__
 ((
unu£d
))) {

169 
	g˝uID
;

170 
u£rDebug
;

171 
U£r_C⁄ãxt
 *
	gu£rC⁄ãxt
 = 
kthªad
->
u£rC⁄ãxt
;

178 
	g˝uID
 = 
Gë_CPU_ID
();

180 
KASSERT
(!
I¡îru±s_E«bÀd
());

182 i‡(
	gCPUs
[
˝uID
].
	gs_cuºítU£rC⁄ãxt
 && 
	gu£rC⁄ãxt
 == 0) {

186 
Së_PDBR
((*)
Kî√l_Page_Dú
());

187 
	gCPUs
[
˝uID
].
	gs_cuºítU£rC⁄ãxt
 = 
NULL
;

192 i‡(
	gu£rC⁄ãxt
 !
CPUs
[
˝uID
].
s_cuºítU£rC⁄ãxt
) {

194 i‡(
u£rDebug
)

195 
Pröt
("A[%p]\n", 
kthªad
);

198 
Swôch_To_Addªss_S∑˚
(
u£rC⁄ãxt
);

201 
	gCPUs
[
˝uID
].
	gs_cuºítU£rC⁄ãxt
 = 
u£rC⁄ãxt
;

211 
ul⁄g_t
 
	ge•0
;

213 
	ge•0
 = ((
ul⁄g_t
Ë
kthªad
->
°ackPage
Ë+ 
PAGE_SIZE
;

214 i‡(
	gu£rDebug
)

215 
Pröt
("S[%lx]\n", 
e•0
);

218 
Së_Kî√l_Sèck_Poöãr
(
e•0
);

	@userseg.c

15 
	~<gìkos/kty≥s.h
>

16 
	~<gìkos/kas£π.h
>

17 
	~<gìkos/defs.h
>

18 
	~<gìkos/mem.h
>

19 
	~<gìkos/°rög.h
>

20 
	~<gìkos/mÆloc.h
>

21 
	~<gìkos/öt.h
>

22 
	~<gìkos/gdt.h
>

23 
	~<gìkos/£gmít.h
>

24 
	~<gìkos/tss.h
>

25 
	~<gìkos/kthªad.h
>

26 
	~<gìkos/¨gblock.h
>

27 
	~<gìkos/u£r.h
>

33 
	#DEFAULT_USER_STACK_SIZE
 8192

	)

36 
	gu£rDebug
 = 0;

42 *
	$U£r_To_Kî√l
(
U£r_C⁄ãxt
 *
u£rC⁄ãxt
, 
ul⁄g_t
 
u£rPå
) {

43 
uch¨_t
 *
u£rBa£
 = (uch¨_à*Ë
u£rC⁄ãxt
->
mem‹y
;

45  (*)(
u£rBa£
 + 
u£rPå
);

46 
	}
}

51 
U£r_C⁄ãxt
 *
	$Cª©e_U£r_C⁄ãxt
(
ul⁄g_t
 
size
) {

52 
U£r_C⁄ãxt
 *
c⁄ãxt
;

53 
ödex
;

56 
size
 = 
	`Round_Up_To_Page
(size);

57 i‡(
u£rDebug
)

58 
	`Pröt
("Sizêo‡u£∏mem‹y =%lu (%lxË(%luÖages)\n", 
size
, size,

59 
size
 / 
PAGE_SIZE
);

62 
	`DißbÀ_I¡îru±s
();

63 
c⁄ãxt
 = (
U£r_C⁄ãxt
 *)
	`MÆloc
((*context));

64 i‡(
c⁄ãxt
 != 0) {

65 
	`mem£t
(
c⁄ãxt
, 0, (
U£r_C⁄ãxt
));

66 
c⁄ãxt
->
mem‹y
 = 
	`MÆloc
(
size
);

68 
	`E«bÀ_I¡îru±s
();

70 i‡(
c⁄ãxt
 =0 || c⁄ãxt->
mem‹y
 == 0)

71 
Áû
;

77 
	`mem£t
(
c⁄ãxt
->
mem‹y
, '\0', 
size
);

79 
c⁄ãxt
->
size
 = size;

82 
c⁄ãxt
->
ldtDes¸ùt‹
 = 
	`AŒoˇã_Segmít_Des¸ùt‹
();

83 i‡(
c⁄ãxt
->
ldtDes¸ùt‹
 == 0)

84 
Áû
;

85 i‡(
u£rDebug
)

86 
	`Pröt
("Allocated descriptor %d for LDT\n",

87 
	`Gë_Des¸ùt‹_Index
(
c⁄ãxt
->
ldtDes¸ùt‹
));

88 
	`Inô_LDT_Des¸ùt‹
(
c⁄ãxt
->
ldtDes¸ùt‹
, c⁄ãxt->
ldt
,

89 
NUM_USER_LDT_ENTRIES
);

90 
ödex
 = 
	`Gë_Des¸ùt‹_Index
(
c⁄ãxt
->
ldtDes¸ùt‹
);

91 
c⁄ãxt
->
ldtSñe˘‹
 = 
	`Sñe˘‹
(
KERNEL_PRIVILEGE
, 
åue
, 
ödex
);

94 
	`Inô_Code_Segmít_Des¸ùt‹
(&
c⁄ãxt
->
ldt
[0],

95 (
ul⁄g_t
Ë
c⁄ãxt
->
mem‹y
,

96 
size
 / 
PAGE_SIZE
, 
USER_PRIVILEGE
);

97 
	`Inô_D©a_Segmít_Des¸ùt‹
(&
c⁄ãxt
->
ldt
[1],

98 (
ul⁄g_t
Ë
c⁄ãxt
->
mem‹y
,

99 
size
 / 
PAGE_SIZE
, 
USER_PRIVILEGE
);

100 
c⁄ãxt
->
csSñe˘‹
 = 
	`Sñe˘‹
(
USER_PRIVILEGE
, 
Ál£
, 0);

101 
c⁄ãxt
->
dsSñe˘‹
 = 
	`Sñe˘‹
(
USER_PRIVILEGE
, 
Ál£
, 1);

104 
c⁄ãxt
->
ªfCou¡
 = 0;

108  
c⁄ãxt
;

110 
Áû
:

112 
	`DißbÀ_I¡îru±s
();

113 i‡(
c⁄ãxt
 != 0) {

114 i‡(
c⁄ãxt
->
mem‹y
 != 0)

115 
	`Fªe
(
c⁄ãxt
->
mem‹y
);

116 
	`Fªe
(
c⁄ãxt
);

118 
	`E«bÀ_I¡îru±s
();

121 
	}
}

123 
boﬁ
 
	$VÆid©e_U£r_Mem‹y
(
U£r_C⁄ãxt
 * 
u£rC⁄ãxt
,

124 
ul⁄g_t
 
u£rAddr
, ul⁄g_à
bufSize
) {

125 
ul⁄g_t
 
avaû
;

127 i‡(
u£rAddr
 >
u£rC⁄ãxt
->
size
)

128  
Ál£
;

130 
avaû
 = 
u£rC⁄ãxt
->
size
 - 
u£rAddr
;

131 i‡(
bufSize
 > 
avaû
)

132  
Ál£
;

134  
åue
;

135 
	}
}

145 
	$De°roy_U£r_C⁄ãxt
(
U£r_C⁄ãxt
 *
u£rC⁄ãxt
) {

146 
	`KASSERT
(
u£rC⁄ãxt
->
ªfCou¡
 == 0);

149 
	`Fªe_Segmít_Des¸ùt‹
(
u£rC⁄ãxt
->
ldtDes¸ùt‹
);

152 
boﬁ
 
iÊag
;

153 
iÊag
 = 
	`Begö_I¡_Atomic
();

154 
	`Fªe
(
u£rC⁄ãxt
->
mem‹y
);

155 
	`Fªe
(
u£rC⁄ãxt
);

156 
	`End_I¡_Atomic
(
iÊag
);

157 
	}
}

177 
Lﬂd_U£r_Progøm
(*
exeFûeD©a
, 
ul⁄g_t
 
exeFûeLígth


178 
__©åibuã__
 ((
unu£d
)), 
Exe_F‹m©
 *
exeF‹m©
,

179 c⁄° *
comm™d
,

180 
U£r_C⁄ãxt
 **
pU£rC⁄ãxt
) {

181 
	gi
;

182 
ul⁄g_t
 
	gmaxva
 = 0;

183 
	gnumArgs
;

184 
ul⁄g_t
 
	g¨gBlockSize
;

185 
ul⁄g_t
 
	gsize
, 
	g¨gBlockAddr
;

186 
U£r_C⁄ãxt
 *
	gu£rC⁄ãxt
 = 0;

189 
	gi
 = 0; i < 
	gexeF‹m©
->
	gnumSegmíts
; ++i) {

190 
Exe_Segmít
 *
	g£gmít
 = &
exeF‹m©
->
£gmítLi°
[
i
];

191 
ul⁄g_t
 
	gt›va
 = 
£gmít
->
°¨tAddªss
 + segmít->
sizeInMem‹y
;

193 i‡(
	gt›va
 > 
	gmaxva
)

194 
	gmaxva
 = 
t›va
;

198 
Gë_Argumít_Block_Size
(
comm™d
, &
numArgs
, &
¨gBlockSize
);

204 
	gsize
 = 
Round_Up_To_Page
(
maxva
Ë+ 
DEFAULT_USER_STACK_SIZE
;

205 
	g¨gBlockAddr
 = 
size
;

206 
	gsize
 +
¨gBlockSize
;

209 
	gu£rC⁄ãxt
 = 
Cª©e_U£r_C⁄ãxt
(
size
);

210 i‡(
	gu£rC⁄ãxt
 == 0)

214 
	gi
 = 0; i < 
	gexeF‹m©
->
	gnumSegmíts
; ++i) {

215 
Exe_Segmít
 *
	g£gmít
 = &
exeF‹m©
->
£gmítLi°
[
i
];

217 
mem˝y
(
u£rC⁄ãxt
->
mem‹y
 + 
£gmít
->
°¨tAddªss
,

218 
exeFûeD©a
 + 
£gmít
->
off£tInFûe
, segmít->
ÀngthInFûe
);

222 
F‹m©_Argumít_Block
(
u£rC⁄ãxt
->
mem‹y
 + 
¨gBlockAddr
, 
numArgs
,

223 
¨gBlockAddr
, 
comm™d
);

226 
	gu£rC⁄ãxt
->
	gíåyAddr
 = 
exeF‹m©
->
íåyAddr
;

232 
	gu£rC⁄ãxt
->
	g¨gBlockAddr
 = 
¨gBlockAddr
;

233 
	gu£rC⁄ãxt
->
	g°ackPoöãrAddr
 = 
¨gBlockAddr
;

236 *
	gpU£rC⁄ãxt
 = 
u£rC⁄ãxt
;

252 
boﬁ
 
	$C›y_From_U£r
(*
de°InKî√l
, 
ul⁄g_t
 
§cInU£r
, ul⁄g_à
bufSize
) {

253 
U£r_C⁄ãxt
 *
cuºít
 = 
CURRENT_THREAD
->
u£rC⁄ãxt
;

255 i‡(!
	`VÆid©e_U£r_Mem‹y
(
cuºít
, 
§cInU£r
, 
bufSize
))

256  
Ál£
;

257 
	`mem˝y
(
de°InKî√l
, 
	`U£r_To_Kî√l
(
cuºít
, 
§cInU£r
), 
bufSize
);

259  
åue
;

260 
	}
}

274 
boﬁ
 
	$C›y_To_U£r
(
ul⁄g_t
 
de°InU£r
, *
§cInKî√l
, ul⁄g_à
bufSize
) {

275 
U£r_C⁄ãxt
 *
cuºít
 = 
CURRENT_THREAD
->
u£rC⁄ãxt
;

277 i‡(!
	`VÆid©e_U£r_Mem‹y
(
cuºít
, 
de°InU£r
, 
bufSize
))

278  
Ál£
;

279 
	`mem˝y
(
	`U£r_To_Kî√l
(
cuºít
, 
de°InU£r
), 
§cInKî√l
, 
bufSize
);

281  
åue
;

282 
	}
}

290 
	$Swôch_To_Addªss_S∑˚
(
U£r_C⁄ãxt
 *
u£rC⁄ãxt
) {

291 
ush‹t_t
 
ldtSñe˘‹
;

296 
	`KASSERT
(
u£rC⁄ãxt
->
mem‹y
 || u£rC⁄ãxt->
∑geDú
);

299 
ldtSñe˘‹
 = 
u£rC⁄ãxt
->ldtSelector;

300 
__asm__
 
	`__vﬁ©ûe__
("Œdà%0"::"a"(
ldtSñe˘‹
)

302 
	}
}

	@uservm.c

17 
	~<gìkos/öt.h
>

18 
	~<gìkos/mem.h
>

19 
	~<gìkos/∑gög.h
>

20 
	~<gìkos/mÆloc.h
>

21 
	~<gìkos/°rög.h
>

22 
	~<gìkos/¨gblock.h
>

23 
	~<gìkos/kthªad.h
>

24 
	~<gìkos/ønge.h
>

25 
	~<gìkos/vfs.h
>

26 
	~<gìkos/u£r.h
>

27 
	~<gìkos/¥oje˘s.h
>

30 
Spö_Lock_t
 
kthªadLock
;

32 
	gu£rDebug
 = 0;

33 
	#Debug
(
¨gs
...Ëi‡(
u£rDebug
Ë
	`Pröt
("u£rvm: "árgs)

	)

50 
	$De°roy_U£r_C⁄ãxt
(
U£r_C⁄ãxt
 *
c⁄ãxt
) {

59 
	`TODO_P
(
PROJECT_VIRTUAL_MEMORY_A
,

61 
	}
}

81 
	$Lﬂd_U£r_Progøm
(*
exeFûeD©a
, 
ul⁄g_t
 
exeFûeLígth
,

82 
Exe_F‹m©
 *
exeF‹m©
, c⁄° *
comm™d
,

83 
U£r_C⁄ãxt
 **
pU£rC⁄ãxt
) {

94 
	`TODO_P
(
PROJECT_VIRTUAL_MEMORY_A
, "Load userÖrogram intoáddress space");

96 
	}
}

102 
boﬁ
 
	$C›y_From_U£r
(*
de°InKî√l
, 
ul⁄g_t
 
§cInU£r
, ul⁄g_à
numByãs
) {

121 
	`TODO_P
(
PROJECT_VIRTUAL_MEMORY_A
, "Copy user dataÅo kernel buffer");

122 
	}
}

128 
boﬁ
 
	$C›y_To_U£r
(
ul⁄g_t
 
de°InU£r
, *
§cInKî√l
, ul⁄g_à
numByãs
) {

135 
	`TODO_P
(
PROJECT_VIRTUAL_MEMORY_A
, "Copy kernel dataÅo user buffer");

136 
	}
}

142 
boﬁ
 
	$C›y_U£r_To_U£r
(*
de°InU£r
, 
ul⁄g_t
 
§cInU£r
, ul⁄g_à
numByãs
) {

161 
	`TODO_P
(
PROJECT_VIRTUAL_MEMORY_A
, "Copy user dataÅo kernel buffer");

162 
	}
}

167 
	$Swôch_To_Addªss_S∑˚
(
U£r_C⁄ãxt
 *
u£rC⁄ãxt
) {

173 
	`TODO_P
(
PROJECT_VIRTUAL_MEMORY_A
,

175 
	}
}

	@util.asm

1 ; 
This
 
code
 
is
 
ad≠ãd
 
‰om
 
Kî√l
 
	gToﬁkô
 0.2

2 ; 
™d
 
Löux
 
	gvîsi⁄
 2.2.x, 
so
 
the
 
fﬁlowög
 
c›yrights
 
	g≠∂y
:

4 ; 
C›yright
 (
C
Ë1991, 1992 
Löus
 
	gT‹vÆds


5 ; 
modifõd
 
by
 
Dªw
 
	gEckh¨dt


6 ; 
modifõd
 
by
 
Bru˚
 
Ev™s
 (
bde
)

7 ; 
ad≠ãd
 
Kî√l
 
Toﬁkô
 
by
 
Luigi
 
	gSgro


9 %
i‚def
 
	gUTIL_ASM


10 %
deföe
 
	gUTIL_ASM


12 ; 
The
 
fﬁlowög
 
wîe
 
c›õd
 
‰om
 
	gktk
-0.2 
	gboŸ£˘
.
	gasm
, 
™d
 wîê
	g¥esumably


13 ; 
‰om
 
the
 
Löux
 
boŸ£˘
 
	gcode
. 
I
 
ch™ged
 
them
 
a
 
lôée
 
so
 
	gthey


14 ; 
	gd⁄
'à˛obbîÅhêˇŒî'
s
 
	gªgi°îs
.

16 ; 
Pröt
 
the
 
w‹d
 
c⁄èöed
 
ö
Åhê
dx
 
to
Åhê
	gs¸ìn
.

17 
	gPrötHex
:

18 
pusha


19 
mov
 
cx
, 4 ; 4 
hex
 
	gdigôs


20 .
	gPrötDigô
:

21 
rﬁ
 
dx
, 4 ; 
rŸ©e
 
so
 
th©
 
	glowe°
 4 
bôs
 
¨e
 
u£d


22 
mov
 
	gax
, 0E0F
	gh
 ; 
	gah
 = 
ªque°
, 
	gÆ
 = 
mask
 
nybbÀ


23 
™d
 
Æ
, 
dl


24 
add
 
	gÆ
, 90
	gh
 ; 
c⁄vît
 
Æ
 
to
 
ascii
 
	$hex
 (
four
 
ö°ru˘i⁄s
)

25 
dØ
 ; 
I
've spent 1 hourÅo understand how it works..

26 
adc
 
Æ
, 40
h


27 
dØ


28 10
h


29 
lo›
 .
PrötDigô


30 
p›a


31 
ªt


33 ; 
Pröt
 
a
 
√wlöe
.

34 
PrötNL
: ; 
¥öt
 
CR
 
™d
 
NL


35 
push
 
ax


36 
mov
 
ax
, 0E0D
h
 ; 
CR


37 10
h


38 
mov
 
Æ
, 0A
h
 ; 
LF


39 10
h


40 
p›
 
ax


41 
ªt


43 %
ídif


	@vfs.c

18 
	~<gìkos/î∫o.h
>

19 
	~<gìkos/li°.h
>

20 
	~<gìkos/°rög.h
>

21 
	~<gìkos/s¸ìn.h
>

22 
	~<gìkos/mÆloc.h
>

23 
	~<gìkos/synch.h
>

24 
	~<gìkos/vfs.h
>

25 
	~<gìkos/¥oje˘s.h
>

42 
Muãx
 
	gs_vfsLock
;

44 
	gdebugVFS
 = 0;

45 
	#Debug
(
¨gs
...Ëi‡(
debugVFS
Ë
	`Pröt
("VFS: "árgs)

	)

47 
	gFûesy°em
;

49 
DEFINE_LIST
(
Mou¡_Poöt_Li°
, 
Mou¡_Poöt
);

50 
IMPLEMENT_LIST
(
Mou¡_Poöt_Li°
, 
Mou¡_Poöt
);

53 
Mou¡_Poöt_Li°
 
	gs_mou¡PoötLi°
;

56 
	sFûesy°em
 {

57 
Fûesy°em_Ops
 *
	m›s
;

58 
	mfsName
[
VFS_MAX_FS_NAME_LEN
 + 1];

59 
DEFINE_LINK
(
Fûesy°em_Li°
, 
Fûesy°em
);

62 
DEFINE_LIST
(
Fûesy°em_Li°
, 
Fûesy°em
);

63 
IMPLEMENT_LIST
(
Fûesy°em_Li°
, 
Fûesy°em
);

66 
Fûesy°em_Li°
 
	gs_fûesy°emLi°
;

69 
Pagög_Devi˚
 *
	gs_∑gögDevi˚
;

71 
	#MAX_PREFIX_LEN
 16

	)

84 
boﬁ
 
	$U≈ack_P©h
(c⁄° *
∑th
, *
¥efix
, c⁄° **
pSuffix
) {

85 *
¶ash
;

86 
size_t
 
pfxLí
;

88 
	`Debug
("∑th=%s\n", 
∑th
);

91 i‡(*
∑th
 != '/')

92  
Ál£
;

93 ++
∑th
;

96 
¶ash
 = 
	`°rchr
(
∑th
, '/');

97 i‡(
¶ash
 == 0) {

103 
pfxLí
 = 
	`°æí
(
∑th
);

104 i‡(
pfxLí
 =0 ||ÖfxLí > 
MAX_PREFIX_LEN
)

105  
Ál£
;

106 
	`°r˝y
(
¥efix
, 
∑th
);

107 *
pSuffix
 = "/";

113 
pfxLí
 = 
¶ash
 - 
∑th
;

114 i‡(
pfxLí
 =0 ||ÖfxLí > 
MAX_PREFIX_LEN
)

115  
Ál£
;

118 
	`mem˝y
(
¥efix
, 
∑th
, 
pfxLí
);

119 
¥efix
[
pfxLí
] = '\0';

125 *
pSuffix
 = 
¶ash
;

128 
	`Debug
("¥efix=%s, suffix=%s\n", 
¥efix
, *
pSuffix
);

129 
	`KASSERT
(**
pSuffix
 == '/');

131  
åue
;

132 
	}
}

141 
Fûesy°em
 *
	$Lookup_Fûesy°em
(c⁄° *
f°y≥
) {

142 
Fûesy°em
 *
fs
;

144 
	`Muãx_Lock
(&
s_vfsLock
);

145 
fs
 = 
	`Gë_Fr⁄t_Of_Fûesy°em_Li°
(&
s_fûesy°emLi°
);

146 
fs
 != 0) {

147 i‡(
	`°rcmp
(
fs
->
fsName
, 
f°y≥
) == 0)

149 
fs
 = 
	`Gë_Next_In_Fûesy°em_Li°
(fs);

151 
	`Muãx_U∆ock
(&
s_vfsLock
);

153  
fs
;

154 
	}
}

162 
Mou¡_Poöt
 *
	$Lookup_Mou¡_Poöt
(c⁄° *
¥efix
) {

163 
Mou¡_Poöt
 *
mou¡Poöt
;

165 
	`Muãx_Lock
(&
s_vfsLock
);

168 
mou¡Poöt
 = 
	`Gë_Fr⁄t_Of_Mou¡_Poöt_Li°
(&
s_mou¡PoötLi°
);

169 
mou¡Poöt
 != 0) {

170 
	`Debug
("Looku∞mou¡Öoöt: %s,%s\n", 
¥efix
, 
mou¡Poöt
->
∑thPªfix
);

171 i‡(
	`°rcmp
(
¥efix
, 
mou¡Poöt
->
∑thPªfix
) == 0)

173 
mou¡Poöt
 = 
	`Gë_Next_In_Mou¡_Poöt_Li°
(mountPoint);

176 
	`Muãx_U∆ock
(&
s_vfsLock
);

178  
mou¡Poöt
;

179 
	}
}

184 
Do_O≥n
(c⁄° *
∑th
, 
mode
, 
Fûe
 **
pFûe
,

185 (*
›íFunc
Ë(
Mou¡_Poöt
 * 
mou¡Poöt
,

186 c⁄° *
∑th
, 
mode
,

187 
Fûe
 ** 
pFûe
)) {

188 
¥efix
[
MAX_PREFIX_LEN
 + 1];

189 c⁄° *
suffix
;

190 
Mou¡_Poöt
 *
mou¡Poöt
;

191 
rc
;

193 i‡(!
	`U≈ack_P©h
(
∑th
, 
¥efix
, &
suffix
))

194  
ENOTFOUND
;

197 
mou¡Poöt
 = 
	`Lookup_Mou¡_Poöt
(
¥efix
);

198 i‡(
mou¡Poöt
 == 0)

199  
ENOTFOUND
;

202 
rc
 = 
	`›íFunc
(
mou¡Poöt
, 
suffix
, 
mode
, 
pFûe
);

203 i‡(
rc
 == 0) {

205 (*
pFûe
)->
mode
 = mode;

206 (*
pFûe
)->
mou¡Poöt
 = mountPoint;

208  
rc
;

209 
	}
}

214 
	$Do_O≥n_Fûe
(
Mou¡_Poöt
 *
mou¡Poöt
, c⁄° *
∑th
,

215 
mode
, 
Fûe
 **
pFûe
) {

216 
	`KASSERT
(
mou¡Poöt
->
›s
->
O≥n
 != 0);

217  
mou¡Poöt
->
›s
->
	`O≥n
(mou¡Poöt, 
∑th
, 
mode
, 
pFûe
);

218 
	}
}

223 
Do_O≥n_Dúe˘‹y
(
Mou¡_Poöt
 *
mou¡Poöt
, c⁄° *
∑th
,

224 
mode


225 
__©åibuã__
 ((
unu£d
)), 
Fûe
 **
pDú
) {

226 
KASSERT
(
mou¡Poöt
->
›s
->
O≥n_Dúe˘‹y
 != 0);

227  
	gmou¡Poöt
->
	g›s
->
O≥n_Dúe˘‹y
(
mou¡Poöt
, 
∑th
, 
pDú
);

243 
boﬁ
 
	$Regi°î_Fûesy°em
(c⁄° *
fsName
, 
Fûesy°em_Ops
 * 
fsOps
) {

244 
Fûesy°em
 *
fs
;

246 
	`KASSERT
(
fsName
 != 0);

247 
	`KASSERT
(
fsOps
 != 0);

248 
	`KASSERT
(
fsOps
->
Mou¡
 != 0);

250 
	`Debug
("Regi°îög %†fûesy°emÅy≥\n", 
fsName
);

253 
fs
 = (
Fûesy°em
 *)
	`MÆloc
((*fs));

254 i‡(
fs
 == 0)

255  
Ál£
;

258 
fs
->
›s
 = 
fsOps
;

259 
	`°∫˝y
(
fs
->
fsName
, fsName, 
VFS_MAX_FS_NAME_LEN
);

260 
fs
->
fsName
[
VFS_MAX_FS_NAME_LEN
] = '\0';

263 
	`Muãx_Lock
(&
s_vfsLock
);

264 
	`Add_To_Back_Of_Fûesy°em_Li°
(&
s_fûesy°emLi°
, 
fs
);

265 
	`Muãx_U∆ock
(&
s_vfsLock
);

267  
åue
;

268 
	}
}

277 
	$F‹m©
(c⁄° *
dev«me
, c⁄° *
f°y≥
) {

278 
Fûesy°em
 *
fs
;

279 
Block_Devi˚
 *
dev
 = 0;

280 
rc
;

283 
fs
 = 
	`Lookup_Fûesy°em
(
f°y≥
);

284 i‡(
fs
 == 0)

285  
ENOFILESYS
;

286 
	`Debug
("Found %†fûesy°emÅy≥\n", 
f°y≥
);

289 i‡(
fs
->
›s
->
F‹m©
 == 0)

290  
EUNSUPPORTED
;

293 i‡((
rc
 = 
	`O≥n_Block_Devi˚
(
dev«me
, &
dev
)) < 0)

294  
rc
;

295 
	`Debug
("O≥√d devi˚ %s\n", 
dev
->
«me
);

298 
rc
 = 
fs
->
›s
->
	`F‹m©
(
dev
);

300 
	`Clo£_Block_Devi˚
(
dev
);

302  
rc
;

303 
	}
}

313 
	$Mou¡
(c⁄° *
dev«me
, c⁄° *
∑thPªfix
, c⁄° *
f°y≥
) {

314 
Fûesy°em
 *
fs
;

315 
Block_Devi˚
 *
dev
 = 0;

316 
Mou¡_Poöt
 *
mou¡Poöt
 = 0;

317 
rc
;

320 *
∑thPªfix
 == '/')

321 ++
∑thPªfix
;

323 i‡(
	`°æí
(
∑thPªfix
Ë> 
MAX_PREFIX_LEN
)

324  
ENAMETOOLONG
;

327 
fs
 = 
	`Lookup_Fûesy°em
(
f°y≥
);

328 i‡(
fs
 == 0)

329  
ENOFILESYS
;

330 
	`KASSERT
(
fs
->
›s
->
Mou¡
 != 0);

333 i‡((
rc
 = 
	`O≥n_Block_Devi˚
(
dev«me
, &
dev
)) < 0) {

334 
	`Pröt
("O≥n_Block_Devi˚: U«bÀÅÿ›í %s\n", 
dev«me
);

335  
rc
;

339 
mou¡Poöt
 = (
Mou¡_Poöt
 *)
	`MÆloc
((*mountPoint));

340 i‡(
mou¡Poöt
 == 0)

341 
memÁû
;

342 
	`mem£t
(
mou¡Poöt
, '\0', (*mountPoint));

343 
mou¡Poöt
->
dev
 = dev;

344 
mou¡Poöt
->
∑thPªfix
 = 
	`°rdup
(pathPrefix);

345 i‡(
mou¡Poöt
->
∑thPªfix
 == 0)

346 
memÁû
;

348 
	`Debug
("Mou¡ög %†⁄ %†usög %†fs\n", 
dev«me
, 
∑thPªfix
, 
f°y≥
);

351 i‡((
rc
 = 
fs
->
›s
->
	`Mou¡
(
mou¡Poöt
)) < 0)

352 
Áû
;

354 
	`Debug
("Mount succeeded!\n");

362 
	`Muãx_Lock
(&
s_vfsLock
);

363 
	`Add_To_Back_Of_Mou¡_Poöt_Li°
(&
s_mou¡PoötLi°
, 
mou¡Poöt
);

364 
	`Muãx_U∆ock
(&
s_vfsLock
);

368 
memÁû
:

369 
rc
 = 
ENOMEM
;

370 
Áû
:

371 i‡(
mou¡Poöt
 != 0) {

372 i‡(
mou¡Poöt
->
∑thPªfix
 != 0)

373 
	`Fªe
(
mou¡Poöt
->
∑thPªfix
);

374 
	`Fªe
(
mou¡Poöt
);

376 i‡(
dev
 != 0)

377 
	`Clo£_Block_Devi˚
(
dev
);

378  
rc
;

379 
	}
}

389 
	$O≥n
(c⁄° *
∑th
, 
mode
, 
Fûe
 **
pFûe
) {

390 
rc
 = 
	`Do_O≥n
(
∑th
, 
mode
, 
pFûe
, &
Do_O≥n_Fûe
);

392  
rc
;

393 
	}
}

403 
	$Clo£
(
Fûe
 *
fûe
) {

404 
rc
;

406 
	`KASSERT
(
fûe
->
›s
->
Clo£
 != 0);

408 
	`TODO_P
(
PROJECT_FORK
, "ManageÑeference count");

410 
rc
 = 
fûe
->
›s
->
	`Clo£
(file);

411 i‡(
rc
 == 0)

412 
	`Fªe
(
fûe
);

413  
rc
;

414 
	}
}

423 
	$Sèt
(c⁄° *
∑th
, 
VFS_Fûe_Sèt
 *
°©
) {

424 
¥efix
[
MAX_PREFIX_LEN
 + 1];

425 c⁄° *
suffix
;

426 
Mou¡_Poöt
 *
mou¡Poöt
;

428 i‡(!
	`U≈ack_P©h
(
∑th
, 
¥efix
, &
suffix
))

429  
ENOTFOUND
;

432 
	`Debug
("Sèt:Üooku∞mou¡Öoöàf‹ %s\n", 
¥efix
);

433 
mou¡Poöt
 = 
	`Lookup_Mou¡_Poöt
(
¥efix
);

434 i‡(
mou¡Poöt
 == 0)

435  
ENOTFOUND
;

437 
	`Debug
("Stat: found mountÖoint, dispatchingÅo filesystem\n");

438 i‡(
mou¡Poöt
->
›s
->
Sèt
 == 0)

439  
EUNSUPPORTED
;

441  
mou¡Poöt
->
›s
->
	`Sèt
(mou¡Poöt, 
suffix
, 
°©
);

442 
	}
}

448 
	$Sync
() {

449 
rc
 = 0;

450 
Mou¡_Poöt
 *
mou¡Poöt
;

452 
	`Muãx_Lock
(&
s_vfsLock
);

453 
mou¡Poöt
 = 
	`Gë_Fr⁄t_Of_Mou¡_Poöt_Li°
(&
s_mou¡PoötLi°
);

454 
mou¡Poöt
 != 0;

455 
mou¡Poöt
 = 
	`Gë_Next_In_Mou¡_Poöt_Li°
(mountPoint)) {

456 
	`KASSERT
(
mou¡Poöt
->
›s
->
Sync
 != 0);

457 
rc
 = 
mou¡Poöt
->
›s
->
	`Sync
(mountPoint);

458 i‡(
rc
 != 0)

461 
	`Muãx_U∆ock
(&
s_vfsLock
);

463  
rc
;

464 
	}
}

478 
Fûe
 *
	$AŒoˇã_Fûe
(
Fûe_Ops
 *
›s
, 
fûePos
, 
ídPos
,

479 *
fsD©a
, 
mode
,

480 
Mou¡_Poöt
 *
mou¡Poöt
) {

481 
Fûe
 *
fûe
;

483 
fûe
 = (
Fûe
 *)
	`MÆloc
((File));

484 i‡(
fûe
 != 0) {

485 
fûe
->
›s
 = ops;

486 
fûe
->
fûePos
 = filePos;

487 
fûe
->
ídPos
 =ÉndPos;

488 
fûe
->
fsD©a
 = fsData;

489 
fûe
->
mode
 = mode;

490 
fûe
->
mou¡Poöt
 = mountPoint;

492  
fûe
;

493 
	}
}

502 
	$FSèt
(
Fûe
 *
fûe
, 
VFS_Fûe_Sèt
 *
°©
) {

503 i‡(
fûe
->
›s
->
FSèt
 == 0)

504  
EUNSUPPORTED
;

506  
fûe
->
›s
->
	`FSèt
(fûe, 
°©
);

507 
	}
}

518 
	$Ród
(
Fûe
 *
fûe
, *
buf
, 
ul⁄g_t
 
Àn
) {

519 i‡(
fûe
->
›s
->
Ród
 == 0)

520  
EUNSUPPORTED
;

522  
fûe
->
›s
->
	`Ród
(fûe, 
buf
, 
Àn
);

523 
	}
}

533 
	$Wrôe
(
Fûe
 *
fûe
, *
buf
, 
ul⁄g_t
 
Àn
) {

534 i‡(
fûe
->
›s
->
Wrôe
 == 0)

535  
EUNSUPPORTED
;

537  
fûe
->
›s
->
	`Wrôe
(fûe, 
buf
, 
Àn
);

538 
	}
}

548 
	$Sìk
(
Fûe
 *
fûe
, 
ul⁄g_t
 
Àn
) {

549 i‡(
fûe
->
›s
->
Sìk
 == 0)

550  
EUNSUPPORTED
;

552  
fûe
->
›s
->
	`Sìk
(fûe, 
Àn
);

553 
	}
}

565 
	$Ród_FuŒy
(c⁄° *
∑th
, **
pBuf„r
, 
ul⁄g_t
 * 
pLí
) {

566 
Fûe
 *
fûe
 = 0;

567 
VFS_Fûe_Sèt
 
°©
;

568 
rc
;

569 *
buf
 = 0;

570 
numByãsRód
;

572 i‡((
rc
 = 
	`Sèt
(
∑th
, &
°©
)Ë< 0 || (r¯
	`O≥n
’©h, 
O_READ
, &
fûe
)) < 0)

573 
Áû
;

574 i‡(
°©
.
size
 < 0) {

575 
rc
 = 
ENOTFOUND
;

576 
Áû
;

579 
buf
 = (*)
	`MÆloc
(
°©
.
size
);

580 i‡(
buf
 == 0)

581 
memÁû
;

584 
numByãsRód
 = 0;

585 
numByãsRód
 < 
°©
.
size
) {

586 
rc
 = 
	`Ród
(
fûe
, 
buf
 + 
numByãsRód
, 
°©
.
size
 -ÇumBytesRead);

587 i‡(
rc
 < 0)

588 
Áû
;

589 
numByãsRód
 +
rc
;

593 
	`Clo£
(
fûe
);

594 *
pBuf„r
 = (*)
buf
;

595 *
pLí
 = 
°©
.
size
;

598 
memÁû
:

599 
rc
 = 
ENOMEM
;

600 
Áû
:

601 i‡(
fûe
 != 0)

602 
	`Clo£
(
fûe
);

603 i‡(
buf
 != 0)

604 
	`Fªe
(
buf
);

605  
rc
;

606 
	}
}

614 
	$Cª©e_Dúe˘‹y
(c⁄° *
∑th
) {

615 
¥efix
[
MAX_PREFIX_LEN
 + 1];

616 c⁄° *
suffix
;

617 
Mou¡_Poöt
 *
mou¡Poöt
;

620 i‡(!
	`U≈ack_P©h
(
∑th
, 
¥efix
, &
suffix
))

621  
ENOTFOUND
;

624 
mou¡Poöt
 = 
	`Lookup_Mou¡_Poöt
(
¥efix
);

625 i‡(
mou¡Poöt
 == 0)

626  
ENOTFOUND
;

628 i‡(
mou¡Poöt
->
›s
->
Cª©e_Dúe˘‹y
 == 0)

629  
EUNSUPPORTED
;

631  
mou¡Poöt
->
›s
->
	`Cª©e_Dúe˘‹y
(mou¡Poöt, 
suffix
);

632 
	}
}

641 
	$Dñëe
(c⁄° *
∑th
, 
boﬁ
 
ªcursive
) {

642 
¥efix
[
MAX_PREFIX_LEN
 + 1];

643 c⁄° *
suffix
;

644 
Mou¡_Poöt
 *
mou¡Poöt
;

647 i‡(!
	`U≈ack_P©h
(
∑th
, 
¥efix
, &
suffix
))

648  
ENOTFOUND
;

651 
mou¡Poöt
 = 
	`Lookup_Mou¡_Poöt
(
¥efix
);

652 i‡(
mou¡Poöt
 == 0)

653  
ENOTFOUND
;

655 i‡(
mou¡Poöt
->
›s
->
Dñëe
 == 0)

656  
EUNSUPPORTED
;

658  
mou¡Poöt
->
›s
->
	`Dñëe
(mou¡Poöt, 
suffix
, 
ªcursive
);

659 
	}
}

669 
	$Ríame
(c⁄° *
ﬁd∑th
, c⁄° *
√w∑th
) {

670 
¥efix1
[
MAX_PREFIX_LEN
 + 1];

671 
¥efix2
[
MAX_PREFIX_LEN
 + 1];

672 c⁄° *
suffix1
;

673 c⁄° *
suffix2
;

674 
Mou¡_Poöt
 *
mou¡Poöt1
;

675 
Mou¡_Poöt
 *
mou¡Poöt2
;

679 i‡(!
	`U≈ack_P©h
(
ﬁd∑th
, 
¥efix1
, &
suffix1
))

680  
ENOTFOUND
;

683 
mou¡Poöt1
 = 
	`Lookup_Mou¡_Poöt
(
¥efix1
);

684 i‡(
mou¡Poöt1
 == 0)

685  
ENOTFOUND
;

687 i‡(
mou¡Poöt1
->
›s
->
Ríame
 == 0)

688  
EUNSUPPORTED
;

691 i‡(!
	`U≈ack_P©h
(
√w∑th
, 
¥efix2
, &
suffix2
))

692  
ENOTFOUND
;

694 
mou¡Poöt2
 = 
	`Lookup_Mou¡_Poöt
(
¥efix2
);

696 i‡(
mou¡Poöt1
 !
mou¡Poöt2
)

697  
EINVALID
;

699  
mou¡Poöt1
->
›s
->
	`Ríame
(mou¡Poöt1, 
suffix1
, 
suffix2
);

700 
	}
}

709 
	$Lök
(c⁄° *
ﬁd∑th
, c⁄° *
√w∑th
) {

710 
¥efix1
[
MAX_PREFIX_LEN
 + 1];

711 
¥efix2
[
MAX_PREFIX_LEN
 + 1];

712 c⁄° *
suffix1
;

713 c⁄° *
suffix2
;

714 
Mou¡_Poöt
 *
mou¡Poöt1
;

715 
Mou¡_Poöt
 *
mou¡Poöt2
;

719 i‡(!
	`U≈ack_P©h
(
ﬁd∑th
, 
¥efix1
, &
suffix1
))

720  
ENOTFOUND
;

723 
mou¡Poöt1
 = 
	`Lookup_Mou¡_Poöt
(
¥efix1
);

724 i‡(
mou¡Poöt1
 == 0)

725  
ENOTFOUND
;

727 i‡(
mou¡Poöt1
->
›s
->
Lök
 == 0)

728  
EUNSUPPORTED
;

731 i‡(!
	`U≈ack_P©h
(
√w∑th
, 
¥efix2
, &
suffix2
))

732  
ENOTFOUND
;

734 
mou¡Poöt2
 = 
	`Lookup_Mou¡_Poöt
(
¥efix2
);

736 i‡(
mou¡Poöt1
 !
mou¡Poöt2
)

737  
EINVALID
;

739  
mou¡Poöt1
->
›s
->
	`Lök
(mou¡Poöt1, 
suffix1
, 
suffix2
);

740 
	}
}

749 
	$SymLök
(c⁄° *
ﬁd∑th
, c⁄° *
√w∑th
) {

750 
¥efix2
[
MAX_PREFIX_LEN
 + 1];

751 c⁄° *
suffix2
;

752 
Mou¡_Poöt
 *
mou¡Poöt2
;

755 i‡(!
	`U≈ack_P©h
(
√w∑th
, 
¥efix2
, &
suffix2
))

756  
ENOTFOUND
;

758 
mou¡Poöt2
 = 
	`Lookup_Mou¡_Poöt
(
¥efix2
);

760 i‡(
mou¡Poöt2
->
›s
->
SymLök
 == 0)

761  
EUNSUPPORTED
;

763  
mou¡Poöt2
->
›s
->
	`SymLök
(mou¡Poöt2, 
ﬁd∑th
, 
suffix2
);

764 
	}
}

772 
	$SëSëUid
(c⁄° *
∑th
, 
£tUid
) {

773 
	`TODO_P
(
PROJECT_USER
, "virtual file system system SetSetUid");

774  
EUNSUPPORTED
;

775 
	}
}

784 
	$SëA˛
(c⁄° *
∑th
, 
u£r
, 
≥rmissi⁄s
) {

785 
	`TODO_P
(
PROJECT_USER
, "virtual file system system SetAcl");

786  
EUNSUPPORTED
;

787 
	}
}

796 
	$O≥n_Dúe˘‹y
(c⁄° *
∑th
, 
Fûe
 **
pDú
) {

797  
	`Do_O≥n
(
∑th
, 0, 
pDú
, &
Do_O≥n_Dúe˘‹y
);

798 
	}
}

807 
	$Ród_E¡ry
(
Fûe
 *
fûe
, 
VFS_Dú_E¡ry
 *
íåy
) {

808 i‡(
fûe
->
›s
->
Ród_E¡ry
 == 0)

809  
EUNSUPPORTED
;

811  
fûe
->
›s
->
	`Ród_E¡ry
(fûe, 
íåy
);

812 
	}
}

823 
	$Disk_Pr›îtõs
(c⁄° *
∑th
,

824 *
block_size
,

825 *
blocks_ö_fûesy°em
) {

826 
¥efix
[
MAX_PREFIX_LEN
 + 1];

827 c⁄° *
suffix
;

828 
Mou¡_Poöt
 *
mou¡Poöt
;

831 i‡(!
	`U≈ack_P©h
(
∑th
, 
¥efix
, &
suffix
))

832  
ENOTFOUND
;

835 
mou¡Poöt
 = 
	`Lookup_Mou¡_Poöt
(
¥efix
);

836 i‡(
mou¡Poöt
 == 0)

837  
ENOTFOUND
;

839 i‡(
mou¡Poöt
->
›s
->
Disk_Pr›îtõs
 == 0)

840  
EUNSUPPORTED
;

842  
mou¡Poöt
->
›s
->
	`Disk_Pr›îtõs
(mou¡Poöt, 
block_size
,

843 
blocks_ö_fûesy°em
);

844 
	}
}

849 
	$Regi°î_Pagög_Devi˚
(
Pagög_Devi˚
 *
∑gögDevi˚
) {

850 
	`KASSERT
(
s_∑gögDevi˚
 == 0);

851 
	`KASSERT
(
∑gögDevi˚
 != 0);

852 
	`Pröt
("Regi°îögÖagög devi˚: %†⁄ %s\n", 
∑gögDevi˚
->
fûeName
,

853 
∑gögDevi˚
->
dev
->
«me
);

854 
s_∑gögDevi˚
 = 
∑gögDevi˚
;

855 
	}
}

861 
Pagög_Devi˚
 *
	$Gë_Pagög_Devi˚
() {

862  
s_∑gögDevi˚
;

863 
	}
}

	@/usr/include/ctype.h

22 #i‚def 
_CTYPE_H


23 
	#_CTYPE_H
 1

	)

25 
	~<„©uªs.h
>

26 
	~<bôs/ty≥s.h
>

28 
	g__BEGIN_DECLS


30 #i‚de‡
_ISbô


39 
	~<ídün.h
>

40 #i‡
__BYTE_ORDER
 =
__BIG_ENDIAN


41 
	#_ISbô
(
bô
Ë(1 << (bô))

	)

43 
	#_ISbô
(
bô
Ë((bôË< 8 ? ((1 << (bô)Ë<< 8Ë: ((1 << (bô)Ë>> 8))

	)

48 
	m_ISuµî
 = 
_ISbô
 (0),

49 
	m_ISlowî
 = 
_ISbô
 (1),

50 
	m_ISÆpha
 = 
_ISbô
 (2),

51 
	m_ISdigô
 = 
_ISbô
 (3),

52 
	m_ISxdigô
 = 
_ISbô
 (4),

53 
	m_IS•a˚
 = 
_ISbô
 (5),

54 
	m_IS¥öt
 = 
_ISbô
 (6),

55 
	m_ISgøph
 = 
_ISbô
 (7),

56 
	m_ISbœnk
 = 
_ISbô
 (8),

57 
	m_IS˙ål
 = 
_ISbô
 (9),

58 
	m_ISpun˘
 = 
_ISbô
 (10),

59 
	m_ISÆnum
 = 
_ISbô
 (11)

79 c⁄° **
	$__˘y≥_b_loc
 ()

80 
__THROW
 
	`__©åibuã__
 ((
__c⁄°__
));

81 c⁄° 
__öt32_t
 **
	$__˘y≥_tﬁowî_loc
 ()

82 
__THROW
 
	`__©åibuã__
 ((
__c⁄°__
));

83 c⁄° 
__öt32_t
 **
	$__˘y≥_touµî_loc
 ()

84 
__THROW
 
	`__©åibuã__
 ((
__c⁄°__
));

87 #i‚de‡
__˝lu•lus


88 
	#__is˘y≥
(
c
, 
ty≥
) \

89 ((*
	`__˘y≥_b_loc
 ())[(Ë(
c
)] & (Ë
ty≥
)

	)

90 #ñi‡
deföed
 
__USE_EXTERN_INLINES


91 
	#__is˘y≥_f
(
ty≥
) \

92 
__exã∫_ölöe
 \

93 
is
##
	`ty≥
 (
__c
Ë
__THROW
 \

95  (*
	`__˘y≥_b_loc
 ())[(Ë(
__c
)] & (Ë
_IS
##
ty≥
; \

96 
	}

	)
}

99 
	#__ißscii
(
c
Ë(((cË& ~0x7fË=0Ë

	)

100 
	#__tﬂscii
(
c
Ë((cË& 0x7fË

	)

102 
	#__ex˘y≥
(
«me
Ë
	`«me
 (Ë
__THROW


	)

104 
__BEGIN_NAMESPACE_STD


110 
__ex˘y≥
 (
iß um
);

111 
__ex˘y≥
 (
ißÕha
);

112 
__ex˘y≥
 (
is˙ål
);

113 
__ex˘y≥
 (
isdigô
);

114 
__ex˘y≥
 (
i¶owî
);

115 
__ex˘y≥
 (
isgøph
);

116 
__ex˘y≥
 (
i•röt
);

117 
__ex˘y≥
 (
i•un˘
);

118 
__ex˘y≥
 (
is•a˚
);

119 
__ex˘y≥
 (
isuµî
);

120 
__ex˘y≥
 (
isxdigô
);

124 
	$tﬁowî
 (
__c
Ë
__THROW
;

127 
	$touµî
 (
__c
Ë
__THROW
;

129 
__END_NAMESPACE_STD


133 #ifdef 
__USE_ISOC99


134 
__BEGIN_NAMESPACE_C99


136 
	`__ex˘y≥
 (
isbœnk
);

138 
__END_NAMESPACE_C99


141 #ifde‡
__USE_GNU


143 
	$is˘y≥
 (
__c
, 
__mask
Ë
__THROW
;

146 #i‡
deföed
 
__USE_SVID
 || deföed 
__USE_MISC
 || deföed 
__USE_XOPEN


150 
	$ißscii
 (
__c
Ë
__THROW
;

154 
	$tﬂscii
 (
__c
Ë
__THROW
;

158 
	`__ex˘y≥
 (
_touµî
);

159 
	`__ex˘y≥
 (
_tﬁowî
);

163 
	#__tobody
(
c
, 
f
, 
a
, 
¨gs
) \

164 (
__exãnsi⁄__
 \

165 ({ 
__ªs
; \

166 i‡( (
c
) > 1) \

168 i‡(
	`__buûtö_c⁄°™t_p
 (
c
)) \

170 
__c
 = (
c
); \

171 
__ªs
 = 
__c
 < -128 || __¯> 255 ? __¯: (
a
)[__c]; \

174 
__ªs
 = 
f
 
¨gs
; \

177 
__ªs
 = (
a
)[(Ë(
c
)]; \

178 
__ªs
; 
	}
}))

	)

180 #i‡!
deföed
 
__NO_CTYPE


181 #ifde‡
__is˘y≥_f


182 
	$__is˘y≥_f
 (
Ænum
)

183 
	$__is˘y≥_f
 (
Æpha
)

184 
	$__is˘y≥_f
 (
˙ål
)

185 
	$__is˘y≥_f
 (
digô
)

186 
	$__is˘y≥_f
 (
lowî
)

187 
	$__is˘y≥_f
 (
gøph
)

188 
	$__is˘y≥_f
 (
¥öt
)

189 
	$__is˘y≥_f
 (
pun˘
)

190 
	$__is˘y≥_f
 (
•a˚
)

191 
	$__is˘y≥_f
 (
uµî
)

192 
	$__is˘y≥_f
 (
xdigô
)

193 #ifde‡
__USE_ISOC99


194 
	$__is˘y≥_f
 (
bœnk
)

196 #ñi‡
deföed
 
__is˘y≥


197 
	#iß um
(
c
Ë
	`__is˘y≥
((c), 
_ISÆnum
)

	)

198 
	#ißÕha
(
c
Ë
	`__is˘y≥
((c), 
_ISÆpha
)

	)

199 
	#is˙ål
(
c
Ë
	`__is˘y≥
((c), 
_IS˙ål
)

	)

200 
	#isdigô
(
c
Ë
	`__is˘y≥
((c), 
_ISdigô
)

	)

201 
	#i¶owî
(
c
Ë
	`__is˘y≥
((c), 
_ISlowî
)

	)

202 
	#isgøph
(
c
Ë
	`__is˘y≥
((c), 
_ISgøph
)

	)

203 
	#i•röt
(
c
Ë
	`__is˘y≥
((c), 
_IS¥öt
)

	)

204 
	#i•un˘
(
c
Ë
	`__is˘y≥
((c), 
_ISpun˘
)

	)

205 
	#is•a˚
(
c
Ë
	`__is˘y≥
((c), 
_IS•a˚
)

	)

206 
	#isuµî
(
c
Ë
	`__is˘y≥
((c), 
_ISuµî
)

	)

207 
	#isxdigô
(
c
Ë
	`__is˘y≥
((c), 
_ISxdigô
)

	)

208 #ifde‡
__USE_ISOC99


209 
	#isbœnk
(
c
Ë
	`__is˘y≥
((c), 
_ISbœnk
)

	)

213 #ifde‡
__USE_EXTERN_INLINES


214 
__exã∫_ölöe
 

215 
	`__NTH
 (
	$tﬁowî
 (
__c
))

217  
__c
 >-128 && __¯< 256 ? (*
	`__˘y≥_tﬁowî_loc
 ())[__c] : __c;

218 
	}
}

220 
__exã∫_ölöe
 

221 
__NTH
 (
	$touµî
 (
__c
))

223  
__c
 >-128 && __¯< 256 ? (*
	`__˘y≥_touµî_loc
 ())[__c] : __c;

224 
	}
}

227 #i‡
__GNUC__
 >2 && 
deföed
 
__OPTIMIZE__
 && !deföed 
__˝lu•lus


228 
	#tﬁowî
(
c
Ë
	`__tobody
 (c, 
tﬁowî
, *
	`__˘y≥_tﬁowî_loc
 (), (c))

	)

229 
	#touµî
(
c
Ë
	`__tobody
 (c, 
touµî
, *
	`__˘y≥_touµî_loc
 (), (c))

	)

232 #i‡
deföed
 
__USE_SVID
 || deföed 
__USE_MISC
 || deföed 
__USE_XOPEN


233 
	#ißscii
(
c
Ë
	`__ißscii
 (c)

	)

234 
	#tﬂscii
(
c
Ë
	`__tﬂscii
 (c)

	)

236 
	#_tﬁowî
(
c
Ë((Ë(*
	`__˘y≥_tﬁowî_loc
 ())[(Ë(c)])

	)

237 
	#_touµî
(
c
Ë((Ë(*
	`__˘y≥_touµî_loc
 ())[(Ë(c)])

	)

243 #ifde‡
__USE_XOPEN2K8


257 
	~<xloˇÀ.h
>

261 
	#__is˘y≥_l
(
c
, 
ty≥
, 
loˇÀ
) \

262 ((
loˇÀ
)->
__˘y≥_b
[(Ë(
c
)] & (Ë
ty≥
)

	)

264 
	#__ex˘y≥_l
(
«me
) \

265 
	`«me
 (, 
__loˇÀ_t
Ë
__THROW


	)

271 
__ex˘y≥_l
 (
iß um_l
);

272 
__ex˘y≥_l
 (
ißÕha_l
);

273 
__ex˘y≥_l
 (
is˙ål_l
);

274 
__ex˘y≥_l
 (
isdigô_l
);

275 
__ex˘y≥_l
 (
i¶owî_l
);

276 
__ex˘y≥_l
 (
isgøph_l
);

277 
__ex˘y≥_l
 (
i•röt_l
);

278 
__ex˘y≥_l
 (
i•un˘_l
);

279 
__ex˘y≥_l
 (
is•a˚_l
);

280 
__ex˘y≥_l
 (
isuµî_l
);

281 
__ex˘y≥_l
 (
isxdigô_l
);

283 
__ex˘y≥_l
 (
isbœnk_l
);

287 
	$__tﬁowî_l
 (
__c
, 
__loˇÀ_t
 
__l
Ë
__THROW
;

288 
	$tﬁowî_l
 (
__c
, 
__loˇÀ_t
 
__l
Ë
__THROW
;

291 
	$__touµî_l
 (
__c
, 
__loˇÀ_t
 
__l
Ë
__THROW
;

292 
	$touµî_l
 (
__c
, 
__loˇÀ_t
 
__l
Ë
__THROW
;

294 #i‡
__GNUC__
 >2 && 
deföed
 
__OPTIMIZE__
 && !deföed 
__˝lu•lus


295 
	#__tﬁowî_l
(
c
, 
loˇÀ
) \

296 
	`__tobody
 (
c
, 
__tﬁowî_l
, (
loˇÀ
)->
__˘y≥_tﬁowî
, (c,ÜoˇÀ))

	)

297 
	#__touµî_l
(
c
, 
loˇÀ
) \

298 
	`__tobody
 (
c
, 
__touµî_l
, (
loˇÀ
)->
__˘y≥_touµî
, (c,ÜoˇÀ))

	)

299 
	#tﬁowî_l
(
c
, 
loˇÀ
Ë
	`__tﬁowî_l
 ((c), (loˇÀ))

	)

300 
	#touµî_l
(
c
, 
loˇÀ
Ë
	`__touµî_l
 ((c), (loˇÀ))

	)

304 #i‚de‡
__NO_CTYPE


305 
	#__iß um_l
(
c
,
l
Ë
	`__is˘y≥_l
((c), 
_ISÆnum
, (l))

	)

306 
	#__ißÕha_l
(
c
,
l
Ë
	`__is˘y≥_l
((c), 
_ISÆpha
, (l))

	)

307 
	#__is˙ål_l
(
c
,
l
Ë
	`__is˘y≥_l
((c), 
_IS˙ål
, (l))

	)

308 
	#__isdigô_l
(
c
,
l
Ë
	`__is˘y≥_l
((c), 
_ISdigô
, (l))

	)

309 
	#__i¶owî_l
(
c
,
l
Ë
	`__is˘y≥_l
((c), 
_ISlowî
, (l))

	)

310 
	#__isgøph_l
(
c
,
l
Ë
	`__is˘y≥_l
((c), 
_ISgøph
, (l))

	)

311 
	#__i•röt_l
(
c
,
l
Ë
	`__is˘y≥_l
((c), 
_IS¥öt
, (l))

	)

312 
	#__i•un˘_l
(
c
,
l
Ë
	`__is˘y≥_l
((c), 
_ISpun˘
, (l))

	)

313 
	#__is•a˚_l
(
c
,
l
Ë
	`__is˘y≥_l
((c), 
_IS•a˚
, (l))

	)

314 
	#__isuµî_l
(
c
,
l
Ë
	`__is˘y≥_l
((c), 
_ISuµî
, (l))

	)

315 
	#__isxdigô_l
(
c
,
l
Ë
	`__is˘y≥_l
((c), 
_ISxdigô
, (l))

	)

317 
	#__isbœnk_l
(
c
,
l
Ë
	`__is˘y≥_l
((c), 
_ISbœnk
, (l))

	)

319 #i‡
deföed
 
__USE_SVID
 || deföed 
__USE_MISC


320 
	#__ißscii_l
(
c
,
l
Ë(÷), 
	`__ißscii
 (c))

	)

321 
	#__tﬂscii_l
(
c
,
l
Ë(÷), 
	`__tﬂscii
 (c))

	)

324 
	#iß um_l
(
c
,
l
Ë
	`__iß um_l
 ((c), (l))

	)

325 
	#ißÕha_l
(
c
,
l
Ë
	`__ißÕha_l
 ((c), (l))

	)

326 
	#is˙ål_l
(
c
,
l
Ë
	`__is˙ål_l
 ((c), (l))

	)

327 
	#isdigô_l
(
c
,
l
Ë
	`__isdigô_l
 ((c), (l))

	)

328 
	#i¶owî_l
(
c
,
l
Ë
	`__i¶owî_l
 ((c), (l))

	)

329 
	#isgøph_l
(
c
,
l
Ë
	`__isgøph_l
 ((c), (l))

	)

330 
	#i•röt_l
(
c
,
l
Ë
	`__i•röt_l
 ((c), (l))

	)

331 
	#i•un˘_l
(
c
,
l
Ë
	`__i•un˘_l
 ((c), (l))

	)

332 
	#is•a˚_l
(
c
,
l
Ë
	`__is•a˚_l
 ((c), (l))

	)

333 
	#isuµî_l
(
c
,
l
Ë
	`__isuµî_l
 ((c), (l))

	)

334 
	#isxdigô_l
(
c
,
l
Ë
	`__isxdigô_l
 ((c), (l))

	)

336 
	#isbœnk_l
(
c
,
l
Ë
	`__isbœnk_l
 ((c), (l))

	)

338 #i‡
deföed
 
__USE_SVID
 || deföed 
__USE_MISC


339 
	#ißscii_l
(
c
,
l
Ë
	`__ißscii_l
 ((c), (l))

	)

340 
	#tﬂscii_l
(
c
,
l
Ë
	`__tﬂscii_l
 ((c), (l))

	)

347 
__END_DECLS


	@/usr/include/limits.h

22 #i‚de‡
_LIBC_LIMITS_H_


23 
	#_LIBC_LIMITS_H_
 1

	)

25 
	~<„©uªs.h
>

31 
	#MB_LEN_MAX
 16

	)

36 #i‡!
deföed
 
__GNUC__
 || __GNUC__ < 2

41 #i‚de‡
_LIMITS_H


42 
	#_LIMITS_H
 1

	)

44 
	~<bôs/w‹dsize.h
>

53 
	#CHAR_BIT
 8

	)

56 
	#SCHAR_MIN
 (-128)

	)

57 
	#SCHAR_MAX
 127

	)

60 
	#UCHAR_MAX
 255

	)

63 #ifde‡
__CHAR_UNSIGNED__


64 
	#CHAR_MIN
 0

	)

65 
	#CHAR_MAX
 
UCHAR_MAX


	)

67 
	#CHAR_MIN
 
SCHAR_MIN


	)

68 
	#CHAR_MAX
 
SCHAR_MAX


	)

72 
	#SHRT_MIN
 (-32768)

	)

73 
	#SHRT_MAX
 32767

	)

76 
	#USHRT_MAX
 65535

	)

79 
	#INT_MIN
 (-
INT_MAX
 - 1)

	)

80 
	#INT_MAX
 2147483647

	)

83 
	#UINT_MAX
 4294967295U

	)

86 #i‡
__WORDSIZE
 == 64

87 
	#LONG_MAX
 9223372036854775807L

	)

89 
	#LONG_MAX
 2147483647L

	)

91 
	#LONG_MIN
 (-
LONG_MAX
 - 1L)

	)

94 #i‡
__WORDSIZE
 == 64

95 
	#ULONG_MAX
 18446744073709551615UL

	)

97 
	#ULONG_MAX
 4294967295UL

	)

100 #ifde‡
__USE_ISOC99


103 
	#LLONG_MAX
 9223372036854775807LL

	)

104 
	#LLONG_MIN
 (-
LLONG_MAX
 - 1LL)

	)

107 
	#ULLONG_MAX
 18446744073709551615ULL

	)

121 #i‡
deföed
 
__GNUC__
 && !deföed 
_GCC_LIMITS_H_


123 #ö˛ude_√xà<
limôs
.
h
>

129 #i‡
deföed
 
__USE_ISOC99
 && deföed 
__GNUC__


130 #i‚de‡
LLONG_MIN


131 
	#LLONG_MIN
 (-
LLONG_MAX
-1)

	)

133 #i‚de‡
LLONG_MAX


134 
	#LLONG_MAX
 
__LONG_LONG_MAX__


	)

136 #i‚de‡
ULLONG_MAX


137 
	#ULLONG_MAX
 (
LLONG_MAX
 * 2ULL + 1)

	)

141 #ifdef 
__USE_POSIX


143 
	~<bôs/posix1_lim.h
>

146 #ifdef 
__USE_POSIX2


147 
	~<bôs/posix2_lim.h
>

150 #ifdef 
__USE_XOPEN


151 
	~<bôs/x›í_lim.h
>

	@/usr/include/string.h

22 #i‚def 
_STRING_H


23 
	#_STRING_H
 1

	)

25 
	~<„©uªs.h
>

27 
	g__BEGIN_DECLS


30 
	#__√ed_size_t


	)

31 
	#__√ed_NULL


	)

32 
	~<°ddef.h
>

39 #i‡
deföed
 
__˝lu•lus
 && (__˝lu•lu†>199711L || 
__GNUC_PREREQ
 (4, 4))

40 
	#__CORRECT_ISO_CPP_STRING_H_PROTO


	)

44 
__BEGIN_NAMESPACE_STD


46 *
	$mem˝y
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
,

47 
size_t
 
__n
Ë
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

50 *
	$memmove
 (*
__de°
, c⁄° *
__§c
, 
size_t
 
__n
)

51 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

52 
__END_NAMESPACE_STD


57 #i‡
deföed
 
__USE_SVID
 || deföed 
__USE_BSD
 || deföed 
__USE_XOPEN


58 *
	$memc˝y
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
,

59 
__c
, 
size_t
 
__n
)

60 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

64 
__BEGIN_NAMESPACE_STD


66 *
	$mem£t
 (*
__s
, 
__c
, 
size_t
 
__n
Ë
__THROW
 
	`__n⁄nuŒ
 ((1));

69 
	$memcmp
 (c⁄° *
__s1
, c⁄° *
__s2
, 
size_t
 
__n
)

70 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

73 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


76 *
	`memchr
 (*
__s
, 
__c
, 
size_t
 
__n
)

77 
__THROW
 
	`__asm
 ("memchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

78 c⁄° *
	`memchr
 (c⁄° *
__s
, 
__c
, 
size_t
 
__n
)

79 
__THROW
 
	`__asm
 ("memchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

81 #ifde‡
__OPTIMIZE__


82 
__exã∫_Æways_ölöe
 *

83 
	`memchr
 (*
__s
, 
__c
, 
size_t
 
__n
Ë
__THROW


85  
	`__buûtö_memchr
 (
__s
, 
__c
, 
__n
);

88 
__exã∫_Æways_ölöe
 const *

89 
	`memchr
 (c⁄° *
__s
, 
__c
, 
size_t
 
__n
Ë
__THROW


91  
	`__buûtö_memchr
 (
__s
, 
__c
, 
__n
);

94 
	}
}

96 *
	$memchr
 (c⁄° *
__s
, 
__c
, 
size_t
 
__n
)

97 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

99 
__END_NAMESPACE_STD


101 #ifde‡
__USE_GNU


104 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


105 "C++" *
	$øwmemchr
 (*
__s
, 
__c
)

106 
__THROW
 
	`__asm
 ("øwmemchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

107 "C++" c⁄° *
	$øwmemchr
 (c⁄° *
__s
, 
__c
)

108 
__THROW
 
	`__asm
 ("øwmemchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

110 *
	$øwmemchr
 (c⁄° *
__s
, 
__c
)

111 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

115 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


116 "C++" *
	$memrchr
 (*
__s
, 
__c
, 
size_t
 
__n
)

117 
__THROW
 
	`__asm
 ("memrchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

118 "C++" c⁄° *
	$memrchr
 (c⁄° *
__s
, 
__c
, 
size_t
 
__n
)

119 
__THROW
 
	`__asm
 ("memrchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

121 *
	$memrchr
 (c⁄° *
__s
, 
__c
, 
size_t
 
__n
)

122 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

127 
__BEGIN_NAMESPACE_STD


129 *
	$°r˝y
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
)

130 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

132 *
	$°∫˝y
 (*
__ª°ri˘
 
__de°
,

133 c⁄° *
__ª°ri˘
 
__§c
, 
size_t
 
__n
)

134 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

137 *
	$°rˇt
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
)

138 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

140 *
	$°∫ˇt
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
,

141 
size_t
 
__n
Ë
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

144 
	$°rcmp
 (c⁄° *
__s1
, c⁄° *
__s2
)

145 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

147 
	$°∫cmp
 (c⁄° *
__s1
, c⁄° *
__s2
, 
size_t
 
__n
)

148 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

151 
	$°rcﬁl
 (c⁄° *
__s1
, c⁄° *
__s2
)

152 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

154 
size_t
 
	$°rx‰m
 (*
__ª°ri˘
 
__de°
,

155 c⁄° *
__ª°ri˘
 
__§c
, 
size_t
 
__n
)

156 
__THROW
 
	`__n⁄nuŒ
 ((2));

157 
__END_NAMESPACE_STD


159 #ifde‡
__USE_XOPEN2K8


163 
	~<xloˇÀ.h
>

166 
	$°rcﬁl_l
 (c⁄° *
__s1
, c⁄° *
__s2
, 
__loˇÀ_t
 
__l
)

167 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2, 3));

169 
size_t
 
	$°rx‰m_l
 (*
__de°
, c⁄° *
__§c
, 
size_t
 
__n
,

170 
__loˇÀ_t
 
__l
Ë
__THROW
 
	`__n⁄nuŒ
 ((2, 4));

173 #i‡
deföed
 
__USE_SVID
 || deföed 
__USE_BSD
 || deföed 
__USE_XOPEN_EXTENDED
 \

174 || 
deföed
 
__USE_XOPEN2K8


176 *
	$°rdup
 (c⁄° *
__s
)

177 
__THROW
 
__©åibuã_mÆloc__
 
	`__n⁄nuŒ
 ((1));

183 #i‡
deföed
 
__USE_XOPEN2K8


184 *
	$°∫dup
 (c⁄° *
__°rög
, 
size_t
 
__n
)

185 
__THROW
 
__©åibuã_mÆloc__
 
	`__n⁄nuŒ
 ((1));

188 #i‡
deföed
 
__USE_GNU
 && deföed 
__GNUC__


190 
	#°rdu∑
(
s
) \

191 (
__exãnsi⁄__
 \

193 c⁄° *
__ﬁd
 = (
s
); \

194 
size_t
 
__Àn
 = 
	`°æí
 (
__ﬁd
) + 1; \

195 *
__√w
 = (*Ë
	`__buûtö_Æloˇ
 (
__Àn
); \

196 (*Ë
	`mem˝y
 (
__√w
, 
__ﬁd
, 
__Àn
); \

197 
	}
}))

	)

200 
	#°∫du∑
(
s
, 
n
) \

201 (
__exãnsi⁄__
 \

203 c⁄° *
__ﬁd
 = (
s
); \

204 
size_t
 
__Àn
 = 
	`°∫Àn
 (
__ﬁd
, (
n
)); \

205 *
__√w
 = (*Ë
	`__buûtö_Æloˇ
 (
__Àn
 + 1); \

206 
__√w
[
__Àn
] = '\0'; \

207 (*Ë
	`mem˝y
 (
__√w
, 
__ﬁd
, 
__Àn
); \

208 }))

	)

211 
	g__BEGIN_NAMESPACE_STD


213 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


216 *
°rchr
 (*
__s
, 
__c
)

217 
__THROW
 
__asm
 ("°rchr"Ë
__©åibuã_puª__
 
__n⁄nuŒ
 ((1));

218 c⁄° *
°rchr
 (c⁄° *
__s
, 
__c
)

219 
__THROW
 
__asm
 ("°rchr"Ë
__©åibuã_puª__
 
__n⁄nuŒ
 ((1));

221 #ifde‡
__OPTIMIZE__


222 
__exã∫_Æways_ölöe
 *

223 
°rchr
 (*
__s
, 
__c
Ë
	g__THROW


225  
__buûtö_°rchr
 (
__s
, 
__c
);

228 
__exã∫_Æways_ölöe
 const *

229 
°rchr
 (c⁄° *
__s
, 
__c
Ë
	g__THROW


231  
__buûtö_°rchr
 (
__s
, 
__c
);

236 *
	$°rchr
 (c⁄° *
__s
, 
__c
)

237 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

240 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


243 *
	`°ºchr
 (*
__s
, 
__c
)

244 
__THROW
 
	`__asm
 ("°ºchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

245 c⁄° *
	`°ºchr
 (c⁄° *
__s
, 
__c
)

246 
__THROW
 
	`__asm
 ("°ºchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

248 #ifde‡
__OPTIMIZE__


249 
__exã∫_Æways_ölöe
 *

250 
	`°ºchr
 (*
__s
, 
__c
Ë
__THROW


252  
	`__buûtö_°ºchr
 (
__s
, 
__c
);

255 
__exã∫_Æways_ölöe
 const *

256 
	`°ºchr
 (c⁄° *
__s
, 
__c
Ë
__THROW


258  
	`__buûtö_°ºchr
 (
__s
, 
__c
);

261 
	}
}

263 *
	$°ºchr
 (c⁄° *
__s
, 
__c
)

264 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

266 
__END_NAMESPACE_STD


268 #ifde‡
__USE_GNU


271 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


272 "C++" *
	$°rch∫ul
 (*
__s
, 
__c
)

273 
__THROW
 
	`__asm
 ("°rch∫ul"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

274 "C++" c⁄° *
	$°rch∫ul
 (c⁄° *
__s
, 
__c
)

275 
__THROW
 
	`__asm
 ("°rch∫ul"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

277 *
	$°rch∫ul
 (c⁄° *
__s
, 
__c
)

278 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

282 
__BEGIN_NAMESPACE_STD


285 
size_t
 
	$°rc•n
 (c⁄° *
__s
, c⁄° *
__ªje˘
)

286 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

289 
size_t
 
	$°r•n
 (c⁄° *
__s
, c⁄° *
__ac˚±
)

290 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

292 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


295 *
	`°Ωbrk
 (*
__s
, c⁄° *
__ac˚±
)

296 
__THROW
 
	`__asm
 ("°Ωbrk"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

297 c⁄° *
	`°Ωbrk
 (c⁄° *
__s
, c⁄° *
__ac˚±
)

298 
__THROW
 
	`__asm
 ("°Ωbrk"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

300 #ifde‡
__OPTIMIZE__


301 
__exã∫_Æways_ölöe
 *

302 
	`°Ωbrk
 (*
__s
, c⁄° *
__ac˚±
Ë
__THROW


304  
	`__buûtö_°Ωbrk
 (
__s
, 
__ac˚±
);

307 
__exã∫_Æways_ölöe
 const *

308 
	`°Ωbrk
 (c⁄° *
__s
, c⁄° *
__ac˚±
Ë
__THROW


310  
	`__buûtö_°Ωbrk
 (
__s
, 
__ac˚±
);

313 
	}
}

315 *
	$°Ωbrk
 (c⁄° *
__s
, c⁄° *
__ac˚±
)

316 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

319 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


322 *
	`°r°r
 (*
__hay°ack
, c⁄° *
__√edÀ
)

323 
__THROW
 
	`__asm
 ("°r°r"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

324 c⁄° *
	`°r°r
 (c⁄° *
__hay°ack
, c⁄° *
__√edÀ
)

325 
__THROW
 
	`__asm
 ("°r°r"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

327 #ifde‡
__OPTIMIZE__


328 
__exã∫_Æways_ölöe
 *

329 
	`°r°r
 (*
__hay°ack
, c⁄° *
__√edÀ
Ë
__THROW


331  
	`__buûtö_°r°r
 (
__hay°ack
, 
__√edÀ
);

334 
__exã∫_Æways_ölöe
 const *

335 
	`°r°r
 (c⁄° *
__hay°ack
, c⁄° *
__√edÀ
Ë
__THROW


337  
	`__buûtö_°r°r
 (
__hay°ack
, 
__√edÀ
);

340 
	}
}

342 *
	$°r°r
 (c⁄° *
__hay°ack
, c⁄° *
__√edÀ
)

343 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

348 *
	$°πok
 (*
__ª°ri˘
 
__s
, c⁄° *__ª°ri˘ 
__dñim
)

349 
__THROW
 
	`__n⁄nuŒ
 ((2));

350 
__END_NAMESPACE_STD


354 *
	$__°πok_r
 (*
__ª°ri˘
 
__s
,

355 c⁄° *
__ª°ri˘
 
__dñim
,

356 **
__ª°ri˘
 
__ßve_±r
)

357 
__THROW
 
	`__n⁄nuŒ
 ((2, 3));

358 #i‡
deföed
 
__USE_POSIX
 || deföed 
__USE_MISC


359 *
	$°πok_r
 (*
__ª°ri˘
 
__s
, c⁄° *__ª°ri˘ 
__dñim
,

360 **
__ª°ri˘
 
__ßve_±r
)

361 
__THROW
 
	`__n⁄nuŒ
 ((2, 3));

364 #ifde‡
__USE_GNU


366 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


367 "C++" *
	$°rˇ£°r
 (*
__hay°ack
, c⁄° *
__√edÀ
)

368 
__THROW
 
	`__asm
 ("°rˇ£°r"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

369 "C++" c⁄° *
	$°rˇ£°r
 (c⁄° *
__hay°ack
,

370 c⁄° *
__√edÀ
)

371 
__THROW
 
	`__asm
 ("°rˇ£°r"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

373 *
	$°rˇ£°r
 (c⁄° *
__hay°ack
, c⁄° *
__√edÀ
)

374 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

378 #ifde‡
__USE_GNU


382 *
	$memmem
 (c⁄° *
__hay°ack
, 
size_t
 
__hay°ackÀn
,

383 c⁄° *
__√edÀ
, 
size_t
 
__√edÀÀn
)

384 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 3));

388 *
	$__memp˝y
 (*
__ª°ri˘
 
__de°
,

389 c⁄° *
__ª°ri˘
 
__§c
, 
size_t
 
__n
)

390 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

391 *
	$memp˝y
 (*
__ª°ri˘
 
__de°
,

392 c⁄° *
__ª°ri˘
 
__§c
, 
size_t
 
__n
)

393 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

397 
__BEGIN_NAMESPACE_STD


399 
size_t
 
	$°æí
 (c⁄° *
__s
)

400 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

401 
__END_NAMESPACE_STD


403 #ifdef 
__USE_XOPEN2K8


406 
size_t
 
	$°∫Àn
 (c⁄° *
__°rög
, 
size_t
 
__maxÀn
)

407 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

411 
__BEGIN_NAMESPACE_STD


413 *
	$°ªº‹
 (
__î∫um
Ë
__THROW
;

414 
__END_NAMESPACE_STD


415 #i‡
deföed
 
__USE_XOPEN2K
 || deföed 
__USE_MISC


423 #i‡
deföed
 
__USE_XOPEN2K
 && !deföed 
__USE_GNU


426 #ifde‡
__REDIRECT_NTH


427 
	`__REDIRECT_NTH
 (
°ªº‹_r
,

428 (
__î∫um
, *
__buf
, 
size_t
 
__buÊí
),

429 
__xpg_°ªº‹_r
Ë
	`__n⁄nuŒ
 ((2));

431 
	$__xpg_°ªº‹_r
 (
__î∫um
, *
__buf
, 
size_t
 
__buÊí
)

432 
__THROW
 
	`__n⁄nuŒ
 ((2));

433 
	#°ªº‹_r
 
__xpg_°ªº‹_r


	)

438 *
	$°ªº‹_r
 (
__î∫um
, *
__buf
, 
size_t
 
__buÊí
)

439 
__THROW
 
	`__n⁄nuŒ
 ((2)Ë
__wur
;

443 #ifde‡
__USE_XOPEN2K8


445 *
	$°ªº‹_l
 (
__î∫um
, 
__loˇÀ_t
 
__l
Ë
__THROW
;

451 
	$__bzîo
 (*
__s
, 
size_t
 
__n
Ë
__THROW
 
	`__n⁄nuŒ
 ((1));

453 #ifde‡
__USE_BSD


455 
	$bc›y
 (c⁄° *
__§c
, *
__de°
, 
size_t
 
__n
)

456 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

459 
	$bzîo
 (*
__s
, 
size_t
 
__n
Ë
__THROW
 
	`__n⁄nuŒ
 ((1));

462 
	$bcmp
 (c⁄° *
__s1
, c⁄° *
__s2
, 
size_t
 
__n
)

463 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

466 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


469 *
	`ödex
 (*
__s
, 
__c
)

470 
__THROW
 
	`__asm
 ("ödex"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

471 c⁄° *
	`ödex
 (c⁄° *
__s
, 
__c
)

472 
__THROW
 
	`__asm
 ("ödex"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

474 #i‡
deföed
 
__OPTIMIZE__
 && !deföed 
__CORRECT_ISO_CPP_STRINGS_H_PROTO


475 
__exã∫_Æways_ölöe
 *

476 
	`ödex
 (*
__s
, 
__c
Ë
__THROW


478  
	`__buûtö_ödex
 (
__s
, 
__c
);

481 
__exã∫_Æways_ölöe
 const *

482 
	`ödex
 (c⁄° *
__s
, 
__c
Ë
__THROW


484  
	`__buûtö_ödex
 (
__s
, 
__c
);

487 
	}
}

489 *
	$ödex
 (c⁄° *
__s
, 
__c
)

490 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

494 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


497 *
	`rödex
 (*
__s
, 
__c
)

498 
__THROW
 
	`__asm
 ("rödex"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

499 c⁄° *
	`rödex
 (c⁄° *
__s
, 
__c
)

500 
__THROW
 
	`__asm
 ("rödex"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

502 #i‡
deföed
 
__OPTIMIZE__
 && !deföed 
__CORRECT_ISO_CPP_STRINGS_H_PROTO


503 
__exã∫_Æways_ölöe
 *

504 
	`rödex
 (*
__s
, 
__c
Ë
__THROW


506  
	`__buûtö_rödex
 (
__s
, 
__c
);

509 
__exã∫_Æways_ölöe
 const *

510 
	`rödex
 (c⁄° *
__s
, 
__c
Ë
__THROW


512  
	`__buûtö_rödex
 (
__s
, 
__c
);

515 
	}
}

517 *
	$rödex
 (c⁄° *
__s
, 
__c
)

518 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

523 
	$ffs
 (
__i
Ë
__THROW
 
	`__©åibuã__
 ((
__c⁄°__
));

527 #ifdef 
__USE_GNU


528 
	$ff¶
 (
__l
Ë
__THROW
 
	`__©åibuã__
 ((
__c⁄°__
));

529 
__exãnsi⁄__
 
	$ff¶l
 (
__Œ
)

530 
__THROW
 
	`__©åibuã__
 ((
__c⁄°__
));

534 
	$°rˇ£cmp
 (c⁄° *
__s1
, c⁄° *
__s2
)

535 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

538 
	$°∫ˇ£cmp
 (c⁄° *
__s1
, c⁄° *
__s2
, 
size_t
 
__n
)

539 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

542 #ifdef 
__USE_GNU


545 
	$°rˇ£cmp_l
 (c⁄° *
__s1
, c⁄° *
__s2
,

546 
__loˇÀ_t
 
__loc
)

547 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2, 3));

549 
	$°∫ˇ£cmp_l
 (c⁄° *
__s1
, c⁄° *
__s2
,

550 
size_t
 
__n
, 
__loˇÀ_t
 
__loc
)

551 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2, 4));

554 #ifdef 
__USE_BSD


557 *
	$°r£p
 (**
__ª°ri˘
 
__°rögp
,

558 c⁄° *
__ª°ri˘
 
__dñim
)

559 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

562 #ifdef 
__USE_XOPEN2K8


564 *
	$°rsig«l
 (
__sig
Ë
__THROW
;

567 *
	$__°p˝y
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
)

568 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

569 *
	$°p˝y
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
)

570 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

574 *
	$__°≤˝y
 (*
__ª°ri˘
 
__de°
,

575 c⁄° *
__ª°ri˘
 
__§c
, 
size_t
 
__n
)

576 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

577 *
	$°≤˝y
 (*
__ª°ri˘
 
__de°
,

578 c⁄° *
__ª°ri˘
 
__§c
, 
size_t
 
__n
)

579 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

582 #ifdef 
__USE_GNU


584 
	$°rvîscmp
 (c⁄° *
__s1
, c⁄° *
__s2
)

585 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

588 *
	$°r‰y
 (*
__°rög
Ë
__THROW
 
	`__n⁄nuŒ
 ((1));

591 *
	$mem‰ob
 (*
__s
, 
size_t
 
__n
Ë
__THROW
 
	`__n⁄nuŒ
 ((1));

593 #i‚de‡
ba£«me


598 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


599 "C++" *
	$ba£«me
 (*
__fûíame
)

600 
__THROW
 
	`__asm
 ("ba£«me"Ë
	`__n⁄nuŒ
 ((1));

601 "C++" c⁄° *
	$ba£«me
 (c⁄° *
__fûíame
)

602 
__THROW
 
	`__asm
 ("ba£«me"Ë
	`__n⁄nuŒ
 ((1));

604 *
	$ba£«me
 (c⁄° *
__fûíame
Ë
__THROW
 
	`__n⁄nuŒ
 ((1));

610 #i‡
deföed
 
__GNUC__
 && __GNUC__ >= 2

611 #i‡
deföed
 
__OPTIMIZE__
 && !deföed 
__OPTIMIZE_SIZE__
 \

612 && !
deföed
 
__NO_INLINE__
 && !deföed 
__˝lu•lus


632 
	~<bôs/°rög.h
>

635 
	~<bôs/°rög2.h
>

638 #i‡
__USE_FORTIFY_LEVEL
 > 0 && 
deföed
 
__f‹tify_fun˘i⁄


640 
	~<bôs/°rög3.h
>

644 
__END_DECLS


	@/usr/include/endian.h

18 #i‚def 
_ENDIAN_H


19 
	#_ENDIAN_H
 1

	)

21 
	~<„©uªs.h
>

31 
	#__LITTLE_ENDIAN
 1234

	)

32 
	#__BIG_ENDIAN
 4321

	)

33 
	#__PDP_ENDIAN
 3412

	)

36 
	~<bôs/ídün.h
>

40 #i‚de‡
__FLOAT_WORD_ORDER


41 
	#__FLOAT_WORD_ORDER
 
__BYTE_ORDER


	)

44 #ifdef 
__USE_BSD


45 
	#LITTLE_ENDIAN
 
__LITTLE_ENDIAN


	)

46 
	#BIG_ENDIAN
 
__BIG_ENDIAN


	)

47 
	#PDP_ENDIAN
 
__PDP_ENDIAN


	)

48 
	#BYTE_ORDER
 
__BYTE_ORDER


	)

51 #i‡
__BYTE_ORDER
 =
__LITTLE_ENDIAN


52 
	#__LONG_LONG_PAIR
(
HI
, 
LO
ËLO, 
	)
HI

53 #ñi‡
__BYTE_ORDER
 =
__BIG_ENDIAN


54 
	#__LONG_LONG_PAIR
(
HI
, 
LO
ËHI, 
	)
LO

58 #i‡
deföed
 
__USE_BSD
 && !deföed 
__ASSEMBLER__


60 
	~<bôs/byãsw≠.h
>

62 #i‡
__BYTE_ORDER
 =
__LITTLE_ENDIAN


63 
	#htobe16
(
x
Ë
	`__bsw≠_16
 (x)

	)

64 
	#htﬁe16
(
x
Ë(x)

	)

65 
	#be16toh
(
x
Ë
	`__bsw≠_16
 (x)

	)

66 
	#À16toh
(
x
Ë(x)

	)

68 
	#htobe32
(
x
Ë
	`__bsw≠_32
 (x)

	)

69 
	#htﬁe32
(
x
Ë(x)

	)

70 
	#be32toh
(
x
Ë
	`__bsw≠_32
 (x)

	)

71 
	#À32toh
(
x
Ë(x)

	)

73 
	#htobe64
(
x
Ë
	`__bsw≠_64
 (x)

	)

74 
	#htﬁe64
(
x
Ë(x)

	)

75 
	#be64toh
(
x
Ë
	`__bsw≠_64
 (x)

	)

76 
	#À64toh
(
x
Ë(x)

	)

79 
	#htobe16
(
x
Ë(x)

	)

80 
	#htﬁe16
(
x
Ë
	`__bsw≠_16
 (x)

	)

81 
	#be16toh
(
x
Ë(x)

	)

82 
	#À16toh
(
x
Ë
	`__bsw≠_16
 (x)

	)

84 
	#htobe32
(
x
Ë(x)

	)

85 
	#htﬁe32
(
x
Ë
	`__bsw≠_32
 (x)

	)

86 
	#be32toh
(
x
Ë(x)

	)

87 
	#À32toh
(
x
Ë
	`__bsw≠_32
 (x)

	)

89 
	#htobe64
(
x
Ë(x)

	)

90 
	#htﬁe64
(
x
Ë
	`__bsw≠_64
 (x)

	)

91 
	#be64toh
(
x
Ë(x)

	)

92 
	#À64toh
(
x
Ë
	`__bsw≠_64
 (x)

	)

	@/usr/include/features.h

18 #i‚def 
_FEATURES_H


19 
	#_FEATURES_H
 1

	)

101 #unde‡
__USE_ISOC11


102 #unde‡
__USE_ISOC99


103 #unde‡
__USE_ISOC95


104 #unde‡
__USE_ISOCXX11


105 #unde‡
__USE_POSIX


106 #unde‡
__USE_POSIX2


107 #unde‡
__USE_POSIX199309


108 #unde‡
__USE_POSIX199506


109 #unde‡
__USE_XOPEN


110 #unde‡
__USE_XOPEN_EXTENDED


111 #unde‡
__USE_UNIX98


112 #unde‡
__USE_XOPEN2K


113 #unde‡
__USE_XOPEN2KXSI


114 #unde‡
__USE_XOPEN2K8


115 #unde‡
__USE_XOPEN2K8XSI


116 #unde‡
__USE_LARGEFILE


117 #unde‡
__USE_LARGEFILE64


118 #unde‡
__USE_FILE_OFFSET64


119 #unde‡
__USE_BSD


120 #unde‡
__USE_SVID


121 #unde‡
__USE_MISC


122 #unde‡
__USE_ATFILE


123 #unde‡
__USE_GNU


124 #unde‡
__USE_REENTRANT


125 #unde‡
__USE_FORTIFY_LEVEL


126 #unde‡
__KERNEL_STRICT_NAMES


130 #i‚de‡
_LOOSE_KERNEL_NAMES


131 
	#__KERNEL_STRICT_NAMES


	)

141 #i‡
deföed
 
__GNUC__
 && deföed 
__GNUC_MINOR__


142 
	#__GNUC_PREREQ
(
maj
, 
mö
) \

143 ((
__GNUC__
 << 16Ë+ 
__GNUC_MINOR__
 >((
maj
Ë<< 16Ë+ (
mö
))

	)

145 
	#__GNUC_PREREQ
(
maj
, 
mö
Ë0

	)

150 #ifde‡
_GNU_SOURCE


151 #unde‡
_ISOC95_SOURCE


152 
	#_ISOC95_SOURCE
 1

	)

153 #unde‡
_ISOC99_SOURCE


154 
	#_ISOC99_SOURCE
 1

	)

155 #unde‡
_ISOC11_SOURCE


156 
	#_ISOC11_SOURCE
 1

	)

157 #unde‡
_POSIX_SOURCE


158 
	#_POSIX_SOURCE
 1

	)

159 #unde‡
_POSIX_C_SOURCE


160 
	#_POSIX_C_SOURCE
 200809L

	)

161 #unde‡
_XOPEN_SOURCE


162 
	#_XOPEN_SOURCE
 700

	)

163 #unde‡
_XOPEN_SOURCE_EXTENDED


164 
	#_XOPEN_SOURCE_EXTENDED
 1

	)

165 #unde‡
_LARGEFILE64_SOURCE


166 
	#_LARGEFILE64_SOURCE
 1

	)

167 #unde‡
_DEFAULT_SOURCE


168 
	#_DEFAULT_SOURCE
 1

	)

169 #unde‡
_BSD_SOURCE


170 
	#_BSD_SOURCE
 1

	)

171 #unde‡
_SVID_SOURCE


172 
	#_SVID_SOURCE
 1

	)

173 #unde‡
_ATFILE_SOURCE


174 
	#_ATFILE_SOURCE
 1

	)

179 #i‡(
deföed
 
_DEFAULT_SOURCE
 \

180 || (!
deföed
 
	g__STRICT_ANSI__
 \

181 && !
deföed
 
	g_ISOC99_SOURCE
 \

182 && !
deföed
 
	g_POSIX_SOURCE
 && !deföed 
	g_POSIX_C_SOURCE
 \

183 && !
deföed
 
	g_XOPEN_SOURCE
 \

184 && !
deföed
 
	g_BSD_SOURCE
 && !deföed 
	g_SVID_SOURCE
))

185 #unde‡
_DEFAULT_SOURCE


186 
	#_DEFAULT_SOURCE
 1

	)

187 #unde‡
_BSD_SOURCE


188 
	#_BSD_SOURCE
 1

	)

189 #unde‡
_SVID_SOURCE


190 
	#_SVID_SOURCE
 1

	)

194 #i‡(
deföed
 
_ISOC11_SOURCE
 \

195 || (
deföed
 
	g__STDC_VERSION__
 && __STDC_VERSION__ >= 201112L))

196 
	#__USE_ISOC11
 1

	)

200 #i‡(
deföed
 
_ISOC99_SOURCE
 || deföed 
_ISOC11_SOURCE
 \

201 || (
deföed
 
__STDC_VERSION__
 && __STDC_VERSION__ >= 199901L))

202 
	#__USE_ISOC99
 1

	)

206 #i‡(
deföed
 
_ISOC99_SOURCE
 || deföed 
_ISOC11_SOURCE
 \

207 || (
deföed
 
__STDC_VERSION__
 && __STDC_VERSION__ >= 199409L))

208 
	#__USE_ISOC95
 1

	)

215 #i‡((
deföed
 
__˝lu•lus
 && __cplusplus >= 201103L) \

216 || 
deföed
 
__GXX_EXPERIMENTAL_CXX0X__
)

217 
	#__USE_ISOCXX11
 1

	)

223 #ifde‡
_DEFAULT_SOURCE


224 #i‡!
deföed
 
_POSIX_SOURCE
 && !deföed 
_POSIX_C_SOURCE


225 
	#__USE_POSIX_IMPLICITLY
 1

	)

227 #unde‡
_POSIX_SOURCE


228 
	#_POSIX_SOURCE
 1

	)

229 #unde‡
_POSIX_C_SOURCE


230 
	#_POSIX_C_SOURCE
 200809L

	)

232 #i‡((!
deföed
 
__STRICT_ANSI__
 || (
_XOPEN_SOURCE
 - 0) >= 500) && \

233 !
deföed
 
_POSIX_SOURCE
 && !deföed 
_POSIX_C_SOURCE
)

234 
	#_POSIX_SOURCE
 1

	)

235 #i‡
deföed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 500

236 
	#_POSIX_C_SOURCE
 2

	)

237 #ñi‡
deföed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 600

238 
	#_POSIX_C_SOURCE
 199506L

	)

239 #ñi‡
deföed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 700

240 
	#_POSIX_C_SOURCE
 200112L

	)

242 
	#_POSIX_C_SOURCE
 200809L

	)

244 
	#__USE_POSIX_IMPLICITLY
 1

	)

247 #i‡
deföed
 
_POSIX_SOURCE
 || 
_POSIX_C_SOURCE
 >1 || deföed 
_XOPEN_SOURCE


248 
	#__USE_POSIX
 1

	)

251 #i‡
deföed
 
_POSIX_C_SOURCE
 && _POSIX_C_SOURCE >2 || deföed 
_XOPEN_SOURCE


252 
	#__USE_POSIX2
 1

	)

255 #i‡(
_POSIX_C_SOURCE
 - 0) >= 199309L

256 
	#__USE_POSIX199309
 1

	)

259 #i‡(
_POSIX_C_SOURCE
 - 0) >= 199506L

260 
	#__USE_POSIX199506
 1

	)

263 #i‡(
_POSIX_C_SOURCE
 - 0) >= 200112L

264 
	#__USE_XOPEN2K
 1

	)

265 #unde‡
__USE_ISOC95


266 
	#__USE_ISOC95
 1

	)

267 #unde‡
__USE_ISOC99


268 
	#__USE_ISOC99
 1

	)

271 #i‡(
_POSIX_C_SOURCE
 - 0) >= 200809L

272 
	#__USE_XOPEN2K8
 1

	)

273 #unde‡
_ATFILE_SOURCE


274 
	#_ATFILE_SOURCE
 1

	)

277 #ifdef 
_XOPEN_SOURCE


278 
	#__USE_XOPEN
 1

	)

279 #i‡(
_XOPEN_SOURCE
 - 0) >= 500

280 
	#__USE_XOPEN_EXTENDED
 1

	)

281 
	#__USE_UNIX98
 1

	)

282 #unde‡
_LARGEFILE_SOURCE


283 
	#_LARGEFILE_SOURCE
 1

	)

284 #i‡(
_XOPEN_SOURCE
 - 0) >= 600

285 #i‡(
_XOPEN_SOURCE
 - 0) >= 700

286 
	#__USE_XOPEN2K8
 1

	)

287 
	#__USE_XOPEN2K8XSI
 1

	)

289 
	#__USE_XOPEN2K
 1

	)

290 
	#__USE_XOPEN2KXSI
 1

	)

291 #unde‡
__USE_ISOC95


292 
	#__USE_ISOC95
 1

	)

293 #unde‡
__USE_ISOC99


294 
	#__USE_ISOC99
 1

	)

297 #ifde‡
_XOPEN_SOURCE_EXTENDED


298 
	#__USE_XOPEN_EXTENDED
 1

	)

303 #ifde‡
_LARGEFILE_SOURCE


304 
	#__USE_LARGEFILE
 1

	)

307 #ifde‡
_LARGEFILE64_SOURCE


308 
	#__USE_LARGEFILE64
 1

	)

311 #i‡
deföed
 
_FILE_OFFSET_BITS
 && _FILE_OFFSET_BITS == 64

312 
	#__USE_FILE_OFFSET64
 1

	)

315 #i‡
deföed
 
_BSD_SOURCE
 || deföed 
_SVID_SOURCE


316 
	#__USE_MISC
 1

	)

319 #ifdef 
_BSD_SOURCE


320 
	#__USE_BSD
 1

	)

323 #ifdef 
_SVID_SOURCE


324 
	#__USE_SVID
 1

	)

327 #ifdef 
_ATFILE_SOURCE


328 
	#__USE_ATFILE
 1

	)

331 #ifdef 
_GNU_SOURCE


332 
	#__USE_GNU
 1

	)

335 #i‡
deföed
 
_REENTRANT
 || deföed 
_THREAD_SAFE


336 
	#__USE_REENTRANT
 1

	)

339 #i‡
deföed
 
_FORTIFY_SOURCE
 && _FORTIFY_SOURCE > 0 \

340 && 
__GNUC_PREREQ
 (4, 1Ë&& 
deföed
 
	g__OPTIMIZE__
 && __OPTIMIZE__ > 0

341 #i‡
_FORTIFY_SOURCE
 > 1

342 
	#__USE_FORTIFY_LEVEL
 2

	)

344 
	#__USE_FORTIFY_LEVEL
 1

	)

347 
	#__USE_FORTIFY_LEVEL
 0

	)

352 
	~<°dc-¥edef.h
>

360 #unde‡
__GNU_LIBRARY__


361 
	#__GNU_LIBRARY__
 6

	)

365 
	#__GLIBC__
 2

	)

366 
	#__GLIBC_MINOR__
 19

	)

368 
	#__GLIBC_PREREQ
(
maj
, 
mö
) \

369 ((
__GLIBC__
 << 16Ë+ 
__GLIBC_MINOR__
 >((
maj
Ë<< 16Ë+ (
mö
))

	)

372 #i‚de‡
__ASSEMBLER__


373 #i‚de‡
_SYS_CDEFS_H


374 
	~<sys/cdefs.h
>

379 #i‡
deföed
 
__USE_FILE_OFFSET64
 && !deföed 
__REDIRECT


380 
	#__USE_LARGEFILE
 1

	)

381 
	#__USE_LARGEFILE64
 1

	)

387 #i‡
__GNUC_PREREQ
 (2, 7Ë&& 
deföed
 
__OPTIMIZE__
 \

388 && !
deföed
 
	g__OPTIMIZE_SIZE__
 && !deföed 
	g__NO_INLINE__
 \

389 && 
deföed
 
	g__exã∫_ölöe


390 
	#__USE_EXTERN_INLINES
 1

	)

398 
	~<gnu/°ubs.h
>

	@/usr/include/xlocale.h

20 #i‚de‡
_XLOCALE_H


21 
	#_XLOCALE_H
 1

	)

27 
	s__loˇÀ_°ru˘


30 
__loˇÀ_d©a
 *
	m__loˇÀs
[13];

33 c⁄° *
	m__˘y≥_b
;

34 c⁄° *
	m__˘y≥_tﬁowî
;

35 c⁄° *
	m__˘y≥_touµî
;

38 c⁄° *
	m__«mes
[13];

39 } *
	t__loˇÀ_t
;

42 
__loˇÀ_t
 
	tloˇÀ_t
;

	@/usr/include/stdc-predef.h

18 #i‚def 
_STDC_PREDEF_H


19 
	#_STDC_PREDEF_H
 1

	)

36 #ifde‡
__GCC_IEC_559


37 #i‡
__GCC_IEC_559
 > 0

38 
	#__STDC_IEC_559__
 1

	)

41 
	#__STDC_IEC_559__
 1

	)

44 #ifde‡
__GCC_IEC_559_COMPLEX


45 #i‡
__GCC_IEC_559_COMPLEX
 > 0

46 
	#__STDC_IEC_559_COMPLEX__
 1

	)

49 
	#__STDC_IEC_559_COMPLEX__
 1

	)

54 
	#__STDC_ISO_10646__
 201103L

	)

57 
	#__STDC_NO_THREADS__
 1

	)

	@
1
.
1
/usr/include
56
572
README.txt
alarm.c
argblock.c
bitset.c
blockdev.c
bootsect.asm
bufcache.c
cfs.c
crc32.c
cscope.out
defs.asm
dma.c
elf.c
fd_boot.asm
floppy.c
gdt.c
gfs2.c
gosfs.c
ide.c
idt.c
int.c
io.c
irq.c
keyboard.c
kthread.c
lowlevel.asm
main.c
malloc.c
mem.c
paging.c
pfat.c
pipe.c
screen.c
segment.c
sem.c
setup.asm
signal.c
smp.c
symbol.asm
synch.c
syscall.c
timer.c
trap.c
tss.c
user.c
userseg.c
uservm.c
util.asm
vfs.c
/usr/include/ctype.h
/usr/include/limits.h
/usr/include/string.h
/usr/include/endian.h
/usr/include/features.h
/usr/include/xlocale.h
/usr/include/stdc-predef.h
